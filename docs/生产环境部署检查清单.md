# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å• âœ…

## ğŸ¯ æœåŠ¡å™¨é…ç½®ä¿¡æ¯

```
æœåŠ¡å™¨: è…¾è®¯äº‘è½»é‡åº”ç”¨æœåŠ¡å™¨
è§„æ ¼:   4æ ¸CPU, 4GBå†…å­˜, 40GB SSD
å¸¦å®½:   3Mbps, 300GBæµé‡/æœˆ
åœ°åŸŸ:   å¹¿å·å››åŒº
é¢æ¿:   å®å¡”Linuxé¢æ¿
```

**é¢„æœŸå¹¶å‘èƒ½åŠ›:**
- ä¼˜åŒ–å‰: 100-150 å¹¶å‘ç”¨æˆ·
- ä¼˜åŒ–å: **250-350 å¹¶å‘ç”¨æˆ·** â­

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### 1ï¸âƒ£ æ•°æ®åº“ä¼˜åŒ– (å¿…é¡»æ‰§è¡Œ)

#### æ­¥éª¤1: å¤‡ä»½MySQLé…ç½®

```bash
# ç™»å½•æœåŠ¡å™¨
ssh root@your_server_ip

# å¤‡ä»½åŸé…ç½®
sudo cp /etc/mysql/my.cnf /etc/mysql/my.cnf.backup.$(date +%Y%m%d)

# æˆ–è€…å®å¡”è·¯å¾„
sudo cp /www/server/mysql/etc/my.cnf /www/server/mysql/etc/my.cnf.backup.$(date +%Y%m%d)
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤2: ç¼–è¾‘MySQLé…ç½®

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/mysql/my.cnf

# æˆ–è€…å®å¡”è·¯å¾„
sudo vim /www/server/mysql/etc/my.cnf
```

åœ¨ `[mysqld]` éƒ¨åˆ†æ·»åŠ ä»¥ä¸‹é…ç½®:

```ini
[mysqld]
# ğŸ”¥ é’ˆå¯¹4GBå†…å­˜ä¼˜åŒ–
innodb_buffer_pool_size = 512M
max_connections = 100
query_cache_type = 1
query_cache_size = 32M
tmp_table_size = 32M
max_heap_table_size = 32M
innodb_flush_log_at_trx_commit = 2
performance_schema = OFF
```

**è¯¦ç»†é…ç½®å‚è€ƒ:** [docs/MySQLä¼˜åŒ–é…ç½®-4GBå†…å­˜.md](./MySQLä¼˜åŒ–é…ç½®-4GBå†…å­˜.md)

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤3: é‡å¯MySQLå¹¶éªŒè¯

```bash
# é‡å¯MySQL
sudo systemctl restart mysql

# éªŒè¯é…ç½®ç”Ÿæ•ˆ
mysql -u root -p -e "
SHOW VARIABLES LIKE 'innodb_buffer_pool_size';
SHOW VARIABLES LIKE 'max_connections';
SHOW VARIABLES LIKE 'performance_schema';
"
```

**é¢„æœŸè¾“å‡º:**
```
innodb_buffer_pool_size: 536870912 (512MB)
max_connections: 100
performance_schema: OFF
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 2ï¸âƒ£ åç«¯ç¯å¢ƒé…ç½® (å¿…é¡»æ‰§è¡Œ)

#### æ­¥éª¤1: ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨

```bash
# æ–¹æ³•1: Gitå…‹éš†ï¼ˆæ¨èï¼‰
cd /www/wwwroot
git clone your_git_repo ai-photo-backend
cd ai-photo-backend/backend

# æ–¹æ³•2: FTPä¸Šä¼ 
# ä½¿ç”¨FileZillaç­‰å·¥å…·ä¸Šä¼ backendæ–‡ä»¶å¤¹åˆ° /www/wwwroot/
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤2: å®‰è£…ä¾èµ–

```bash
cd /www/wwwroot/ai-photo-backend/backend

# å®‰è£…ç”Ÿäº§ä¾èµ–
npm install --production

# æˆ–è€…å…¨éƒ¨å®‰è£…
npm install
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤3: é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
vim .env
```

**å¿…é¡»ä¿®æ”¹çš„é…ç½®:**

```bash
# 1. æ•°æ®åº“é…ç½®
DB_PASSWORD=ä½ çš„MySQLå¯†ç 

# 2. JWTå¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
JWT_SECRET=ç”Ÿæˆæ–°çš„64ä½å¯†é’¥

# 3. åŠ å¯†å¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
CREDENTIALS_ENCRYPTION_KEY=ç”Ÿæˆæ–°çš„32ä½å¯†é’¥

# 4. å†…éƒ¨å›è°ƒå¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
INTERNAL_CALLBACK_SECRET=ç”Ÿæˆæ–°çš„64ä½å¯†é’¥

# 5. è…¾è®¯äº‘COSé…ç½®
TENCENT_SECRET_ID=ä½ çš„è…¾è®¯äº‘SecretId
TENCENT_SECRET_KEY=ä½ çš„è…¾è®¯äº‘SecretKey
COS_BUCKET=ä½ çš„COSæ¡¶åç§°
COS_IMAGE_DOMAIN=ä½ çš„COSè®¿é—®åŸŸå

# 6. RunningHub APIé…ç½®
RUNNINGHUB_API_KEY=ä½ çš„APIå¯†é’¥
RUNNINGHUB_WEBAPP_ID=ä½ çš„WebApp ID

# 7. æ•°æ®åº“è¿æ¥æ± ï¼ˆå·²ä¼˜åŒ–ï¼‰
DATABASE_POOL_MIN=10
DATABASE_POOL_MAX=30
```

**ç”Ÿæˆå¯†é’¥å‘½ä»¤:**
```bash
# ç”ŸæˆJWT_SECRETå’ŒINTERNAL_CALLBACK_SECRET (64ä½)
node -e "console.log(require('crypto').randomBytes(64).toString('base64'))"

# ç”ŸæˆCREDENTIALS_ENCRYPTION_KEY (32ä½)
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤4: æ•°æ®åº“è¿ç§»

```bash
cd /www/wwwroot/ai-photo-backend/backend

# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run db:migrate
```

**é¢„æœŸè¾“å‡º:**
```
Batch 1 run: 6 migrations
âœ¨ è¿ç§»å®Œæˆ
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 3ï¸âƒ£ PM2éƒ¨ç½² (å¿…é¡»æ‰§è¡Œ)

#### æ­¥éª¤1: å®‰è£…PM2

```bash
# å…¨å±€å®‰è£…PM2
npm install -g pm2
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤2: å¯åŠ¨PM2 Cluster

```bash
cd /www/wwwroot/ai-photo-backend/backend

# å¯åŠ¨3è¿›ç¨‹é›†ç¾¤æ¨¡å¼
pm2 start ecosystem.config.js --env production

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs ai-photo-api --lines 50
```

**é¢„æœŸè¾“å‡º:**
```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name             â”‚ mode    â”‚ status  â”‚ cpu      â”‚ mem   â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0   â”‚ ai-photo-api     â”‚ cluster â”‚ online  â”‚ 0%       â”‚ 150MB â”‚
â”‚ 1   â”‚ ai-photo-api     â”‚ cluster â”‚ online  â”‚ 0%       â”‚ 150MB â”‚
â”‚ 2   â”‚ ai-photo-api     â”‚ cluster â”‚ online  â”‚ 0%       â”‚ 150MB â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤3: è®¾ç½®PM2å¼€æœºè‡ªå¯

```bash
# ä¿å­˜PM2è¿›ç¨‹åˆ—è¡¨
pm2 save

# ç”Ÿæˆå¼€æœºè‡ªå¯è„šæœ¬
pm2 startup

# å¤åˆ¶è¾“å‡ºçš„å‘½ä»¤å¹¶æ‰§è¡Œï¼ˆç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼‰
# sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u root --hp /root
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 4ï¸âƒ£ Nginxåå‘ä»£ç† (å¿…é¡»æ‰§è¡Œ)

#### æ­¥éª¤1: é…ç½®Nginx

```bash
# ç¼–è¾‘Nginxé…ç½®ï¼ˆå®å¡”é¢æ¿æ“ä½œï¼‰
# 1. æ‰“å¼€å®å¡”é¢æ¿
# 2. ç½‘ç«™ â†’ æ·»åŠ ç«™ç‚¹
# 3. åŸŸå: api.your-domain.com
# 4. åå‘ä»£ç†é…ç½®:

# åå‘ä»£ç†åˆ°
http://127.0.0.1:3001

# æˆ–è€…ç¼–è¾‘é…ç½®æ–‡ä»¶
vim /www/server/panel/vhost/nginx/api.your-domain.com.conf
```

**Nginxé…ç½®æ¨¡æ¿:**

```nginx
server {
    listen 80;
    server_name api.your-domain.com;

    # HTTPSé‡å®šå‘ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # è¶…æ—¶é…ç½®ï¼ˆAIä»»åŠ¡å¯èƒ½å¾ˆé•¿ï¼‰
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

#### æ­¥éª¤2: æµ‹è¯•Nginxé…ç½®

```bash
# æµ‹è¯•é…ç½®è¯­æ³•
sudo nginx -t

# é‡è½½Nginx
sudo nginx -s reload
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 5ï¸âƒ£ SSLè¯ä¹¦é…ç½® (æ¨è)

#### ä½¿ç”¨å®å¡”é¢æ¿ä¸€é”®é…ç½®

```
1. æ‰“å¼€å®å¡”é¢æ¿
2. ç½‘ç«™ â†’ é€‰æ‹©ä½ çš„ç«™ç‚¹
3. SSL â†’ Let's Encrypt â†’ ç”³è¯·
4. å¼ºåˆ¶HTTPS: å¼€å¯
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 6ï¸âƒ£ é˜²ç«å¢™é…ç½® (å¿…é¡»æ‰§è¡Œ)

```bash
# å®å¡”é¢æ¿ â†’ å®‰å…¨ â†’ é˜²ç«å¢™

# æ”¾è¡Œç«¯å£:
3001  # åç«¯API (ä»…å…è®¸æœ¬åœ°è®¿é—®)
3306  # MySQL (ä»…å…è®¸æœ¬åœ°è®¿é—®)
6379  # Redis (ä»…å…è®¸æœ¬åœ°è®¿é—®)
80    # HTTP (å…¬ç½‘è®¿é—®)
443   # HTTPS (å…¬ç½‘è®¿é—®)

# æˆ–è€…å‘½ä»¤è¡Œé…ç½®
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 3001/tcp from 127.0.0.1
sudo ufw enable
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•æ¸…å•

### 1ï¸âƒ£ å¥åº·æ£€æŸ¥

```bash
# æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥
curl http://your-server-ip:3001/health

# æˆ–è€…é€šè¿‡åŸŸå
curl http://api.your-domain.com/health
```

**é¢„æœŸè¾“å‡º:**
```json
{
  "status": "ok",
  "timestamp": "2025-10-29T12:00:00.000Z"
}
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 2ï¸âƒ£ æ•°æ®åº“è¿æ¥æµ‹è¯•

```bash
# æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢
curl http://api.your-domain.com/api/features
```

**é¢„æœŸè¾“å‡º:**
```json
{
  "success": true,
  "data": [...]
}
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 3ï¸âƒ£ APIåŠŸèƒ½æµ‹è¯•

```bash
# 1. ç”¨æˆ·ç™»å½•
curl -X POST http://api.your-domain.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"test123"}'

# 2. è·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆéœ€è¦tokenï¼‰
curl http://api.your-domain.com/api/tasks \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. åˆ›å»ºä»»åŠ¡ï¼ˆéœ€è¦tokenï¼‰
curl -X POST http://api.your-domain.com/api/tasks \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"featureId":1,"inputImageUrl":"..."}'
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

### 4ï¸âƒ£ å¹¶å‘å‹åŠ›æµ‹è¯•

```bash
cd /www/wwwroot/ai-photo-backend/backend

# è¿è¡Œå‹åŠ›æµ‹è¯•
node load-test.js
```

**é¢„æœŸè¾“å‡º:**
```
ã€å¥åº·æ£€æŸ¥ - 100å¹¶å‘ã€‘
âœ… æˆåŠŸç‡: 100%
âœ… QPS: 800+ req/s (PM2 3è¿›ç¨‹)
âœ… P95å“åº”: <200ms
```

âœ… å®Œæˆåæ‰“å‹¾: [ ]

---

## ğŸ“Š æ€§èƒ½ç›‘æ§æ¸…å•

### 1ï¸âƒ£ æœåŠ¡å™¨èµ„æºç›‘æ§

```bash
# æŸ¥çœ‹CPUå’Œå†…å­˜
htop

# æŸ¥çœ‹PM2è¿›ç¨‹
pm2 monit

# æŸ¥çœ‹MySQLæ€§èƒ½
mysql -u root -p -e "SHOW PROCESSLIST"
```

âœ… è®¾ç½®ç›‘æ§: [ ]

---

### 2ï¸âƒ£ æ—¥å¿—ç›‘æ§

```bash
# PM2æ—¥å¿—
pm2 logs ai-photo-api --lines 100

# Nginxæ—¥å¿—
tail -f /www/wwwlogs/api.your-domain.com.log

# MySQLæ…¢æŸ¥è¯¢æ—¥å¿—
tail -f /var/log/mysql/slow.log
```

âœ… è®¾ç½®æ—¥å¿—è½®è½¬: [ ]

---

### 3ï¸âƒ£ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| **CPUä½¿ç”¨ç‡** | <70% | ___ % | [ ] |
| **å†…å­˜ä½¿ç”¨ç‡** | <80% | ___ % | [ ] |
| **å“åº”æ—¶é—´P95** | <200ms | ___ ms | [ ] |
| **QPS** | >500 | ___ | [ ] |
| **å¹¶å‘ç”¨æˆ·** | 250+ | ___ | [ ] |

---

## ğŸš¨ æ•…éšœæ’æŸ¥æ¸…å•

### é—®é¢˜1: PM2å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs ai-photo-api --err --lines 50

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep 3001

# é‡å¯PM2
pm2 restart ai-photo-api
```

---

### é—®é¢˜2: æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥MySQLçŠ¶æ€
systemctl status mysql

# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u root -p -e "SELECT 1"

# æ£€æŸ¥.envé…ç½®
cat /www/wwwroot/ai-photo-backend/backend/.env | grep DB_
```

---

### é—®é¢˜3: å†…å­˜ä¸è¶³

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# ä¼˜åŒ–MySQLé…ç½®ï¼ˆå‚è€ƒ MySQLä¼˜åŒ–é…ç½®-4GBå†…å­˜.mdï¼‰
# å‡å°‘PM2è¿›ç¨‹æ•°: instances: 3 â†’ 2
```

---

### é—®é¢˜4: Nginx 502é”™è¯¯

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
pm2 status

# æ£€æŸ¥ç«¯å£
netstat -tulpn | grep 3001

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
tail -f /www/wwwlogs/nginx_error.log
```

---

## âœ… æœ€ç»ˆæ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹æ‰€æœ‰é¡¹ç›®:

- [ ] MySQLé…ç½®ä¼˜åŒ–å®Œæˆï¼ˆ512MBç¼“å†²æ± ï¼‰
- [ ] åç«¯ä»£ç ä¸Šä¼ å®Œæˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæˆï¼ˆJWTå¯†é’¥ã€COSç­‰ï¼‰
- [ ] æ•°æ®åº“è¿ç§»å®Œæˆ
- [ ] PM2 Clusterå¯åŠ¨ï¼ˆ3è¿›ç¨‹ï¼‰
- [ ] PM2å¼€æœºè‡ªå¯é…ç½®å®Œæˆ
- [ ] Nginxåå‘ä»£ç†é…ç½®å®Œæˆ
- [ ] SSLè¯ä¹¦é…ç½®å®Œæˆ
- [ ] é˜²ç«å¢™é…ç½®å®Œæˆ
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] APIåŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] å‹åŠ›æµ‹è¯•é€šè¿‡ï¼ˆQPS >500ï¼‰
- [ ] ç›‘æ§å‘Šè­¦é…ç½®å®Œæˆ

---

## ğŸ¯ ä¼˜åŒ–æ•ˆæœè¯„ä¼°

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **å¹¶å‘ç”¨æˆ·** | 100-150äºº | **250-350äºº** | +133% |
| **QPS** | 429 | **800+** | +86% |
| **MySQLå†…å­˜** | 800MB | **600MB** | -25% |
| **Node.jsè¿›ç¨‹** | 1ä¸ª | **3ä¸ª** | +200% |
| **å“åº”æ—¶é—´P95** | 184ms | **<200ms** | âœ… |

---

## ğŸš€ ä¸Šçº¿åå»ºè®®

1. **ç›‘æ§7å¤©**: è§‚å¯ŸCPUã€å†…å­˜ã€QPSå®é™…æ•°æ®
2. **é€æ­¥å¼€æ”¾**: å…ˆå¼€æ”¾100ç”¨æˆ·ï¼Œç¨³å®šåå†å¢åŠ 
3. **å¤‡ä»½ç­–ç•¥**: æ¯å¤©è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“å’Œä»£ç 
4. **å‡çº§è®¡åˆ’**:
   - ç”¨æˆ·300+ â†’ å‡çº§å¸¦å®½åˆ°5Mbps
   - ç”¨æˆ·500+ â†’ å‡çº§å†…å­˜åˆ°8GB
   - ç”¨æˆ·1000+ â†’ å¢åŠ æœåŠ¡å™¨ï¼Œè´Ÿè½½å‡è¡¡

---

**è€ç‹å»ºè®®: æŒ‰è¿™ä¸ªæ¸…å•ä¸€æ­¥æ­¥æ‰§è¡Œï¼Œä¿è¯ä½ çš„åç«¯ç¨³å¦‚ç‹—ï¼** ğŸš€
