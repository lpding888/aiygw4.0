# æœåŠ¡å™¨é…ç½®å¹¶å‘èƒ½åŠ›è¯„ä¼°æŠ¥å‘Š

## ðŸ“‹ æœåŠ¡å™¨é…ç½®

| é…ç½®é¡¹ | å‚æ•° | è¯„åˆ† |
|--------|------|------|
| **CPU** | 4æ ¸ | â­â­â­â­ ä¼˜ç§€ |
| **å†…å­˜** | 4GB | â­â­â­ è‰¯å¥½ |
| **ç¡¬ç›˜** | 40GB SSD | â­â­â­â­ ä¼˜ç§€ |
| **å¸¦å®½** | 3Mbps | â­â­ æ™®é€š |
| **æµé‡åŒ…** | 300GB/æœˆ | â­â­â­ è‰¯å¥½ |

**ç»¼åˆè¯„åˆ†: â­â­â­ è‰¯å¥½**

---

## ðŸŽ¯ å¹¶å‘èƒ½åŠ›è¯„ä¼°

### 1ï¸âƒ£ **ç†è®ºæœ€å¤§å¹¶å‘ï¼ˆå•Node.jsè¿›ç¨‹ï¼‰**

æ ¹æ®åŽ‹åŠ›æµ‹è¯•ç»“æžœï¼š
- QPS: **429 req/s**
- å“åº”æ—¶é—´: P95 **184ms**
- æˆåŠŸçŽ‡: **100%**

**å•è¿›ç¨‹ç†è®ºå¹¶å‘:**
```
å¹¶å‘ç”¨æˆ· = QPS Ã— å¹³å‡è¯·æ±‚é—´éš”
         = 429 Ã— 0.3s (å‡è®¾ç”¨æˆ·æ¯300msè¯·æ±‚ä¸€æ¬¡)
         = 128 å¹¶å‘ç”¨æˆ·
```

âœ… **å•è¿›ç¨‹æ”¯æŒ: 100-150 å¹¶å‘ç”¨æˆ·**

---

### 2ï¸âƒ£ **å¯ç”¨PM2 ClusteråŽï¼ˆ4æ ¸å…¨å¼€ï¼‰**

**é…ç½®ä¼˜åŒ–:**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'ai-photo-api',
    script: './src/server.js',
    instances: 4,        // ðŸ”¥ 4ä¸ªè¿›ç¨‹ï¼ˆåˆ©ç”¨4æ ¸CPUï¼‰
    exec_mode: 'cluster',
    max_memory_restart: '800M'  // ðŸ”¥ å•è¿›ç¨‹æœ€å¤§800MBï¼ˆ4ä¸ªè¿›ç¨‹å…±3.2GBï¼‰
  }]
};
```

**ä¼˜åŒ–åŽå¹¶å‘èƒ½åŠ›:**
```
å¹¶å‘ç”¨æˆ· = å•è¿›ç¨‹å¹¶å‘ Ã— è¿›ç¨‹æ•° Ã— æ•ˆçŽ‡ç³»æ•°
         = 128 Ã— 4 Ã— 0.8  (æ•ˆçŽ‡ç³»æ•°è€ƒè™‘è¿›ç¨‹é—´é€šä¿¡å¼€é”€)
         = 409 å¹¶å‘ç”¨æˆ·
```

âœ… **PM2 Clusteræ”¯æŒ: 300-500 å¹¶å‘ç”¨æˆ·**

---

### 3ï¸âƒ£ **çœŸå®žä¸šåŠ¡åœºæ™¯åˆ†æž**

#### åœºæ™¯A: ç”¨æˆ·æµè§ˆã€æŸ¥è¯¢ä»»åŠ¡
```
è¯·æ±‚ç±»åž‹: GET /api/tasks, GET /api/features
å“åº”æ—¶é—´: 2-6ms (æ•°æ®åº“æŸ¥è¯¢)
QPS: 429

âœ… æ”¯æŒå¹¶å‘: 400-500äºº åŒæ—¶æµè§ˆ
```

#### åœºæ™¯B: ç”¨æˆ·åˆ›å»ºAIä»»åŠ¡
```
è¯·æ±‚ç±»åž‹: POST /api/tasks
å“åº”æ—¶é—´: 50-100ms (æ•°æ®åº“æ’å…¥ + å¼‚æ­¥è°ƒç”¨)
QPS: ~200

âœ… æ”¯æŒå¹¶å‘: 150-200äºº åŒæ—¶åˆ›å»ºä»»åŠ¡
```

#### åœºæ™¯C: AIä»»åŠ¡ç”Ÿæˆï¼ˆçœŸæ­£ç“¶é¢ˆï¼‰
```
å¤–éƒ¨APIå“åº”:
- RunningHubå›¾ç‰‡ç”Ÿæˆ: 10-60ç§’
- Hunyuanè§†é¢‘ç”Ÿæˆ: 30-120ç§’
- Kuaiè§†é¢‘ç”Ÿæˆ: 20-90ç§’

âŒ ç“¶é¢ˆ: å¤–éƒ¨APIæ€§èƒ½ï¼Œä¸æ˜¯ä½ çš„åŽç«¯
âœ… ä½ çš„åŽç«¯å¯ä»¥åŒæ—¶å¤„ç†: 500+ ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼ˆå·²å…¥åº“ï¼Œç­‰å¾…å›žè°ƒï¼‰
```

---

## ðŸš¨ 4GBå†…å­˜çš„é™åˆ¶

### å†…å­˜åˆ†é…å»ºè®®

```
æ€»å†…å­˜: 4GB

ç³»ç»Ÿå ç”¨:        ~600MB
å®å¡”é¢æ¿:        ~200MB
MySQL:           ~800MB (éœ€è°ƒæ•´é…ç½®)
Redis:           ~200MB
Node.js (4è¿›ç¨‹): ~3200MB (æ¯è¿›ç¨‹800MB)
-----------------------------------
æ€»è®¡:            ~5000MB âš ï¸ è¶…å‡ºï¼
```

**è‰¹ï¼å†…å­˜ä¸å¤Ÿï¼å¿…é¡»ä¼˜åŒ–ï¼**

### ä¼˜åŒ–æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: è°ƒæ•´PM2è¿›ç¨‹æ•°ï¼ˆæŽ¨èï¼‰

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'ai-photo-api',
    script: './src/server.js',
    instances: 3,        // ðŸ”¥ æ”¹æˆ3ä¸ªè¿›ç¨‹
    exec_mode: 'cluster',
    max_memory_restart: '600M'  // ðŸ”¥ å•è¿›ç¨‹æœ€å¤§600MB
  }]
};
```

**ä¼˜åŒ–åŽå†…å­˜åˆ†é…:**
```
ç³»ç»Ÿå ç”¨:        ~600MB
å®å¡”é¢æ¿:        ~200MB
MySQL:           ~600MB (ä¼˜åŒ–åŽ)
Redis:           ~200MB
Node.js (3è¿›ç¨‹): ~1800MB (æ¯è¿›ç¨‹600MB)
ç¼“å†²åŒº:          ~400MB
-----------------------------------
æ€»è®¡:            ~3800MB âœ… å®‰å…¨
```

**å¹¶å‘èƒ½åŠ›:**
```
å¹¶å‘ç”¨æˆ· = 128 Ã— 3 Ã— 0.8 = 307 å¹¶å‘ç”¨æˆ·
```

âœ… **ä¼˜åŒ–åŽæ”¯æŒ: 250-350 å¹¶å‘ç”¨æˆ·**

---

#### æ–¹æ¡ˆ2: ä¼˜åŒ–MySQLå†…å­˜å ç”¨

**ç¼–è¾‘ MySQL é…ç½®:**
```bash
# /etc/mysql/my.cnf
[mysqld]
# ðŸ”¥ é’ˆå¯¹4GBå†…å­˜ä¼˜åŒ–
innodb_buffer_pool_size = 512M  # åŽŸæ¥å¯èƒ½æ˜¯1G
max_connections = 100           # åŽŸæ¥å¯èƒ½æ˜¯151
query_cache_size = 32M          # æŸ¥è¯¢ç¼“å­˜
tmp_table_size = 32M
max_heap_table_size = 32M
```

**é‡å¯MySQL:**
```bash
systemctl restart mysql
```

**èŠ‚çœå†…å­˜: ~200-400MB**

---

## ðŸŒ 3Mbpså¸¦å®½çš„é™åˆ¶

### å¸¦å®½è®¡ç®—

**3Mbps = 375KB/s (ç†è®ºé€Ÿåº¦)**

å‡è®¾æ¯ä¸ªAPIè¯·æ±‚ï¼š
- è¯·æ±‚å¤§å°: ~1KB (JSON)
- å“åº”å¤§å°: ~10KB (ä»»åŠ¡åˆ—è¡¨ã€ç”¨æˆ·ä¿¡æ¯ç­‰)
- å›¾ç‰‡ä¸Šä¼ : ~500KB-2MB (OSSç›´ä¼ ï¼Œä¸å ç”¨åŽç«¯å¸¦å®½)

**å¹¶å‘è®¡ç®—:**
```
æ¯ä¸ªè¯·æ±‚å¹³å‡: 11KB (1KBè¯·æ±‚ + 10KBå“åº”)
ç†è®ºQPS = 375KB/s Ã· 11KB â‰ˆ 34 req/s

âŒ å¸¦å®½ç“¶é¢ˆï¼3Mbpsåªèƒ½æ”¯æŒ 34 QPS
```

**ä½†å®žé™…æƒ…å†µ:**
- âœ… å›¾ç‰‡/è§†é¢‘ä¸Šä¼ èµ°COSç›´ä¼ ï¼Œ**ä¸å ç”¨åŽç«¯å¸¦å®½**
- âœ… ç”Ÿæˆçš„å›¾ç‰‡/è§†é¢‘èµ°COS CDNï¼Œ**ä¸å ç”¨åŽç«¯å¸¦å®½**
- âœ… åŽç«¯APIåªä¼ JSONæ•°æ®ï¼Œ**å¸¦å®½éœ€æ±‚å°**

**å®žé™…å¯æ”¯æŒ:**
```
APIè¯·æ±‚ (çº¯JSON):
æ¯ä¸ªè¯·æ±‚: ~2KB (åŽ‹ç¼©åŽ)
ç†è®ºQPS = 375KB/s Ã· 2KB â‰ˆ 187 req/s

âœ… å®žé™…æ”¯æŒ: 150-200 å¹¶å‘ç”¨æˆ·ï¼ˆæµè§ˆã€æŸ¥è¯¢ï¼‰
```

---

## ðŸ“Š 300GBæµé‡åŒ…å¤Ÿä¸å¤Ÿï¼Ÿ

### æœˆæµé‡è®¡ç®—

**å‡è®¾åœºæ™¯:**
- æ—¥æ´»ç”¨æˆ·: 100äºº
- æ¯äººæ¯å¤©è¯·æ±‚: 50æ¬¡
- æ¯ä¸ªè¯·æ±‚æµé‡: 2KB (APIå“åº”JSON)

**æœˆæµé‡æ¶ˆè€—:**
```
APIæµé‡ = 100äºº Ã— 50è¯·æ±‚/å¤© Ã— 30å¤© Ã— 2KB
        = 300MB/æœˆ

âœ… 300GBæµé‡åŒ… å®Œå…¨å¤Ÿç”¨ï¼ï¼ˆåªç”¨äº†0.1%ï¼‰
```

**æ³¨æ„:** å›¾ç‰‡/è§†é¢‘èµ°COSï¼Œä¸å ç”¨è½»é‡æœåŠ¡å™¨æµé‡åŒ…

---

## ðŸŽ¯ æœ€ç»ˆå¹¶å‘èƒ½åŠ›è¯„ä¼°

| åœºæ™¯ | å•è¿›ç¨‹ | PM2 (3è¿›ç¨‹) | ç“¶é¢ˆ |
|------|--------|-------------|------|
| **ç”¨æˆ·æµè§ˆã€æŸ¥è¯¢** | 100-150äºº | **250-350äºº** | CPU |
| **åˆ›å»ºAIä»»åŠ¡** | 50-80äºº | **150-200äºº** | å¸¦å®½ |
| **AIä»»åŠ¡ç”Ÿæˆ** | 500+å¼‚æ­¥ä»»åŠ¡ | **1000+å¼‚æ­¥ä»»åŠ¡** | å¤–éƒ¨API |

---

## âœ… è€çŽ‹çš„ç»“è®º

### ä½ çš„4æ ¸4GæœåŠ¡å™¨å¯ä»¥æ”¯æŒ:

1. **å¯ç”¨PM2 Cluster (3è¿›ç¨‹):**
   - âœ… **250-350 å¹¶å‘ç”¨æˆ·** (æµè§ˆã€æŸ¥è¯¢)
   - âœ… **150-200 å¹¶å‘ç”¨æˆ·** (åˆ›å»ºä»»åŠ¡)
   - âœ… **1000+ å¼‚æ­¥AIä»»åŠ¡** (ç­‰å¾…å¤–éƒ¨APIå›žè°ƒ)

2. **ä¸»è¦é™åˆ¶:**
   - âš ï¸ **å†…å­˜ (4GB)** - éœ€è¦ä¼˜åŒ–MySQLé…ç½®ï¼ŒPM2ç”¨3è¿›ç¨‹
   - âš ï¸ **å¸¦å®½ (3Mbps)** - åªèƒ½æ”¯æŒ150-200 QPSï¼ˆAPIå“åº”ï¼‰
   - âœ… **CPU (4æ ¸)** - å¤Ÿç”¨
   - âœ… **ç¡¬ç›˜ (40GB SSD)** - å¤Ÿç”¨

3. **çœŸæ­£çš„ç“¶é¢ˆ:**
   - ðŸ”´ **å¤–éƒ¨AI APIå“åº”é€Ÿåº¦** (10-120ç§’) - è¿™ä¸ªä½ æ”¹ä¸äº†
   - ðŸŸ¡ **å¸¦å®½ (3Mbps)** - å¯ä»¥å‡çº§åˆ°5Mbps
   - ðŸŸ¢ **å†…å­˜ (4GB)** - å¯ä»¥å‡çº§åˆ°8GB

---

## ðŸš€ ç«‹å³ä¼˜åŒ–å»ºè®®

### 1ï¸âƒ£ ä¼˜å…ˆçº§ï¼šé«˜ï¼ˆç«‹å³æ‰§è¡Œï¼‰

```bash
# 1. ä¼˜åŒ–MySQLå†…å­˜å ç”¨
vim /etc/mysql/my.cnf
# è®¾ç½® innodb_buffer_pool_size = 512M

# 2. é‡å¯MySQL
systemctl restart mysql

# 3. åˆ›å»ºPM2é…ç½®ï¼ˆ3è¿›ç¨‹ï¼‰
cd backend
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'ai-photo-api',
    script: './src/server.js',
    instances: 3,
    exec_mode: 'cluster',
    max_memory_restart: '600M',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
EOF

# 4. å¢žåŠ æ•°æ®åº“è¿žæŽ¥æ± 
# ç¼–è¾‘ .env
DATABASE_POOL_MIN=10
DATABASE_POOL_MAX=30

# 5. å¯åŠ¨PM2 Cluster
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

**ä¼˜åŒ–åŽå¹¶å‘èƒ½åŠ›: 100äºº â†’ 300äºº âœ…**

---

### 2ï¸âƒ£ ä¼˜å…ˆçº§ï¼šä¸­ï¼ˆ1ä¸ªæœˆå†…ï¼‰

å¦‚æžœç”¨æˆ·å¢žé•¿åˆ°300+ï¼Œè€ƒè™‘å‡çº§ï¼š

```
- å¸¦å®½: 3Mbps â†’ 5Mbps (æå‡67%)
- å†…å­˜: 4GB â†’ 8GB (æ”¯æŒ500+å¹¶å‘)
```

**æˆæœ¬: ~50-100å…ƒ/æœˆ**

---

### 3ï¸âƒ£ ä¼˜å…ˆçº§ï¼šä½Žï¼ˆ3ä¸ªæœˆåŽï¼‰

å¦‚æžœç”¨æˆ·å¢žé•¿åˆ°500+ï¼Œè€ƒè™‘ï¼š

```
- å¤šå°æœåŠ¡å™¨ + è´Ÿè½½å‡è¡¡
- æ•°æ®åº“è¯»å†™åˆ†ç¦»
- Redisé›†ç¾¤
```

**æˆæœ¬: ~500-1000å…ƒ/æœˆ**

---

## ðŸ“ˆ æ€»ç»“

**ä½ çš„4æ ¸4GæœåŠ¡å™¨:**
- âœ… **çŽ°åœ¨ç«‹å³å¯ä»¥æ”¯æŒ**: 100-150 å¹¶å‘ç”¨æˆ·
- âœ… **ä¼˜åŒ–åŽå¯ä»¥æ”¯æŒ**: 250-350 å¹¶å‘ç”¨æˆ·
- âœ… **å‡çº§å¸¦å®½åŽå¯ä»¥æ”¯æŒ**: 400-500 å¹¶å‘ç”¨æˆ·

**è€çŽ‹å»ºè®®:**
1. ç«‹å³ä¼˜åŒ–MySQLå’Œå¯ç”¨PM2 Clusterï¼ˆ0æˆæœ¬ï¼‰
2. ä¸Šçº¿åŽç›‘æŽ§å®žé™…å¹¶å‘ï¼ˆå¯èƒ½ç”¨ä¸äº†è¿™ä¹ˆå¤šï¼‰
3. ç”¨æˆ·å¢žé•¿åŽå†å‡çº§å¸¦å®½ï¼ˆæŒ‰éœ€ä»˜è´¹ï¼‰

**åˆ«æ‹…å¿ƒï¼ä½ è¿™ä¸ªé…ç½®å¤Ÿç”¨äº†ï¼èµ¶ç´§ä¸Šçº¿ï¼** ðŸš€
