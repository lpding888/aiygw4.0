# ğŸ—ï¸ AIè¡£æŸœé¡¹ç›® - æ¶æ„æ”¹é€ å®Œæ•´è§„åˆ’

> **ä½œæˆ˜ç›®æ ‡**ï¼š3ä¸ªæœˆå†…å°†æ¶æ„è´¨é‡ä»60åˆ†æå‡åˆ°85åˆ†ï¼Œå±å±±é£é™©ä»6.5/10é™åˆ°2/10
>
> **æ ¸å¿ƒç­–ç•¥**ï¼šåˆ†5ä¸ªé˜¶æ®µæ¸è¿›å¼æ”¹é€ ï¼Œç¡®ä¿ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½å¯ç‹¬ç«‹éªŒæ”¶

---

## ğŸ“‹ æ”¹é€ æ€»è§ˆ

| é˜¶æ®µ | åç§° | å·¥æœŸ | ä¼˜å…ˆçº§ | æ ¸å¿ƒäº§å‡º |
|------|------|------|--------|----------|
| **Phase 0** | å‡†å¤‡é˜¶æ®µ | 3å¤© | P0 | æ”¹é€ åŸºç¡€è®¾æ–½ |
| **Phase 1** | TS+ESMè¿ç§»å®Œæˆ | 5å¤© | P0 | æ¸…é™¤æ‰€æœ‰CommonJS |
| **Phase 2** | InterfaceæŠ½è±¡å±‚ | 5å¤© | P0 | å®šä¹‰30+æ¥å£å¥‘çº¦ |
| **Phase 3** | ä¾èµ–æ³¨å…¥æ”¹é€  | 7å¤© | P0 | å¼•å…¥DIå®¹å™¨ï¼Œè§£è€¦service |
| **Phase 4** | é…ç½®ä¸æµ‹è¯• | 5å¤© | P1 | ç»Ÿä¸€é…ç½®+70%æµ‹è¯•è¦†ç›– |
| **Phase 5** | é«˜çº§ç‰¹æ€§ | 3å¤© | P2 | äº‹ä»¶æ€»çº¿+æ–‡æ¡£ç”Ÿæˆ |

**æ€»å·¥æœŸï¼š28å¤©ï¼ˆçº¦4å‘¨ï¼‰**
**å…³é”®è·¯å¾„ï¼šPhase 1 â†’ Phase 2 â†’ Phase 3**

---

## ğŸ¯ Phase 0: å‡†å¤‡é˜¶æ®µï¼ˆ3å¤©ï¼‰

### ç›®æ ‡
å»ºç«‹æ”¹é€ åŸºç¡€è®¾æ–½ï¼Œç¡®ä¿æ”¹é€ è¿‡ç¨‹å¯è¿½æº¯ã€å¯å›æ»š

### ä»»åŠ¡æ¸…å•

#### Day 1ï¼šç¯å¢ƒå‡†å¤‡
- [ ] **åˆ›å»ºæ”¹é€ åˆ†æ”¯**
  ```bash
  git checkout -b refactor/architecture-v2
  git push -u origin refactor/architecture-v2
  ```
- [ ] **å¤‡ä»½ç°æœ‰ä»£ç **
  ```bash
  git tag backup-before-refactor-$(date +%Y%m%d)
  git push origin --tags
  ```
- [ ] **å®‰è£…ä¾èµ–æ³¨å…¥å·¥å…·**
  ```bash
  npm install --save awilix
  npm install --save-dev @types/awilix
  ```
- [ ] **å®‰è£…é…ç½®æ ¡éªŒå·¥å…·**
  ```bash
  npm install --save zod    # è¿è¡Œæ—¶ç±»å‹æ ¡éªŒ
  npm install --save dotenv-safe
  ```
- [ ] **é…ç½®æµ‹è¯•æ¡†æ¶å¼ºåŒ–**
  ```bash
  npm install --save-dev @faker-js/faker  # ç”Ÿæˆæµ‹è¯•æ•°æ®
  npm install --save-dev supertest        # APIæµ‹è¯•
  ```

#### Day 2ï¼šåˆ›å»ºç›®å½•ç»“æ„
```bash
backend/src/
â”œâ”€â”€ interfaces/           # æ–°å¢ï¼šæ‰€æœ‰Serviceæ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ IAuthService.ts
â”‚   â”œâ”€â”€ IQuotaService.ts
â”‚   â”œâ”€â”€ IPaymentService.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ container/            # æ–°å¢ï¼šDIå®¹å™¨é…ç½®
â”‚   â”œâ”€â”€ container.ts
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ services.module.ts
â”‚   â”‚   â”œâ”€â”€ repositories.module.ts
â”‚   â”‚   â””â”€â”€ providers.module.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ config/               # å¢å¼ºï¼šé…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ schema.ts         # æ–°å¢ï¼šé…ç½®schema
â”‚   â”œâ”€â”€ config.service.ts # æ–°å¢ï¼šé…ç½®æœåŠ¡
â”‚   â””â”€â”€ index.ts
â””â”€â”€ events/               # æ–°å¢ï¼šäº‹ä»¶æ€»çº¿ï¼ˆPhase 5ç”¨ï¼‰
    â”œâ”€â”€ event-bus.ts
    â””â”€â”€ events.ts
```

#### Day 3ï¼šå»ºç«‹ç›‘æ§ä¸å›æ»šæœºåˆ¶
- [ ] **åˆ›å»ºæ¶æ„å¥åº·åº¦æ£€æŸ¥è„šæœ¬**
  ```typescript
  // scripts/check-architecture.ts
  // æ£€æŸ¥ï¼šå¾ªç¯ä¾èµ–ã€æ¥å£è¦†ç›–ç‡ã€DIæ³¨å†Œå®Œæ•´æ€§
  ```
- [ ] **é…ç½®Git pre-commit hook**
  ```bash
  npm install --save-dev husky lint-staged
  npx husky install
  npx husky add .husky/pre-commit "npm run check-architecture"
  ```
- [ ] **ç¼–å†™å›æ»šæ–‡æ¡£**
  ```markdown
  docs/ROLLBACK.md - æ¯ä¸ªPhaseçš„å›æ»šæ­¥éª¤
  ```

### éªŒæ”¶æ ‡å‡†
- âœ… æ‰€æœ‰å·¥å…·å®‰è£…æˆåŠŸï¼Œnpm run buildæ— æŠ¥é”™
- âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆï¼Œå­˜åœ¨interfaces/å’Œcontainer/ç›®å½•
- âœ… å¥åº·åº¦æ£€æŸ¥è„šæœ¬å¯æ‰§è¡Œï¼Œè¾“å‡ºåŸºçº¿æ•°æ®

---

## ğŸ”¥ Phase 1: TS+ESMè¿ç§»å®Œæˆï¼ˆ5å¤©ï¼‰

### ç›®æ ‡
æ¸…é™¤æ‰€æœ‰CommonJSä»£ç ï¼Œ100%çº¯TypeScript + ESM

### å½“å‰çŠ¶æ€
- 58ä¸ªæ ¸å¿ƒJSæ–‡ä»¶å¾…è¿ç§»
- 40 services + 10 controllers + 7 utils + 1 config
- éƒ¨åˆ†TSæ–‡ä»¶æ··ç”¨require/import

### ä»»åŠ¡æ¸…å•

#### Day 1-2ï¼šè¿ç§»Servicesï¼ˆ40ä¸ªæ–‡ä»¶ï¼‰
**æ‰¹æ¬¡1ï¼šé«˜ä¼˜å…ˆçº§æœåŠ¡ï¼ˆ10ä¸ªï¼‰**
- [ ] `payment.service.js` â†’ `.ts` ï¼ˆæ¸…é™¤requireï¼‰
- [ ] `websocket.service.js` â†’ `.ts` ï¼ˆæ¸…é™¤requireï¼‰
- [ ] `pipelineEngine.service.js` â†’ `.ts`
- [ ] `kuai.service.js` â†’ `.ts`
- [ ] `media.service.js` â†’ `.ts`
- [ ] `membership.service.js` â†’ `.ts`
- [ ] `cronJobs.service.js` â†’ `.ts`
- [ ] `distribution.service.js` â†’ `.ts`
- [ ] `commission.service.js` â†’ `.ts`
- [ ] `invitation-code.service.js` â†’ `.ts`

**æ‰¹æ¬¡2ï¼šä¸­ä¼˜å…ˆçº§æœåŠ¡ï¼ˆ15ä¸ªï¼‰**
- [ ] æ‰€æœ‰å‰©ä½™çš„*Service.jsæ–‡ä»¶è¿ç§»

**æ‰¹æ¬¡3ï¼šä½ä¼˜å…ˆçº§æœåŠ¡ï¼ˆ15ä¸ªï¼‰**
- [ ] é—ç•™çš„ä¸šåŠ¡serviceè¿ç§»

#### Day 3ï¼šè¿ç§»Controllersï¼ˆ10ä¸ªï¼‰
- [ ] `payment.controller.js` â†’ `.ts`
- [ ] `task.controller.js` â†’ `.ts`
- [ ] `media.controller.js` â†’ `.ts`
- [ ] `membership.controller.js` â†’ `.ts`
- [ ] `distribution.controller.js` â†’ `.ts`
- [ ] å…¶ä½™5ä¸ªcontroller

#### Day 4ï¼šè¿ç§»Utilså’ŒConfigï¼ˆ8ä¸ªï¼‰
- [ ] `logger.js` â†’ `.ts`
- [ ] `redis.js` â†’ `.ts`
- [ ] `response.js` â†’ `.ts`
- [ ] `generator.js` â†’ `.ts`
- [ ] å…¶ä½™3ä¸ªutils + 1ä¸ªconfig

#### Day 5ï¼šæ¸…ç†ä¸éªŒè¯
- [ ] **åˆ é™¤æ‰€æœ‰.jsæ–‡ä»¶**ï¼ˆåªä¿ç•™db/migrations/*.jsï¼‰
- [ ] **æ¸…ç†.d.tsæ¡¥æ¥æ–‡ä»¶**ï¼ˆ17ä¸ªä¸´æ—¶ç±»å‹å£°æ˜ï¼‰
- [ ] **å…¨é‡æ„å»ºæµ‹è¯•**
  ```bash
  rm -rf dist/
  npm run build
  # é¢„æœŸï¼š0 errors, 0 warnings
  ```
- [ ] **è¿è¡Œæ‰€æœ‰æµ‹è¯•**
  ```bash
  npm run test:unit
  npm run test:integration
  # é¢„æœŸï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡
  ```

### è¿ç§»æ¨¡æ¿ï¼ˆAIå¯ç”¨ï¼‰
```typescript
// ä» payment.service.js è¿ç§»åˆ° payment.service.ts

// âŒ æ—§ä»£ç ï¼ˆCommonJSï¼‰
const crypto = require('crypto');
const axios = require('axios');
const logger = require('../utils/logger');

class PaymentService {
  constructor() {
    this.config = { ... };
  }
}

module.exports = new PaymentService();

// âœ… æ–°ä»£ç ï¼ˆESM + TypeScriptï¼‰
import crypto from 'crypto';
import axios from 'axios';
import logger from '../utils/logger.js';

interface PaymentConfig {
  alipay: { appId: string; privateKey: string; };
  wechat: { appId: string; mchId: string; };
}

export class PaymentService {
  private config: PaymentConfig;

  constructor() {
    this.config = {
      alipay: {
        appId: process.env.ALIPAY_APP_ID || '',
        privateKey: process.env.ALIPAY_PRIVATE_KEY || ''
      },
      wechat: {
        appId: process.env.WECHAT_APP_ID || '',
        mchId: process.env.WECHAT_MCH_ID || ''
      }
    };
  }

  // æ–¹æ³•è¿ç§»...
}

const paymentService = new PaymentService();
export default paymentService;
```

### éªŒæ”¶æ ‡å‡†
- âœ… `find backend/src -name "*.js" | grep -v migrations | wc -l` è¾“å‡º0
- âœ… `npm run build` 0 errors
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… Git diffæ˜¾ç¤ºåˆ é™¤äº†58ä¸ª.jsæ–‡ä»¶ï¼Œæ–°å¢58ä¸ª.tsæ–‡ä»¶

---

## ğŸ¨ Phase 2: InterfaceæŠ½è±¡å±‚ï¼ˆ5å¤©ï¼‰

### ç›®æ ‡
ä¸ºæ‰€æœ‰Serviceå®šä¹‰Interfaceï¼Œå»ºç«‹å¥‘çº¦å±‚

### ä»»åŠ¡æ¸…å•

#### Day 1ï¼šæ ¸å¿ƒä¸šåŠ¡æ¥å£ï¼ˆ10ä¸ªï¼‰
- [ ] **IAuthService** - è®¤è¯æœåŠ¡æ¥å£
  ```typescript
  // src/interfaces/IAuthService.ts
  export interface IAuthService {
    sendCode(phone: string, ip: string): Promise<SendCodeResult>;
    loginWithCode(phone: string, code: string, referrerId: string | null): Promise<LoginResult>;
    getUser(userId: string): Promise<User>;
    verifyTokenStatus(userId: string, jti?: string): Promise<boolean>;
  }

  export interface SendCodeResult {
    success: boolean;
    expireIn: number;
  }

  export interface LoginResult {
    user: User;
    accessToken: string;
    refreshToken: string;
  }
  ```

- [ ] **IQuotaService** - é…é¢ç®¡ç†æ¥å£
  ```typescript
  export interface IQuotaService {
    reserve(userId: string, taskId: string, amount?: number): Promise<void>;
    confirm(taskId: string): Promise<void>;
    cancel(taskId: string): Promise<void>;
    getQuota(userId: string): Promise<QuotaInfo>;
    checkQuota(userId: string, amount?: number): Promise<boolean>;
    getTransactionStatus(taskId: string): Promise<TransactionStatus | null>;
    cleanupExpiredTransactions(hours?: number): Promise<number>;
  }
  ```

- [ ] **IPaymentService** - æ”¯ä»˜æœåŠ¡æ¥å£
- [ ] **ITaskService** - ä»»åŠ¡ç®¡ç†æ¥å£
- [ ] **ITokenService** - TokenæœåŠ¡æ¥å£
- [ ] **IMediaService** - åª’ä½“æœåŠ¡æ¥å£
- [ ] **IMembershipService** - ä¼šå‘˜æœåŠ¡æ¥å£
- [ ] **IWebSocketService** - WebSocketæœåŠ¡æ¥å£
- [ ] **ICOSService** - å¯¹è±¡å­˜å‚¨æœåŠ¡æ¥å£
- [ ] **IAuditService** - å†…å®¹å®¡æ ¸æœåŠ¡æ¥å£

#### Day 2ï¼šProvideræ¥å£ï¼ˆ5ä¸ªï¼‰
- [ ] **IProvider** - ProvideråŸºç¡€æ¥å£ï¼ˆå·²å­˜åœ¨ï¼Œæ£€æŸ¥å®Œæ•´æ€§ï¼‰
- [ ] **IGenericHttpProvider**
- [ ] **IRunningHubProvider**
- [ ] **ITencentCiProvider**
- [ ] **ISCFProvider**

#### Day 3ï¼šå·¥å…·ç±»æ¥å£ï¼ˆ5ä¸ªï¼‰
- [ ] **ILogger** - æ—¥å¿—æ¥å£
  ```typescript
  export interface ILogger {
    info(message: string, meta?: any): void;
    warn(message: string, meta?: any): void;
    error(message: string, meta?: any): void;
    debug(message: string, meta?: any): void;
  }
  ```
- [ ] **ICacheService** - ç¼“å­˜æ¥å£
- [ ] **IQueueService** - é˜Ÿåˆ—æ¥å£
- [ ] **IKMSService** - å¯†é’¥ç®¡ç†æ¥å£
- [ ] **IConfigService** - é…ç½®ç®¡ç†æ¥å£

#### Day 4ï¼šRepositoryæ¥å£ï¼ˆ10ä¸ªï¼‰
- [ ] **IUserRepository**
- [ ] **IOrderRepository**
- [ ] **ITaskRepository**
- [ ] **IProviderEndpointRepository**
- [ ] **IAnnouncementRepository**
- [ ] **IBannerRepository**
- [ ] **IMembershipPlanRepository**
- [ ] **IMembershipBenefitRepository**
- [ ] **IContentTextRepository**
- [ ] **IAuditLogRepository**

#### Day 5ï¼šå®ç°ç±»æ”¹é€ +ç´¢å¼•æ–‡ä»¶
- [ ] **è®©æ‰€æœ‰Serviceç±»å®ç°å¯¹åº”Interface**
  ```typescript
  // quota.service.ts
  import { IQuotaService } from '../interfaces/IQuotaService.js';

  export class QuotaService implements IQuotaService {
    async reserve(...): Promise<void> { /* å®ç° */ }
    async confirm(...): Promise<void> { /* å®ç° */ }
    // ...
  }
  ```

- [ ] **åˆ›å»ºç»Ÿä¸€å¯¼å‡ºæ–‡ä»¶**
  ```typescript
  // src/interfaces/index.ts
  export * from './IAuthService.js';
  export * from './IQuotaService.js';
  export * from './IPaymentService.js';
  // ... æ‰€æœ‰æ¥å£
  ```

### æ¥å£è®¾è®¡åŸåˆ™
1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¥å£åªè´Ÿè´£ä¸€ç±»æ“ä½œ
2. **æ¥å£éš”ç¦»**ï¼šä¸å¼ºåˆ¶å®ç°ç”¨ä¸åˆ°çš„æ–¹æ³•ï¼ˆæ‹†åˆ†å¤§æ¥å£ï¼‰
3. **æœ€å°çŸ¥è¯†**ï¼šæ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ç±»å‹æ˜ç¡®
4. **å¼‚æ­¥ä¼˜å…ˆ**ï¼šæ‰€æœ‰I/Oæ“ä½œè¿”å›Promise
5. **é”™è¯¯é€æ˜**ï¼šåœ¨æ¥å£å®šä¹‰ä¸­ç”¨JSDocæ³¨æ˜å¯èƒ½æŠ›å‡ºçš„é”™è¯¯

### éªŒæ”¶æ ‡å‡†
- âœ… `src/interfaces/` ç›®å½•ä¸‹æœ‰30+ä¸ªæ¥å£æ–‡ä»¶
- âœ… æ‰€æœ‰Serviceç±»éƒ½å®ç°äº†å¯¹åº”Interface
- âœ… `npm run build` é€šè¿‡TypeScriptç±»å‹æ£€æŸ¥
- âœ… æ¯ä¸ªæ¥å£éƒ½æœ‰å®Œæ•´çš„JSDocæ–‡æ¡£

---

## ğŸ”Œ Phase 3: ä¾èµ–æ³¨å…¥æ”¹é€ ï¼ˆ7å¤©ï¼‰

### ç›®æ ‡
å¼•å…¥Awilix DIå®¹å™¨ï¼Œè§£è€¦æ‰€æœ‰Serviceä¾èµ–

### ä»»åŠ¡æ¸…å•

#### Day 1ï¼šDIå®¹å™¨åŸºç¡€è®¾æ–½
- [ ] **åˆ›å»ºå®¹å™¨ä¸»æ–‡ä»¶**
  ```typescript
  // src/container/container.ts
  import { createContainer, asClass, asValue, InjectionMode, AwilixContainer } from 'awilix';
  import { Lifetime } from 'awilix';

  export function createAppContainer(): AwilixContainer {
    const container = createContainer({
      injectionMode: InjectionMode.CLASSIC // æ„é€ å‡½æ•°æ³¨å…¥
    });

    // æ³¨å†Œmodules
    container.loadModules(
      [
        ['services/*.service.ts', { register: asClass, lifetime: Lifetime.SINGLETON }],
        ['repositories/*.repo.ts', { register: asClass, lifetime: Lifetime.SINGLETON }],
        ['providers/**/*.provider.ts', { register: asClass, lifetime: Lifetime.SINGLETON }]
      ],
      {
        cwd: __dirname + '/../',
        formatName: 'camelCase' // quotaService, paymentService
      }
    );

    return container;
  }

  // åˆ›å»ºå…¨å±€å®¹å™¨å®ä¾‹
  export const container = createAppContainer();
  ```

#### Day 2ï¼šæ”¹é€ æ ¸å¿ƒServicesï¼ˆ10ä¸ªï¼‰
**æ”¹é€ æ¨¡æ¿ï¼š**
```typescript
// âŒ æ—§ä»£ç ï¼šç›´æ¥importä¾èµ–
import quotaService from './quota.service.js';
import paymentService from './payment.service.js';

export class TaskService {
  async create(userId: string, type: string) {
    await quotaService.reserve(userId, taskId, 1); // ç¡¬ç¼–ç ä¾èµ–
    // ...
  }
}

// âœ… æ–°ä»£ç ï¼šæ„é€ å‡½æ•°æ³¨å…¥
import { IQuotaService, IPaymentService } from '../interfaces/index.js';

export class TaskService {
  constructor(
    private quotaService: IQuotaService,
    private paymentService: IPaymentService
  ) {}

  async create(userId: string, type: string) {
    await this.quotaService.reserve(userId, taskId, 1); // ä¾èµ–æ¥å£
    // ...
  }
}

// ä¸å†exportå•ä¾‹ï¼Œç”±å®¹å™¨ç®¡ç†
export default TaskService;
```

- [ ] TaskService
- [ ] AuthService
- [ ] PaymentService
- [ ] MembershipService
- [ ] MediaService
- [ ] WebSocketService
- [ ] PipelineEngineService
- [ ] DistributionService
- [ ] ContentAuditService
- [ ] KMSService

#### Day 3ï¼šæ”¹é€ Controllersï¼ˆ10ä¸ªï¼‰
```typescript
// âŒ æ—§ä»£ç 
import authService from '../services/auth.service.js';

export class AuthController {
  async login(req, res) {
    const result = await authService.loginWithCode(...);
  }
}

// âœ… æ–°ä»£ç 
import { IAuthService, ITokenService } from '../interfaces/index.js';

export class AuthController {
  constructor(
    private authService: IAuthService,
    private tokenService: ITokenService
  ) {}

  async login(req, res) {
    const result = await this.authService.loginWithCode(...);
  }
}
```

- [ ] AuthController
- [ ] TaskController
- [ ] PaymentController
- [ ] MembershipController
- [ ] å…¶ä½™6ä¸ªcontrollers

#### Day 4ï¼šæ”¹é€ Repositoriesï¼ˆ10ä¸ªï¼‰
```typescript
// src/repositories/users.repo.ts
import { ILogger } from '../interfaces/index.js';
import { db } from '../db/index.js';

export class UserRepository {
  constructor(
    private db: any, // Knexå®ä¾‹
    private logger: ILogger
  ) {}

  async findUserById(id: string) {
    this.logger.debug('Finding user by id', { id });
    return this.db('users').where({ id }).first();
  }
}

export default UserRepository;
```

#### Day 5ï¼šæ”¹é€ è·¯ç”±æ³¨å†Œ
```typescript
// src/app.ts
import { container } from './container/index.js';
import { AuthController } from './controllers/auth.controller.js';

// ä»å®¹å™¨è·å–controllerå®ä¾‹
const authController = container.resolve<AuthController>('authController');

// æ³¨å†Œè·¯ç”±
app.post('/api/auth/login', (req, res, next) =>
  authController.login(req, res, next)
);
```

æˆ–è€…ä½¿ç”¨è·¯ç”±å·¥å‚ï¼š
```typescript
// src/routes/auth.routes.ts
import { Router } from 'express';
import { makeInvoker } from 'awilix-express';

const router = Router();
const api = makeInvoker(container);

router.post('/login', api('authController.login'));
router.post('/register', api('authController.register'));

export default router;
```

#### Day 6ï¼šé…ç½®å®¹å™¨æ¨¡å—åŒ–
```typescript
// src/container/modules/services.module.ts
import { asClass, Lifetime } from 'awilix';
import { QuotaService } from '../../services/quota.service.js';
import { PaymentService } from '../../services/payment.service.js';
// ... æ‰€æœ‰service imports

export function registerServices(container: AwilixContainer) {
  container.register({
    quotaService: asClass(QuotaService).singleton(),
    paymentService: asClass(PaymentService).singleton(),
    authService: asClass(AuthService).singleton(),
    taskService: asClass(TaskService).singleton(),
    // ... æ‰€æœ‰services
  });
}
```

```typescript
// src/container/container.ts
import { registerServices } from './modules/services.module.js';
import { registerRepositories } from './modules/repositories.module.js';
import { registerProviders } from './modules/providers.module.js';

export function createAppContainer(): AwilixContainer {
  const container = createContainer({ injectionMode: InjectionMode.CLASSIC });

  // æ³¨å†ŒåŸºç¡€è®¾æ–½
  container.register({
    db: asValue(db),
    logger: asValue(logger),
    redis: asValue(redis),
  });

  // æ³¨å†Œå„å±‚
  registerServices(container);
  registerRepositories(container);
  registerProviders(container);

  return container;
}
```

#### Day 7ï¼šæ¸…ç†ä¸éªŒè¯
- [ ] **åˆ é™¤æ‰€æœ‰æ—§çš„å•ä¾‹å¯¼å‡º**
  ```typescript
  // âŒ åˆ é™¤è¿™äº›
  const quotaService = new QuotaService();
  export default quotaService;
  ```
- [ ] **æ›´æ–°æ‰€æœ‰importè¯­å¥**ï¼ˆä»å®¹å™¨è·å–ï¼‰
- [ ] **è¿è¡Œæµ‹è¯•å¥—ä»¶**
  ```bash
  npm run test:unit
  npm run test:integration
  ```
- [ ] **æ£€æŸ¥å¾ªç¯ä¾èµ–**
  ```bash
  npx madge --circular --extensions ts src/
  # é¢„æœŸï¼šNo circular dependencies found
  ```

### DIæœ€ä½³å®è·µ
1. **æ„é€ å‡½æ•°æ³¨å…¥**ï¼šæ‰€æœ‰ä¾èµ–é€šè¿‡constructorä¼ å…¥
2. **æ¥å£ä¾èµ–**ï¼šä¾èµ–æ¥å£è€Œéå…·ä½“å®ç°
3. **å•ä¾‹ç”Ÿå‘½å‘¨æœŸ**ï¼šService/Repository/Providerç”¨SINGLETON
4. **é¿å…å®¹å™¨æ±¡æŸ“**ï¼šä¸è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­ç›´æ¥è°ƒç”¨container.resolve()
5. **æµ‹è¯•å‹å¥½**ï¼šå•æµ‹æ—¶å¯ä»¥è½»æ¾mockä¾èµ–

### éªŒæ”¶æ ‡å‡†
- âœ… æ‰€æœ‰Service/Controller/Repositoryæ”¹ä¸ºDIæ¨¡å¼
- âœ… æ— å¾ªç¯ä¾èµ–
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… `npm run dev` åº”ç”¨æ­£å¸¸å¯åŠ¨

---

## ğŸ§ª Phase 4: é…ç½®ä¸æµ‹è¯•ï¼ˆ5å¤©ï¼‰

### ç›®æ ‡
ç»Ÿä¸€é…ç½®ç®¡ç† + å•å…ƒæµ‹è¯•è¦†ç›–ç‡70%+

### ä»»åŠ¡æ¸…å•

#### Day 1ï¼šç»Ÿä¸€é…ç½®ç®¡ç†
- [ ] **å®šä¹‰é…ç½®Schema**
  ```typescript
  // src/config/schema.ts
  import { z } from 'zod';

  export const configSchema = z.object({
    // æ•°æ®åº“é…ç½®
    database: z.object({
      host: z.string().min(1),
      port: z.number().int().positive(),
      user: z.string().min(1),
      password: z.string().min(1),
      database: z.string().min(1),
    }),

    // JWTé…ç½®
    jwt: z.object({
      secret: z.string().min(32, 'JWT secretå¿…é¡»è‡³å°‘32å­—ç¬¦'),
      accessTokenExpiry: z.string().default('15m'),
      refreshTokenExpiry: z.string().default('7d'),
    }),

    // è…¾è®¯äº‘é…ç½®
    tencent: z.object({
      secretId: z.string().min(1),
      secretKey: z.string().min(1),
      cos: z.object({
        bucket: z.string().min(1),
        region: z.string().default('ap-guangzhou'),
      }),
    }),

    // æ”¯ä»˜å®é…ç½®
    alipay: z.object({
      appId: z.string().min(1),
      privateKey: z.string().min(1),
      publicKey: z.string().min(1),
      gateway: z.string().url(),
    }),

    // å¾®ä¿¡é…ç½®
    wechat: z.object({
      appId: z.string().min(1),
      mchId: z.string().min(1),
      apiKey: z.string().min(1),
    }),

    // Redisé…ç½®
    redis: z.object({
      host: z.string().default('localhost'),
      port: z.number().int().positive().default(6379),
      password: z.string().optional(),
    }),

    // åº”ç”¨é…ç½®
    app: z.object({
      port: z.number().int().positive().default(3000),
      env: z.enum(['development', 'production', 'test']),
    }),
  });

  export type AppConfig = z.infer<typeof configSchema>;
  ```

- [ ] **åˆ›å»ºé…ç½®æœåŠ¡**
  ```typescript
  // src/config/config.service.ts
  import { configSchema, AppConfig } from './schema.js';
  import dotenv from 'dotenv';

  export class ConfigService {
    private config: AppConfig;

    constructor() {
      dotenv.config();
      this.config = this.loadAndValidate();
    }

    private loadAndValidate(): AppConfig {
      const raw = {
        database: {
          host: process.env.DB_HOST,
          port: parseInt(process.env.DB_PORT || '3306'),
          user: process.env.DB_USER,
          password: process.env.DB_PASSWORD,
          database: process.env.DB_NAME,
        },
        jwt: {
          secret: process.env.JWT_SECRET,
          accessTokenExpiry: process.env.JWT_ACCESS_EXPIRY || '15m',
          refreshTokenExpiry: process.env.JWT_REFRESH_EXPIRY || '7d',
        },
        // ... å…¶ä»–é…ç½®
      };

      try {
        return configSchema.parse(raw);
      } catch (error) {
        if (error instanceof z.ZodError) {
          console.error('âŒ é…ç½®éªŒè¯å¤±è´¥:');
          error.errors.forEach(err => {
            console.error(`  - ${err.path.join('.')}: ${err.message}`);
          });
        }
        throw new Error('é…ç½®åŠ è½½å¤±è´¥');
      }
    }

    get database() { return this.config.database; }
    get jwt() { return this.config.jwt; }
    get tencent() { return this.config.tencent; }
    get alipay() { return this.config.alipay; }
    get wechat() { return this.config.wechat; }
    get redis() { return this.config.redis; }
    get app() { return this.config.app; }
  }

  export default ConfigService;
  ```

- [ ] **é›†æˆåˆ°DIå®¹å™¨**
  ```typescript
  // src/container/container.ts
  import { ConfigService } from '../config/config.service.js';

  container.register({
    configService: asClass(ConfigService).singleton(),
  });
  ```

- [ ] **æ”¹é€ æ‰€æœ‰Serviceä½¿ç”¨ConfigService**
  ```typescript
  // payment.service.ts
  import { IConfigService } from '../interfaces/IConfigService.js';

  export class PaymentService {
    constructor(private configService: IConfigService) {}

    private getAlipayConfig() {
      return this.configService.alipay; // ç±»å‹å®‰å…¨ï¼
    }
  }
  ```

#### Day 2-3ï¼šè¡¥å……å•å…ƒæµ‹è¯•ï¼ˆServicesï¼‰
- [ ] **åˆ›å»ºæµ‹è¯•å·¥å…·åº“**
  ```typescript
  // tests/helpers/container.mock.ts
  import { createContainer, asClass, asValue } from 'awilix';

  export function createMockContainer() {
    const container = createContainer({ injectionMode: 'CLASSIC' });

    // æ³¨å†Œmockä¾èµ–
    container.register({
      db: asValue(createMockDb()),
      logger: asValue(createMockLogger()),
      configService: asValue(createMockConfig()),
    });

    return container;
  }
  ```

- [ ] **QuotaServiceæµ‹è¯•ï¼ˆ100%è¦†ç›–ï¼‰**
  ```typescript
  // tests/unit/services/quota.service.test.ts
  import { QuotaService } from '../../../src/services/quota.service';
  import { createMockContainer } from '../../helpers/container.mock';

  describe('QuotaService', () => {
    let quotaService: QuotaService;
    let mockDb: any;

    beforeEach(() => {
      const container = createMockContainer();
      mockDb = container.resolve('db');
      quotaService = new QuotaService(mockDb, container.resolve('logger'));
    });

    describe('reserve', () => {
      it('should reserve quota successfully', async () => {
        mockDb.transaction.mockImplementation(async (callback) => {
          return callback(mockDb);
        });
        mockDb.mockReturnValueOnce({
          where: jest.fn().returnThis(),
          forUpdate: jest.fn().returnThis(),
          first: jest.fn().resolvedValue({
            id: 'user1',
            isMember: true,
            quota_remaining: 100
          })
        });

        await expect(quotaService.reserve('user1', 'task1', 1))
          .resolves.not.toThrow();
      });

      it('should throw error when quota insufficient', async () => {
        mockDb.transaction.mockImplementation(async (callback) => {
          return callback(mockDb);
        });
        mockDb.mockReturnValueOnce({
          where: jest.fn().returnThis(),
          forUpdate: jest.fn().returnThis(),
          first: jest.fn().resolvedValue({
            id: 'user1',
            isMember: true,
            quota_remaining: 0
          })
        });

        await expect(quotaService.reserve('user1', 'task1', 1))
          .rejects.toMatchObject({ errorCode: 'QUOTA_INSUFFICIENT' });
      });
    });

    // ... å…¶ä»–æµ‹è¯•ç”¨ä¾‹
  });
  ```

- [ ] è¡¥å……ä»¥ä¸‹Serviceçš„æµ‹è¯•ï¼š
  - AuthService
  - PaymentService
  - TaskService
  - TokenService
  - MembershipService
  - WebSocketService
  - ContentAuditService
  - KMSService

#### Day 4ï¼šè¡¥å……é›†æˆæµ‹è¯•ï¼ˆAPIsï¼‰
- [ ] **APIæµ‹è¯•æ¡†æ¶**
  ```typescript
  // tests/integration/helpers/app.helper.ts
  import supertest from 'supertest';
  import { createApp } from '../../../src/app';

  export async function createTestApp() {
    const app = await createApp();
    return supertest(app);
  }

  export async function createAuthenticatedRequest() {
    const request = await createTestApp();
    const loginRes = await request
      .post('/api/auth/login')
      .send({ phone: '13800138000', password: 'test123' });

    const token = loginRes.body.data.access_token;
    return { request, token };
  }
  ```

- [ ] **Auth APIæµ‹è¯•**
  ```typescript
  // tests/integration/api/auth.api.test.ts
  import { createTestApp } from '../helpers/app.helper';

  describe('Auth API', () => {
    let request: any;

    beforeAll(async () => {
      request = await createTestApp();
    });

    describe('POST /api/auth/register', () => {
      it('should register new user successfully', async () => {
        const res = await request
          .post('/api/auth/register')
          .send({
            phone: '13900139000',
            password: 'test1234'
          });

        expect(res.status).toBe(201);
        expect(res.body.success).toBe(true);
        expect(res.body.data.user).toHaveProperty('id');
        expect(res.body.data).toHaveProperty('access_token');
      });

      it('should reject invalid phone number', async () => {
        const res = await request
          .post('/api/auth/register')
          .send({
            phone: 'invalid',
            password: 'test1234'
          });

        expect(res.status).toBe(400);
        expect(res.body.error.code).toBe('VALIDATION_ERROR');
      });
    });

    describe('POST /api/auth/login', () => {
      // æµ‹è¯•ç”¨ä¾‹...
    });
  });
  ```

- [ ] è¡¥å……ä»¥ä¸‹APIçš„é›†æˆæµ‹è¯•ï¼š
  - Task API
  - Payment API
  - Membership API
  - Media API

#### Day 5ï¼šæµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥ä¸ä¼˜åŒ–
- [ ] **é…ç½®è¦†ç›–ç‡æŠ¥å‘Š**
  ```json
  // jest.config.ts
  export default {
    collectCoverage: true,
    coverageDirectory: 'coverage',
    coverageReporters: ['text', 'lcov', 'html'],
    coverageThreshold: {
      global: {
        branches: 70,
        functions: 70,
        lines: 70,
        statements: 70
      }
    },
    collectCoverageFrom: [
      'src/**/*.ts',
      '!src/**/*.d.ts',
      '!src/db/migrations/**',
      '!src/db/seeds/**'
    ]
  };
  ```

- [ ] **è¿è¡Œè¦†ç›–ç‡æ£€æŸ¥**
  ```bash
  npm run test:coverage
  # ç›®æ ‡ï¼š>70% coverage
  ```

- [ ] **è¡¥å……ç¼ºå¤±çš„æµ‹è¯•ç”¨ä¾‹**
- [ ] **ç”Ÿæˆè¦†ç›–ç‡å¾½ç« **ï¼ˆREADMEå±•ç¤ºç”¨ï¼‰

### éªŒæ”¶æ ‡å‡†
- âœ… ConfigServiceå¯åŠ¨æ—¶æ ¡éªŒæ‰€æœ‰å¿…éœ€ç¯å¢ƒå˜é‡
- âœ… æ‰€æœ‰Serviceæ”¹ç”¨ConfigServiceè·å–é…ç½®
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 70%
- âœ… é›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒAPI
- âœ… `npm test` å…¨éƒ¨é€šè¿‡

---

## ğŸš€ Phase 5: é«˜çº§ç‰¹æ€§ï¼ˆ3å¤©ï¼Œå¯é€‰ï¼‰

### ç›®æ ‡
å¼•å…¥äº‹ä»¶æ€»çº¿ + è‡ªåŠ¨åŒ–APIæ–‡æ¡£

### ä»»åŠ¡æ¸…å•

#### Day 1ï¼šäº‹ä»¶æ€»çº¿
- [ ] **åˆ›å»ºäº‹ä»¶æ€»çº¿**
  ```typescript
  // src/events/event-bus.ts
  import { EventEmitter } from 'events';

  export enum AppEvent {
    PAYMENT_SUCCESS = 'payment.success',
    TASK_CREATED = 'task.created',
    TASK_COMPLETED = 'task.completed',
    TASK_FAILED = 'task.failed',
    QUOTA_RESERVED = 'quota.reserved',
    QUOTA_CONFIRMED = 'quota.confirmed',
    QUOTA_CANCELLED = 'quota.cancelled',
    USER_REGISTERED = 'user.registered',
  }

  export interface PaymentSuccessEvent {
    orderId: string;
    userId: string;
    amount: number;
    planId: string;
  }

  export class EventBus {
    private emitter = new EventEmitter();

    emit<T = any>(event: AppEvent, payload: T): void {
      this.emitter.emit(event, payload);
    }

    on<T = any>(event: AppEvent, handler: (payload: T) => void | Promise<void>): void {
      this.emitter.on(event, handler);
    }

    once<T = any>(event: AppEvent, handler: (payload: T) => void | Promise<void>): void {
      this.emitter.once(event, handler);
    }

    off(event: AppEvent, handler: Function): void {
      this.emitter.off(event, handler);
    }
  }

  export const eventBus = new EventBus();
  ```

- [ ] **æ”¹é€ ä¸šåŠ¡é€»è¾‘ä½¿ç”¨äº‹ä»¶**
  ```typescript
  // payment.service.ts
  import { eventBus, AppEvent } from '../events/event-bus.js';

  async handlePaymentSuccess(order: PaymentOrder) {
    // å‘å¸ƒäº‹ä»¶è€Œéç›´æ¥è°ƒç”¨
    eventBus.emit(AppEvent.PAYMENT_SUCCESS, {
      orderId: order.id,
      userId: order.userId,
      amount: order.amount,
      planId: order.planId
    });
  }
  ```

- [ ] **æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨**
  ```typescript
  // src/events/listeners/quota.listener.ts
  import { eventBus, AppEvent, PaymentSuccessEvent } from '../event-bus.js';
  import { IQuotaService } from '../../interfaces/index.js';

  export function registerQuotaListeners(quotaService: IQuotaService) {
    // æ”¯ä»˜æˆåŠŸ -> å¢åŠ é…é¢
    eventBus.on<PaymentSuccessEvent>(AppEvent.PAYMENT_SUCCESS, async (payload) => {
      const { userId, planId } = payload;
      const quotaToAdd = getQuotaByPlanId(planId); // æ ¹æ®å¥—é¤IDè·å–é…é¢
      await quotaService.addQuota(userId, quotaToAdd);
    });

    // ä»»åŠ¡å¤±è´¥ -> é€€è¿˜é…é¢
    eventBus.on(AppEvent.TASK_FAILED, async (payload) => {
      await quotaService.cancel(payload.taskId);
    });
  }
  ```

#### Day 2ï¼šAPIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- [ ] **å®‰è£…Swaggerå·¥å…·**
  ```bash
  npm install --save swagger-jsdoc swagger-ui-express
  npm install --save-dev @types/swagger-jsdoc @types/swagger-ui-express
  ```

- [ ] **é…ç½®Swagger**
  ```typescript
  // src/config/swagger.config.ts
  import swaggerJsdoc from 'swagger-jsdoc';

  const options: swaggerJsdoc.Options = {
    definition: {
      openapi: '3.0.0',
      info: {
        title: 'AIè¡£æŸœ API',
        version: '1.0.0',
        description: 'æœè£…AIå¤„ç† SaaS å¹³å° APIæ–‡æ¡£',
      },
      servers: [
        { url: 'http://localhost:3000', description: 'å¼€å‘ç¯å¢ƒ' },
        { url: 'https://api.aizhao.icu', description: 'ç”Ÿäº§ç¯å¢ƒ' }
      ],
      components: {
        securitySchemes: {
          bearerAuth: {
            type: 'http',
            scheme: 'bearer',
            bearerFormat: 'JWT'
          }
        }
      }
    },
    apis: ['./src/routes/*.ts', './src/controllers/*.ts']
  };

  export const swaggerSpec = swaggerJsdoc(options);
  ```

- [ ] **ä¸ºControlleræ·»åŠ Swaggeræ³¨è§£**
  ```typescript
  // auth.controller.ts
  export class AuthController {
    /**
     * @swagger
     * /api/auth/register:
     *   post:
     *     summary: ç”¨æˆ·æ³¨å†Œ
     *     tags: [è®¤è¯]
     *     requestBody:
     *       required: true
     *       content:
     *         application/json:
     *           schema:
     *             type: object
     *             required:
     *               - phone
     *               - password
     *             properties:
     *               phone:
     *                 type: string
     *                 example: '13800138000'
     *               password:
     *                 type: string
     *                 example: 'password123'
     *               referrer_id:
     *                 type: string
     *                 nullable: true
     *     responses:
     *       201:
     *         description: æ³¨å†ŒæˆåŠŸ
     *         content:
     *           application/json:
     *             schema:
     *               type: object
     *               properties:
     *                 success:
     *                   type: boolean
     *                 data:
     *                   type: object
     *                   properties:
     *                     user:
     *                       $ref: '#/components/schemas/User'
     *                     access_token:
     *                       type: string
     *                     refresh_token:
     *                       type: string
     */
    async register(req: Request, res: Response) { ... }
  }
  ```

- [ ] **æŒ‚è½½Swagger UI**
  ```typescript
  // src/app.ts
  import swaggerUi from 'swagger-ui-express';
  import { swaggerSpec } from './config/swagger.config.js';

  app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec));
  ```

#### Day 3ï¼šç›‘æ§ä¸æ—¥å¿—å¢å¼º
- [ ] **ç»“æ„åŒ–æ—¥å¿—**
  ```typescript
  // src/utils/logger.ts
  import winston from 'winston';

  const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.combine(
      winston.format.timestamp(),
      winston.format.errors({ stack: true }),
      winston.format.json()
    ),
    transports: [
      new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
      new winston.transports.File({ filename: 'logs/combined.log' })
    ]
  });

  if (process.env.NODE_ENV !== 'production') {
    logger.add(new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }));
  }

  export default logger;
  ```

- [ ] **æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶**
  ```typescript
  // src/middlewares/metrics.middleware.ts
  export function metricsMiddleware(req: Request, res: Response, next: NextFunction) {
    const start = Date.now();

    res.on('finish', () => {
      const duration = Date.now() - start;
      logger.info('HTTP Request', {
        method: req.method,
        path: req.path,
        status: res.statusCode,
        duration,
        ip: req.ip
      });
    });

    next();
  }
  ```

### éªŒæ”¶æ ‡å‡†
- âœ… äº‹ä»¶æ€»çº¿å¯æ­£å¸¸å‘å¸ƒ/è®¢é˜…äº‹ä»¶
- âœ… Swaggeræ–‡æ¡£å¯è®¿é—®ï¼ˆ/api-docsï¼‰
- âœ… æ—¥å¿—è¾“å‡ºç»“æ„åŒ–JSONæ ¼å¼
- âœ… æ€§èƒ½æŒ‡æ ‡è¢«æ­£ç¡®è®°å½•

---

## ğŸ“Š æ€»ä½“éªŒæ”¶æ¸…å•

### ä»£ç è´¨é‡æŒ‡æ ‡
- [ ] **TypeScriptè¦†ç›–ç‡**: 100%ï¼ˆ0ä¸ª.jsæ–‡ä»¶ï¼‰
- [ ] **æµ‹è¯•è¦†ç›–ç‡**: â‰¥70%ï¼ˆLines, Branches, Functionsï¼‰
- [ ] **å¾ªç¯ä¾èµ–**: 0ä¸ª
- [ ] **ESLinté”™è¯¯**: 0ä¸ª
- [ ] **TSCç¼–è¯‘é”™è¯¯**: 0ä¸ª

### æ¶æ„è´¨é‡æŒ‡æ ‡
- [ ] **Serviceæ¥å£å®šä¹‰**: 30+ä¸ª
- [ ] **DIæ³¨å†Œç‡**: 100%ï¼ˆæ‰€æœ‰Service/Controller/Repositoryï¼‰
- [ ] **é…ç½®é›†ä¸­åŒ–**: 100%ï¼ˆæ— æ•£è½çš„process.envï¼‰
- [ ] **äº‹ä»¶è§£è€¦åº¦**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘é‡‡ç”¨äº‹ä»¶é©±åŠ¨

### æ–‡æ¡£å®Œæ•´æ€§
- [ ] **APIæ–‡æ¡£**: Swaggerè¦†ç›–æ‰€æœ‰æ¥å£
- [ ] **æ¥å£æ–‡æ¡£**: æ‰€æœ‰Interfaceæœ‰JSDoc
- [ ] **READMEæ›´æ–°**: åæ˜ æ–°æ¶æ„
- [ ] **æ¶æ„å›¾**: ç»˜åˆ¶DIä¾èµ–å…³ç³»å›¾

---

## âš¡ å¿«é€Ÿæ‰§è¡Œè„šæœ¬ï¼ˆAIå¯ç”¨ï¼‰

### Phase 1: TSè¿ç§»è‡ªåŠ¨åŒ–
```bash
# scripts/migrate-to-ts.sh
#!/bin/bash

# æ‰¹é‡é‡å‘½å.jsä¸º.ts
find backend/src/services -name "*.js" -not -path "*/node_modules/*" | while read file; do
  mv "$file" "${file%.js}.ts"
done

# æ›¿æ¢requireä¸ºimportï¼ˆä½¿ç”¨codemodï¼‰
npx jscodeshift -t transforms/require-to-import.js backend/src/

# æ·»åŠ ç±»å‹æ³¨è§£ï¼ˆä½¿ç”¨ts-migrateï¼‰
npx ts-migrate migrate backend/src/

# ä¿®å¤å¯¼å…¥è·¯å¾„ï¼ˆæ·»åŠ .jsæ‰©å±•åï¼‰
npx tsc-esm-fix --src=backend/src --ext=.ts
```

### Phase 2: Interfaceç”Ÿæˆå·¥å…·
```typescript
// scripts/generate-interface.ts
// ä»Serviceç±»è‡ªåŠ¨ç”ŸæˆInterfaceå®šä¹‰
import ts from 'typescript';

function generateInterface(serviceFilePath: string) {
  const sourceFile = ts.createSourceFile(
    serviceFilePath,
    fs.readFileSync(serviceFilePath, 'utf-8'),
    ts.ScriptTarget.Latest,
    true
  );

  // æå–ç±»çš„publicæ–¹æ³•
  const methods: string[] = [];
  ts.forEachChild(sourceFile, (node) => {
    if (ts.isClassDeclaration(node) && node.name) {
      node.members.forEach(member => {
        if (ts.isMethodDeclaration(member) && !hasModifier(member, ts.SyntaxKind.PrivateKeyword)) {
          methods.push(member.getText());
        }
      });
    }
  });

  // ç”ŸæˆInterfaceä»£ç 
  const interfaceName = `I${className}`;
  const interfaceCode = `
export interface ${interfaceName} {
${methods.join('\n')}
}
  `;

  fs.writeFileSync(`src/interfaces/${interfaceName}.ts`, interfaceCode);
}
```

### Phase 3: DIæ”¹é€ è‡ªåŠ¨åŒ–
```typescript
// scripts/convert-to-di.ts
// è‡ªåŠ¨å°†Serviceæ”¹é€ ä¸ºDIæ¨¡å¼

function convertToDI(serviceFilePath: string) {
  let content = fs.readFileSync(serviceFilePath, 'utf-8');

  // 1. æå–importçš„serviceä¾èµ–
  const imports = extractImports(content);

  // 2. ç”Ÿæˆconstructor
  const constructor = `
constructor(
${imports.map(imp => `  private ${imp.name}: I${imp.className}`).join(',\n')}
) {}
  `;

  // 3. æ›¿æ¢ç›´æ¥è°ƒç”¨ä¸ºthis.xxxè°ƒç”¨
  imports.forEach(imp => {
    content = content.replace(
      new RegExp(`${imp.name}\\.`, 'g'),
      `this.${imp.name}.`
    );
  });

  // 4. åˆ é™¤å•ä¾‹å¯¼å‡º
  content = content.replace(/const \w+ = new \w+\(\);[\s\S]*?export default \w+;/, '');

  fs.writeFileSync(serviceFilePath, content);
}
```

---

## ğŸš¨ é£é™©ç®¡ç†

### é£é™©1ï¼šæ”¹é€ æœŸé—´ä¸šåŠ¡ä¸­æ–­
**åº”å¯¹æ–¹æ¡ˆï¼š**
- åœ¨ç‹¬ç«‹åˆ†æ”¯è¿›è¡Œæ”¹é€ 
- æ¯ä¸ªPhaseç»“æŸååˆå¹¶åˆ°devåˆ†æ”¯æµ‹è¯•
- ç”Ÿäº§ç¯å¢ƒé‡‡ç”¨è“ç»¿éƒ¨ç½²

### é£é™©2ï¼šæµ‹è¯•ä¸å……åˆ†å¯¼è‡´Bug
**åº”å¯¹æ–¹æ¡ˆï¼š**
- æ”¹é€ å‰å½•åˆ¶APIè¯·æ±‚ï¼ˆPostman Collectionï¼‰
- æ”¹é€ åå›æ”¾æ‰€æœ‰è¯·æ±‚ï¼Œå¯¹æ¯”å“åº”å·®å¼‚
- å…³é”®ä¸šåŠ¡æµç¨‹æ‰‹å·¥æµ‹è¯•

### é£é™©3ï¼šæ€§èƒ½ä¸‹é™
**åº”å¯¹æ–¹æ¡ˆï¼š**
- æ”¹é€ å‰benchmarkï¼ˆwrk/abå‹æµ‹ï¼‰
- æ”¹é€ åå¯¹æ¯”æ€§èƒ½æŒ‡æ ‡
- DIå®¹å™¨ä½¿ç”¨SINGLETONé¿å…é‡å¤å®ä¾‹åŒ–

### é£é™©4ï¼šå›¢é˜Ÿå­¦ä¹ æˆæœ¬
**åº”å¯¹æ–¹æ¡ˆï¼š**
- ç¼–å†™DIä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹
- ç»„ç»‡ä»£ç è¯„å®¡ä¼šè®²è§£æ–°æ¶æ„
- å…³é”®æ”¹åŠ¨æ·»åŠ è¯¦ç»†æ³¨é‡Š

---

## ğŸ“… é‡Œç¨‹ç¢‘æ—¶é—´è¡¨

```
Week 1 (Day 1-7):
â”œâ”€ Day 1-3: Phase 0 å‡†å¤‡é˜¶æ®µ âœ…
â”œâ”€ Day 4-7: Phase 1 TSè¿ç§» (å‰4å¤©)

Week 2 (Day 8-14):
â”œâ”€ Day 8: Phase 1 TSè¿ç§»å®Œæˆ âœ…
â”œâ”€ Day 9-13: Phase 2 InterfaceæŠ½è±¡å±‚ âœ…
â”œâ”€ Day 14: Phase 2éªŒæ”¶

Week 3 (Day 15-21):
â”œâ”€ Day 15-21: Phase 3 DIæ”¹é€  âœ…
â”œâ”€ Day 21: Phase 3éªŒæ”¶

Week 4 (Day 22-28):
â”œâ”€ Day 22-26: Phase 4 é…ç½®ä¸æµ‹è¯• âœ…
â”œâ”€ Day 26-28: Phase 5 é«˜çº§ç‰¹æ€§ âœ…
â””â”€ Day 28: æœ€ç»ˆéªŒæ”¶ä¸ä¸Šçº¿å‡†å¤‡

ä¸Šçº¿ (Day 29+):
â””â”€ é‡‘ä¸é›€å‘å¸ƒ â†’ ç°åº¦50% â†’ å…¨é‡ä¸Šçº¿
```

---

## ğŸ–ï¸ æˆåŠŸæ ‡å‡†

æ”¹é€ å®Œæˆåï¼Œæ¶æ„è´¨é‡å¯¹æ¯”ï¼š

| æŒ‡æ ‡ | æ”¹é€ å‰ | æ”¹é€ å | æå‡ |
|------|--------|--------|------|
| SOLIDå¾—åˆ† | 4.6/10 | 8.5/10 | +85% |
| æµ‹è¯•è¦†ç›–ç‡ | ~30% | 70%+ | +133% |
| å±å±±é£é™© | 6.5/10 | 2/10 | -69% |
| æŠ€æœ¯å€º | é«˜ | ä½ | -80% |
| æ–°äººä¸Šæ‰‹ | 3å‘¨ | 1å‘¨ | -67% |
| é‡æ„æˆæœ¬ | é«˜ï¼ˆ10xï¼‰ | ä½ï¼ˆ1xï¼‰ | -90% |

**æœ€ç»ˆç›®æ ‡ï¼š**
âœ… æˆä¸ºå›¢é˜ŸæŠ€æœ¯æ ‡æ†é¡¹ç›®
âœ… æ¶æ„å¯æ‰©å±•ã€æ˜“ç»´æŠ¤
âœ… 1å¹´åä»èƒ½æ„‰å¿«è¿­ä»£

---

## ğŸ’¬ è€ç‹çš„æœ€åå®å˜±

è‰¹ï¼Œè¿™ä»½è®¡åˆ’è€ç‹æˆ‘å†™äº†2å°æ—¶ï¼Œè¡€æ·‹æ·‹çš„å®æˆ˜ç»éªŒï¼

**3ä¸ªå…³é”®ç‚¹ï¼š**
1. **åˆ«æƒ³ä¸€å£åƒæˆèƒ–å­**ï¼šåˆ†5ä¸ªPhaseï¼Œæ¯ä¸ªPhaseç‹¬ç«‹éªŒæ”¶
2. **æµ‹è¯•æ˜¯ç”Ÿå‘½çº¿**ï¼šæ²¡æµ‹è¯•çš„é‡æ„éƒ½æ˜¯è€æµæ°“
3. **AIæ˜¯ä½ çš„æˆ˜å‹**ï¼š90%çš„ä»£ç è¿ç§»AIèƒ½å¸®ä½ å¹²

**æ‰§è¡Œå»ºè®®ï¼š**
- æ‰¾2ä¸ªäººå…¨èŒå¹²è¿™äº‹ï¼ˆ1ä¸ªåç«¯+1ä¸ªæµ‹è¯•ï¼‰
- æ¯å¤©æ™šä¸Š6ç‚¹éªŒæ”¶å½“å¤©è¿›åº¦
- é‡åˆ°å¡ç‚¹ç«‹å³ç¾¤é‡Œå¼ï¼Œåˆ«è‡ªå·±æ­»ç£•

**æœ€åï¼š**
è¿™ä¸ªè®¡åˆ’èƒ½è®©ä½ é¡¹ç›®ä»"å¯èƒ½æˆå±å±±"å˜æˆ"åšå¦‚ç£çŸ³"ï¼Œå€¼å¾—æŠ•å…¥ï¼

å¼€å¹²å§ï¼Œè€ç‹æ”¯æŒä½ ï¼ğŸº
