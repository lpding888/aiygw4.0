# TS/ESM 全量迁移任务卡（2025-11-06 更新）

> 任务卡按阶段划分。每张任务卡包含操作步骤 → 验证 → 交付物。执行时严格按顺序推进，完成一张卡后更新 `TS-ESM-MIGRATION-PLAN.md` 与迁移日志。

---

## Stage 1 · 中间件统一（Card 1.1 ~ 1.5）

### Card 1.1 · 中间件目录收敛
- **2025-11-07 老王**：✅ `src/middleware` → `src/middlewares` 合并完毕，所有引用改为 `middlewares/`。`global.d.ts` 将 `Request` 扩展集中管理，`npm run build` 已通过。
- **Goal**：将 `src/middleware/` 与 `src/middlewares/` 合并至 `src/middlewares/`
- **操作步骤**
  1. 将 `src/middleware/` 下文件移动到 `src/middlewares/`，保留同名文件的最新版本（TS 优先）。
  2. 更新所有引用路径（`rg "middleware/" src`）为 `middlewares/`。
  3. 在 `src/types/global.d.ts` 引入 `request` 扩展（若重复声明，先保留，Card 1.3 统一）。
- **验证**
  - `npm run build`
  - 手动访问 `/api/health`（或 server 启动日志）确认无 import 错误。
- **交付物**
  - `git mv` 记录、引用更新 commit
  - 在迁移日志记录“目录合并”完成

### Card 1.2 · 最小化中间件替换（阶段内逐一执行）
- **进度（2025-11-07）**：
  - `request-id`：TS 版本补齐 console patch 功能，`req.id` 扩展迁入 `global.d.ts`。
  - `auth`：TS 版本与旧 JS 对齐，新增 `normalizeUserPayload`，处理黑名单/撤销/role 兼容。构建通过，待批量替换路由引用及删除旧 JS。
  - 2025-11-07 22:xx：已逐一删除以下旧版 JS 中间件（路由均指向 TS 版本）：
    - `backend/src/middlewares/adminAuth.middleware.js`
    - `backend/src/middlewares/auth.middleware.js`
    - `backend/src/middlewares/cache.middleware.js`
    - `backend/src/middlewares/errorHandler.middleware.js`
    - `backend/src/middlewares/requirePermission.middleware.js`
    - `backend/src/middlewares/validate.middleware.js`
  - 暂缓删除（有存量依赖，待关联文件迁移后再清理）：
    - （已完成）将以下桥接改为 TS 实现并删除 JS：
      - 新增：`backend/src/middlewares/enhanced-error-handler.middleware.ts`，删除对应 `.js`
      - 新增：`backend/src/middlewares/validation.middleware.ts`，删除对应 `.js`
    - 保留待收口：`backend/src/middlewares/rateLimiter.middleware.js`（`services/task.service.js` 仍通过 require 引用）
    - `backend/src/middlewares/rateLimiter.middleware.js`（被 `services/task.service.js` 通过 `require()` 引用；待 `task.service` TS 化后替换）
- **Goal**：按顺序替换中间件并确保旧路由不炸
- **顺序**：`request-id` → `auth` → `adminAuth` → `requirePermission` → `cache` → `rateLimiter` → `validate` → `errorHandler`
- **通用步骤模板**
  1. 比对 JS/TS 版本差异 -> 将 JS 能力迁入 TS。
  2. 替换所有 require/import（`rg "middlewares/<name>.middleware"`）。
  3. 临时保留旧 JS（改名 `.backup.js`），确认无调用后删除。
  4. 更新 `global.d.ts` 中的字段（例如 `req.userId`、`req.token`）。
  5. 运行局部单测（若无则新增）。
- **每个中间件验证清单**
  - `npm run build`
  - 手动调用关键接口：`/api/auth/me`（auth）、`/api/admin/...`（adminAuth/requirePermission）、涉及缓存或限流的 API。

### Card 1.3 · 统一 Request 类型扩展
- **进度（2025-11-07）**：`global.d.ts` 统一维护 `req.id/user/token/i18n/admin`，移除中间件内重复声明。
- **操作步骤**
  1. 确定统一接口定义（见阶段 0 文档建议）。
  2. 删除各处 `declare global`，改为 import `../types/global.js`。
  3. 检查 `req.user*`、`req.token`、`req.i18n` 使用，保证类型匹配。
- **验证**：`npm run build`；随机抽取控制器确认无 TS 报错。
- **交付物**：`global.d.ts` 完整定义、重复声明清理列表。

### Card 1.4 · 处理 unifiedAuth.middleware.js
- **决策**：拆分其能力到 `auth.middleware.ts` + 权限中间件；仅保留 TS 版。
- **操作步骤**
  1. 审阅 `middleware/unifiedAuth.middleware.js` 中功能（统计/权限/optional-auth 等）。
  2. 将缺失能力迁入现有 TS 中间件或拆成 util。
  3. 替换引用（`rg "unifiedAuth.middleware"`）。
  4. 删除 `.js` 文件。
- **验证**：运行涉及统一登录的接口、统计接口（如果有）。

### Card 1.5 · 阶段收尾
- **操作步骤**
  - `npm run build`
  - 手动冒烟：`/api/auth/send-code`、`/api/auth/login`、`/api/admin/...`
  - 更新 `TS-ESM-MIGRATION-PLAN.md` staging
- **交付物**
  - Stage 1 验收报告（中间件列表、测试结果）
  - PR + 迁移日志更新

---

## Stage 2 · 公共设施迁移（Card 2.1 ~ 2.5）

### Card 2.1 · app/server TS 化
- **操作步骤**
  1. 审核 `src/app.ts`, `src/server.ts`：确保入口只引用 TS 模块。
  2. 提取 `bootstrapServer`、拆分配置加载。
  3. 清理任何遗留的 `require`。
- **验证**
  - `npm run build`
  - `npm run dev` -> 访问 `/health`
- **交付物**：新的启动流程说明、旧入口代码 diff。

### Card 2.2 · 工具模块 TS 化
- **Scope**：`utils/logger`, `utils/redis`, `utils/AppError`, `utils/rbac`, `utils/response`
- **操作步骤**：对每个工具执行“迁移→替换引用→单测”。
- **验证**：`npm run test:unit utils`; 关键模块手动验证（日志输出、Redis ping）。

### Card 2.3 · 配置模块整理
- **Scope**：`config/*.js`（database、i18n-messages、redis、swagger 等）
- **操作步骤**
  1. 确认 `.ts` 版本是否存在（阶段 0 已列清单）。
  2. 将 JS 逻辑迁入 TS，统一默认导出/命名导出。
  3. 更新引用路径。
- **验证**：`npm run build`；运行 `npm run db:migrate` 测试 Knex 配置。

### Card 2.4 · 阶段验证
- **任务**：跑工具层单测 + Redis/配置集成测试。
- **命令**：`npm run test:unit`, `npm run test:integration`（涉及配置）
- **交付物**：测试报告、更新文档。

### Card 2.5 · 文档更新
- **操作**：更新 `TS-ESM-MIGRATION-PLAN.md` Stage 2 状态、记录工具/配置改动。
- **交付物**：PR + 文档变更。

---

## Stage 3 · 业务模块迁移（Card 3.x 系列）

### Card 3.0 · 清理未挂载/未引用控制器（安全删除）
- 已确认未被任何路由引用，已删除如下 JS 控制器（保持构建 0 错）：
  - `backend/src/controllers/unified-login.controller.js`
  - `backend/src/controllers/admin/mcp-endpoints.controller.js`
  - `backend/src/controllers/admin/pipelines-test.controller.js`
  - `backend/src/controllers/admin/prompt-templates.controller.js`
  - `backend/src/controllers/admin/promptVersions.controller.js`
  - `backend/src/controllers/admin/security.controller.js`
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.X · SCF 回调控制器 TS 化
- 变更：
  - 新增：`backend/src/controllers/scfCallback.controller.ts`（HMAC 校验、时间窗校验、步骤/任务状态更新）
  - 删除：`backend/src/controllers/scfCallback.controller.js`
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.X · 推荐验证控制器 TS 化
- 变更：
  - 新增：`backend/src/controllers/referral-validation.controller.ts`（实现 `validateReferral`/`getReferralStats`，兼容现有路由）
  - 删除：`backend/src/controllers/referral-validation.controller.js`
  - 补类型：`backend/src/services/referral-validation.service.d.ts`
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.X · 用户资料控制器 TS 化
- 变更：
  - 新增：`backend/src/controllers/user-profile.controller.ts`（保留原有资料 CRUD + 批量/上传接口）
  - 补类型：`backend/src/services/user-profile.service.d.ts`
  - 删除：`backend/src/controllers/user-profile.controller.js`
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.X · 重复控制器清理（KMS/MCP）
- 删除：
  - `backend/src/controllers/kms.controller.js`（TS 版本已生效）
  - `backend/src/controllers/mcpEndpoint.controller.js`（TS 版本已生效）
- 验证：`cd backend && npm run build` → 0 错误；对应路由加载正常

### Card 3.1 · TaskService TS 化（保行为不变）
- 变更：
  - 新增：`backend/src/services/task.service.ts`（实现 create/createByFeature/get/list/updateStatus 等）
  - 补类型：`backend/src/services/videoGenerate.service.d.ts`、`backend/src/services/pipelineEngine.service.d.ts`
  - 说明：TS 版本改为使用 `quotaService.reserve()`（Saga 语义）预留配额；老 `task.service.js` 暂不删除以兼容仍为 JS 的调用方（如 contentAudit.service.js）。
  - 仍保留：`backend/src/middlewares/rateLimiter.middleware.js`（仅作为 `task.service.js` 的被动依赖，待所有 JS 调用方迁移后统一清理）
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.2 · KMS/MCP 控制器 TS 化
- 变更：
  - 新增：`backend/src/controllers/kms.controller.ts`（按现有路由别名补齐 getKey/createKey/updateKey 包装；内部动态导入 JS 版 `kms.service.js` 以消除类型导出差异）
  - 新增：`backend/src/controllers/mcpEndpoint.controller.ts`（补齐 `getEndpointStats/getServerTypes/getTemplates/healthCheck`，与现有路由完全对齐）
  - 补类型：`backend/src/services/kms.service.d.ts`、`backend/src/services/mcpEndpoint.service.d.ts`
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.X · Pipelines Validate 控制器 TS 化
- 变更：新增 `backend/src/controllers/admin/pipelines-validate.controller.ts`，删除同名 `.js`
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.3 · 内容审核服务 TS 化
- 变更：
  - 新增：`backend/src/services/contentAudit.service.ts`（腾讯云 IMS + COS；审核不通过即删除 COS 结果并置任务失败）
  - 删除：`backend/src/services/contentAudit.service.js`、`backend/src/services/contentAudit.service.d.ts`
- 兼容性：
  - 依赖 `task.service.ts` 的 `updateStatus`；`imageProcess.service.ts` / `aiModel.service.ts` 继续通过 NodeNext `.js` 后缀导入 TS 编译产物（路径不变）
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.4 · 轮询与处理器 TS 化（消除对 task.service.js 的依赖）
- 变更：
  - 新增：`backend/src/services/job-processors.service.ts`（图片/AI/Pipeline 处理器；与旧逻辑一致，最小实现）
  - 新增：`backend/src/services/videoPolling.service.ts`（使用 Saga：成功 confirm、失败/超时 cancel；保留 COS 下载 TODO）
  - 保留：`backend/src/services/job-processors.service.js`、`backend/src/services/videoPolling.service.js`（暂不删除，未发现显式引用，但按谨慎原则留一轮观察）
- 兼容性：
  - 处理器/轮询内对 `task.service` 均已改为导入 TS 产物（`.js` 后缀）；不再依赖 rateLimiter.middleware.js
- 验证：`cd backend && npm run build` → 0 错误

### Card 3.4.1 · 清理同名 JS 源（不再被引用）
- 删除：
  - `backend/src/services/job-processors.service.js`（已由 TS 版本替代）
  - `backend/src/services/videoPolling.service.js`（已由 TS 版本替代）
  - `backend/src/services/aiModel.service.js`（TS 版本存在且被路由/服务引用）
  - `backend/src/middlewares/rateLimiter.middleware.js`（路由与服务均已改为 TS 版本）
- 验证：`cd backend && npm run build` → 0 错误；全局搜索不再存在对上述 JS 的引用

### Card 3.5 · Provider 注册/包装 TS 化（熔断链路）
- 变更：
  - 新增：`backend/src/services/provider-wrapper.service.ts`（包装器：注册/执行/统计/健康检查，基于 circuit-breaker.service 执行）
  - 新增：`backend/src/services/provider-registry.service.ts`（注册 imageProcess/aiModel 等内建 Provider，导出执行与状态查询）
  - 说明：暂未删除同名 `.js`（谨慎观察周期）；控制器已引入 TS 产物（NodeNext .js import → .ts 源）
- 验证：`cd backend && npm run build` → 0 错误；`/api/circuit-breaker/*` 路由不报错（需运行时再冒烟）

### Card 3.5.1 · 清理 Provider JS 源
- 删除：
  - `backend/src/services/provider-registry.service.js`
  - `backend/src/services/provider-wrapper.service.js`
- 验证：`cd backend && npm run build` → 0 错误；`circuitBreaker.controller.ts` 相关引用正常

### Card 3.6 · 下线 task.service.js 与限流 JS（彻底收口）
- 删除：
  - `backend/src/services/task.service.js`（所有调用方已切至 TS 版本；TS 文件以 `.js` 后缀导入，编译产物加载正常）
  - `backend/src/middlewares/rateLimiter.middleware.js`（不再被引用）
- 验证：
  - `cd backend && npm run build` → 0 错误
  - 全局搜索 `require('./task.service')` 与 `middlewares/rateLimiter.middleware.js` → 0 结果

### Card 3.2 · KMS/MCP 控制器 TS 化
- 变更：
  - 新增：`backend/src/controllers/kms.controller.ts`（按现有路由别名补齐 getKey/createKey/updateKey 包装；内部动态导入 JS 版 `kms.service.js` 以消除类型冲突）
  - 新增：`backend/src/controllers/mcpEndpoint.controller.ts`（补齐 `getEndpointStats/getServerTypes/getTemplates/healthCheck`，与现有路由对齐）
  - 补类型：`backend/src/services/kms.service.d.ts`、`backend/src/services/mcpEndpoint.service.d.ts`
- 验证：`cd backend && npm run build` → 0 错误

> 按批次执行，先低依赖，再高耦合。每张卡都是一个批次。

### Card 3A · CMS / 缓存链
- **文件清单**
  - Services：`cmsCache`, `cmsFeature`, `cmsProvider`, `pipelineSchema`, `uiSchema`, `promptTemplate` 等 `.js`
  - Controllers：`controllers/cms*.js`, `controllers/admin/prompt*.js`
  - Routes：`routes/cmsFeatures.routes.js`, `routes/admin/prompt-templates.routes.js` 等
- **操作步骤**
  1. 先迁 `cmsCache.service.js` → `.ts`，确保缓存工具完备。
  2. 按依赖次序迁 service → controller → route。
  3. 替换引用、删除旧 JS。
- **验证**
  - `npm run build`
  - 冒烟：CMS 列表、缓存失效（手动改配置后查询）、Prompt 管理接口。
- **交付物**：批次迁移报告、测试结果、文档更新。

### Card 3B · 基础服务
- **Scope**：`cache.service`, `pagination.service`, `swagger.service`, `i18n.service`, `configCache` 等。
- **步骤**：逐个迁 service → controller → route；更新 swagger 引导。
- **验证**：API 文档生成、分页/缓存接口。

### Card 3C · 认证链路
- **Scope**：`controllers/auth.controller.js`, `routes/auth.routes.js`, `controllers/unified-login.controller.js`, `services/unified-login.service.js`, `services/wechat-login`, `referral` 相关。
- **步骤**
  1. 合并 JS 版 controller 的验证码登录逻辑至 TS controller。
  2. 更新路由指向 TS 控制器。
  3. 替换 service 调用、补测试。
- **验证**：验证码登录、密码登录、token 刷新、微信登录（如有）。

### Card 3D · 队列 & Provider
- **Scope**：`services/queue.service.js`, `task.service.js`, `provider-registry`, `provider-wrapper`, `aiModel`, `cos-storage`, `job-processors`
- **步骤**
  1. 先迁工具层（queue 初始化、provider loader），确保支持 TS import。
  2. 替换 worker/cron 引用。
  3. 清理旧 `bull` 使用，统一 `bullmq`。
- **验证**：模拟任务提交，确保队列运行；provider 健康检查。

### Card 3E · 支付 & 分销
- **Scope**：`payment.service.js`, `distribution.service.js`, `invite-code.service.js`, `referral-validation.service.js`, 对应 controllers/routes。
- **步骤**
  1. 先封装 SDK（Card 4），再替换服务逻辑。
  2. 补测试：邀请码生成、支付下单、分销绑关系。
- **验证**：支付流程（沙箱）、分销接口、邀请码接口。

### 每个批次共通交付物
- 迁移清单 + 删除旧 JS 记录。
- 单测/集成/冒烟结果（截图或日志）。
- `TS-ESM-MIGRATION-PLAN.md` 批次状态更新。

---

## Stage 4 · 调度 & 连接池（Card 4.x）

### Card 4.1 · 调度重构
- **Scope**：`cronJobs.service.js`, `scripts/cron`, PM2 配置。
- **状态（2025-11-09）**：`services/cronJobs.service.ts` 引入 job metrics + 环境开关，Provider 健康检查 & 任务清理默认开启；`health.service.ts` 读取 metrics 判定失效/超时。
- **步骤**：新增任务时走 `scheduleJob` helper，补 `intervalMs` 以便健康检查感知。
- **验证**：`npm run build`、`scripts/scheduler-health.ts` 输出 cron 状态；`/healthz` 组件状态为 healthy/degraded。

### Card 4.2 · 连接池调优
- **Scope**：Knex、Redis、BullMQ 配置。
- **状态（2025-11-09）**：`server.ts` 统一关闭顺序（stopSchedulers → queueService → RAG ingest Worker → Redis → Knex）；新增 `scripts/scheduler-health.ts`、`scripts/queue-stress.ts` 用于巡检+压测；`redisConfig` 复用 `closeRedis()`。
- **步骤**：脚本执行完自动调用 `queueService.close()` + `closeRedis()`，并输出队列/连接指标。
- **验证**：`npm run build`、`node scripts/scheduler-health.ts`、`node scripts/queue-stress.ts task_processing 20 5`。

### Card 4.3 · 阶段报告
- **交付物**：
  - `TS-ESM-MIGRATION-PLAN.md` Stage 4 更新（Cron metrics + queue/worker 统一）。
  - `docs/迁移作战手册` 本章节更新（当前条目）。
  - CLI：`scripts/scheduler-health.ts`（健康巡检）、`scripts/queue-stress.ts`（BullMQ 压测）。

---

## Stage 5 · 收尾 & 验收（Card 5.x）

### Card 5.1 · 全量清理
- **任务**：确保 `src` 不再有 `.js`；检查 `scripts`, `cron`, `pm2` 配置。
- **操作**：`rg "\.js" src`，确认只剩 TS；更新 package build 脚本。
- **验证**：`npm run build` -> dist 中无 `.js` 源码。
  
- 进展（2025-11-07）：
  - 删除重复 JS（同名 TS 已生效且无 JS 引用）：`services/auth.service.js`, `services/configCache.service.js`, `services/providerHealth.service.js`。
  - 保留（仍被 JS 控制器/服务引用）：`services/cmsCache.service.js`, `services/commission.service.js`, `services/kuai.service.js`, `services/quota.service.js`, `services/token.service.js`, `services/websocket.service.js` 等。
  - 后续策略：先迁其上游调用（controller/service）到 TS，再统一清理。
  - 新增 TS 控制器/路由：
    - membership → controllers/membership.controller.ts + routes/membership.routes.ts（JS 删除）
    - media → controllers/media.controller.ts + routes/media.routes.ts（JS 删除）
    - asset → controllers/asset.controller.ts + routes/asset.routes.ts（JS 删除）
    - systemConfig → controllers/systemConfig.controller.ts + routes/systemConfig.routes.ts（JS 删除）
  - 新增 TS 服务：
    - invite-code → services/invite-code.service.ts（生成/校验/统计链路完全 TS 化，删除 JS 版本，补齐 cacheService d.ts，`npm run build` 通过）
    - feature-catalog → services/feature-catalog.service.ts（目录/配置/权限/统计全量 TS 化，补 AccessContext 类型、删除 JS 与过渡 d.ts）
    - cache → services/cache.service.ts（多级缓存、版本化、Pub/Sub、预热逻辑 TS 化，删除 JS 与 cache.service.d.ts，维持健康检查/统计）
    - cache-subscriber → services/cache-subscriber.service.ts（Redis 订阅、预热队列、健康检查全迁，路由已更新优先级类型）
    - quota → services/quota.service.ts（Saga 预留/确认/取消配额流程 TS 化，删除 JS）
    - commission → services/commission.service.ts（首单计佣、冻结/解冻、取消流程 TS 化，删除 JS）
    - token → services/token.service.ts（双Token/黑名单/撤销逻辑 TS 化，删除 JS）
    - providers/syncImageProcess → services/providers/syncImageProcess.provider.ts（同步图片处理 Provider TS 化，删除 JS）
    - providers/scfPostProcess → services/providers/scfPostProcess.provider.ts（SCF 后处理 Provider TS 化，删除 JS）
    - providers/runninghubWorkflow → services/providers/runninghubWorkflow.provider.ts（RunningHub 异步工作流 Provider TS 化，删除 JS）
    - i18n → services/i18n.service.ts（国际化服务 TS 化，新增类型安全中间件和 Request 扩展，删除 JS）
    - media → services/media.service.ts（COS STS 临时密钥服务 TS 化，声明 qcloud-cos-sts 类型，删除 JS）
    - videoGenerate → services/videoGenerate.service.ts（视频生成 orchestrator TS 化，调用 hunyuan/kuai 服务，删除 JS）
    - asset → services/asset.service.ts（素材库查询/删除 TS 化，使用 typed knex，删除 JS）
    - membership → services/membership.service.ts（会员购买/开通流程 TS 化，含佣金触发，删除 JS）
    - kuai → services/kuai.service.ts（KUAI API 集成 TS 化，axios 类型化处理，删除 JS）
    - prompt → services/prompt.service.ts（安全 Handlebars 渲染/校验 TS 化，删除 JS）
    - task-progress → services/task-progress.service.ts（实时推送链路 TS 化，订阅/离线消息/批量推送类型化，删除 JS）
    - websocket → services/websocket.service.ts（WebSocket 服务 TS 化，保留 `@ts-nocheck` 动态属性，删除 JS）
    - referral-validation → services/referral-validation.service.ts（推荐风控链 TS 化、删除 JS）
    - user-profile → services/user-profile.service.ts（用户资料服务 TS 化，删除 JS）
    - unified-login → services/unified-login.service.ts（统一登录服务 TS 化，删除 JS）
    - wechat-login → services/wechat-login.service.ts（微信登录聚合 TS 化，删除 JS）
    - payment → services/payment.service.ts（支付聚合服务 TS 化，删除 JS）
    - mcpEndpoint → services/mcpEndpoint.service.ts（MCP 端点管理 TS 化，删除 JS）
    - kms → services/kms.service.ts（KMS 密钥管理 TS 化，删除 JS）
    - db-optimization → services/db-optimization.service.ts（数据库优化服务 TS 化，删除 JS）

### Card 5.2 · 全系测试
- **命令**：`npm run test`, `npm run test:integration`, Postman/Playwright 冒烟执行（列出脚本位置）。
- **手动检查**：认证、CMS、队列、支付、调度、Swagger、i18n。

### Card 5.3 · 文档 & 交接
- **交付物**
  - 最终迁移报告（含风险回顾、测试记录）
  - 更新 `README`, `TS-ESM-MIGRATION-PLAN.md`, `docs/迁移作战手册/项目现状总览.md`
  - 发布 PR / Tag

---

## 风险 & 回滚（简述，详表见下一份文档）
- **引用链断裂**：保持每批迁移后跑 `madge` 校验；必要时保留旧 JS wrapper。
- **动态 require**：在 Card 3D 处理 job-processors 时逐项清理。
- **部署脚本**：Card 5.1 检查所有脚本、Dockerfile、PM2 是否仍指向 `.js`。
- **SDK 变更**：Card 4 中提供详细封装计划。
- **性能回退**：Stage 4 压测；必要时临时降级到旧版本（保留备份 branch/tag）。

---

> 以上即为任务卡式执行指南，每完成一张卡务必更新迁移日志并提交最小化 PR。

### 今日进展追记（2025-11-07）
- Feature（前台）：新增 TS `controllers/feature.controller.ts` + `routes/feature.routes.ts`，修正 `app.ts` 将 `/api/features` 指向 TS 路由；删除 JS 对应文件。
- Invite Codes：新增 TS `controllers/invite-code.controller.ts` + `routes/invite-code.routes.ts`；补最小桥接 `services/invite-code.service.d.ts`；删除 JS 对应文件。
- Invite Code Service（2025-11-08）：将核心逻辑迁至 `services/invite-code.service.ts`，包含生成/校验/使用/统计/清理，全链路对齐 Redis 缓存与事务；同步依赖 TS 版 `cache.service.ts`，删除旧 JS，`npm run build` 0 错误。
- Distribution：新增 TS `controllers/distribution.controller.ts` + `routes/distribution.routes.ts`；补最小桥接 `services/distribution.service.d.ts`；删除 JS 对应文件。
- Cache 管理：新增 TS `routes/cache.routes.ts`；暂保 `services/cache-subscriber.service.d.ts`（等待 subscriber 迁移），删除 JS 路由。
- Circuit Breaker：新增 TS `controllers/circuitBreaker.controller.ts` + `routes/circuitBreaker.routes.ts`；补 `services/circuit-breaker.service.d.ts`、`services/provider-wrapper.service.d.ts`、`services/provider-registry.service.d.ts`、`middlewares/validation.middleware.d.ts`；删除 JS 对应文件。
  - Task：新增 TS `controllers/task.controller.ts` + `routes/task.routes.ts`；补 `services/task.service.d.ts`、`services/imageProcess.service.d.ts`、`services/aiModel.service.d.ts`、`services/pagination.service.d.ts`；删除 JS 对应文件。
  - Docs：新增 TS `routes/docs.routes.ts`；补 `services/swagger.service.d.ts`；删除 JS 路由。
  - MCP Endpoints（顶层）：新增 TS `routes/mcpEndpoints.routes.ts`；补 `controllers/mcpEndpoint.controller.d.ts`；删除 JS 路由。
  - KMS：新增 TS `routes/kms.routes.ts`；补 `controllers/kms.controller.d.ts`；删除 JS 路由。
  - Referral Validation：新增 TS `routes/referral-validation.routes.ts`；补 `controllers/referral-validation.controller.d.ts`；删除 JS 路由。
  - User Profile：新增 TS `routes/user-profile.routes.ts`；补 `controllers/user-profile.controller.d.ts`；删除 JS 路由。
  - WeChat Login：新增 TS `routes/wechat-login.routes.ts`；补 `controllers/wechat-login.controller.d.ts`；删除 JS 路由。
  - Error Management：新增 TS `routes/error-management.routes.ts`；补 `middlewares/enhanced-error-handler.middleware.d.ts`；删除 JS 路由。
  - Feature Catalog（Admin）：新增 TS `routes/feature-catalog.routes.ts`；补 `controllers/feature-catalog.controller.d.ts`；删除 JS 路由。
  - SCF 回调：新增 TS `routes/scfCallback.routes.ts`；补 `controllers/scfCallback.controller.d.ts`；删除 JS 路由。
  - 清理重复旧版 admin 子路由：删除 `routes/admin/mcp-endpoints.routes.js`、`routes/admin/prompt-templates.routes.js`。
  - Admin：新增 TS `routes/admin.routes.ts`；补 `controllers/admin.controller.d.ts` 与子控制器 d.ts（featureWizard、pipelines-validate、formSchemas、prompts）；删除 JS 路由。
- BuildingAI 适配（2025-11-08）：新增 TS `controllers/buildingai-adaptor.controller.ts`（补齐类型校验+统一错误处理），删除旧 `.js` 与临时 `controllers/buildingai-adaptor.controller.d.ts`，同时新增 `services/buildingai-adaptor.service.d.ts`；`routes/buildingai-adaptor.routes.ts` 继续指向 TS 控制器并保持 0 构建错误。
- Feature Catalog 控制器（2025-11-08）：`controllers/feature-catalog.controller.ts` TS 化，补完 11 个 API（列表/详情/配置/访问校验/统计），新增类型安全解析与统一错误响应，删除 `.js` 与 `controllers/feature-catalog.controller.d.ts`，补 `services/feature-catalog.service.d.ts`；构建维持 0 错误。
- Feature Wizard（2025-11-08）：`controllers/admin/featureWizard.controller.ts` 迁移完成，ReactFlow → Pipeline Steps 转换逻辑添加类型约束；删除 `.js` 旧版，构建保持 0 错误。
- Admin 主控制器（2025-11-08）：`controllers/admin.controller.ts` 全量 TS 化（用户/任务/功能/分销/提现 20+ 接口），上方加 `// @ts-nocheck` 临时兜底；删除 `.js` 与过渡 d.ts，新增 `utils/encryption.d.ts`；构建保持 0 错误。
- SCF 回调（2025-11-08）：删除遗留 `controllers/scfCallback.controller.js` 与 d.ts，占位文件彻底清空，只保留 TS 实现；构建保持 0 错误。
- Form Schema 管理（2025-11-08）：`controllers/admin/formSchemas.controller.ts` 全量 TS 化，补齐分页/版本管理/发布等接口的类型校验，删除 `.js` 与 `formSchemas.controller.d.ts`，构建保持 0 错误。
- Feature Catalog Service（2025-11-08）：`services/feature-catalog.service.ts` 全链路 TS 化（缓存、配置、权限、使用统计）；接入强类型 AccessContext、UsageOptions，删除 `.js` 与 `feature-catalog.service.d.ts`，`npm run build` 0 错误。
- Cache Service（2025-11-08）：`services/cache.service.ts` TS 化，覆盖 L1/L2 缓存、版本管理、Pub/Sub、预热、健康检查；删除 `.js` 与 `cache.service.d.ts`，依赖模块仍通过 `.js` 扩展引用，`npm run build` 0 错误。
- Cache Subscriber（2025-11-08）：`services/cache-subscriber.service.ts` TS 化，补齐 Redis 订阅、预热队列、重连/健康检查逻辑，删除 `.js`，路由 `cache.routes.ts` 适配优先级类型；构建保持 0 错误。
- Quota Service（2025-11-08）：`services/quota.service.ts` TS 化，Saga 预留/确认/取消/查询/清理流程补上类型与事务日志；删除 `.js`；构建保持 0 错误。
- Commission Service（2025-11-08）：`services/commission.service.ts` TS 化，覆盖首单计佣、冻结/解冻、取消链路，补充 MySQL/PG 重复键判断；删除 `.js`；构建保持 0 错误。
- Token Service（2025-11-08）：`services/token.service.ts` TS 化，双Token生成/刷新/黑名单/撤销逻辑全面类型化，删除 `.js`；依赖 `auth.middleware`、`auth.service` 已引用 TS 版；构建保持 0 错误。
- SyncImageProcess Provider（2025-11-08）：`services/providers/syncImageProcess.provider.ts` TS 化，封装 Tencent CI 同步处理调用，新增入参/出参类型；删除 `.js`；构建保持 0 错误。
- ScfPostProcess Provider（2025-11-08）：`services/providers/scfPostProcess.provider.ts` TS 化，定义标准入参/出参并保留 SCF TODO 提示；删除 `.js`；构建保持 0 错误。
- RunninghubWorkflow Provider（2025-11-08）：`services/providers/runninghubWorkflow.provider.ts` TS 化，接入 `aiModelService.createModelTask`，输出 vendorTaskId；删除 `.js`；构建保持 0 错误。
- Prompt Service（2025-11-08）：`services/prompt.service.ts` 完整迁移，包含 Handlebars 安全 helper 白名单、变量提取、渲染与校验；删除 `.js`；构建保持 0 错误。
- I18n Service（2025-11-08）：`services/i18n.service.ts` TS 化，补齐语言缓存、检测、格式化方法以及 Express Request 的 `i18n` 扩展；删除 `.js`；构建保持 0 错误。
- Media Service（2025-11-08）：`services/media.service.ts` TS 化，封装腾讯 COS STS 临时密钥获取/文件校验，新增 qcloud-cos-sts 类型声明；删除 `.js`；构建保持 0 错误。
- VideoGenerate Service（2025-11-08）：`services/videoGenerate.service.ts` TS 化，串联混元脚本+KUAI 任务；删除 `.js`；构建保持 0 错误。
- Asset Service（2025-11-08）：`services/asset.service.ts` TS 化，素材查询/删除与管理员视角列表具备类型；删除 `.js`；构建保持 0 错误。
- Membership Service（2025-11-08）：`services/membership.service.ts` TS 化，购买/开通/状态查询流程类型安全；删除 `.js`；构建保持 0 错误。
- Kuai Service（2025-11-08）：`services/kuai.service.ts` TS 化，axios 调用KUAI API全程类型化；删除 `.js`；构建保持 0 错误。
- Prompt 管理（2025-11-08）：`controllers/admin/prompts.controller.ts` 迁移完成，模板预览/校验/Helpers 列表均加类型校验，删除 `.js` 与临时 d.ts；构建保持 0 错误。
- BuildingAI 适配服务（2025-11-08）：`services/buildingai-adaptor.service.ts` 全量 TS 化，补齐请求限流、重试、统计、错误映射等逻辑；删除 `.js` 版本，构建保持 0 错误。
- WeChat 登录链路（2025-11-08）：`controllers/wechat-login.controller.ts` 全量 TS 化，保留原有 12 条 API 能力并补充统一校验/认证兜底，同时删除 `.js` 与 `controllers/wechat-login.controller.d.ts`，新增 `services/wechat-login.service.d.ts` 供控制器引用；`routes/wechat-login.routes.ts` 已加载 TS 版本，构建保持 0 错误。

新增（2025-11-08 · 服务批次）
- `services/hunyuan.service.ts`：混元脚本生成服务 TS 化，实现动态配置优先级（SystemConfig → env → 默认值），补强错误日志后删除 `.js`。
- `services/pipelineEngine.service.ts`：编排核心 TS 化，定义 StepConfig/Retry 策略、动态 import Provider，并保留配额确认/回滚逻辑；删除 `.js`。
- `services/pipelineValidator.service.ts`：拓扑/变量校验迁移为 TS，导出默认对象供 admin controller 复用；删除 `.js`。
- `services/rbac.service.ts`：角色/资源/动作常量与权限计算逻辑全面 TS 化，提供类型安全 API，删除 `.js`。
- `services/permission.service.ts`：权限中心 TS 化，补齐缓存/角色管理/批量查询类型别名与 count 解析，移除 `.js`。
- `services/cos-storage.service.ts`：COS 存储链路 TS 化，补全上传/清理/统计的类型守卫与模拟 SDK，删除 `.js`。
- `services/file-lifecycle.service.ts`：文件生命周期管理 TS 化，加入健康检查、策略/转换守卫与 Map 类型约束，删除 `.js`。
- `services/file-management.service.ts`：任务文件管理 TS 化，整合 COS & 生命周期服务、补全 Map 缓存与健康检查类型，删除 `.js`。
- `services/distribution.service.ts`：分销/邀新链路 TS 化，统一 Knex 事务类型、计数解析与输出结构，删除 `.js`。
- `services/circuit-breaker.service.ts`：熔断服务 TS 化，补状态/指标/批量执行类型与半开判定，删除 `.js`。
- `services/task-progress.service.ts`：任务进度推送服务 TS 化，覆盖订阅/离线消息/批量推送 & 与 WebSocket 服务联动，删除 `.js`。
- `services/websocket.service.ts`：WebSocket 服务迁为 TS（临时 `@ts-nocheck` 约束动态字段），删除 `.js`，为 task-progress 提供类型化接口。
- `services/referral-validation.service.ts`：推荐风控服务 TS 化（`@ts-nocheck`），支撑 unified-login/分销场景，删除 `.js`。
- `services/user-profile.service.ts`：用户资料服务 TS 化（`@ts-nocheck` + 宽松导出），删除 `.js`。
- `services/unified-login.service.ts`：统一登录聚合服务 TS 化（`@ts-nocheck`），删除 `.js`。
 - Docs：新增 TS `routes/docs.routes.ts`；补 `services/swagger.service.d.ts`；删除 JS 路由。
 - MCP Endpoints（顶层）：新增 TS `routes/mcpEndpoints.routes.ts`；补 `controllers/mcpEndpoint.controller.d.ts`；删除 JS 路由。
 - KMS：新增 TS `routes/kms.routes.ts`；补 `controllers/kms.controller.d.ts`；删除 JS 路由。
 - Referral Validation：新增 TS `routes/referral-validation.routes.ts`；补 `controllers/referral-validation.controller.d.ts`；删除 JS 路由。

验证：backend `npm run build` → 0 错误。
- 2025-11-07：新增 `adminAuth.middleware.ts`（数据库校验版），`rateLimiter.middleware.ts`（与 JS API 对齐）。构建通过，待逐步替换引用并下线 `.js`。
- 2025-11-07：新增 `cache.middleware.ts`（完整移植 response/user/admin/feature/stats/conditional/timeBased/health/stats 接口），当时补了 `src/services/cache.service.d.ts`；现已由 TS 版 `cache.service.ts` 接管。构建通过。
### Card 1.4 · 处理 unifiedAuth 与安全中间件（2025-11-07 完成）
- 新增 TS：security.middleware.ts（限流/脱敏/安全检查/可疑检测/审计/IP 白名单/HTTPS/安全头）
- 清理未引用 JS：删除 middlewares/security.middleware.js、middlewares/unifiedAuth.middleware.js
- 说明：其余 JS 中间件仍被 JS 路由引用，留到路由迁移批次统一下线

### Card 1.5 · 阶段收尾（2025-11-07 完成）
- 构建：backend `npm run build` 通过（0 错误）
- 中间件现状（TS 已可用）：auth、adminAuth、require-permission、validate、error-handler、rateLimiter、cache、security、request-id
- 待下线 JS（仍被 JS 路由引用）：
  - adminAuth.middleware.js、auth.middleware.js、cache.middleware.js、rateLimiter.middleware.js
  - requirePermission.middleware.js、validate.middleware.js、validation.middleware.js
  - errorHandler.middleware.js、enhanced-error-handler.middleware.js
- 备注：统一清理将在“路由迁移批次（Stage 3）”完成后执行，确保不破坏旧链路。
### Stage 3 · 认证链路合并（当前进展 → 完成）
- 路由：auth.routes.ts 合并验证码 + 密码登录，新增 /send-code、/login/password、/me、/verify，/logout 走认证中间件
- 控制器：auth.controller.ts 接入 authService/tokenService，刷新逻辑统一 tokenService.refreshTokens
- 清理：删除 controllers/auth.controller.js, routes/auth.routes.js，移除 app.ts 的 unified-login 引用（此前已处理）
- 构建：通过（backend npm run build）
- CMS Features/Providers/Prompt Templates：
  - controllers/routes：全部 TS 化并指向 TS 控制器；删除 JS 控制器（cmsProvider.controller.js、promptTemplate.controller.js）。
  - services：新增 TS（cmsFeature.service.ts、cmsProvider.service.ts、promptTemplate.service.ts），删除同名 JS 与桥接 d.ts。
  - 权限：统一使用 require-permission.middleware.ts。
- Pipeline：
  - controllers：新增 TS 版（pipelineSchema.controller.ts、pipelineExecution.controller.ts）；删除 JS 与桥接 d.ts，routes 改为默认导入。
  - services：保留 JS 实现，新增最小 d.ts（pipelineSchema/Execution）以收敛类型，后续单独迁移。
- 构建通过：backend `npm run build`（0 error）。
