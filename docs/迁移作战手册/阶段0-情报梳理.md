# 阶段 0 情报梳理记录（老王亲测）

> 目标：摸清依赖拓扑、CommonJS 残留与认证链路差异，确保阶段 1 及后续迁移不再瞎忙活。

---

## 1. 依赖拓扑

- 使用命令：`npx madge --extensions ts,js --json src > docs/迁移作战手册/madge-deps.json`
- 输出文件：`docs/迁移作战手册/madge-deps.json`
- 备注：包含从入口、路由、服务到工具的完整依赖映射，后续可用于绘图或批量检测循环依赖。

---

## 2. 各目录 `.js` / `.ts` 余量

统计路径：`backend/src`

| 目录 | `.js` 文件数 | `.ts` 文件数 | 备注 |
|------|-------------:|-------------:|------|
| api | 0 | 0 | 已清空 |
| cache | 1 | 1 | `config-cache.js` 尚未移除 |
| config | 1 | 10 | `config/database.js` 遗留 |
| controllers | 36 | 10 | 大量 Controller 未迁移 |
| db | 65 | 1 | 迁移后的 `index.ts` + 旧 `connection.js`、迁移脚本 |
| engine | 0 | 3 | 已 TS 化 |
| middleware | 2 | 2 | 旧目录，需与 `middlewares/` 合并 |
| middlewares | 9 | 4 | 中间件两套并存 |
| providers | 3 | 7 | Provider 仍大量 CJS |
| pubsub | 0 | 1 | OK |
| rag | 0 | 3 | OK |
| repositories | 0 | 8 | OK |
| routes | 32 | 18 | 大部分路由仍是 JS |
| scripts | 0 | 1 | 仅余 TS 版本 |
| services | 62 | 38 | 主战场 |
| types | 0 | 0 | 预留位置 |
| utils | 7 | 11 | `response.js` 等需清理 |

> 详见 `TS-ESM-MIGRATION-PLAN.md` 附录《剩余 CommonJS 清单》。

---

## 3. CommonJS 外部依赖清单与策略

| 模块 | 当前用途 | 模块现状 | 建议处理方式 |
|------|----------|----------|--------------|
| `alipay-sdk` | 支付回调签名、下单 | CJS-only | 包装成 TS helper（单例） |
| `bull` | 旧队列实现 | CJS-only | 迁移至 `bullmq` or 封装桥接层 |
| `cos-nodejs-sdk-v5` | 腾讯云 COS | CJS-only | 维持 wrapper，导出 Promise API |
| `dotenv` | 本地配置 | CJS-only | 启动时专用，不阻塞 |
| `express` 系列（`cors`、`rate-limit`、`validator`、`helmet`、`mongo-sanitize`） | 中间件 | CJS-only | 统一通过 `import pkg from` + 类型声明 |
| `ioredis` | Redis 客户端 | CJS-only | 已有 `RedisManager` TS Wrapper，继续强化 |
| `joi` (`@hapi/joi`) | 数据校验 | CJS-only | 封装校验工具或寻找 ESM 版本（可考虑 `joi` 官方包） |
| `jsonwebtoken` | JWT | CJS-only | 现有 TS 封装 ok |
| `knex` | DB ORM | CJS-only | 使用 TS 类型包（已 TS 化） |
| `node-cache` | 本地缓存 | CJS-only | 迁移时考虑替换 or 封装 |
| `node-cron` | 定时任务 | CJS-only | 使用 TS wrapper 暴露 schedule API |
| `qcloud-cos-sts` | COS 临时密钥 | CJS-only | 维持 wrapper |
| `shortid` | 唯一 ID | CJS-only，已废弃 | 迁移至 `nanoid` |
| `swagger-jsdoc` | 文档生成 | CJS-only | 封装 wrapper |
| `tencentcloud-sdk-nodejs` | 云 API | CJS-only | 一定要包一层 TS 适配器 |
| `wechatpay-node-v3` / `wechat-api` | 微信支付/登录 | CJS-only | 同上，准备 TS wrapper |
| `ws` | WebSocket | CJS-only | 现有 TS service 需要显式类型 |

> 其余如 `axios`、`nanoid`、`p-limit`、`uuid` 为 ESM-only，同样需要确保导入姿势正确（`import { v4 as uuid } from 'uuid'` 等）。

---

## 4. 中间件目录现状（阶段 1 Checklist）

| 位置 | `.js` | `.ts` | 状态 |
|------|------|------|------|
| `middleware/` | `auth.middleware.js`, `validation.middleware.js` | `auth.middleware.ts`, `error-handler.ts` | 旧 + 新并存 |
| `middlewares/` | `adminAuth.middleware.js`, `auth.middleware.js`, `cache.middleware.js`, `enhanced-error-handler.middleware.js`, `errorHandler.middleware.js`, `rateLimiter.middleware.js`, `requirePermission.middleware.js`, `security.middleware.js`, `validate.middleware.js` | `auth.middleware.ts`, `request-id.middleware.ts`, `require-permission.middleware.ts`, `validate.middleware.ts` | 主要在此目录 |

> 阶段 1 需要：统一到 `src/middlewares/`，每个中间件提供 TS 实现并删除对应 JS。

---

## 5. `Express.Request` 扩展策略

- 建立 `src/types/global.d.ts`（若目录不存在则创建 `src/types/`）
- 集中声明：
  ```ts
  declare global {
    namespace Express {
      interface Request {
        id?: string;
        user?: {
          id: string;
          role: UserRole;
          [key: string]: unknown;
        };
        token?: string;
        i18n?: {
          locale: string;
          getMessage: (key: string, vars?: Record<string, unknown>) => string;
        };
      }
    }
  }
  export {};
  ```
- 所有中间件与 controller 禁止再单独 `declare global`，直接复用此声明。

---

## 6. 认证链路差异 & TODO 列表

### 6.1 功能差异

| 功能 | 现状 | TODO |
|------|------|------|
| 验证码登录 (`auth.controller.js`) | 支持 `sendCode`、`login`、`verify`、`logout` 等 | 合并进 TS controller，复用 TS service |
| 密码登录 (`auth.controller.ts`) | 只处理注册、密码登录、刷新、登出 | 增加验证码相关入口，统一响应格式 |
| 推荐绑定 (`auth.service.js`) | 事务内调用 `distribution.service` | TS 版保留逻辑，缺失部分补 TODO 实现 |
| Token 服务 | TS 版 `token.service.ts` 已实现 | 控制器需统一调用 TS 版 |
| 周边调用 | `unified-login`, `wechat-login`, `user-profile`, `referral` 等依赖 JS service | 改为引用 TS service 并补类型 |

### 6.2 测试用例草单

1. 验证码登录：`/api/auth/send-code` → `/api/auth/login`（携带推荐人）  
2. 密码注册+登录：`/api/auth/register` → `/api/auth/login`（密码）  
3. Token 刷新 & 失效：`/api/auth/refresh`、`/api/auth/logout`  
4. `unified-login` 兼容性：手机验证码流程  
5. `wechat-login`：扫码/UnionID 绑定  
6. 推荐关系绑定：校验分销表记录  

---

## 7. 后续提醒

- 阶段 1 启动前，务必确认阶段 0 三项产出齐全，避免迁移中途返工。  
- 每完成一个阶段必须执行文末“老王提示”里的验证动作，同时更新 `TS-ESM-MIGRATION-PLAN.md` 与项目日志。  
- 如需进一步拆分阶段任务或协助撰写执行清单，直接吼我。老王在线扛雷。  

---

艹，情报已经备齐，接下来按计划逐步推进，别再瞎搞。记得同步这份文档给后续接盘的人。老王先去准备下一阶段的锤子。
