# 项目现状总览（2025-11-06）

> 供后续规划/提问 GPT-5P 时使用的上下文，聚焦“我们已经做了什么、还缺什么、历史上踩过哪些坑”。

---

## 1. 技术栈版本演进

| 维度 | 旧栈（CommonJS 时代） | 现状 / 目标 |
|------|----------------------|-------------|
| Node.js | 18.x（文档中标注） | `package.json` / `.tool-versions` 已切到 **>=20.11** |
| 模块系统 | CommonJS (`require/module.exports`) | `type: "module"`，`tsconfig` 采用 `NodeNext`（仍混杂大量 `.js`） |
| Express | 4.x（重构报告） | 依赖已经升级到 **5.1.0**，但大量路由仍是 4.x 风格写法 |
| ORM / DB | Knex 2.x + MySQL 8 | 现依赖 **Knex 3.1.0**，数据库保持 MySQL 8 |
| 队列 | Bull 旧版 | `bullmq` 已引入，但旧 `bull` 仍在依赖中，代码尚未统一 |
| 类型系统 | 无（纯 JS） | TypeScript 5.7.2，部分服务（token、auth、新 controller）已 TS 化 |

---

## 2. 历史遗留问题（摘自《后端架构重构问题报告》）

> 原报告按 P0/P1 给出了 18 个关键问题，以下列出与迁移直接相关的项目，并标注当前状态。

| 编号 | 问题描述 | 旧实现状况 | 当前代码进展 | 现状评估 |
|------|----------|------------|--------------|----------|
| P0-1 | Pipeline 失败时配额无法回滚 | Service/Repository 混写，异常处理分散 | `quota.service.ts` 已有 TS 版，仍有 JS 调用 | **待统一到 TS 调用链** |
| P0-2 | JWT Token 无刷新 / 无吊销机制 | 纯 JS `token.service`，走 `jsonwebtoken` | **`token.service.ts`** 已实现双 token + Redis 黑名单 | **功能改进已编码**，旧 controller 还未接入 |
| P0-4 | Fork/Join 并行无并发控制 | Pipeline 使用 `Promise.all` 无限放大 | `p-limit` 已在 TS 版 service 中引用 | 需确认所有调用方已迁至 TS |
| P0-7 | 验证码登录 vs 密码登录混乱 | 共存两套 controller、service、middleware | `auth.service.ts` 提供双模式，但 controller/route 仍分裂 | **核心迁移任务** |
| P0-8 | 支付仅模拟 + SDK 缺失 | `payment.controller.js` 里只有占位逻辑 | `alipay-sdk`、`wechatpay-node-v3` 已加入依赖 | **需要 TS 封装和真实集成** |
| P0-9 | 两套认证中间件导致权限失效 | `middlewares/auth.middleware.js` + `middleware/auth.middleware.ts` 并存 | TS 版 auth 中间件已支持 token 管理，但大多数路由仍引用 JS 版 | **Stage 1 必须解决** |
| P0-10 | Redis 仅用于验证码 | 旧时代缺乏缓存层封装 | `cmsCache.service.ts`（新）与大量 JS 缓存代码并存 | 需要按批次迁移 |
| P1-12 | 错误处理不统一 | 大量控制器直接 `res.status/ res.json` | `middleware/error-handler.ts` 已存在，但 JS 控制器未接入 | 全面 TS 化后统一 |
| P1-13 | 缺少 Swagger 文档 | 无自动化文档 | `swagger.service.js` 仍是 CJS | 需迁移并接入 TS app.ts |

---

## 3. 已完成的工作

1. **Stage 0 情报收集**  
   - `madge` 依赖图：`docs/迁移作战手册/madge-deps.json`  
   - 目录级 `.js` 余量统计 & 中间件现状清单：`docs/迁移作战手册/阶段0-情报梳理.md`  
   - CommonJS 外部 SDK 清单及初步建议同上。

2. **TypeScript 雏形**  
   - 已有 TS 版本的核心：`token.service.ts`、`auth.service.ts`、`provider-management.service.ts` 等。  
   - `app.ts`, `server.ts`, `tsconfig`、`tsconfig.build` 已设置 ESM/nodeNext 模型。  
   - `ts-esm-migration.patch` 中清理了老的 `jest.config.js` 等 CommonJS 配置。

3. **工具链升级**  
   - `package.json` 设置 `"type": "module"`、`node >=20.11`。  
   - ESLint/Prettier 配置改为 TS/ESM 取向；Husky + lint-staged 仍在运行。

---

## 4. 仍然存在的结构性问题

1. **中间件双目录 / 双实现**  
   - `middleware/` 下保留旧版 `auth.middleware.js`、`validation.middleware.js` 和新 `auth.middleware.ts`。  
   - `middlewares/` 下又有另一套实现，路由 require/ import 互相交叉。

2. **业务服务混合**  
   - 62 个 `.js` service 文件仍在生产路径，部分和 TS 版本并存（例如 `auth.service.js` vs `auth.service.ts`）。  
   - 大部分 controller / route 仍为 CJS，导致 `app.ts` 不敢切掉旧注册流程。

3. **部署与脚本**  
   - `scripts/test-*.js`、`cron` 目录、PM2 配置尚未审查，可能继续引用 CJS。  
   - 外部 SDK 仍以 CJS 形式调用，迁移会波及支付、COS、RunningHub 等关键链路。

4. **测试覆盖缺口**  
   - Jest 配置已经迁至 TS，但实际测试仍以旧目录为主；TS 新模块未补足单测 / 集成测。  
   - 冒烟脚本目前为 Postman/手动，缺乏自动化 pipeline。

---

## 5. 近期梳理出的关键节点

| 节点 | 状态 | 备注 |
|------|------|------|
| `TS-ESM-MIGRATION-PLAN.md` | 最新更新于 2025-11-06 | Stage 0 ✅，Stage 1~5 待执行 |
| `docs/迁移作战手册/全量迁移任务卡.md` | 已列出阶段目标 | 需要更细粒度拆分和验收项 |
| `docs/后端架构重构问题报告-GPT5专用.md` | 提供 P0/P1 问题背景 | 规划时应对照逐项验证是否已解决 |
| `backend/src/types/global.d.ts` | 已新建（2025-11-06） | 统一 `Express.Request` 扩展，后续中间件务必引用 |

---

## 6. 我们已经解决 / 正在解决的点

- ✅ **Token 刷新 / 黑名单机制**：`token.service.ts` 完成实现，Redis 黑名单已写好，需要 controller 接入。  
- ✅ **TS 工具链 & 构建脚本**：`tsx`、`ts-jest`、ESLint/Prettier 已配置完成。  
- ✅ **Stage 0 调研**：依赖拓扑、JS 分布、外部 SDK 列表全部整理清楚。  
- ⚙️ **TS 中间件雏形**：`auth.middleware.ts (新版)`、`request-id.middleware.ts`、`validate.middleware.ts` 已存在，需要替换所有路由引用。  
- ⚙️ **配置和文档**：`TS-ESM-MIGRATION-PLAN.md` + `迁移作战手册` 目录搭建完毕，支持持续记录。

---

## 7. 下一步需要 GPT-5P 提供的内容

1. **阶段化执行蓝图**：在已有 Stage 1~5 框架上，填充“具体目录/文件 → 操作步骤 → 验证脚本 → 交付物”的执行计划。  
2. **中间件迁移顺序 & 兼容策略**：确保在替换路由引用时系统不中断，同时设计 `.js` 清理的验收方法。  
3. **业务批次拆解**：根据 `madge-deps.json`，明确每个批次的服务清单、依赖关系、风险点和测试要求。  
4. **第三方 SDK 改造方案**：逐一给出具体封装/替换建议及影响分析。  
5. **测试矩阵 & 验收标准**：定义阶段性测试（单测/集成/冒烟/压测）和最终验收条件（构建、联调、部署、文档更新）。  
6. **风险与回滚预案**：针对引用链断裂、动态 require、部署脚本引用 `.js`、外部 SDK 报错等高风险场景给出应急方案。

---

> 有了以上上下文，再提问 GPT-5P 时就能让它围绕真实现状给出可执行的迁移方案，而不是泛泛而谈。
