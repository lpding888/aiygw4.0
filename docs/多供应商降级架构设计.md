# å¤šä¾›åº”å•†é™çº§æ¶æ„è®¾è®¡

**è®¾è®¡äºº**: è€ç‹ï¼ˆBackend Dev Skillï¼‰
**è®¾è®¡æ—¶é—´**: 2025-10-29
**ä¼˜å…ˆçº§**: P0ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
**å®æ–½é˜¶æ®µ**: Phase 2
**é¢„è®¡å·¥ä½œé‡**: 3-5å¤©

---

## ğŸ“‹ èƒŒæ™¯

### å½“å‰é—®é¢˜

**ä»£ç å®¡æŸ¥å‘ç°**ï¼ˆP0-3ï¼‰:
- âŒ PipelineEngineåªæ”¯æŒå•ä¸€providerï¼ˆç¡¬ç¼–ç provider_refï¼‰
- âŒ æ²¡æœ‰providerå¥åº·æ£€æŸ¥æœºåˆ¶
- âŒ ä¸»provideræ•…éšœæ—¶æ— æ³•è‡ªåŠ¨åˆ‡æ¢

**ä¸šåŠ¡é£é™©**:
- ğŸ”´ RunningHub APIæ•…éšœ â†’ æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆä»»åŠ¡å¤±è´¥
- ğŸ”´ Hunyuan APIæ•…éšœ â†’ æ‰€æœ‰è§†é¢‘ç”Ÿæˆä»»åŠ¡å¤±è´¥
- ğŸ”´ å•ç‚¹æ•…éšœå¯¼è‡´ç”¨æˆ·ä½“éªŒå·®

**å®¡æŸ¥æ ‡å‡†è¦æ±‚**ï¼ˆreviewer_skill.md ä»»åŠ¡3ï¼‰:
```javascript
// âœ… æ­£ç¡®: æ”¯æŒ provider_candidates é™çº§
async function getProvider(step) {
  const candidates = step.provider_candidates || [step.provider_ref];

  for (const providerRef of candidates) {
    const health = await db('provider_health')
      .where({ provider_ref: providerRef })
      .first();

    if (health && health.status === 'up') {
      return await db('provider_endpoints')
        .where({ provider_ref: providerRef })
        .first();
    }
  }

  throw new Error('æ‰€æœ‰ä¾›åº”å•†ä¸å¯ç”¨');
}
```

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡

1. **é«˜å¯ç”¨æ€§**: ä¸»provideræ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨provider
2. **å¥åº·æ£€æŸ¥**: å®æ—¶ç›‘æ§æ‰€æœ‰providerå¥åº·çŠ¶æ€
3. **çµæ´»é…ç½®**: æ”¯æŒæ¯ä¸ªstepé…ç½®å¤šä¸ªå€™é€‰provider
4. **è‡ªåŠ¨é™çº§**: æŒ‰ä¼˜å…ˆçº§è‡ªåŠ¨é€‰æ‹©å¯ç”¨provider
5. **ç›‘æ§å‘Šè­¦**: provideræ•…éšœæ—¶è®°å½•æ—¥å¿—å¹¶å‘Šè­¦

### æ€§èƒ½æŒ‡æ ‡

- å¥åº·æ£€æŸ¥é¢‘ç‡: æ¯30ç§’
- é™çº§å“åº”æ—¶é—´: <100msï¼ˆå†…å­˜ç¼“å­˜ï¼‰
- æ•…éšœæ¢å¤æ—¶é—´: <1åˆ†é’Ÿ

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1ï¸âƒ£ æ•°æ®åº“è®¾è®¡

#### 1.1 provider_health è¡¨ï¼ˆå·²å­˜åœ¨ï¼Œéœ€å®Œå–„ï¼‰

**è¿ç§»æ–‡ä»¶**: `backend/src/db/migrations/20251029000007_create_provider_health_table.js`

```javascript
/**
 * provider_health è¡¨ - ä¾›åº”å•†å¥åº·çŠ¶æ€
 */
exports.up = function(knex) {
  return knex.schema.createTable('provider_health', function(table) {
    table.string('provider_ref', 100).primary().comment('ä¾›åº”å•†å¼•ç”¨ID');
    table.enum('status', ['up', 'down', 'degraded']).notNullable().defaultTo('up').comment('å¥åº·çŠ¶æ€');
    table.integer('success_count').defaultTo(0).comment('æˆåŠŸæ¬¡æ•°');
    table.integer('failure_count').defaultTo(0).comment('å¤±è´¥æ¬¡æ•°');
    table.float('success_rate').defaultTo(1.0).comment('æˆåŠŸç‡');
    table.integer('avg_response_time').comment('å¹³å‡å“åº”æ—¶é—´(ms)');
    table.timestamp('last_check_at').comment('æœ€åæ£€æŸ¥æ—¶é—´');
    table.timestamp('last_success_at').comment('æœ€åæˆåŠŸæ—¶é—´');
    table.timestamp('last_failure_at').comment('æœ€åå¤±è´¥æ—¶é—´');
    table.text('error_message').comment('æœ€åé”™è¯¯ä¿¡æ¯');
    table.timestamps(true, true);

    // ç´¢å¼•
    table.index('status');
    table.index('last_check_at');
  });
};

exports.down = function(knex) {
  return knex.schema.dropTable('provider_health');
};
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| provider_ref | string | ä¾›åº”å•†å¼•ç”¨IDï¼ˆå¦‚runninghub_imageï¼‰ | - |
| status | enum | å¥åº·çŠ¶æ€: up/down/degraded | up |
| success_count | int | æˆåŠŸæ¬¡æ•° | 0 |
| failure_count | int | å¤±è´¥æ¬¡æ•° | 0 |
| success_rate | float | æˆåŠŸç‡ï¼ˆ0-1ï¼‰ | 1.0 |
| avg_response_time | int | å¹³å‡å“åº”æ—¶é—´(ms) | null |
| last_check_at | timestamp | æœ€åæ£€æŸ¥æ—¶é—´ | null |
| last_success_at | timestamp | æœ€åæˆåŠŸæ—¶é—´ | null |
| last_failure_at | timestamp | æœ€åå¤±è´¥æ—¶é—´ | null |
| error_message | text | æœ€åé”™è¯¯ä¿¡æ¯ | null |

---

#### 1.2 pipeline_schemas.steps å­—æ®µæ‰©å±•

**å½“å‰ç»“æ„**:
```json
{
  "steps": [
    {
      "type": "image_enhance",
      "provider_ref": "runninghub_image",
      "timeout": 30000
    }
  ]
}
```

**æ‰©å±•åç»“æ„**:
```json
{
  "steps": [
    {
      "type": "image_enhance",
      "provider_ref": "runninghub_image",  // ä¿ç•™å…¼å®¹æ€§ï¼Œä½œä¸ºç¬¬ä¸€å€™é€‰
      "provider_candidates": [              // ğŸ”¥ æ–°å¢ï¼šå€™é€‰provideråˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        "runninghub_image",                 // ä¸»provider
        "alicloud_image",                   // å¤‡ç”¨provider 1
        "tencent_hunyuan_image"             // å¤‡ç”¨provider 2
      ],
      "timeout": 30000,
      "retry_policy": {
        "max_retries": 2,
        "retry_delay_ms": 1000
      }
    }
  ]
}
```

**å­—æ®µè¯´æ˜**:
- `provider_candidates`: å€™é€‰provideråˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
- é™çº§é€»è¾‘: æŒ‰æ•°ç»„é¡ºåºä¾æ¬¡å°è¯•ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¥åº·çš„provider
- å…¼å®¹æ€§: å¦‚æœæ²¡æœ‰provider_candidatesï¼Œä½¿ç”¨provider_refä½œä¸ºå”¯ä¸€å€™é€‰

---

### 2ï¸âƒ£ æ ¸å¿ƒæœåŠ¡è®¾è®¡

#### 2.1 ProviderHealthServiceï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶**: `backend/src/services/providerHealth.service.js`

```javascript
const db = require('../config/database');
const logger = require('../utils/logger');

/**
 * Providerå¥åº·æ£€æŸ¥æœåŠ¡
 * è´Ÿè´£ç›‘æ§æ‰€æœ‰providerçš„å¥åº·çŠ¶æ€
 */
class ProviderHealthService {
  constructor() {
    this.healthCache = new Map(); // å†…å­˜ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
    this.cacheExpiry = 30 * 1000; // ç¼“å­˜30ç§’
  }

  /**
   * è·å–providerå¥åº·çŠ¶æ€ï¼ˆå¸¦ç¼“å­˜ï¼‰
   * @param {string} providerRef - providerå¼•ç”¨ID
   * @returns {Promise<Object>} å¥åº·çŠ¶æ€
   */
  async getHealth(providerRef) {
    // æ£€æŸ¥ç¼“å­˜
    const cached = this.healthCache.get(providerRef);
    if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
      return cached.data;
    }

    // ä»æ•°æ®åº“æŸ¥è¯¢
    const health = await db('provider_health')
      .where('provider_ref', providerRef)
      .first();

    if (!health) {
      // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œåˆ›å»ºé»˜è®¤è®°å½•
      await this.createDefaultHealth(providerRef);
      return { provider_ref: providerRef, status: 'up', success_rate: 1.0 };
    }

    // æ›´æ–°ç¼“å­˜
    this.healthCache.set(providerRef, {
      data: health,
      timestamp: Date.now()
    });

    return health;
  }

  /**
   * åˆ›å»ºé»˜è®¤å¥åº·è®°å½•
   * @param {string} providerRef - providerå¼•ç”¨ID
   */
  async createDefaultHealth(providerRef) {
    await db('provider_health').insert({
      provider_ref: providerRef,
      status: 'up',
      success_count: 0,
      failure_count: 0,
      success_rate: 1.0,
      created_at: new Date(),
      updated_at: new Date()
    });
  }

  /**
   * è®°å½•providerè°ƒç”¨æˆåŠŸ
   * @param {string} providerRef - providerå¼•ç”¨ID
   * @param {number} responseTime - å“åº”æ—¶é—´(ms)
   */
  async recordSuccess(providerRef, responseTime) {
    await db('provider_health')
      .where('provider_ref', providerRef)
      .update({
        success_count: db.raw('success_count + 1'),
        success_rate: db.raw('success_count / (success_count + failure_count + 1)'),
        avg_response_time: responseTime,
        last_check_at: new Date(),
        last_success_at: new Date(),
        status: 'up',
        updated_at: new Date()
      });

    // æ¸…é™¤ç¼“å­˜
    this.healthCache.delete(providerRef);

    logger.info(`[ProviderHealth] è®°å½•æˆåŠŸ provider=${providerRef} responseTime=${responseTime}ms`);
  }

  /**
   * è®°å½•providerè°ƒç”¨å¤±è´¥
   * @param {string} providerRef - providerå¼•ç”¨ID
   * @param {string} errorMessage - é”™è¯¯ä¿¡æ¯
   */
  async recordFailure(providerRef, errorMessage) {
    const health = await this.getHealth(providerRef);

    const newFailureCount = (health.failure_count || 0) + 1;
    const totalCount = (health.success_count || 0) + newFailureCount;
    const newSuccessRate = (health.success_count || 0) / totalCount;

    // åˆ¤æ–­æ˜¯å¦éœ€è¦æ ‡è®°ä¸ºdown
    const status = newSuccessRate < 0.5 ? 'down' : 'degraded';

    await db('provider_health')
      .where('provider_ref', providerRef)
      .update({
        failure_count: db.raw('failure_count + 1'),
        success_rate: newSuccessRate,
        last_check_at: new Date(),
        last_failure_at: new Date(),
        error_message: errorMessage,
        status: status,
        updated_at: new Date()
      });

    // æ¸…é™¤ç¼“å­˜
    this.healthCache.delete(providerRef);

    logger.error(`[ProviderHealth] è®°å½•å¤±è´¥ provider=${providerRef} status=${status} error=${errorMessage}`);
  }

  /**
   * è·å–ç¬¬ä¸€ä¸ªå¥åº·çš„provider
   * @param {Array<string>} candidates - å€™é€‰provideråˆ—è¡¨
   * @returns {Promise<string|null>} å¥åº·çš„providerå¼•ç”¨ID
   */
  async getFirstHealthyProvider(candidates) {
    if (!Array.isArray(candidates) || candidates.length === 0) {
      return null;
    }

    for (const providerRef of candidates) {
      const health = await this.getHealth(providerRef);

      // åªé€‰æ‹©çŠ¶æ€ä¸ºupçš„provider
      if (health.status === 'up') {
        logger.info(`[ProviderHealth] é€‰æ‹©provider=${providerRef} status=up`);
        return providerRef;
      }
    }

    // æ‰€æœ‰provideréƒ½ä¸å¥åº·ï¼Œè®°å½•è­¦å‘Š
    logger.warn(`[ProviderHealth] æ‰€æœ‰å€™é€‰provideréƒ½ä¸å¥åº· candidates=${candidates.join(',')}`);
    return null;
  }

  /**
   * å®šæ—¶å¥åº·æ£€æŸ¥ä»»åŠ¡ï¼ˆæ¯30ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
   */
  async runHealthCheck() {
    logger.info('[ProviderHealth] å¼€å§‹å®šæ—¶å¥åº·æ£€æŸ¥');

    try {
      const allProviders = await db('provider_endpoints').select('provider_ref');

      for (const { provider_ref } of allProviders) {
        try {
          // ç®€å•çš„å¥åº·æ£€æŸ¥ï¼šæŸ¥è¯¢provider_endpointsæ˜¯å¦å­˜åœ¨
          const endpoint = await db('provider_endpoints')
            .where('provider_ref', provider_ref)
            .first();

          if (endpoint) {
            // æ›´æ–°last_check_at
            await db('provider_health')
              .where('provider_ref', provider_ref)
              .update({
                last_check_at: new Date(),
                updated_at: new Date()
              });
          }
        } catch (error) {
          logger.error(`[ProviderHealth] å¥åº·æ£€æŸ¥å¤±è´¥ provider=${provider_ref} error=${error.message}`);
        }
      }

      logger.info('[ProviderHealth] å®šæ—¶å¥åº·æ£€æŸ¥å®Œæˆ');
    } catch (error) {
      logger.error(`[ProviderHealth] å®šæ—¶å¥åº·æ£€æŸ¥å¼‚å¸¸ error=${error.message}`);
    }
  }
}

module.exports = new ProviderHealthService();
```

---

#### 2.2 PipelineEngine æ”¹é€ 

**æ–‡ä»¶**: `backend/src/services/pipelineEngine.service.js`

**æ”¹é€ å†…å®¹**:

##### 2.2.1 ä¿®æ”¹ executePipeline æ–¹æ³•

**ä¿®æ”¹å‰**:
```javascript
const stepConfig = {
  taskId,
  stepIndex: i,
  type: step.type,
  providerRef: step.provider_ref,  // âŒ ç¡¬ç¼–ç å•ä¸€provider
  timeout: step.timeout || 30000,
  retryPolicy: step.retry_policy || {}
};
```

**ä¿®æ”¹å**:
```javascript
const stepConfig = {
  taskId,
  stepIndex: i,
  type: step.type,
  providerCandidates: step.provider_candidates || [step.provider_ref], // ğŸ”¥ å€™é€‰åˆ—è¡¨
  timeout: step.timeout || 30000,
  retryPolicy: step.retry_policy || {}
};
```

---

##### 2.2.2 ä¿®æ”¹ executeStep æ–¹æ³•

**ä¿®æ”¹å‰**:
```javascript
// æ ¹æ®typeè°ƒç”¨å¯¹åº”çš„provider
let provider;
try {
  provider = this.getProvider(type, providerRef);  // âŒ å•ä¸€provider
} catch (error) {
  logger.error(`[PipelineEngine] ProvideråŠ è½½å¤±è´¥ type=${type} ref=${providerRef}`);
  throw error;
}
```

**ä¿®æ”¹å**:
```javascript
const providerHealthService = require('./providerHealth.service');

// æ ¹æ®typeå’Œå¥åº·çŠ¶æ€é€‰æ‹©provider
let providerRef;
let provider;

try {
  // ğŸ”¥ ä»å€™é€‰åˆ—è¡¨ä¸­é€‰æ‹©ç¬¬ä¸€ä¸ªå¥åº·çš„provider
  providerRef = await providerHealthService.getFirstHealthyProvider(
    stepConfig.providerCandidates
  );

  if (!providerRef) {
    throw new Error(`æ‰€æœ‰å€™é€‰provideréƒ½ä¸å¯ç”¨: ${stepConfig.providerCandidates.join(',')}`);
  }

  provider = this.getProvider(type, providerRef);

  logger.info(
    `[PipelineEngine] é€‰æ‹©provider taskId=${taskId} stepIndex=${stepIndex} ` +
    `candidates=${stepConfig.providerCandidates.join(',')} selected=${providerRef}`
  );

} catch (error) {
  logger.error(`[PipelineEngine] Provideré€‰æ‹©å¤±è´¥ type=${type} error=${error.message}`);
  throw error;
}
```

---

##### 2.2.3 æ·»åŠ å¥åº·çŠ¶æ€è®°å½•

**åœ¨executeStepæ–¹æ³•ä¸­ï¼ŒæˆåŠŸå’Œå¤±è´¥æ—¶è®°å½•å¥åº·çŠ¶æ€**:

```javascript
try {
  const output = await Promise.race([
    provider.execute(input, taskId),
    this.timeout(timeout, `æ­¥éª¤æ‰§è¡Œè¶…æ—¶(${timeout}ms)`)
  ]);

  // ğŸ”¥ è®°å½•æˆåŠŸ
  const responseTime = Date.now() - startTime;
  await providerHealthService.recordSuccess(providerRef, responseTime);

  // æˆåŠŸ,æ›´æ–°æ­¥éª¤çŠ¶æ€
  await db('task_steps')
    .where({ task_id: taskId, step_index: stepIndex })
    .update({
      status: 'completed',
      output: JSON.stringify(output),
      provider_ref: providerRef,  // ğŸ”¥ è®°å½•å®é™…ä½¿ç”¨çš„provider
      completed_at: new Date()
    });

  return { success: true, output };

} catch (error) {
  // ğŸ”¥ è®°å½•å¤±è´¥
  await providerHealthService.recordFailure(providerRef, error.message);

  lastError = error;
  logger.warn(
    `[PipelineEngine] æ­¥éª¤æ‰§è¡Œå¤±è´¥ attempt=${attempt} ` +
    `taskId=${taskId} stepIndex=${stepIndex} provider=${providerRef} error=${error.message}`
  );
}
```

---

### 3ï¸âƒ£ å®šæ—¶ä»»åŠ¡è®¾è®¡

#### 3.1 å¥åº·æ£€æŸ¥å®šæ—¶ä»»åŠ¡

**æ–‡ä»¶**: `backend/src/services/cronJobs.service.js`ï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ‰©å±•ï¼‰

```javascript
const cron = require('node-cron');
const logger = require('../utils/logger');
const providerHealthService = require('./providerHealth.service');

/**
 * å®šæ—¶ä»»åŠ¡æœåŠ¡
 */
class CronJobsService {
  /**
   * å¯åŠ¨æ‰€æœ‰å®šæ—¶ä»»åŠ¡
   */
  startAll() {
    // ğŸ”¥ Providerå¥åº·æ£€æŸ¥ï¼ˆæ¯30ç§’ï¼‰
    cron.schedule('*/30 * * * * *', async () => {
      try {
        await providerHealthService.runHealthCheck();
      } catch (error) {
        logger.error('[CronJobs] Providerå¥åº·æ£€æŸ¥å¤±è´¥', error);
      }
    });

    logger.info('[CronJobs] æ‰€æœ‰å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨');
  }
}

module.exports = new CronJobsService();
```

**åœ¨ server.js ä¸­å¯åŠ¨**:
```javascript
const cronJobsService = require('./services/cronJobs.service');

// å¯åŠ¨å®šæ—¶ä»»åŠ¡
cronJobsService.startAll();
```

---

### 4ï¸âƒ£ ç›‘æ§å’Œå‘Šè­¦

#### 4.1 ç›‘æ§æŒ‡æ ‡

**å®æ—¶ç›‘æ§æŒ‡æ ‡**:
- Providerå¥åº·çŠ¶æ€ï¼ˆup/down/degradedï¼‰
- æˆåŠŸç‡ï¼ˆsuccess_rateï¼‰
- å¹³å‡å“åº”æ—¶é—´ï¼ˆavg_response_timeï¼‰
- æœ€åæ£€æŸ¥æ—¶é—´ï¼ˆlast_check_atï¼‰

**å‘Šè­¦è§„åˆ™**:
```javascript
// åœ¨ providerHealthService.recordFailure ä¸­æ·»åŠ å‘Šè­¦é€»è¾‘
async recordFailure(providerRef, errorMessage) {
  // ...

  // ğŸ”¥ å‘Šè­¦é€»è¾‘
  if (status === 'down') {
    await this.sendAlert({
      level: 'critical',
      title: `Provideræ•…éšœ: ${providerRef}`,
      message: `Provider ${providerRef} å·²æ ‡è®°ä¸ºdownï¼ŒæˆåŠŸç‡: ${(newSuccessRate * 100).toFixed(2)}%`,
      errorMessage: errorMessage
    });
  } else if (status === 'degraded') {
    await this.sendAlert({
      level: 'warning',
      title: `Provideræ€§èƒ½ä¸‹é™: ${providerRef}`,
      message: `Provider ${providerRef} å·²æ ‡è®°ä¸ºdegradedï¼ŒæˆåŠŸç‡: ${(newSuccessRate * 100).toFixed(2)}%`,
      errorMessage: errorMessage
    });
  }
}

/**
 * å‘é€å‘Šè­¦ï¼ˆå¯å¯¹æ¥ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰ï¼‰
 */
async sendAlert(alert) {
  // TODO: å¯¹æ¥å‘Šè­¦æ¸ é“
  logger.error(`[ProviderHealth] å‘Šè­¦ ${alert.level}: ${alert.title} - ${alert.message}`);
}
```

---

## ğŸ“Š å®æ–½è®¡åˆ’

### Phase 2.1: æ•°æ®åº“å’ŒåŸºç¡€æœåŠ¡ï¼ˆ1-2å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] å®Œå–„ provider_health è¡¨è¿ç§»æ–‡ä»¶
- [ ] åˆ›å»º ProviderHealthService
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆsuccess/failureè®°å½•ã€å¥åº·æŸ¥è¯¢ï¼‰
- [ ] åˆå§‹åŒ–æ‰€æœ‰providerçš„å¥åº·è®°å½•

**äº¤ä»˜ç‰©**:
- `backend/src/services/providerHealth.service.js`
- `backend/tests/providerHealth.service.test.js`
- æ•°æ®åº“è¿ç§»æˆåŠŸ

---

### Phase 2.2: PipelineEngineæ”¹é€ ï¼ˆ1-2å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹ executePipeline æ–¹æ³•æ”¯æŒ provider_candidates
- [ ] ä¿®æ”¹ executeStep æ–¹æ³•é›†æˆå¥åº·æ£€æŸ¥
- [ ] æ·»åŠ æˆåŠŸ/å¤±è´¥å¥åº·çŠ¶æ€è®°å½•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆå¤šprovideré™çº§åœºæ™¯ï¼‰

**äº¤ä»˜ç‰©**:
- æ”¹é€ åçš„ `backend/src/services/pipelineEngine.service.js`
- `backend/tests/pipelineEngine.multi-provider.test.js`

---

### Phase 2.3: å®šæ—¶ä»»åŠ¡å’Œç›‘æ§ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] æ·»åŠ å¥åº·æ£€æŸ¥å®šæ—¶ä»»åŠ¡
- [ ] é›†æˆå‘Šè­¦é€»è¾‘
- [ ] åˆ›å»ºç›‘æ§ä»ªè¡¨ç›˜ï¼ˆå¯é€‰ï¼‰
- [ ] ç¼–å†™è¿ç»´æ–‡æ¡£

**äº¤ä»˜ç‰©**:
- æ”¹é€ åçš„ `backend/src/services/cronJobs.service.js`
- `docs/Providerå¥åº·ç›‘æ§è¿ç»´æ‰‹å†Œ.md`

---

### Phase 2.4: Pipeline Schemaå‡çº§ï¼ˆ0.5å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] æ›´æ–°ç°æœ‰ pipeline_schemas æ·»åŠ  provider_candidates
- [ ] åˆ›å»ºç¤ºä¾‹é…ç½®æ–‡æ¡£

**ç¤ºä¾‹é…ç½®**:
```json
{
  "pipeline_id": "image_enhance_pipeline_v2",
  "name": "å›¾ç‰‡å¢å¼ºPipelineï¼ˆå¤šä¾›åº”å•†ï¼‰",
  "steps": [
    {
      "type": "image_enhance",
      "provider_ref": "runninghub_image",
      "provider_candidates": [
        "runninghub_image",
        "alicloud_image"
      ],
      "timeout": 30000,
      "retry_policy": {
        "max_retries": 2,
        "retry_delay_ms": 1000
      }
    }
  ]
}
```

---

### Phase 2.5: æµ‹è¯•å’Œä¸Šçº¿ï¼ˆ0.5å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆä¸»provideræ•…éšœåœºæ™¯ï¼‰
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆ100å¹¶å‘ + provideræ•…éšœï¼‰
- [ ] ç°åº¦å‘å¸ƒï¼ˆ20%æµé‡ï¼‰
- [ ] å…¨é‡å‘å¸ƒ

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

```javascript
// backend/tests/providerHealth.service.test.js

describe('ProviderHealthService', () => {
  describe('recordSuccess', () => {
    it('åº”è¯¥å¢åŠ æˆåŠŸè®¡æ•°å¹¶æ›´æ–°æˆåŠŸç‡', async () => {
      await providerHealthService.recordSuccess('runninghub_image', 1500);
      const health = await providerHealthService.getHealth('runninghub_image');

      expect(health.success_count).toBeGreaterThan(0);
      expect(health.avg_response_time).toBe(1500);
      expect(health.status).toBe('up');
    });
  });

  describe('recordFailure', () => {
    it('åº”è¯¥å¢åŠ å¤±è´¥è®¡æ•°å¹¶æ›´æ–°çŠ¶æ€', async () => {
      // è¿ç»­å¤±è´¥10æ¬¡
      for (let i = 0; i < 10; i++) {
        await providerHealthService.recordFailure('runninghub_image', 'APIè¶…æ—¶');
      }

      const health = await providerHealthService.getHealth('runninghub_image');
      expect(health.failure_count).toBeGreaterThanOrEqual(10);
      expect(health.status).toBe('down');
    });
  });

  describe('getFirstHealthyProvider', () => {
    it('åº”è¯¥è¿”å›ç¬¬ä¸€ä¸ªå¥åº·çš„provider', async () => {
      const candidates = ['provider_down', 'provider_up', 'provider_degraded'];

      // è®¾ç½®å¥åº·çŠ¶æ€
      await db('provider_health').where('provider_ref', 'provider_down').update({ status: 'down' });
      await db('provider_health').where('provider_ref', 'provider_up').update({ status: 'up' });

      const selected = await providerHealthService.getFirstHealthyProvider(candidates);
      expect(selected).toBe('provider_up');
    });

    it('æ‰€æœ‰provideréƒ½downæ—¶åº”è¯¥è¿”å›null', async () => {
      const candidates = ['provider_down1', 'provider_down2'];

      await db('provider_health').where('provider_ref', 'provider_down1').update({ status: 'down' });
      await db('provider_health').where('provider_ref', 'provider_down2').update({ status: 'down' });

      const selected = await providerHealthService.getFirstHealthyProvider(candidates);
      expect(selected).toBeNull();
    });
  });
});
```

---

### é›†æˆæµ‹è¯•

```javascript
// backend/tests/pipelineEngine.multi-provider.test.js

describe('PipelineEngine - å¤šä¾›åº”å•†é™çº§', () => {
  it('ä¸»provideræ•…éšœæ—¶åº”è¯¥è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨provider', async () => {
    // 1. åˆ›å»ºæµ‹è¯•ä»»åŠ¡
    const taskId = await createTestTask();

    // 2. è®¾ç½®ä¸»providerä¸ºdown
    await db('provider_health')
      .where('provider_ref', 'runninghub_image')
      .update({ status: 'down' });

    // 3. æ‰§è¡ŒPipeline
    await pipelineEngine.executePipeline(taskId, 'image_enhance', { imageUrl: 'test.jpg' });

    // 4. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å¤‡ç”¨provider
    const taskSteps = await db('task_steps').where('task_id', taskId);
    expect(taskSteps[0].provider_ref).not.toBe('runninghub_image');
    expect(taskSteps[0].provider_ref).toBe('alicloud_image'); // å¤‡ç”¨provider
  });

  it('æ‰€æœ‰provideréƒ½æ•…éšœæ—¶åº”è¯¥å¤±è´¥å¹¶è¿”è¿˜é…é¢', async () => {
    const taskId = await createTestTask();
    const userId = 'test_user';

    // è®°å½•åˆå§‹é…é¢
    const initialQuota = await quotaService.getQuota(userId);

    // è®¾ç½®æ‰€æœ‰providerä¸ºdown
    await db('provider_health').update({ status: 'down' });

    // æ‰§è¡ŒPipelineï¼ˆåº”è¯¥å¤±è´¥ï¼‰
    await expect(
      pipelineEngine.executePipeline(taskId, 'image_enhance', { imageUrl: 'test.jpg' })
    ).rejects.toThrow('æ‰€æœ‰ä¾›åº”å•†ä¸å¯ç”¨');

    // æ£€æŸ¥é…é¢æ˜¯å¦è¿”è¿˜
    const finalQuota = await quotaService.getQuota(userId);
    expect(finalQuota.remaining).toBe(initialQuota.remaining);
  });
});
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | æ•°æ®æ¥æº | ç›‘æ§é¢‘ç‡ | å‘Šè­¦é˜ˆå€¼ |
|------|---------|---------|---------|
| Providerå¥åº·çŠ¶æ€ | provider_health.status | å®æ—¶ | status=down |
| æˆåŠŸç‡ | provider_health.success_rate | å®æ—¶ | <50% |
| å¹³å‡å“åº”æ—¶é—´ | provider_health.avg_response_time | å®æ—¶ | >5000ms |
| é™çº§æ¬¡æ•° | æ—¥å¿—ç»Ÿè®¡ | æ¯å°æ—¶ | >10æ¬¡/å°æ—¶ |

### ç›‘æ§ä»ªè¡¨ç›˜

**æ¨èå·¥å…·**: Grafana + Prometheus

**ç›‘æ§é¢æ¿**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Provider å¥åº·çŠ¶æ€æ€»è§ˆ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ runninghub_image:  ğŸŸ¢ UP (æˆåŠŸç‡ 98.5%)               â”‚
â”‚ alicloud_image:    ğŸŸ¡ DEGRADED (æˆåŠŸç‡ 75.2%)         â”‚
â”‚ hunyuan_video:     ğŸ”´ DOWN (æˆåŠŸç‡ 45.1%)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é™çº§ç»Ÿè®¡ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰                                  â”‚
â”‚ æ€»é™çº§æ¬¡æ•°: 15                                        â”‚
â”‚ runninghub â†’ alicloud: 12æ¬¡                          â”‚
â”‚ hunyuan â†’ kuai: 3æ¬¡                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä¸Šçº¿æ£€æŸ¥æ¸…å•

### Phase 2 ä¸Šçº¿å‰

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] provider_health è¡¨å·²åˆ›å»ºå¹¶åˆå§‹åŒ–
- [ ] ProviderHealthService å·²éƒ¨ç½²
- [ ] PipelineEngine å·²æ”¹é€ å¹¶æµ‹è¯•
- [ ] å®šæ—¶å¥åº·æ£€æŸ¥ä»»åŠ¡å·²å¯åŠ¨
- [ ] å‘Šè­¦é€»è¾‘å·²é…ç½®
- [ ] æ‰€æœ‰ pipeline_schemas å·²æ·»åŠ  provider_candidates
- [ ] è¿ç»´æ–‡æ¡£å·²å®Œæˆ
- [ ] ç°åº¦æµ‹è¯•é€šè¿‡ï¼ˆ20%æµé‡ï¼Œæ— å¼‚å¸¸ï¼‰

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | æ”¹é€ å‰ | æ”¹é€ å | æå‡ |
|------|--------|--------|------|
| **å•ç‚¹æ•…éšœé£é™©** | 100% | 0% | âœ… æ¶ˆé™¤ |
| **è‡ªåŠ¨é™çº§å“åº”** | æ—  | <100ms | âœ… æ–°å¢ |
| **æ•…éšœæ¢å¤æ—¶é—´** | äººå·¥å¹²é¢„ï¼ˆæ•°å°æ—¶ï¼‰ | <1åˆ†é’Ÿ | ğŸ”¥ æå‡99% |
| **ç”¨æˆ·ä½“éªŒ** | ä¸»provideræ•…éšœâ†’å…¨éƒ¨å¤±è´¥ | è‡ªåŠ¨åˆ‡æ¢â†’æ— æ„ŸçŸ¥ | âœ… æ˜¾è‘—æå‡ |

### è¿ç»´æ•ˆç‡

- âœ… è‡ªåŠ¨å¥åº·æ£€æŸ¥ï¼Œå‡å°‘äººå·¥å·¡æ£€
- âœ… å®æ—¶å‘Šè­¦ï¼Œå¿«é€Ÿå“åº”æ•…éšœ
- âœ… é™çº§ç»Ÿè®¡ï¼Œä¼˜åŒ–ä¾›åº”å•†é€‰æ‹©

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **å®¡æŸ¥æ ‡å‡†**: docs/ROLE_TASKS/reviewer_skill.md - ä»»åŠ¡3
- **ä¿®å¤æŠ¥å‘Š**: docs/Backend_Review_Fixes_Report.md
- **ä¸Šçº¿è®¡åˆ’**: docs/ROLL_OUT_PLAN.md - Phase 2

---

## ğŸ”¥ è€ç‹çš„æ€»ç»“

**è‰¹ï¼è¿™ä¸ªå¤šä¾›åº”å•†é™çº§æ¶æ„æ˜¯ä¿è¯é«˜å¯ç”¨çš„å…³é”®ï¼**

**æ ¸å¿ƒè¦ç‚¹**:
1. âœ… provider_healthè¡¨è®°å½•æ‰€æœ‰providerå¥åº·çŠ¶æ€
2. âœ… ProviderHealthServiceæä¾›å¥åº·æ£€æŸ¥å’Œé™çº§é€»è¾‘
3. âœ… PipelineEngineé›†æˆé™çº§ï¼Œè‡ªåŠ¨é€‰æ‹©å¥åº·provider
4. âœ… å®šæ—¶ä»»åŠ¡30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå®æ—¶ç›‘æ§
5. âœ… å‘Šè­¦æœºåˆ¶åŠæ—¶é€šçŸ¥æ•…éšœ

**å·¥ä½œé‡è¯„ä¼°**:
- æ•°æ®åº“å’ŒåŸºç¡€æœåŠ¡: 1-2å¤©
- PipelineEngineæ”¹é€ : 1-2å¤©
- å®šæ—¶ä»»åŠ¡å’Œç›‘æ§: 1å¤©
- æµ‹è¯•å’Œä¸Šçº¿: 0.5-1å¤©
- **æ€»è®¡: 3.5-5.5å¤©**

**ä¼˜å…ˆçº§**: P0ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
**å®æ–½é˜¶æ®µ**: Phase 2
**ä¸Šçº¿ä¾èµ–**: Phase 1å®Œæˆå

**è€ç‹çš„å»ºè®®: Phase 1ä¸Šçº¿åç«‹å³å¯åŠ¨Phase 2ï¼Œç¡®ä¿é«˜å¯ç”¨ï¼** ğŸš€

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-10-29
**æ–‡æ¡£ç»´æŠ¤äºº**: è€ç‹ï¼ˆBackend Dev Skillï¼‰
**æœ€åæ›´æ–°**: 2025-10-29
