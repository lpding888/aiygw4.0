# GEMINI.md - 服装AI处理 SaaS 平台

**沟通语言: 请使用中文与我交流。**

## 1. 项目概述

本项目是一个为服装电商卖家提供AI图片处理服务的SaaS平台。其核心功能是通过AI技术帮助用户快速处理商品图片，主要包括两大功能：基础修图（如抠图、换背景）和AI模特图生成。

项目采用前后端分离的架构：

*   **前端 (Frontend)**: 基于 **Next.js** 和 **TypeScript** 构建，为用户提供操作界面，包括登录、会员购买、上传图片、创建处理任务和查看结果等。
*   **后端 (Backend)**: 基于 **Node.js** 和 **Express.js** 构建，提供API服务，负责用户认证、订单支付、配额管理、任务调度以及与第三方AI服务和云存储的集成。
*   **云服务**:
    *   **腾讯云对象存储 (COS)**: 用于存储用户上传的原始图片和AI处理后的结果图。
    *   **腾讯数据万象 (CI)**: 用于执行基础修图任务。
    *   **RunningHub**: 一个第三方的AI服务，用于执行复杂的AI模特生成任务。

其商业模式为**会员订阅制**，用户购买会员后获得一定数量的图片处理**配额**，每次处理消耗相应配额。

## 2. 构建与运行

### 后端 (Backend)

1.  **安装依赖**:
    ```bash
    cd backend
    npm install
    ```
2.  **配置环境**:
    *   复制环境变量文件: `cp .env.example .env`
    *   编辑 `.env` 文件，填入数据库、腾讯云等配置信息。
3.  **数据库迁移**:
    ```bash
    npm run db:migrate
    ```
4.  **启动服务**:
    *   开发模式: `npm run dev`
    *   生产模式: `pm2 start ecosystem.config.js`

### 前端 (Frontend)

1.  **安装依赖**:
    ```bash
    cd frontend
    npm install
    ```
2.  **配置环境**:
    *   复制环境变量文件: `cp .env.local.example .env.local`
    *   编辑 `.env.local` 文件，填入后端API地址等信息。
3.  **启动服务**:
    *   开发模式: `npm run dev`
    *   生产模式: `npm run build && npm start`

## 3. 开发约定

根据项目文档，开发过程中需遵循以下关键约定和约束：

*   **原子性操作**:
    *   **配额管理**: 对用户配额的扣减和返还必须在数据库事务中完成，并使用行锁 (`forUpdate`) 防止并发问题导致数据不一致。
    *   **核心链路**: 支付、开通会员、增加配额、创建任务等关键流程必须作为一个整体进行联调测试，确保数据流的完整性。
*   **成本控制**:
    *   **外部API调用**: 只有当任务状态为`processing`时，才向RunningHub查询任务状态，避免在任务已完成或失败后进行不必要的轮询，以节省API调用成本。
*   **配置化**:
    *   **业务参数**: 会员套餐对应的配额数量等业务参数应通过环境变量进行配置，禁止在代码中硬编码，方便后续调整。
*   **代码规范**:
    *   项目集成了`eslint`和`prettier`，在提交代码前应执行 `npm run lint` 和 `npm run format` 来保证代码风格统一。
