# 开发规范

<cite>
**本文档引用的文件**
- [skills/backend_dev_skill/FLOW.md](file://skills/backend_dev_skill/FLOW.md)
- [skills/backend_dev_skill/CHECKLIST.md](file://skills/backend_dev_skill/CHECKLIST.md)
- [skills/backend_dev_skill/EXAMPLES.md](file://skills/backend_dev_skill/EXAMPLES.md)
- [skills/reviewer_skill/RULES.md](file://skills/reviewer_skill/RULES.md)
- [skills/reviewer_skill/CHECKLIST.md](file://skills/reviewer_skill/CHECKLIST.md)
- [skills/billing_guard_skill/RULES.md](file://skills/billing_guard_skill/RULES.md)
- [backend/src/services/quota.service.js](file://backend/src/services/quota.service.js)
- [backend/package.json](file://backend/package.json)
- [frontend/package.json](file://frontend/package.json)
- [backend/src/config/database.js](file://backend/src/config/database.js)
- [backend/knexfile.js](file://backend/knexfile.js)
- [backend/src/controllers/auth.controller.js](file://backend/src/controllers/auth.controller.js)
- [backend/src/middlewares/auth.middleware.js](file://backend/src/middlewares/auth.middleware.js)
- [deploy/README.md](file://deploy/README.md)
</cite>

## 目录
1. [概述](#概述)
2. [分支管理策略](#分支管理策略)
3. [代码提交规范](#代码提交规范)
4. [Pull Request审查流程](#pull-request审查流程)
5. [代码风格规范](#代码风格规范)
6. [AI Agent工作流](#ai-agent工作流)
7. [关键编码纪律](#关键编码纪律)
8. [安全要求](#安全要求)
9. [性能要求](#性能要求)
10. [部署和运维](#部署和运维)

## 概述

本开发规范基于项目中的AI Photo SaaS平台的实际需求和最佳实践制定，涵盖了从代码开发到部署运维的全流程规范。规范的核心目标是确保代码质量、系统安全性和业务连续性。

## 分支管理策略

### Git Flow工作流程

项目采用标准的Git Flow分支管理策略：

```mermaid
gitGraph
commit id: "初始提交"
branch develop
checkout develop
commit id: "开发分支"
branch feature/auth
checkout feature/auth
commit id: "认证功能开发"
commit id: "单元测试"
checkout develop
merge feature/auth
commit id: "合并认证功能"
checkout main
merge develop
commit id: "发布版本"
```

**图表来源**
- [skills/backend_dev_skill/FLOW.md](file://skills/backend_dev_skill/FLOW.md#L1-L99)

### 分支类型定义

| 分支类型 | 命名规范 | 用途 | 合并目标 |
|---------|---------|------|---------|
| 主分支 | `main` | 生产环境代码 | 无 |
| 开发分支 | `develop` | 集成开发代码 | main |
| 功能分支 | `feature/*` | 新功能开发 | develop |
| 修复分支 | `fix/*` | Bug修复 | develop |
| 发布分支 | `release/*` | 版本发布准备 | main+develop |
| 热修复分支 | `hotfix/*` | 生产紧急修复 | main+develop |

### Trunk-Based Development补充

对于小型功能和快速迭代，采用Trunk-Based Development模式：

- 短期功能开发直接在develop分支进行
- 频繁提交，每日合并
- 使用特性标志（Feature Flags）控制功能开关

## 代码提交规范

### Conventional Commits格式

所有提交必须遵循Conventional Commits规范：

```
<类型>[可选作用域]: <描述>

[可选正文]

[可选脚注]
```

### 提交类型定义

| 类型 | 描述 | 示例 |
|------|------|------|
| feat | 新功能 | `feat(auth): 添加手机号登录功能` |
| fix | 错误修复 | `fix(quota): 修复配额并发扣减问题` |
| docs | 文档更新 | `docs(api): 更新API接口文档` |
| style | 代码格式 | `style: 应用ESLint规则` |
| refactor | 代码重构 | `refactor(service): 优化服务层结构` |
| test | 测试相关 | `test(auth): 添加认证单元测试` |
| chore | 构建过程 | `chore(deps): 更新依赖包版本` |

### 提交消息模板

```bash
# feat(auth): 实现手机号验证码登录
#
# 详细描述：
# - 添加sendCode接口用于发送验证码
# - 实现login接口进行用户认证
# - 集成短信服务提供商
#
# 测试：
# - 单元测试覆盖所有场景
# - 集成测试验证流程完整性
# - 性能测试确保响应时间<500ms
#
# 相关Issue: #123
```

## Pull Request审查流程

### 审查流程标准

基于reviewer_skill的审查标准，PR审查必须遵循以下7个步骤：

```mermaid
flowchart TD
Start([开始审查]) --> Prepare["1. 审查准备<br/>- 分析PR描述<br/>- 搭建测试环境<br/>- 准备测试数据"]
Prepare --> FuncCheck["2. 功能逻辑<br/>- 验证业务需求<br/>- 检查数据流程<br/>- 测试边界条件"]
FuncCheck --> QualityCheck["3. 代码质量<br/>- 检查代码规范<br/>- 评估架构设计<br/>- 分析模块耦合"]
QualityCheck --> SecurityCheck["4. 安全审查<br/>- 输入验证检查<br/>- 权限控制审查<br/>- 敏感数据处理"]
SecurityCheck --> PerformanceCheck["5. 性能审查<br/>- 数据库优化<br/>- 内存使用分析<br/>- 并发处理评估"]
PerformanceCheck --> TestCheck["6. 测试审查<br/>- 测试覆盖率<br/>- 测试质量评估<br/>- 边界场景测试"]
TestCheck --> Conclusion["7. 审查结论<br/>- 问题清单整理<br/>- 改进建议提供<br/>- 最终结论给出"]
Conclusion --> End([结束])
```

**图表来源**
- [skills/reviewer_skill/FLOW.md](file://skills/reviewer_skill/FLOW.md#L1-L137)

### 审查检查清单

#### 功能完整性检查
- [ ] 业务需求是否完整实现
- [ ] 边界条件和异常场景是否处理
- [ ] 数据验证和过滤是否充分
- [ ] 用户体验是否友好

#### 安全性检查（最高优先级）
- [ ] 配额操作是否使用数据库事务
- [ ] 是否使用行锁防止并发竞争
- [ ] 配额检查逻辑是否在事务内
- [ ] 敏感信息是否加密存储
- [ ] API接口是否有适当访问控制

#### 代码质量检查
- [ ] 代码是否符合项目编码规范
- [ ] 变量和函数命名是否清晰合理
- [ ] 代码注释是否充分且有用
- [ ] 代码结构是否清晰，模块化良好

**章节来源**
- [skills/reviewer_skill/CHECKLIST.md](file://skills/reviewer_skill/CHECKLIST.md#L1-L192)

## 代码风格规范

### ESLint配置

项目使用ESLint进行JavaScript代码质量检查：

```javascript
// .eslintrc.js 示例配置
module.exports = {
  env: {
    node: true,
    es2021: true
  },
  extends: ['eslint:recommended'],
  parserOptions: {
    ecmaVersion: 12,
    sourceType: 'module'
  },
  rules: {
    'indent': ['error', 2],
    'quotes': ['error', 'single'],
    'semi': ['error', 'always'],
    'no-unused-vars': ['warn'],
    'no-console': ['warn']
  }
};
```

### Prettier格式化

使用Prettier统一代码格式：

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100
}
```

### 前端代码规范

基于Next.js项目的TypeScript规范：

| 规范类型 | 要求 | 示例 |
|---------|------|------|
| 文件命名 | kebab-case | `user-profile.tsx` |
| 组件命名 | PascalCase | `UserProfile` |
| 变量命名 | camelCase | `userProfile` |
| 接口定义 | I + PascalCase | `IUser` |
| 常量命名 | UPPER_SNAKE_CASE | `API_BASE_URL` |

### 后端代码规范

基于Express.js项目的JavaScript规范：

| 规范类型 | 要求 | 示例 |
|---------|------|------|
| 文件命名 | snake_case | `auth_controller.js` |
| 类命名 | PascalCase | `AuthController` |
| 方法命名 | camelCase | `sendCode()` |
| 常量命名 | UPPER_SNAKE_CASE | `JWT_SECRET` |
| 私有属性 | _开头 | `_privateMethod()` |

**章节来源**
- [backend/package.json](file://backend/package.json#L1-L48)
- [frontend/package.json](file://frontend/package.json#L1-L32)

## AI Agent工作流

### 后端开发工作流

基于backend_dev_skill的标准工作流程：

```mermaid
sequenceDiagram
participant Dev as 开发者
participant API as API设计
participant DB as 数据库设计
participant Service as 业务逻辑
participant Auth as 认证授权
participant Third as 第三方集成
participant Quota as 配额系统
participant Task as 任务处理
participant Error as 错误处理
Dev->>API : 1. API接口设计
API->>DB : 2. 数据库设计
DB->>Service : 3. 业务逻辑实现
Service->>Auth : 4. 认证授权系统
Auth->>Third : 5. 第三方服务集成
Third->>Quota : 6. 配额和计费系统
Quota->>Task : 7. 任务处理系统
Task->>Error : 8. 错误处理和日志
Error->>Dev : 返回最终代码
```

**图表来源**
- [skills/backend_dev_skill/FLOW.md](file://skills/backend_dev_skill/FLOW.md#L1-L99)

### 自动化协作模式

#### 配额管理自动化

配额操作必须使用事务确保原子性：

```mermaid
flowchart TD
Start([开始配额操作]) --> Lock["获取行锁<br/>FOR UPDATE"]
Lock --> CheckMember["检查会员状态"]
CheckMember --> MemberOK{"会员有效?"}
MemberOK --> |否| Error1["抛出会员错误"]
MemberOK --> |是| CheckQuota["检查配额余额"]
CheckQuota --> QuotaOK{"配额充足?"}
QuotaOK --> |否| Error2["抛出配额错误"]
QuotaOK --> |是| Deduct["原子扣减配额<br/>DECREMENT"]
Deduct --> Log["记录操作日志"]
Log --> Success["返回剩余配额"]
Error1 --> Rollback["事务回滚"]
Error2 --> Rollback
Rollback --> End([结束])
Success --> End
```

**图表来源**
- [backend/src/services/quota.service.js](file://backend/src/services/quota.service.js#L1-L130)

#### 任务创建自动化流程

基于EXAMPLES.md中的Promo Poster任务示例：

1. **入口验证**：扩展POST /task/create接口
2. **参数校验**：手机号、验证码格式验证
3. **配额预扣**：原子操作，禁止负数
4. **状态初始化**：创建任务记录，状态processing
5. **同步处理**：直接调用海报生成服务
6. **内容审核**：逐张图片审核
7. **结果落库**：更新任务状态和结果

**章节来源**
- [skills/backend_dev_skill/EXAMPLES.md](file://skills/backend_dev_skill/EXAMPLES.md#L1-L76)

## 关键编码纪律

### 事务操作规范

所有涉及数据修改的操作必须使用数据库事务：

```javascript
// 示例：用户配额扣减事务
async function deductQuota(userId, amount) {
  return await db.transaction(async (trx) => {
    // 1. 行锁查询用户
    const user = await trx('users')
      .where('id', userId)
      .forUpdate()
      .first();
    
    // 2. 业务逻辑验证
    if (!user.isMember) {
      throw new Error('非会员用户');
    }
    
    // 3. 原子操作扣减
    await trx('users')
      .where('id', userId)
      .decrement('quota_remaining', amount);
    
    return { remaining: user.quota_remaining - amount };
  });
}
```

### 敏感信息处理

#### 环境变量配置

所有敏感信息必须通过环境变量配置：

```bash
# .env.production 示例
DB_HOST=prod-db-host
DB_PORT=3306
DB_USER=prod_user
DB_PASSWORD=encrypted_password
JWT_SECRET=secure_random_string
TENCENT_SECRET_ID=your_secret_id
TENCENT_SECRET_KEY=your_secret_key
WECHAT_API_KEY=your_api_key
```

#### 密钥轮换机制

```mermaid
flowchart LR
Current["当前密钥"] --> Rotate["密钥轮换"]
Rotate --> New["新密钥生效"]
New --> Old["旧密钥废弃"]
Old --> Audit["审计记录"]
Audit --> Monitor["监控告警"]
```

### 数据库操作规范

#### 参数化查询

避免SQL注入，使用参数化查询：

```javascript
// 错误示例：直接拼接SQL
const sql = `SELECT * FROM users WHERE phone = '${phone}'`;

// 正确示例：参数化查询
const users = await db('users')
  .where('phone', phone)
  .andWhere('isMember', true);
```

#### 索引优化

为频繁查询的字段添加索引：

```sql
-- 用户表索引优化
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_quota_expire ON users(quota_expireAt);
CREATE INDEX idx_orders_user_status ON orders(userId, status);
```

**章节来源**
- [backend/src/services/quota.service.js](file://backend/src/services/quota.service.js#L1-L130)
- [backend/src/config/database.js](file://backend/src/config/database.js#L1-L10)

## 安全要求

### 认证授权系统

#### JWT Token管理

```mermaid
sequenceDiagram
participant Client as 客户端
participant Auth as 认证中间件
participant Service as 认证服务
participant DB as 数据库
Client->>Service : 登录请求
Service->>DB : 验证用户凭据
DB-->>Service : 用户信息
Service->>Service : 生成JWT Token
Service-->>Client : 返回Token
Client->>Auth : API请求 + Token
Auth->>Auth : 验证Token
Auth->>Auth : 解析用户信息
Auth-->>Client : 执行业务逻辑
```

**图表来源**
- [backend/src/middlewares/auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L1-L77)

#### 权限控制

| 权限级别 | 可访问接口 | 说明 |
|---------|-----------|------|
| 匿名用户 | POST /auth/send-code | 发送验证码 |
| 匿名用户 | POST /auth/login | 手机号登录 |
| 普通用户 | GET /auth/me | 获取用户信息 |
| 普通用户 | POST /task/create | 创建任务 |
| 普通用户 | GET /task/* | 查询任务 |
| 管理员 | GET /admin/* | 管理接口 |

### 安全防护措施

#### 输入验证

```javascript
// 验证手机号格式
if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
  return res.status(400).json({
    success: false,
    error: {
      code: 2000,
      message: '手机号格式错误'
    }
  });
}

// 验证验证码格式
if (!code || !/^\d{6}$/.test(code)) {
  return res.status(400).json({
    success: false,
    error: {
      code: 2002,
      message: '验证码格式错误'
    }
  });
}
```

#### 访问频率限制

使用express-rate-limit防止暴力攻击：

```javascript
const rateLimit = require('express-rate-limit');

// 验证码发送频率限制
const codeLimiter = rateLimit({
  windowMs: 60 * 1000, // 1分钟
  max: 5, // 最多5次
  message: '请求过于频繁，请稍后再试'
});
```

**章节来源**
- [skills/reviewer_skill/RULES.md](file://skills/reviewer_skill/RULES.md#L1-L98)
- [skills/billing_guard_skill/RULES.md](file://skills/billing_guard_skill/RULES.md#L1-L90)

## 性能要求

### API响应时间要求

| 接口类型 | 响应时间要求 | 优化策略 |
|---------|-------------|---------|
| 认证接口 | < 200ms | 缓存用户信息，优化数据库查询 |
| 业务接口 | < 500ms | 添加索引，优化SQL查询 |
| 文件上传 | < 2s | 使用CDN，分片上传 |
| 任务处理 | < 10s | 异步处理，队列机制 |

### 数据库性能优化

#### 查询优化

```sql
-- 错误示例：全表扫描
SELECT * FROM users WHERE phone LIKE '%138%';

-- 正确示例：使用索引
SELECT * FROM users WHERE phone = '13812345678';
```

#### 分页查询

```javascript
// 使用LIMIT和OFFSET进行分页
const items = await db('tasks')
  .where('userId', userId)
  .orderBy('createdAt', 'desc')
  .limit(pageSize)
  .offset((page - 1) * pageSize);
```

### 缓存策略

#### Redis缓存

```javascript
const redis = require('ioredis');
const cache = new redis();

// 缓存用户信息
async function getUserInfo(userId) {
  const cached = await cache.get(`user:${userId}`);
  if (cached) {
    return JSON.parse(cached);
  }
  
  const user = await db('users').where('id', userId).first();
  await cache.set(`user:${userId}`, JSON.stringify(user), 'EX', 3600);
  return user;
}
```

## 部署和运维

### 环境配置

#### 生产环境配置

```bash
# 生产环境变量
NODE_ENV=production
PORT=3000
DATABASE_URL=mysql://user:password@host:3306/database

# 安全配置
JWT_SECRET=production_secure_secret
COOKIE_SECRET=production_cookie_secret

# 第三方服务
TENCENT_SECRET_ID=prod_secret_id
TENCENT_SECRET_KEY=prod_secret_key
WECHAT_API_KEY=prod_api_key
```

### 监控告警

#### 系统监控指标

```mermaid
graph TB
subgraph "系统指标"
CPU["CPU使用率"]
Memory["内存使用率"]
Disk["磁盘空间"]
Network["网络流量"]
end
subgraph "应用指标"
ResponseTime["响应时间"]
ErrorRate["错误率"]
Throughput["吞吐量"]
QueueLength["队列长度"]
end
subgraph "业务指标"
TaskSuccess["任务成功率"]
UserActive["活跃用户"]
Revenue["收入统计"]
QuotaUsage["配额使用率"]
end
CPU --> Alert1["CPU告警"]
Memory --> Alert2["内存告警"]
ResponseTime --> Alert3["性能告警"]
TaskSuccess --> Alert4["业务告警"]
```

#### 健康检查

```javascript
// 健康检查接口
app.get('/health', async (req, res) => {
  try {
    // 数据库连接检查
    await db.raw('SELECT 1');
    
    // Redis连接检查
    await redis.ping();
    
    // 第三方服务检查
    const wechatStatus = await checkWeChatService();
    
    res.json({
      status: 'healthy',
      timestamp: new Date(),
      uptime: process.uptime(),
      dependencies: {
        database: 'ok',
        redis: 'ok',
        wechat: wechatStatus
      }
    });
  } catch (error) {
    res.status(503).json({
      status: 'unhealthy',
      error: error.message
    });
  }
});
```

**章节来源**
- [deploy/README.md](file://deploy/README.md#L1-L132)

## 总结

本开发规范建立了完整的代码开发、审查、部署和运维流程，确保AI Photo SaaS平台的高质量交付。规范的核心要点包括：

1. **严格的分支管理**：采用Git Flow和Trunk-Based Development相结合的策略
2. **标准化的提交流程**：遵循Conventional Commits规范
3. **全面的代码审查**：基于reviewer_skill的七步审查流程
4. **统一的代码风格**：ESLint和Prettier配置
5. **自动化协作**：基于AI Agent的工作流
6. **关键编码纪律**：事务操作、敏感信息处理
7. **严格的安全要求**：认证授权、输入验证、访问控制
8. **性能优化**：响应时间、数据库查询、缓存策略
9. **完善的监控体系**：系统指标、应用指标、业务指标

通过严格执行这些规范，确保项目的安全性、稳定性和可维护性，为用户提供优质的AI照片处理服务。