# 部署与运维

<cite>
**本文档引用的文件**  
- [ecosystem.config.js](file://backend/ecosystem.config.js)
- [package.json](file://backend/package.json)
- [knexfile.js](file://backend/knexfile.js)
- [logger.js](file://backend/src/utils/logger.js)
- [cos.js](file://backend/src/config/cos.js)
- [app.js](file://backend/src/app.js)
- [server.js](file://backend/src/server.js)
- [database.js](file://backend/src/config/database.js)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js)
- [deploy/README.md](file://deploy/README.md)
- [DEPLOY_PRODUCTION.md](file://DEPLOY_PRODUCTION.md)
- [DEPLOY_GUIDE.md](file://DEPLOY_GUIDE.md)
- [DEPLOYMENT.md](file://DEPLOYMENT.md)
- [docker-compose.prod.yml](file://docker-compose.prod.yml)
- [init-letsencrypt.sh](file://init-letsencrypt.sh)
- [nginx/conf.d/default.conf](file://nginx/conf.d/default.conf)
</cite>

## 更新摘要
**变更内容**  
- 新增Docker生产环境部署指南，涵盖Docker Compose配置、服务编排和容器管理
- 新增SSL证书配置说明，包括Let's Encrypt自动化部署和腾讯云证书配置
- 扩展数据库迁移流程，增加Docker环境下的迁移执行方法
- 更新PM2配置说明，包含针对4核4G服务器的优化参数
- 新增Nginx反向代理详细配置，包括HTTPS、健康检查和负载均衡
- 增加环境变量配置的详细说明和安全建议

## 目录

1. [生产环境部署与PM2管理](#生产环境部署与pm2管理)  
2. [环境变量配置](#环境变量配置)  
3. [日志轮转与监控](#日志轮转与监控)  
4. [Nginx反向代理与SSL部署](#nginx反向代理与ssl部署)  
5. [数据库迁移流程](#数据库迁移流程)  
6. [健康检查接口使用](#健康检查接口使用)  
7. [异常日志排查方法](#异常日志排查方法)
8. [Docker生产环境部署](#docker生产环境部署)

## 生产环境部署与PM2管理

本项目使用PM2进行后端服务的进程管理。PM2配置文件位于`backend/ecosystem.config.js`，采用集群模式运行3个实例，针对4核4G服务器进行了优化，提升服务并发处理能力与容错性。

启动服务前，请确保已安装PM2：
```bash
npm install -g pm2
```

在生产环境中，使用以下命令启动服务：
```bash
cd backend
pm2 start ecosystem.config.js --env production
pm2 save
```

常用PM2管理命令：
- `pm2 restart ai-photo-api`：重启服务
- `pm2 reload ai-photo-api`：零停机重载（适用于代码更新）
- `pm2 logs ai-photo-api`：查看实时日志
- `pm2 status`：查看服务状态
- `pm2 monit`：进入监控界面
- `pm2 startup`：设置开机自启动

服务配置说明：
- **进程名称**：`ai-photo-api`
- **脚本入口**：`./src/server.js`
- **运行模式**：`cluster`（集群模式）
- **实例数量**：3（针对4核CPU优化，留1核给系统和MySQL）
- **自动重启**：启用（`autorestart: true`）
- **内存限制**：600MB，超出则自动重启（3进程共1.8GB，留2.2GB给系统）
- **日志文件**：输出至`./logs/pm2-out.log`和`./logs/pm2-error.log`
- **日志时间格式**：`YYYY-MM-DD HH:mm:ss Z`
- **定时重启**：每天凌晨4点重启，清理内存碎片（`cron_restart: '0 4 * * *'`）
- **端口配置**：3001（避免和前端3000端口冲突）

**Section sources**  
- [ecosystem.config.js](file://backend/ecosystem.config.js#L1-L67)

## 环境变量配置

项目通过`.env`文件管理环境变量，生产环境需创建`.env`文件并填入以下关键配置：

```env
# 数据库配置
DB_HOST=your_db_host
DB_PORT=3306
DB_USER=your_db_user
DB_PASSWORD=your_strong_password_here
DB_NAME=ai_photo

# JWT配置
JWT_SECRET=your_strong_jwt_secret_key_here
JWT_EXPIRES_IN=7d

# 腾讯云配置
TENCENT_SECRET_ID=your_tencent_secret_id
TENCENT_SECRET_KEY=your_tencent_secret_key
COS_BUCKET=your_cos_bucket_name
COS_REGION=ap-guangzhou
COS_IMAGE_DOMAIN=https://your-bucket.cos.ap-guangzhou.myqcloud.com

# Redis配置
REDIS_HOST=your_redis_host
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# 应用配置
NODE_ENV=production
PORT=3000
API_DOMAIN=https://api.aizhao.icu
LOG_LEVEL=info

# 加密密钥
CREDENTIALS_ENCRYPTION_KEY=your_32bit_encryption_key
INTERNAL_CALLBACK_SECRET=your_strong_callback_secret

# 支付配置
WECHAT_APPID=your_wechat_app_id
WECHAT_MCHID=your_merchant_id
WECHAT_API_KEY=your_wechat_api_key
WECHAT_CERT_PATH=/path/to/production/cert.pem

# AI服务配置
RUNNINGHUB_API_KEY=your_runninghub_api_key
HUNYUAN_API_KEY=your_hunyuan_api_key
KUAI_API_KEY=your_kuai_api_key
```

**安全注意事项**：
- 严禁将`.env`文件提交至代码仓库
- 生产环境密钥应通过安全渠道（如密钥管理服务）分发
- 定期轮换腾讯云密钥、JWT密钥和加密密钥
- 使用`openssl rand -base64 32`或`node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`生成强随机密钥

**Section sources**  
- [DEPLOY_PRODUCTION.md](file://DEPLOY_PRODUCTION.md#L9-L137)
- [DEPLOY_GUIDE.md](file://DEPLOY_GUIDE.md#L198-L224)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L147-L195)

## 日志轮转与监控

项目使用Winston作为日志框架，配置了文件日志与控制台日志（仅开发环境）。日志文件位于`backend/logs/`目录下。

日志配置详情（`src/utils/logger.js`）：
- **错误日志**：`logs/error.log`，仅记录`error`级别日志
- **综合日志**：`logs/combined.log`，记录所有级别日志
- **单文件大小限制**：5MB
- **最大保留文件数**：5个
- **日志格式**：JSON格式，包含时间戳、服务名、堆栈信息
- **Morgan集成**：HTTP请求日志通过Winston输出

日志轮转由Winston内置机制自动处理，当日志文件达到5MB时自动创建新文件，最多保留5个历史文件。建议结合系统级日志轮转工具（如`logrotate`）进行更精细的管理。

**Section sources**  
- [logger.js](file://backend/src/utils/logger.js#L1-L41)

## Nginx反向代理与SSL部署

建议在生产环境中使用Nginx作为反向代理，实现负载均衡、SSL终止和静态资源服务。

### Nginx配置示例

```nginx
# HTTP -> HTTPS 强制跳转
server {
    listen 80;
    server_name aizhao.icu www.aizhao.icu api.aizhao.icu;
    
    # ACME验证（Let's Encrypt自动续期）
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # 其他所有请求跳转HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# 主站 HTTPS - aizhao.icu
server {
    listen 443 ssl http2;
    server_name aizhao.icu www.aizhao.icu;

    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/aizhao.icu/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/aizhao.icu/privkey.pem;

    # SSL优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # 前端页面
    location / {
        proxy_pass http://frontend_pool;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API接口
    location /api/ {
        proxy_pass http://backend_pool;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 限流：API接口每秒10个请求
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;
    }

    # 健康检查
    location /health {
        proxy_pass http://backend_pool/health;
        access_log off;
    }
}
```

### SSL证书部署
1. **Let's Encrypt免费证书（推荐）**：
   ```bash
   # 停止Nginx
   docker-compose stop nginx
   
   # 申请证书
   sudo certbot certonly --standalone -d aizhao.icu -d www.aizhao.icu
   
   # 复制证书到项目目录
   sudo cp /etc/letsencrypt/live/aizhao.icu/fullchain.pem ./docker/nginx/ssl/
   sudo cp /etc/letsencrypt/live/aizhao.icu/privkey.pem ./docker/nginx/ssl/
   
   # 重启Nginx
   docker-compose up -d nginx
   ```

2. **自动续期配置**：
   ```bash
   # 添加定时任务
   sudo crontab -e
   0 2 1 * * certbot renew --quiet && cp /etc/letsencrypt/live/aizhao.icu/*.pem /path/to/project/docker/nginx/ssl/ && docker-compose restart nginx
   ```

**Section sources**  
- [nginx/conf.d/default.conf](file://nginx/conf.d/default.conf#L1-L192)
- [init-letsencrypt.sh](file://init-letsencrypt.sh#L1-L158)

## 数据库迁移流程

项目使用Knex进行数据库迁移管理。迁移文件位于`backend/src/db/migrations/`目录。

### 执行数据库迁移

在生产环境中执行最新迁移：
```bash
cd backend
npm run db:migrate
```

该命令等价于：
```bash
knex migrate:latest
```

### Docker环境下的迁移
```bash
# 进入后端容器执行迁移
docker-compose exec backend npm run db:migrate

# 或直接运行命令
docker-compose run backend npm run db:migrate
```

### 迁移流程说明
1. **准备阶段**：确保数据库连接配置正确（通过环境变量）
2. **备份阶段**：执行迁移前务必备份生产数据库
3. **执行迁移**：运行`npm run db:migrate`
4. **验证阶段**：检查服务日志，确认迁移成功
5. **回滚机制**：如需回滚，可使用`npm run db:rollback`

**注意事项**：
- 生产环境迁移应在低峰期进行
- 每次迁移前必须进行完整数据库备份
- 建议在测试环境先行验证迁移脚本
- 迁移过程中数据库连接池配置已优化，生产环境`min: 5, max: 20`

**Section sources**  
- [package.json](file://backend/package.json#L10-L12)
- [knexfile.js](file://backend/knexfile.js#L57-L78)
- [database.js](file://backend/src/config/database.js#L1-L107)

## 健康检查接口使用

系统提供健康检查接口，用于服务状态监控和负载均衡健康探测。

### 健康检查接口
- **路径**：`GET /health`
- **响应示例**：
  ```json
  {
    "status": "ok",
    "timestamp": "2025-10-28T00:00:00.000Z",
    "env": "production"
  }
  ```

### 使用场景
1. **Nginx健康探测**：配置Nginx定期访问`/health`接口
2. **云服务商健康检查**：在腾讯云等平台配置HTTP健康检查
3. **自动化监控**：通过脚本定期调用接口并告警
4. **CI/CD流程**：部署后自动验证服务可用性

该接口不进行数据库连接等复杂检查，确保响应快速，避免因健康检查本身导致性能问题。

**Section sources**  
- [app.js](file://backend/src/app.js#L30-L35)

## 异常日志排查方法

当服务出现异常时，应按以下步骤进行排查：

### 1. 查看PM2进程状态
```bash
pm2 status
```
确认服务是否正在运行，是否有频繁重启（可能因内存溢出或未捕获异常）。

### 2. 检查实时日志
```bash
pm2 logs ai-photo-api --lines 200
```
重点关注：
- 启动错误
- 未捕获的异常（`uncaughtException`）
- 未处理的Promise拒绝（`unhandledRejection`）
- 数据库连接失败
- JWT验证失败

### 3. 分析Winston日志文件
日志文件位于`backend/logs/`目录：
- `error.log`：查看所有错误级别日志
- `combined.log`：查看完整请求上下文
- `pm2-out.log` 和 `pm2-error.log`：PM2进程输出日志

### 4. 常见问题排查
- **服务无法启动**：检查端口占用、环境变量配置、数据库连接
- **API响应慢**：检查数据库查询性能、外部API调用延迟
- **内存持续增长**：可能存在内存泄漏，检查大文件处理、缓存机制
- **频繁重启**：检查`max_memory_restart`设置，分析内存使用情况

### 5. 关键日志路径
- **错误日志**：`backend/logs/error.log`
- **综合日志**：`backend/logs/combined.log`
- **PM2输出日志**：`backend/logs/pm2-out.log`
- **PM2错误日志**：`backend/logs/pm2-error.log`

**Section sources**  
- [logger.js](file://backend/src/utils/logger.js#L1-L41)
- [server.js](file://backend/src/server.js#L30-L40)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L1-L45)

## Docker生产环境部署

### 系统要求
- **硬件配置**：4核CPU，4GB内存，50GB硬盘（SSD优先），3Mbps带宽
- **软件环境**：Ubuntu 20.04+/CentOS 7+/Debian 10+，Docker 20.10+，Docker Compose 2.0+

### 快速部署
```bash
# 1. 克隆代码
git clone <your-repo-url>
cd <your-project-directory>

# 2. 配置环境变量
cd backend
cp .env.example .env
vim .env  # 必须填写真实配置

# 3. 返回项目根目录
cd ..

# 4. 一键启动所有服务
docker-compose -f docker-compose.prod.yml up -d

# 5. 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 6. 运行数据库迁移
docker-compose -f docker-compose.prod.yml exec backend npm run db:migrate

# 7. 查看日志
docker-compose -f docker-compose.prod.yml logs -f backend
```

### Docker Compose配置
`docker-compose.prod.yml`文件定义了完整的生产环境服务编排：
- **Nginx**：反向代理，端口80/443
- **Certbot**：Let's Encrypt证书自动化申请和续期
- **Backend**：后端服务，端口3000
- **Frontend**：前端服务，通过Nginx代理
- **MySQL**：数据库，端口3306（仅本地访问）
- **Redis**：缓存，端口6379（仅本地访问）

### SSL证书自动化
使用`init-letsencrypt.sh`脚本实现SSL证书的自动化配置：
```bash
# 修改脚本中的域名和邮箱
vim init-letsencrypt.sh

# 执行SSL证书申请
chmod +x init-letsencrypt.sh
./init-letsencrypt.sh
```

脚本会自动完成以下步骤：
1. 创建必要目录
2. 下载SSL配置
3. 生成DH参数
4. 创建临时证书
5. 启动Nginx
6. 申请Let's Encrypt证书
7. 重启Nginx
8. 配置自动续期（每12小时检查一次）

### 运维操作
```bash
# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f

# 重启服务
docker-compose -f docker-compose.prod.yml restart

# 更新代码
git pull
docker-compose -f docker-compose.prod.yml build backend
docker-compose -f docker-compose.prod.yml up -d backend
docker-compose -f docker-compose.prod.yml exec backend npm run db:migrate

# 数据库备份
docker-compose -f docker-compose.prod.yml exec mysql mysqldump -u root -p${DB_PASSWORD} ai_photo > backup_$(date +%Y%m%d_%H%M%S).sql

# 停止服务
docker-compose -f docker-compose.prod.yml down
```

**Section sources**  
- [docker-compose.prod.yml](file://docker-compose.prod.yml#L1-L200)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L33-L61)
- [DEPLOY_GUIDE.md](file://DEPLOY_GUIDE.md#L280-L324)
- [init-letsencrypt.sh](file://init-letsencrypt.sh#L1-L158)