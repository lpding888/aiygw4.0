# 认证接口API文档

<cite>
**本文档中引用的文件**
- [auth.controller.js](file://backend/src/controllers/auth.controller.js)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js)
- [auth.routes.js](file://backend/src/routes/auth.routes.js)
- [auth.service.js](file://backend/src/services/auth.service.js)
- [generator.js](file://backend/src/utils/generator.js)
- [app.js](file://backend/src/app.js)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js)
- [create_users_table.js](file://backend/src/db/migrations/20251028000001_create_users_table.js)
- [create_verification_codes_table.js](file://backend/src/db/migrations/2025102800004_create_verification_codes_table.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目架构概览](#项目架构概览)
3. [核心接口详解](#核心接口详解)
4. [认证机制](#认证机制)
5. [数据模型](#数据模型)
6. [错误处理](#错误处理)
7. [使用示例](#使用示例)
8. [故障排除](#故障排除)
9. [总结](#总结)

## 简介

本文档详细描述了AI照片编辑平台的认证接口系统，包括验证码发送、用户登录注册以及用户信息获取等功能。系统采用手机号+验证码的方式进行身份验证，支持JWT令牌认证机制，具备完善的防刷限制和错误处理机制。

## 项目架构概览

```mermaid
graph TB
subgraph "客户端层"
Web[Web客户端]
Mobile[移动端]
end
subgraph "API网关层"
Express[Express服务器]
CORS[CORS中间件]
Helmet[安全中间件]
Logger[日志中间件]
end
subgraph "路由层"
AuthRoutes[认证路由]
MemberRoutes[会员路由]
MediaRoutes[媒体路由]
TaskRoutes[任务路由]
end
subgraph "控制器层"
AuthController[认证控制器]
MemberController[会员控制器]
MediaController[媒体控制器]
TaskController[任务控制器]
end
subgraph "服务层"
AuthService[认证服务]
MemberService[会员服务]
MediaService[媒体服务]
TaskService[任务服务]
end
subgraph "中间件层"
AuthMiddleware[认证中间件]
ErrorHandler[错误处理中间件]
end
subgraph "数据层"
MySQL[(MySQL数据库)]
Redis[(Redis缓存)]
end
Web --> Express
Mobile --> Express
Express --> CORS
Express --> Helmet
Express --> Logger
Express --> AuthRoutes
Express --> MemberRoutes
Express --> MediaRoutes
Express --> TaskRoutes
AuthRoutes --> AuthController
MemberRoutes --> MemberController
MediaRoutes --> MediaController
TaskRoutes --> TaskController
AuthController --> AuthService
MemberController --> MemberService
MediaController --> MediaService
TaskController --> TaskService
AuthController --> AuthMiddleware
AuthController --> ErrorHandler
AuthService --> MySQL
AuthService --> Redis
```

**图表来源**
- [app.js](file://backend/src/app.js#L1-L52)
- [auth.routes.js](file://backend/src/routes/auth.routes.js#L1-L28)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L1-L100)

## 核心接口详解

### 接口概览

| 接口路径 | HTTP方法 | 访问权限 | 描述 |
|---------|----------|----------|------|
| `/api/auth/send-code` | POST | 公开 | 发送手机验证码 |
| `/api/auth/login` | POST | 公开 | 手机号验证码登录/注册 |
| `/api/auth/me` | GET | 受保护 | 获取当前用户信息 |

### POST /api/auth/send-code - 发送验证码

#### 接口描述
向指定手机号发送6位数字验证码，用于后续登录或注册操作。系统实施严格的防刷限制机制。

#### 请求参数

| 参数名 | 类型 | 必填 | 描述 | 格式要求 |
|--------|------|------|------|----------|
| phone | string | 是 | 手机号码 | 11位中国大陆手机号，以1开头 |

#### 请求体结构 (JSON Schema)
```json
{
  "type": "object",
  "properties": {
    "phone": {
      "type": "string",
      "pattern": "^1[3-9]\\d{9}$",
      "description": "中国大陆手机号码"
    }
  },
  "required": ["phone"]
}
```

#### 响应格式

**成功响应 (200 OK)**
```json
{
  "success": true,
  "data": {
    "expireIn": 300
  },
  "message": "验证码已发送"
}
```

**失败响应 (400 Bad Request)**
```json
{
  "success": false,
  "error": {
    "code": 2000,
    "message": "手机号格式错误"
  }
}
```

#### 验证码发送流程

```mermaid
sequenceDiagram
participant Client as 客户端
participant Controller as 认证控制器
participant Service as 认证服务
participant DB as 数据库
participant SMS as 短信服务
Client->>Controller : POST /api/auth/send-code
Controller->>Controller : 验证手机号格式
Controller->>Service : sendCode(phone, ip)
Service->>Service : 检查防刷限制
Service->>Service : 生成6位验证码
Service->>DB : 保存验证码记录
Service->>SMS : 发送短信验证码
SMS-->>Service : 发送结果
Service-->>Controller : 返回过期时间
Controller-->>Client : 成功响应
Note over Service,DB : 验证码5分钟有效
Note over Service,SMS : 支持腾讯云短信服务
```

**图表来源**
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L8-L35)
- [auth.service.js](file://backend/src/services/auth.service.js#L10-L45)

#### 防刷限制机制

系统实施双重防刷策略：

1. **同一手机号限制**：1分钟内最多5次请求
2. **同一IP限制**：1小时内最多20次请求

**节来源**
- [auth.service.js](file://backend/src/services/auth.service.js#L47-L75)

### POST /api/auth/login - 登录/注册

#### 接口描述
使用手机号和验证码进行登录或自动注册新用户，成功后返回JWT访问令牌。

#### 请求参数

| 参数名 | 类型 | 必填 | 描述 | 格式要求 |
|--------|------|------|------|----------|
| phone | string | 是 | 手机号码 | 11位中国大陆手机号 |
| code | string | 是 | 验证码 | 6位数字 |

#### 请求体结构 (JSON Schema)
```json
{
  "type": "object",
  "properties": {
    "phone": {
      "type": "string",
      "pattern": "^1[3-9]\\d{9}$"
    },
    "code": {
      "type": "string",
      "pattern": "^\\d{6}$"
    }
  },
  "required": ["phone", "code"]
}
```

#### 响应格式

**成功响应 (200 OK)**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "abc123def456",
      "phone": "13800138000",
      "isMember": false,
      "quota_remaining": 0,
      "quota_expireAt": null
    }
  }
}
```

**失败响应 (400 Bad Request)**
```json
{
  "success": false,
  "error": {
    "code": 2001,
    "message": "验证码错误或已过期"
  }
}
```

#### 登录流程

```mermaid
flowchart TD
Start([开始登录]) --> ValidatePhone["验证手机号格式"]
ValidatePhone --> PhoneValid{"手机号有效?"}
PhoneValid --> |否| PhoneError["返回手机号错误"]
PhoneValid --> |是| ValidateCode["验证验证码格式"]
ValidateCode --> CodeValid{"验证码有效?"}
CodeValid --> |否| CodeError["返回验证码错误"]
CodeValid --> |是| VerifyCode["验证验证码有效性"]
VerifyCode --> CodeExists{"验证码存在且未过期?"}
CodeExists --> |否| CodeInvalid["返回验证码无效"]
CodeExists --> |是| CheckUser["检查用户是否存在"]
CheckUser --> UserExists{"用户已存在?"}
UserExists --> |否| CreateUser["创建新用户"]
UserExists --> |是| LoadUser["加载用户信息"]
CreateUser --> LoadUser
LoadUser --> MarkUsed["标记验证码已使用"]
MarkUsed --> GenerateToken["生成JWT令牌"]
GenerateToken --> Success["返回登录成功"]
PhoneError --> End([结束])
CodeError --> End
CodeInvalid --> End
Success --> End
```

**图表来源**
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L37-L70)
- [auth.service.js](file://backend/src/services/auth.service.js#L106-L180)

**节来源**
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L37-L70)
- [auth.service.js](file://backend/src/services/auth.service.js#L106-L180)

### GET /api/auth/me - 获取用户信息

#### 接口描述
获取当前已认证用户的详细信息，需要有效的JWT访问令牌。

#### 请求头
| 头部名称 | 值 | 描述 |
|----------|-----|------|
| Authorization | Bearer {token} | JWT访问令牌 |

#### 响应格式

**成功响应 (200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "abc123def456",
    "phone": "13800138000",
    "isMember": false,
    "quota_remaining": 0,
    "quota_expireAt": null,
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

**失败响应 (401 Unauthorized)**
```json
{
  "success": false,
  "error": {
    "code": 1001,
    "message": "未登录"
  }
}
```

**节来源**
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L72-L85)

## 认证机制

### JWT令牌系统

系统采用JSON Web Token (JWT) 进行无状态认证，支持令牌的生成、验证和刷新。

#### 令牌结构
```json
{
  "userId": "abc123def456",
  "phone": "13800138000",
  "iat": 1640995200,
  "exp": 1641595200
}
```

#### 令牌生成策略

```mermaid
classDiagram
class JWTConfig {
+string JWT_SECRET
+string JWT_EXPIRE
+generateToken(userId, phone) string
+verifyToken(token) object
}
class AuthService {
+login(phone, code) Promise~Object~
+getUser(userId) Promise~Object~
-verifyCode(phone, code) Promise~void~
-checkRateLimit(phone, ip) Promise~void~
}
class AuthController {
+sendCode(req, res, next) Promise~void~
+login(req, res, next) Promise~void~
+getMe(req, res, next) Promise~void~
}
JWTConfig <-- AuthService : 使用
AuthService <-- AuthController : 调用
```

**图表来源**
- [auth.service.js](file://backend/src/services/auth.service.js#L155-L170)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L6-L51)

#### 认证中间件工作流程

```mermaid
sequenceDiagram
participant Client as 客户端
participant Middleware as 认证中间件
participant JWT as JWT验证器
participant Controller as 控制器
Client->>Middleware : 请求 + Authorization头
Middleware->>Middleware : 提取Bearer Token
Middleware->>JWT : 验证JWT签名
JWT-->>Middleware : 解码后的用户信息
Middleware->>Middleware : 将用户信息附加到req对象
Middleware->>Controller : 继续处理请求
Controller-->>Client : 响应结果
Note over Middleware,JWT : 验证失败时返回401错误
Note over Middleware,Controller : 用户信息存储在req.userId和req.user
```

**图表来源**
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L6-L51)

**节来源**
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L6-L77)

## 数据模型

### 用户表 (users)

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | string(32) | PRIMARY KEY | 用户唯一标识符 |
| phone | string(11) | UNIQUE, NOT NULL | 手机号码 |
| isMember | boolean | DEFAULT false | 是否为会员 |
| quota_remaining | integer | DEFAULT 0 | 剩余使用配额 |
| quota_expireAt | datetime | NULLABLE | 配额到期时间 |
| created_at | timestamp | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 验证码表 (verification_codes)

| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | integer | AUTO_INCREMENT, PRIMARY KEY | 自增主键 |
| phone | string(11) | NOT NULL | 手机号码 |
| code | string(6) | NOT NULL | 验证码 |
| ip | string(45) | NULLABLE | 请求IP地址 |
| expireAt | datetime | NOT NULL | 验证码过期时间 |
| used | boolean | DEFAULT false | 是否已使用 |
| created_at | timestamp | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**节来源**
- [create_users_table.js](file://backend/src/db/migrations/20251028000001_create_users_table.js#L4-L15)
- [create_verification_codes_table.js](file://backend/src/db/migrations/20251028000004_create_verification_codes_table.js#L4-L15)

## 错误处理

### 错误代码定义

| 错误代码 | HTTP状态码 | 描述 | 场景 |
|----------|------------|------|------|
| 1001 | 401 | 未登录/Token无效 | JWT认证失败 |
| 2000 | 400 | 手机号格式错误 | 手机号格式不正确 |
| 2001 | 400 | 验证码错误 | 验证码不存在或已过期 |
| 2002 | 400 | 验证码格式错误 | 验证码格式不正确 |
| 2004 | 429 | 频繁请求 | 手机号验证码发送过于频繁 |
| 2005 | 429 | 频繁请求 | IP地址请求过于频繁 |
| 1004 | 404 | 用户不存在 | 查询的用户不存在 |

### 错误响应格式

```json
{
  "success": false,
  "error": {
    "code": 2000,
    "message": "手机号格式错误"
  }
}
```

### 错误处理流程

```mermaid
flowchart TD
Request[接收请求] --> Validate[参数验证]
Validate --> ValidOK{"验证通过?"}
ValidOK --> |否| ValidationError[返回400错误]
ValidOK --> |是| Process[业务处理]
Process --> ProcessOK{"处理成功?"}
ProcessOK --> |否| BusinessError[返回业务错误]
ProcessOK --> |是| Success[返回成功响应]
ValidationError --> ErrorResponse[错误响应]
BusinessError --> ErrorResponse
Success --> SuccessResponse[成功响应]
ErrorResponse --> LogError[记录错误日志]
SuccessResponse --> LogSuccess[记录成功日志]
```

**图表来源**
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L6-L25)

**节来源**
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L1-L46)

## 使用示例

### curl命令示例

#### 1. 发送验证码
```bash
# 发送验证码到指定手机号
curl -X POST https://api.aizhao.icu/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000"
  }'

# 响应示例
{
  "success": true,
  "data": {
    "expireIn": 300
  },
  "message": "验证码已发送"
}
```

#### 2. 使用验证码登录
```bash
# 使用验证码登录
curl -X POST https://api.aizhao.icu/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "code": "123456"
  }'

# 登录成功响应
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "abc123def456",
      "phone": "13800138000",
      "isMember": false,
      "quota_remaining": 0,
      "quota_expireAt": null
    }
  }
}
```

#### 3. 获取用户信息
```bash
# 获取当前用户信息
curl -X GET https://api.aizhao.icu/api/auth/me \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# 用户信息响应
{
  "success": true,
  "data": {
    "id": "abc123def456",
    "phone": "13800138000",
    "isMember": false,
    "quota_remaining": 0,
    "quota_expireAt": null,
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

### 完整认证流程示例

```mermaid
sequenceDiagram
participant User as 用户
participant Frontend as 前端应用
participant API as 认证API
participant SMS as 短信服务
participant DB as 数据库
User->>Frontend : 输入手机号
Frontend->>API : POST /api/auth/send-code
API->>API : 验证手机号格式
API->>DB : 检查防刷限制
API->>SMS : 发送验证码短信
SMS-->>API : 发送成功
API-->>Frontend : 返回验证码发送成功
Frontend-->>User : 显示输入验证码界面
User->>Frontend : 输入收到的验证码
Frontend->>API : POST /api/auth/login
API->>DB : 验证验证码有效性
API->>DB : 创建/查询用户
API->>DB : 标记验证码已使用
API->>API : 生成JWT令牌
API-->>Frontend : 返回访问令牌和用户信息
Frontend->>Frontend : 存储JWT令牌
Frontend-->>User : 登录成功，显示主页
Note over User,DB : 后续请求携带JWT令牌
Frontend->>API : GET /api/auth/me (带Authorization头)
API-->>Frontend : 返回用户信息
```

**图表来源**
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L8-L85)
- [auth.service.js](file://backend/src/services/auth.service.js#L10-L180)

## 故障排除

### 常见问题及解决方案

#### 1. 手机号格式错误 (错误代码: 2000)
**问题描述**: 提供的手机号不符合中国大陆手机号格式要求。

**解决方案**:
- 确保手机号为11位数字
- 确保手机号以1开头（13-19范围）
- 移除任何分隔符（如空格、破折号）

**调试建议**:
```javascript
// 验证手机号格式的正则表达式
const phoneRegex = /^1[3-9]\d{9}$/;
console.log(phoneRegex.test("13800138000")); // true
```

#### 2. 验证码错误或已过期 (错误代码: 2001)
**问题描述**: 验证码不存在、已过期或已被使用。

**解决方案**:
- 确认收到的验证码是否正确
- 确保在验证码有效期内（5分钟）使用
- 避免重复使用同一个验证码

**调试建议**:
```sql
-- 检查验证码状态
SELECT * FROM verification_codes 
WHERE phone = '13800138000' 
AND code = '123456'
AND used = false
AND expireAt > NOW();
```

#### 3. 验证码发送过于频繁 (错误代码: 2004)
**问题描述**: 同一手机号在1分钟内发送超过5次验证码。

**解决方案**:
- 等待至少1分钟后重试
- 检查是否有多个客户端同时请求
- 考虑增加验证码有效期

#### 4. 请求过于频繁 (错误代码: 2005)
**问题描述**: 同一IP地址在1小时内发送超过20次验证码。

**解决方案**:
- 检查是否有爬虫或恶意请求
- 实施更严格的IP限制策略
- 考虑使用验证码图片验证

#### 5. JWT认证失败 (错误代码: 1001)
**问题描述**: JWT令牌无效、已过期或格式不正确。

**解决方案**:
- 检查Authorization头格式是否为"Bearer {token}"
- 验证JWT_SECRET配置是否正确
- 检查令牌是否已过期
- 重新登录获取新的访问令牌

**调试建议**:
```javascript
// 验证JWT令牌
const jwt = require('jsonwebtoken');
try {
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  console.log('令牌有效:', decoded);
} catch (error) {
  console.error('令牌验证失败:', error.message);
}
```

### 日志分析

系统提供了详细的日志记录功能，可通过以下方式分析问题：

#### 关键日志位置
- **开发环境**: 控制台输出
- **生产环境**: `./logs/`目录下的日志文件

#### 常见日志模式
```bash
# 验证码发送成功
[INFO] 验证码已发送: phone=13800138000, ip=127.0.0.1

# 用户登录成功
[INFO] 用户登录成功: userId=abc123def456, phone=13800138000

# 新用户注册
[INFO] 新用户注册: userId=xyz789uvw210, phone=13900139000

# JWT验证失败
[ERROR] JWT验证失败: JsonWebTokenError: invalid signature
```

**节来源**
- [auth.service.js](file://backend/src/services/auth.service.js#L30-L35)
- [auth.service.js](file://backend/src/services/auth.service.js#L185-L190)

## 总结

本文档详细介绍了AI照片编辑平台的认证接口系统，涵盖了从验证码发送到用户登录的完整流程。系统具有以下特点：

### 核心特性
1. **手机号+验证码认证**: 简单易用的身份验证方式
2. **完善的防刷机制**: 双重限制防止恶意请求
3. **JWT令牌认证**: 无状态的认证机制
4. **自动用户注册**: 无需手动注册的新用户处理
5. **详细的错误处理**: 清晰的错误信息和状态码

### 安全考虑
- 验证码5分钟有效期
- 防刷限制机制
- JWT令牌签名验证
- HTTPS传输加密

### 扩展性
- 支持多种短信服务商集成
- 可扩展的用户信息字段
- 灵活的配额管理系统

该认证系统为整个平台提供了安全可靠的身份验证基础，支持后续的功能扩展和业务发展需求。