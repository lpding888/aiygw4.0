# 核心功能模块

<cite>
**本文档引用的文件**  
- [auth.service.js](file://backend/src/services/auth.service.js)
- [membership.service.js](file://backend/src/services/membership.service.js)
- [task.service.js](file://backend/src/services/task.service.js)
- [quota.service.js](file://backend/src/services/quota.service.js)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js)
- [membership.controller.js](file://backend/src/controllers/membership.controller.js)
- [task.controller.js](file://backend/src/controllers/task.controller.js)
- [auth.routes.js](file://backend/src/routes/auth.routes.js)
- [membership.routes.js](file://backend/src/routes/membership.routes.js)
- [task.routes.js](file://backend/src/routes/task.routes.js)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js)
- [20251028000001_create_users_table.js](file://backend/src/db/migrations/20251028000001_create_users_table.js)
- [20251028000002_create_orders_table.js](file://backend/src/db/migrations/20251028000002_create_orders_table.js)
- [20251028000003_create_tasks_table.js](file://backend/src/db/migrations/20251028000003_create_tasks_table.js)
</cite>

## 目录
1. [认证模块](#认证模块)
2. [会员模块](#会员模块)
3. [任务模块](#任务模块)
4. [配额模块](#配额模块)
5. [模块依赖关系](#模块依赖关系)

## 认证模块

认证模块负责用户的身份验证与登录流程，采用手机号+验证码的无密码登录机制，并通过JWT实现会话管理。该模块确保用户安全访问系统资源。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant AuthController as AuthController
participant AuthService as AuthService
participant 数据库 as 数据库
前端->>AuthController : POST /api/auth/send-code
AuthController->>AuthService : sendCode(phone, ip)
AuthService->>AuthService : checkRateLimit()
AuthService->>数据库 : 插入验证码记录
AuthService->>AuthService : sendSMS()
AuthService-->>AuthController : 返回 expireIn
AuthController-->>前端 : {success : true, data : {expireIn}}
前端->>AuthController : POST /api/auth/login
AuthController->>AuthService : login(phone, code)
AuthService->>数据库 : 查询验证码记录
AuthService->>数据库 : 查询或创建用户
AuthService->>AuthService : verifyCode()
AuthService->>AuthService : 生成JWT token
AuthService-->>AuthController : 返回 token 和用户信息
AuthController-->>前端 : {success : true, data : {token, user}}
```

**图示来源**  
- [auth.service.js](file://backend/src/services/auth.service.js#L1-L220)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L1-L100)
- [auth.routes.js](file://backend/src/routes/auth.routes.js#L1-L28)

**本节来源**  
- [auth.service.js](file://backend/src/services/auth.service.js#L1-L220)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L1-L100)

## 会员模块

会员模块处理用户的支付购买流程、会员状态管理和自动续期逻辑。通过订单系统与支付渠道对接，确保会员服务的开通与到期管理。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant MembershipController as MembershipController
participant MembershipService as MembershipService
participant 数据库 as 数据库
前端->>MembershipController : POST /api/membership/purchase
MembershipController->>MembershipService : purchase(userId, channel)
MembershipService->>数据库 : 创建订单记录
MembershipService->>MembershipService : getPaymentParams()
MembershipService-->>MembershipController : 返回 orderId 和 payParams
MembershipController-->>前端 : {success : true, data : {orderId, payParams}}
支付平台->>MembershipController : POST /api/membership/payment-callback
MembershipController->>MembershipService : handlePaymentCallback()
MembershipService->>数据库 : 查询订单
MembershipService->>数据库 : 开启事务
数据库->>数据库 : 更新订单状态为 paid
数据库->>数据库 : 更新用户为会员并设置配额
MembershipService-->>MembershipController : success
MembershipController-->>支付平台 : {success : true}
```

**图示来源**  
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)
- [membership.controller.js](file://backend/src/controllers/membership.controller.js#L1-L78)
- [membership.routes.js](file://backend/src/routes/membership.routes.js#L1-L28)

**本节来源**  
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)
- [membership.controller.js](file://backend/src/controllers/membership.controller.js#L1-L78)

## 任务模块

任务模块管理AI处理任务的全生命周期，包括创建、查询、状态更新和清理。支持不同类型的任务（如基础修图、AI模特），并与配额系统紧密集成。

```mermaid
flowchart TD
A[创建任务] --> B{验证参数}
B --> |无效| C[返回错误]
B --> |有效| D{检查会员状态}
D --> |非会员| E[提示开通会员]
D --> |会员| F[调用配额服务扣减]
F --> |失败| G[返回配额不足]
F --> |成功| H[创建任务记录]
H --> I{任务类型}
I --> |basic_clean| J[异步处理基础修图]
I --> |model_pose12| K[提交至AI模型服务]
H --> L[返回任务ID]
M[获取任务详情] --> N{权限检查}
N --> |非本人| O[拒绝访问]
N --> |本人| P[返回任务数据]
Q[更新任务状态] --> R{是否失败}
R --> |是| S[调用配额返还]
R --> |否| T[更新状态]
```

**图示来源**  
- [task.service.js](file://backend/src/services/task.service.js#L1-L259)
- [task.controller.js](file://backend/src/controllers/task.controller.js#L1-L173)
- [task.routes.js](file://backend/src/routes/task.routes.js#L1-L24)

**本节来源**  
- [task.service.js](file://backend/src/services/task.service.js#L1-L259)
- [task.controller.js](file://backend/src/controllers/task.controller.js#L1-L173)

## 配额模块

配额模块确保用户在使用AI服务时的资源消耗受控，通过事务性操作保证配额扣减的原子性和非负性约束。支持任务失败时的自动返还机制。

```mermaid
classDiagram
class QuotaService {
+deduct(userId, amount)
+refund(userId, amount, reason)
+getQuota(userId)
+checkQuota(userId, amount)
}
class TaskService {
+create()
+get()
+updateStatus()
+list()
}
class MembershipService {
+handlePaymentCallback()
}
QuotaService <|-- TaskService : 使用
QuotaService <|-- MembershipService : 使用
note right of QuotaService
关键特性：
- 扣减使用事务+行锁
- 确保 quota_remaining ≥ 0
- 支持失败返还
end note
```

**图示来源**  
- [quota.service.js](file://backend/src/services/quota.service.js#L1-L130)
- [task.service.js](file://backend/src/services/task.service.js#L1-L259)
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)

**本节来源**  
- [quota.service.js](file://backend/src/services/quota.service.js#L1-L130)

## 模块依赖关系

各核心模块之间存在明确的依赖关系，形成完整的业务闭环。认证模块为其他模块提供身份基础，会员模块驱动配额发放，任务模块消费配额资源。

```mermaid
graph TD
A[认证模块] --> |提供用户身份| B[会员模块]
A --> |提供用户身份| C[任务模块]
A --> |提供用户身份| D[配额模块]
B --> |开通会员| D[配额模块]
B --> |更新用户状态| E[用户表]
C --> |创建任务| D[配额模块]
C --> |任务失败| D[配额返还]
C --> |任务记录| F[任务表]
D --> |读写| E[用户表]
B --> |读写| G[订单表]
H[前端] --> A
H --> B
H --> C
```

**图示来源**  
- [auth.service.js](file://backend/src/services/auth.service.js#L1-L220)
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)
- [task.service.js](file://backend/src/services/task.service.js#L1-L259)
- [quota.service.js](file://backend/src/services/quota.service.js#L1-L130)
- [20251028000001_create_users_table.js](file://backend/src/db/migrations/20251028000001_create_users_table.js#L1-L24)
- [20251028000002_create_orders_table.js](file://backend/src/db/migrations/20251028000002_create_orders_table.js#L1-L31)
- [20251028000003_create_tasks_table.js](file://backend/src/db/migrations/20251028000003_create_tasks_table.js#L1-L34)

**本节来源**  
- [auth.service.js](file://backend/src/services/auth.service.js#L1-L220)
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)
- [task.service.js](file://backend/src/services/task.service.js#L1-L259)
- [quota.service.js](file://backend/src/services/quota.service.js#L1-L130)