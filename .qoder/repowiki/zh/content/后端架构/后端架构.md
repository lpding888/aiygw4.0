# 后端架构

<cite>
**本文档引用的文件**
- [app.js](file://backend/src/app.js)
- [server.js](file://backend/src/server.js)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js)
- [auth.routes.js](file://backend/src/routes/auth.routes.js)
- [membership.routes.js](file://backend/src/routes/membership.routes.js)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js)
- [membership.controller.js](file://backend/src/controllers/membership.controller.js)
- [auth.service.js](file://backend/src/services/auth.service.js)
- [membership.service.js](file://backend/src/services/membership.service.js)
- [database.js](file://backend/src/config/database.js)
- [knexfile.js](file://backend/knexfile.js)
- [logger.js](file://backend/src/utils/logger.js)
- [generator.js](file://backend/src/utils/generator.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细描述了基于Express框架的MVC分层后端系统架构。系统采用清晰的职责分离设计，包含控制器（controllers）、服务层（services）和数据访问层（Knex），并集成JWT认证机制。文档重点说明中间件加载顺序、服务启动逻辑、路由分发机制以及认证流程在整个架构中的贯穿方式。

## 项目结构

```mermaid
graph TD
subgraph "配置"
database["config/database.js"]
knexfile["knexfile.js"]
end
subgraph "控制器"
authController["controllers/auth.controller.js"]
membershipController["controllers/membership.controller.js"]
end
subgraph "中间件"
authMiddleware["middlewares/auth.middleware.js"]
errorHandlerMiddleware["middlewares/errorHandler.middleware.js"]
end
subgraph "路由"
authRoutes["routes/auth.routes.js"]
membershipRoutes["routes/membership.routes.js"]
end
subgraph "服务"
authService["services/auth.service.js"]
membershipService["services/membership.service.js"]
end
subgraph "工具"
logger["utils/logger.js"]
generator["utils/generator.js"]
end
app["app.js"] --> authRoutes
app --> membershipRoutes
app --> authMiddleware
app --> errorHandlerMiddleware
app --> logger
authRoutes --> authController
membershipRoutes --> membershipController
authController --> authService
membershipController --> membershipService
authService --> database
membershipService --> database
database --> knexfile
authService --> generator
membershipService --> generator
```

**图示来源**
- [app.js](file://backend/src/app.js#L1-L50)
- [auth.routes.js](file://backend/src/routes/auth.routes.js#L1-L10)
- [membership.routes.js](file://backend/src/routes/membership.routes.js#L1-L10)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L1-L10)
- [membership.controller.js](file://backend/src/controllers/membership.controller.js#L1-L10)

**本节来源**
- [app.js](file://backend/src/app.js#L1-L50)
- [server.js](file://backend/src/server.js#L1-L10)

## 核心组件

系统采用标准的MVC架构模式，各层职责明确：
- **控制器（controllers）**：协调HTTP请求与响应，处理输入验证
- **服务层（services）**：封装核心业务逻辑，确保可重用性和事务一致性
- **数据访问层**：通过Knex执行数据库操作，实现数据持久化
- **中间件（middlewares）**：提供认证、错误处理等横切关注点功能

JWT认证机制贯穿整个请求处理流程，确保接口安全性。

**本节来源**
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L1-L100)
- [auth.service.js](file://backend/src/services/auth.service.js#L1-L50)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L1-L20)

## 架构概览

```mermaid
graph TB
Client[客户端] --> |HTTP请求| Server[Express服务器]
subgraph "中间件层"
Helmet[安全头]
CORS[CORS配置]
BodyParser[请求解析]
Logger[日志记录]
Auth[JWT认证]
Error[全局错误处理]
end
subgraph "路由层"
AuthRoutes[认证路由]
MembershipRoutes[会员路由]
end
subgraph "控制器层"
AuthController[认证控制器]
MembershipController[会员控制器]
end
subgraph "服务层"
AuthService[认证服务]
MembershipService[会员服务]
end
subgraph "数据层"
Database[(MySQL数据库)]
Knex[Knex查询构建器]
end
Server --> Helmet
Server --> CORS
Server --> BodyParser
Server --> Logger
Logger --> |写入| LogFile[(日志文件)]
Logger --> AuthRoutes
AuthRoutes --> AuthController
AuthController --> AuthService
AuthService --> Knex
Knex --> Database
Auth --> AuthController
Error --> |捕获异常| AuthController
MembershipController --> MembershipService
MembershipService --> Knex
```

**图示来源**
- [app.js](file://backend/src/app.js#L1-L50)
- [server.js](file://backend/src/server.js#L1-L40)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L1-L75)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L1-L45)

## 详细组件分析

### 认证流程分析

#### 认证中间件工作流程
```mermaid
sequenceDiagram
participant Client as "客户端"
participant App as "Express应用"
participant AuthMiddleware as "auth.middleware"
participant JWT as "JWT验证"
participant Controller as "控制器"
participant Service as "服务层"
Client->>App : 发送请求 (Authorization : Bearer token)
App->>AuthMiddleware : 执行authenticate中间件
AuthMiddleware->>JWT : 提取并验证Token
alt Token有效
JWT-->>AuthMiddleware : 返回解码的用户信息
AuthMiddleware->>App : 将用户信息附加到req对象
App->>Controller : 调用目标控制器方法
Controller->>Service : 调用业务逻辑
Service-->>Controller : 返回结果
Controller-->>Client : 返回响应
else Token无效
JWT-->>AuthMiddleware : 抛出验证错误
AuthMiddleware->>Client : 返回401未授权
end
```

**图示来源**
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L1-L75)
- [auth.routes.js](file://backend/src/routes/auth.routes.js#L15-L25)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L60-L80)

### 路由与控制器分析

#### 请求分发流程
```mermaid
flowchart TD
Start([HTTP请求]) --> ParseURL["解析URL路径"]
ParseURL --> MatchRoute{"匹配路由规则?"}
MatchRoute --> |是| ExecuteMiddleware["执行路由中间件"]
ExecuteMiddleware --> AuthCheck{"需要认证?"}
AuthCheck --> |是| JWTValidation["验证JWT Token"]
JWTValidation --> |有效| ExecuteController["执行控制器方法"]
JWTValidation --> |无效| Return401["返回401未授权"]
AuthCheck --> |否| ExecuteController
ExecuteController --> CallService["调用服务层方法"]
CallService --> |成功| ReturnSuccess["返回200成功"]
CallService --> |失败| ThrowError["抛出异常"]
ThrowError --> GlobalError["全局错误处理器"]
GlobalError --> ReturnError["返回错误响应"]
Return401 --> End([响应])
ReturnSuccess --> End
ReturnError --> End
```

**图示来源**
- [app.js](file://backend/src/app.js#L25-L35)
- [auth.routes.js](file://backend/src/routes/auth.routes.js#L1-L25)
- [auth.controller.js](file://backend/src/controllers/auth.controller.js#L1-L100)

### 服务层职责分析

#### 业务逻辑封装
```mermaid
classDiagram
class AuthService {
+sendCode(phone, ip) Promise~object~
+login(phone, code) Promise~object~
+getUser(userId) Promise~object~
-checkRateLimit(phone, ip) Promise~void~
-verifyCode(phone, code) Promise~void~
-sendSMS(phone, code) Promise~void~
}
class MembershipService {
+purchase(userId, channel) Promise~object~
+handlePaymentCallback(data) Promise~void~
+getStatus(userId) Promise~object~
-getPaymentParams(orderId, amount, channel) Promise~object~
-verifySignature(data, channel) Promise~boolean~
}
class DatabaseManager {
+knex : Knex
+transaction(callback) Promise~void~
}
AuthService --> DatabaseManager : "使用"
MembershipService --> DatabaseManager : "使用"
AuthService --> Generator : "使用"
MembershipService --> Generator : "使用"
Generator --> crypto : "Node.js加密模块"
```

**图示来源**
- [auth.service.js](file://backend/src/services/auth.service.js#L1-L220)
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L190)
- [database.js](file://backend/src/config/database.js#L1-L10)
- [generator.js](file://backend/src/utils/generator.js#L1-L57)

**本节来源**
- [auth.service.js](file://backend/src/services/auth.service.js#L1-L220)
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L190)
- [database.js](file://backend/src/config/database.js#L1-L10)

## 依赖分析

```mermaid
graph LR
app["app.js"] --> express["express"]
app --> cors["cors"]
app --> helmet["helmet"]
app --> morgan["morgan"]
app --> logger["logger.js"]
app --> authRoutes["auth.routes.js"]
app --> membershipRoutes["membership.routes.js"]
app --> errorHandler["errorHandler.middleware.js"]
authRoutes --> authController["auth.controller.js"]
authRoutes --> authMiddleware["auth.middleware.js"]
authController --> authService["auth.service.js"]
authController --> logger
authService --> database["database.js"]
authService --> jwt["jsonwebtoken"]
authService --> generator["generator.js"]
authService --> logger
database --> knex["knex"]
database --> knexfile["knexfile.js"]
membershipController --> membershipService["membership.service.js"]
membershipService --> database
membershipService --> generator
membershipService --> logger
```

**图示来源**
- [app.js](file://backend/src/app.js#L1-L50)
- [package.json](file://backend/package.json#L1-L48)
- [knexfile.js](file://backend/knexfile.js#L1-L47)

**本节来源**
- [app.js](file://backend/src/app.js#L1-L50)
- [package.json](file://backend/package.json#L1-L48)
- [knexfile.js](file://backend/knexfile.js#L1-L47)

## 性能考虑

系统在设计时考虑了多项性能优化措施：
- 使用连接池管理数据库连接，避免频繁创建销毁连接
- 实现验证码发送频率限制，防止恶意刷单
- 采用异步非阻塞I/O操作，提高并发处理能力
- 配置适当的请求体大小限制，防止大文件上传导致内存溢出
- 使用Winston日志库进行结构化日志记录，便于后续分析

生产环境建议监控数据库连接数、API响应时间和错误率等关键指标。

## 故障排除指南

常见问题及解决方案：

1. **JWT认证失败**
   - 检查`JWT_SECRET`环境变量是否正确配置
   - 确认客户端发送的Token格式正确（Bearer token）
   - 验证Token是否已过期

2. **数据库连接失败**
   - 检查数据库连接配置（host、port、user、password）
   - 确认数据库服务正在运行
   - 验证网络连接是否正常

3. **路由无法访问**
   - 确认路由路径拼写正确
   - 检查中间件是否阻止了请求
   - 查看服务器启动日志确认路由已正确加载

4. **服务启动失败**
   - 检查端口是否被占用
   - 验证环境变量配置
   - 查看错误日志定位具体问题

**本节来源**
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js#L1-L75)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L1-L45)
- [logger.js](file://backend/src/utils/logger.js#L1-L42)
- [server.js](file://backend/src/server.js#L1-L40)

## 结论

本系统采用清晰的MVC分层架构，实现了良好的职责分离。Express应用通过`app.js`配置中间件和路由，`server.js`负责服务启动和生命周期管理。JWT认证机制通过`auth.middleware.js`在路由层面统一处理，确保接口安全性。控制器层协调请求响应，服务层封装核心业务逻辑，Knex提供可靠的数据库操作能力。整个架构具有良好的可维护性、可扩展性和安全性，适合持续迭代开发。