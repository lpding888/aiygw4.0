# 会员服务

<cite>
**本文档引用的文件**
- [membership.service.js](file://backend/src/services/membership.service.js)
- [membership.controller.js](file://backend/src/controllers/membership.controller.js)
- [membership.routes.js](file://backend/src/routes/membership.routes.js)
- [create_orders_table.js](file://backend/src/db/migrations/20251028000002_create_orders_table.js)
- [generator.js](file://backend/src/utils/generator.js)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js)
- [auth.middleware.js](file://backend/src/middlewares/auth.middleware.js)
- [membership.page.tsx](file://frontend/src/app/membership/page.tsx)
- [api.ts](file://frontend/src/lib/api.ts)
</cite>

## 目录
1. [简介](#简介)
2. [系统架构](#系统架构)
3. [核心组件分析](#核心组件分析)
4. [会员购买流程](#会员购买流程)
5. [支付回调处理机制](#支付回调处理机制)
6. [会员状态管理](#会员状态管理)
7. [支付安全与验证](#支付安全与验证)
8. [异常处理机制](#异常处理机制)
9. [性能优化考虑](#性能优化考虑)
10. [故障排除指南](#故障排除指南)

## 简介

会员服务是本系统的核心商业模块，提供基于订阅模式的会员购买、支付处理和配额管理功能。系统采用微信支付和支付宝双渠道支付方案，支持自动化的会员开通、配额分配和到期管理。

### 主要特性

- **双渠道支付支持**：兼容微信支付和支付宝支付
- **自动化会员管理**：自动开通会员、分配配额、设置有效期
- **幂等性保障**：确保支付回调的重复处理不会产生副作用
- **自动降级机制**：会员到期后自动降级为普通用户
- **实时状态查询**：提供会员状态的实时查询接口

## 系统架构

```mermaid
graph TB
subgraph "前端层"
FP[会员页面]
API[API客户端]
end
subgraph "控制器层"
MC[会员控制器]
AM[认证中间件]
end
subgraph "服务层"
MS[会员服务]
QS[配额服务]
end
subgraph "数据层"
DB[(数据库)]
Orders[订单表]
Users[用户表]
end
subgraph "支付网关"
WX[微信支付]
ALI[支付宝]
end
FP --> API
API --> MC
MC --> AM
MC --> MS
MS --> QS
MS --> DB
DB --> Orders
DB --> Users
MS --> WX
MS --> ALI
```

**图表来源**
- [membership.controller.js](file://backend/src/controllers/membership.controller.js#L1-L78)
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)
- [membership.routes.js](file://backend/src/routes/membership.routes.js#L1-L28)

## 核心组件分析

### 会员服务类 (MembershipService)

会员服务是整个会员系统的核心，负责处理会员购买、支付参数生成、支付回调处理和会员状态管理。

```mermaid
classDiagram
class MembershipService {
+purchase(userId, channel) Promise~Object~
+getPaymentParams(orderId, amount, channel) Promise~Object~
+handlePaymentCallback(callbackData) Promise~Object~
+getStatus(userId) Promise~Object~
-verifySignature(data, channel) Promise~void~
}
class Database {
+orders Table
+users Table
+insert(orderData) Promise~void~
+update(query, data) Promise~void~
+transaction(callback) Promise~void~
}
class Generator {
+generateOrderId() string
+generateId(length) string
}
MembershipService --> Database : "使用"
MembershipService --> Generator : "依赖"
```

**图表来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L6-L191)
- [generator.js](file://backend/src/utils/generator.js#L30-L40)

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)

### 数据库架构

系统使用两个核心表来支撑会员功能：

| 表名 | 字段 | 类型 | 描述 |
|------|------|------|------|
| orders | id | string(32) | 订单唯一标识符 |
| orders | userId | string(32) | 关联用户ID |
| orders | status | string(20) | 订单状态(pending/paid) |
| orders | amount | decimal(10,2) | 订单金额(分) |
| orders | channel | string(20) | 支付渠道(wx/alipay) |
| orders | transactionId | string(64) | 第三方交易号 |
| orders | createdAt | datetime | 订单创建时间 |
| orders | paidAt | datetime | 支付完成时间 |

**章节来源**
- [create_orders_table.js](file://backend/src/db/migrations/20251028000002_create_orders_table.js#L1-L31)

## 会员购买流程

会员购买流程是一个完整的端到端流程，从订单创建到支付完成的全过程。

```mermaid
sequenceDiagram
participant User as 用户
participant Frontend as 前端页面
participant Controller as 控制器
participant Service as 会员服务
participant DB as 数据库
participant Payment as 支付网关
User->>Frontend : 选择支付方式
Frontend->>Controller : POST /api/membership/purchase
Controller->>Controller : 验证用户身份
Controller->>Service : purchase(userId, channel)
Service->>Service : 获取价格和配额配置
Service->>DB : 创建待支付订单
Service->>Service : 生成支付参数
Service-->>Controller : 返回订单ID和支付参数
Controller-->>Frontend : 返回支付信息
Frontend-->>User : 显示支付二维码
User->>Payment : 扫码支付
Payment->>Controller : 回调通知
Controller->>Service : handlePaymentCallback()
Service->>Service : 验证签名
Service->>DB : 更新订单状态
Service->>DB : 开通会员
Service-->>Controller : 处理完成
Controller-->>Payment : 确认接收
```

**图表来源**
- [membership.controller.js](file://backend/src/controllers/membership.controller.js#L10-L35)
- [membership.service.js](file://backend/src/services/membership.service.js#L12-L37)

### 订单创建与支付参数生成

购买流程的第一步是创建订单并生成支付参数：

1. **价格与配额配置**：从环境变量读取会员价格和配额配置
2. **订单创建**：生成唯一订单ID，插入待支付状态订单
3. **支付参数生成**：根据支付渠道生成相应的支付参数

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L12-L37)

### 支付参数模拟实现

系统目前使用模拟支付参数，实际生产环境中需要集成真实的支付SDK：

```mermaid
flowchart TD
Start([开始支付参数生成]) --> CheckChannel{检查支付渠道}
CheckChannel --> |微信支付| GenerateWX[生成微信支付参数]
CheckChannel --> |支付宝| GenerateALI[生成支付宝参数]
CheckChannel --> |其他| Error[返回不支持错误]
GenerateWX --> WXTimestamp[生成时间戳]
GenerateWX --> WXNonce[生成随机字符串]
GenerateWX --> WXPackage[生成prepay_id]
GenerateWX --> WXSign[生成签名]
GenerateALI --> ALIMethod[生成支付方法]
GenerateALI --> ALIAppId[添加应用ID]
GenerateALI --> ALIOrderNo[添加订单号]
WXTimestamp --> Return[返回支付参数]
WXNonce --> Return
WXPackage --> Return
WXSign --> Return
ALIMethod --> Return
ALIAppId --> Return
ALIOrderNo --> Return
Error --> End([结束])
Return --> End
```

**图表来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L47-L75)

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L47-L75)

## 支付回调处理机制

支付回调处理是会员系统的关键环节，需要确保支付结果的准确性和系统的稳定性。

### 幂等性控制

系统实现了严格的幂等性控制，防止重复回调导致的重复处理：

```mermaid
flowchart TD
Start([接收支付回调]) --> ExtractData[提取回调数据]
ExtractData --> VerifyOrder{订单是否存在?}
VerifyOrder --> |否| OrderNotFound[返回订单不存在错误]
VerifyOrder --> |是| CheckStatus{订单状态检查}
CheckStatus --> |已支付| AlreadyPaid[返回已处理消息]
CheckStatus --> |待支付| ProcessCallback[处理回调]
ProcessCallback --> StartTransaction[开启数据库事务]
StartTransaction --> UpdateOrder[更新订单状态]
UpdateOrder --> GetQuota[获取配额配置]
GetQuota --> OpenMembership[开通会员]
OpenMembership --> CommitTransaction[提交事务]
CommitTransaction --> Success[返回成功]
OrderNotFound --> End([结束])
AlreadyPaid --> End
Success --> End
```

**图表来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L86-L133)

### 事务性会员开通

会员开通过程使用数据库事务确保数据一致性：

1. **订单状态更新**：将订单状态从"待支付"更新为"已支付"
2. **配额配置获取**：从环境变量读取配额和有效期配置
3. **会员开通**：更新用户表，设置会员状态和配额信息

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L86-L133)

### 自动降级机制

系统实现了智能的会员自动降级机制：

```mermaid
stateDiagram-v2
[*] --> Active : 会员激活
Active --> Expired : 到期检查
Expired --> Downgraded : 自动降级
Downgraded --> [*] : 状态更新
Active --> Active : 继续使用
Expired --> Expired : 保持降级状态
```

**图表来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L135-L189)

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L135-L189)

## 会员状态管理

会员状态管理提供了完整的会员生命周期管理功能。

### 状态查询接口

状态查询接口返回详细的会员信息：

| 字段 | 类型 | 描述 |
|------|------|------|
| isMember | boolean | 是否为会员 |
| quota_remaining | number | 剩余配额数量 |
| quota_expireAt | string \| null | 配额到期时间 |
| expireDays | number | 剩余有效天数 |
| price | number | 会员价格(分) |

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L135-L189)

### 前端状态同步

前端通过定期轮询获取最新的会员状态：

```mermaid
sequenceDiagram
participant Frontend as 前端组件
participant API as API客户端
participant Controller as 控制器
participant Service as 服务
loop 每3秒轮询
Frontend->>API : 调用会员状态接口
API->>Controller : GET /api/membership/status
Controller->>Service : getStatus(userId)
Service->>Service : 查询用户状态
Service->>Service : 检查到期状态
Service-->>Controller : 返回状态信息
Controller-->>API : 返回响应
API-->>Frontend : 更新UI状态
end
```

**图表来源**
- [membership.page.tsx](file://frontend/src/app/membership/page.tsx#L44-L93)
- [api.ts](file://frontend/src/lib/api.ts#L60-L65)

**章节来源**
- [membership.page.tsx](file://frontend/src/app/membership/page.tsx#L44-L93)

## 支付安全与验证

### 签名验证机制

虽然当前实现为TODO状态，但系统预留了支付签名验证的扩展点：

```mermaid
flowchart TD
Callback[支付回调到达] --> ExtractSign[提取签名信息]
ExtractSign --> SelectKey[选择验证密钥]
SelectKey --> VerifySign{验证签名}
VerifySign --> |成功| ProcessCallback[处理回调]
VerifySign --> |失败| RejectCallback[拒绝回调]
ProcessCallback --> UpdateOrder[更新订单]
RejectCallback --> LogError[记录错误]
```

**图表来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L86-L88)

### 支付安全最佳实践

1. **签名验证**：验证支付平台返回的数据完整性
2. **金额校验**：确认支付金额与订单金额一致
3. **商户号验证**：确保回调来自正确的商户
4. **重复处理防护**：通过订单状态实现幂等性

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L86-L88)

## 异常处理机制

系统实现了完善的异常处理机制，确保各种异常情况都能得到妥善处理。

### 错误分类与处理

| 错误类型 | HTTP状态码 | 错误代码 | 处理方式 |
|----------|------------|----------|----------|
| 订单不存在 | 404 | 5002 | 返回订单不存在错误 |
| 支付渠道错误 | 400 | 5003 | 返回支付渠道不支持错误 |
| 用户不存在 | 404 | 1004 | 返回用户不存在错误 |
| 系统内部错误 | 500 | 9999 | 记录日志并返回通用错误 |

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L89-L100)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L1-L46)

### 异常场景处理

```mermaid
flowchart TD
Exception[发生异常] --> ErrorHandler[全局错误处理器]
ErrorHandler --> LogError[记录错误日志]
LogError --> CheckType{检查异常类型}
CheckType --> |业务异常| BusinessError[返回业务错误]
CheckType --> |系统异常| SystemError[返回系统错误]
CheckType --> |认证异常| AuthError[返回认证错误]
BusinessError --> ClientResponse[返回客户端响应]
SystemError --> ClientResponse
AuthError --> ClientResponse
ClientResponse --> End([结束])
```

**图表来源**
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L5-L25)

**章节来源**
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L1-L46)

## 性能优化考虑

### 数据库优化

1. **索引设计**：为订单表的关键字段建立适当索引
2. **查询优化**：使用适当的查询条件减少扫描范围
3. **连接池管理**：合理配置数据库连接池参数

### 缓存策略

虽然当前实现没有缓存，但可以考虑以下缓存策略：
- 用户会员状态缓存
- 支付配置信息缓存
- 订单状态查询缓存

### 并发控制

1. **事务隔离**：使用适当的事务隔离级别
2. **行级锁**：在关键操作中使用行级锁
3. **乐观锁**：在高并发场景下使用乐观锁策略

## 故障排除指南

### 常见问题与解决方案

#### 支付回调处理失败

**问题现象**：支付成功但会员未开通

**排查步骤**：
1. 检查支付回调URL是否正确配置
2. 验证回调数据格式是否符合支付平台要求
3. 检查数据库事务是否正常提交
4. 查看服务日志中的错误信息

**解决方案**：
- 确保回调接口的幂等性实现
- 添加更详细的日志记录
- 实现回调重试机制

#### 会员状态查询异常

**问题现象**：会员状态查询返回错误

**排查步骤**：
1. 检查用户ID是否有效
2. 验证数据库连接状态
3. 检查用户表结构是否正确

**解决方案**：
- 添加用户存在性检查
- 实现降级处理逻辑
- 提供默认状态返回

#### 支付参数生成失败

**问题现象**：无法生成支付参数

**排查步骤**：
1. 检查环境变量配置
2. 验证支付SDK集成状态
3. 检查网络连接状态

**解决方案**：
- 完善支付SDK集成
- 添加备用支付方案
- 实现支付参数缓存

### 监控与告警

建议实施以下监控指标：

1. **支付成功率**：监控支付回调的成功率
2. **订单处理延迟**：监控订单处理的平均时间
3. **会员开通成功率**：监控会员开通的成功率
4. **系统错误率**：监控系统异常的发生频率

**章节来源**
- [membership.service.js](file://backend/src/services/membership.service.js#L1-L191)
- [errorHandler.middleware.js](file://backend/src/middlewares/errorHandler.middleware.js#L1-L46)