# AIè¡£æŸœåç«¯ - å®Œå…¨ä½¿ç”¨è¯´æ˜ï¼ˆé›¶åŸºç¡€ç‰ˆï¼‰

è‰¹ï¼è€ç‹æˆ‘ç»™ä½ ä»å¤´åˆ°å°¾è®²æ¸…æ¥šè¿™ä¸ªåç«¯æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæ€ä¹ˆç”¨ï¼

---

## ğŸ“š ç›®å½•

1. [è¿™ä¸ªåç«¯æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ](#è¿™ä¸ªåç«¯æ˜¯å¹²ä»€ä¹ˆçš„)
2. [æ•´ä½“æ¶æ„ï¼ˆä½ éœ€è¦çŸ¥é“çš„ï¼‰](#æ•´ä½“æ¶æ„)
3. [å¿«é€Ÿå¯åŠ¨ï¼ˆ5åˆ†é’Ÿä¸Šæ‰‹ï¼‰](#å¿«é€Ÿå¯åŠ¨)
4. [æ ¸å¿ƒåŠŸèƒ½è¯¦è§£](#æ ¸å¿ƒåŠŸèƒ½è¯¦è§£)
5. [APIæ¥å£å¤§å…¨](#apiæ¥å£å¤§å…¨)
6. [æ•°æ®åº“ç»“æ„](#æ•°æ®åº“ç»“æ„)
7. [å¸¸è§é—®é¢˜è§£ç­”](#å¸¸è§é—®é¢˜è§£ç­”)

---

## è¿™ä¸ªåç«¯æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ

### ä¸€å¥è¯æ¦‚æ‹¬
**è¿™æ˜¯ä¸€ä¸ªAIå›¾ç‰‡/è§†é¢‘å¤„ç†å¹³å°çš„åç«¯æœåŠ¡ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ å›¾ç‰‡ï¼Œé€šè¿‡AIç”Ÿæˆå„ç§æ•ˆæœï¼ˆæ¢è£…ã€è§†é¢‘ç­‰ï¼‰ã€‚**

### ä¸»è¦åŠŸèƒ½
1. **ç”¨æˆ·ç³»ç»Ÿ**ï¼šæ‰‹æœºéªŒè¯ç ç™»å½•ã€ä¼šå‘˜ç®¡ç†
2. **ä»»åŠ¡å¤„ç†**ï¼šAIå›¾ç‰‡/è§†é¢‘ç”Ÿæˆï¼ˆè°ƒç”¨ç¬¬ä¸‰æ–¹AIæœåŠ¡ï¼‰
3. **ä¼šå‘˜å……å€¼**ï¼šè´­ä¹°ä¼šå‘˜ã€é…é¢ç®¡ç†
4. **åˆ†é”€ç³»ç»Ÿ**ï¼šæ¨èè¿”ä½£ã€æç°
5. **å†…å®¹ç®¡ç†**ï¼šå…¬å‘Šã€è½®æ’­å›¾ã€ä¼šå‘˜æƒç›Š
6. **åå°ç®¡ç†**ï¼šåŠŸèƒ½é…ç½®ã€æ•°æ®ç›‘æ§

---

## æ•´ä½“æ¶æ„

### æŠ€æœ¯æ ˆï¼ˆä½ ä¸éœ€è¦æ·±å…¥äº†è§£ï¼Œä½†è¦çŸ¥é“ï¼‰

```
åç«¯æ¡†æ¶ï¼šNode.js + Expressï¼ˆå¤„ç†HTTPè¯·æ±‚ï¼‰
æ•°æ®åº“ï¼šMySQLï¼ˆå­˜å‚¨ç”¨æˆ·ã€ä»»åŠ¡æ•°æ®ï¼‰
ç¼“å­˜ï¼šRedisï¼ˆéªŒè¯ç ã€Sessionï¼‰
å¯¹è±¡å­˜å‚¨ï¼šè…¾è®¯äº‘COSï¼ˆå­˜å‚¨å›¾ç‰‡/è§†é¢‘ï¼‰
AIæœåŠ¡ï¼šRunningHubï¼ˆç¬¬ä¸‰æ–¹AIå¤„ç†ï¼‰
```

### ç›®å½•ç»“æ„ï¼ˆè‰¹ï¼è¿™ä¸ªå¾ˆé‡è¦ï¼‰

```
backend/
â”œâ”€â”€ src/                          # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ routes/                   # è·¯ç”±ï¼ˆAPIæ¥å£å®šä¹‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ auth.routes.js        # è®¤è¯ç›¸å…³ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰
â”‚   â”‚   â”œâ”€â”€ task.routes.js        # ä»»åŠ¡ç›¸å…³ï¼ˆåˆ›å»ºä»»åŠ¡ã€æŸ¥è¯¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ membership.routes.js  # ä¼šå‘˜ç›¸å…³ï¼ˆè´­ä¹°ã€æŸ¥è¯¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ distribution.routes.js # åˆ†é”€ç›¸å…³ï¼ˆæ¨èã€æç°ï¼‰
â”‚   â”‚   â””â”€â”€ ...                   # å…¶ä»–è·¯ç”±
â”‚   â”‚
â”‚   â”œâ”€â”€ controllers/              # æ§åˆ¶å™¨ï¼ˆå¤„ç†è¯·æ±‚é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ auth.controller.js    # è®¤è¯é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ task.controller.js    # ä»»åŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                 # æœåŠ¡ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ auth.service.js       # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ task.service.js       # ä»»åŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ pipelineEngine.service.js  # Pipelineæ‰§è¡Œå¼•æ“ï¼ˆé‡è¦ï¼ï¼‰
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/                # AIæœåŠ¡æä¾›å•†ï¼ˆè°ƒç”¨ç¬¬ä¸‰æ–¹AIï¼‰
â”‚   â”‚   â”œâ”€â”€ runninghub.provider.js # RunningHub AI
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ db/migrations/            # æ•°æ®åº“è¿ç§»ï¼ˆè¡¨ç»“æ„å®šä¹‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ 20251028000001_create_users_table.js
â”‚   â”‚   â”œâ”€â”€ 20251028000003_create_tasks_table.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ database.js           # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”œâ”€â”€ redis.js              # Redisé…ç½®
â”‚   â”‚   â””â”€â”€ cos.js                # å¯¹è±¡å­˜å‚¨é…ç½®
â”‚   â”‚
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ logger.js             # æ—¥å¿—
â”‚       â”œâ”€â”€ jwt.ts                # JWTè®¤è¯
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ tests/                        # æµ‹è¯•ä»£ç 
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
â”œâ”€â”€ package.json                  # ä¾èµ–åŒ…é…ç½®
â”œâ”€â”€ docker-compose.dev.yml        # Dockeré…ç½®ï¼ˆMySQLã€Redisï¼‰
â””â”€â”€ README*.md                    # å„ç§è¯´æ˜æ–‡æ¡£
```

---

## å¿«é€Ÿå¯åŠ¨

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–

```bash
cd backend
npm install
```

### æ­¥éª¤2ï¼šå¯åŠ¨æ•°æ®åº“ï¼ˆä½¿ç”¨Dockerï¼‰

**å‰æï¼šå®‰è£…Docker Desktop**

```bash
# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..

# å¯åŠ¨MySQLã€Redisã€MinIO
docker-compose -f docker-compose.dev.yml up -d

# æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ
docker ps
```

**åº”è¯¥çœ‹åˆ°3ä¸ªå®¹å™¨ï¼š**
- `ai-photo-mysql-dev` - MySQLæ•°æ®åº“
- `ai-photo-redis-dev` - Redisç¼“å­˜
- `ai-photo-minio-dev` - MinIOå¯¹è±¡å­˜å‚¨

### æ­¥éª¤3ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd backend

# åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨
npm run db:migrate
```

**é¢„æœŸè¾“å‡ºï¼š**
```
Using environment: development
Batch 1 run: 20 migrations
âœ“ æ•°æ®åº“è¿ç§»å®Œæˆ
```

### æ­¥éª¤4ï¼šé…ç½®ç¯å¢ƒå˜é‡

**`.env`æ–‡ä»¶å·²ç»é…ç½®å¥½äº†ï¼Œä½†ä½ éœ€è¦äº†è§£ï¼š**

```bash
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=dev_password_123
DB_NAME=ai_photo

# JWTå¯†é’¥ï¼ˆè®¤è¯ç”¨ï¼‰
JWT_SECRET=docker_dev_secret_key_for_testing_only_32chars

# ç«¯å£
PORT=3001
```

### æ­¥éª¤5ï¼šå¯åŠ¨åç«¯æœåŠ¡

```bash
npm run dev
```

**æˆåŠŸå¯åŠ¨çš„æ ‡å¿—ï¼š**
```
[SERVER] ğŸš€ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
[SERVER] ğŸŒ ç«¯å£: 3001
[SERVER] ğŸ”— URL: http://localhost:3001
```

### æ­¥éª¤6ï¼šæµ‹è¯•API

**æµè§ˆå™¨è®¿é—®ï¼š**
```
http://localhost:3001/health
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```json
{
  "status": "ok",
  "timestamp": "2025-11-01T12:00:00.000Z"
}
```

---

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. è®¤è¯ç³»ç»Ÿï¼ˆæ‰‹æœºéªŒè¯ç ç™»å½•ï¼‰

**å·¥ä½œæµç¨‹ï¼š**

```
ç”¨æˆ·è¾“å…¥æ‰‹æœºå·
  â†’ å‘é€éªŒè¯ç ï¼ˆPOST /api/auth/send-codeï¼‰
  â†’ æ”¶åˆ°6ä½éªŒè¯ç ï¼ˆçŸ­ä¿¡/å¼€å‘ç¯å¢ƒçœ‹æ—¥å¿—ï¼‰
  â†’ è¾“å…¥éªŒè¯ç ç™»å½•ï¼ˆPOST /api/auth/loginï¼‰
  â†’ è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆå¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼‰
  â†’ è¿”å›Token
  â†’ åç»­è¯·æ±‚å¸¦ä¸ŠTokenè®¿é—®å—ä¿æŠ¤æ¥å£
```

**å…³é”®æ–‡ä»¶ï¼š**
- `src/routes/auth.routes.js` - è®¤è¯è·¯ç”±
- `src/controllers/auth.controller.js` - è®¤è¯é€»è¾‘
- `src/services/auth.service.js` - è®¤è¯æœåŠ¡
- `src/middlewares/auth.middleware.js` - TokenéªŒè¯

### 2. ä»»åŠ¡å¤„ç†ç³»ç»Ÿï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼ï¼‰

**ä»€ä¹ˆæ˜¯ä»»åŠ¡ï¼Ÿ**
- ç”¨æˆ·ä¸Šä¼ ä¸€å¼ å›¾ç‰‡
- é€‰æ‹©ä¸€ä¸ªAIåŠŸèƒ½ï¼ˆå¦‚"AIæ¢è£…"ï¼‰
- åç«¯åˆ›å»ºä»»åŠ¡ï¼Œè°ƒç”¨AIæœåŠ¡å¤„ç†
- å¤„ç†å®Œæˆåè¿”å›ç»“æœå›¾ç‰‡/è§†é¢‘

**Pipelineå¼•æ“ï¼ˆé‡è¦ï¼ï¼‰**

```
ç”¨æˆ·è¯·æ±‚
  â†’ åˆ›å»ºTaskï¼ˆsrc/services/task.service.jsï¼‰
  â†’ æ‰§è¡ŒPipelineï¼ˆsrc/services/pipelineEngine.service.jsï¼‰
  â†’ è°ƒç”¨Providerï¼ˆsrc/providers/runninghub.provider.jsï¼‰
  â†’ AIå¤„ç†
  â†’ ä¸Šä¼ ç»“æœåˆ°COS
  â†’ æ›´æ–°TaskçŠ¶æ€
  â†’ é€šçŸ¥ç”¨æˆ·
```

**å…³é”®æ¦‚å¿µï¼š**

- **Featureï¼ˆåŠŸèƒ½ï¼‰**ï¼šå¦‚"AIæ¢è£…"ã€"ç”Ÿæˆè§†é¢‘"
- **Pipelineï¼ˆæµæ°´çº¿ï¼‰**ï¼šä¸€ä¸ªFeatureçš„æ‰§è¡Œæ­¥éª¤
  - Step 1: å›¾ç‰‡é¢„å¤„ç†
  - Step 2: è°ƒç”¨AI
  - Step 3: åå¤„ç†
- **Providerï¼ˆæä¾›å•†ï¼‰**ï¼šå®é™…æ‰§è¡ŒAIçš„ç¬¬ä¸‰æ–¹æœåŠ¡
- **FORK/JOINï¼ˆå¹¶è¡Œï¼‰**ï¼šå¤šä¸ªAIåŒæ—¶å¤„ç†ï¼Œæé«˜é€Ÿåº¦

**å…³é”®æ–‡ä»¶ï¼š**
- `src/routes/task.routes.js` - ä»»åŠ¡è·¯ç”±
- `src/services/task.service.js` - ä»»åŠ¡ç®¡ç†
- `src/services/pipelineEngine.service.js` - Pipelineå¼•æ“
- `src/providers/runninghub.provider.js` - AIæä¾›å•†

### 3. ä¼šå‘˜ç³»ç»Ÿ

**æµç¨‹ï¼š**
```
ç”¨æˆ·è´­ä¹°ä¼šå‘˜
  â†’ åˆ›å»ºè®¢å•ï¼ˆPOST /api/membership/purchaseï¼‰
  â†’ è°ƒç”¨æ”¯ä»˜æ¥å£
  â†’ æ”¯ä»˜æˆåŠŸå›è°ƒ
  â†’ å¼€é€šä¼šå‘˜
  â†’ èµ é€é…é¢ï¼ˆå¦‚100æ¬¡ï¼‰
```

**é…é¢ç®¡ç†ï¼š**
- æ¯æ¬¡AIå¤„ç†æ¶ˆè€—é…é¢
- é…é¢ä¸è¶³æ— æ³•ä½¿ç”¨
- ä¼šå‘˜åˆ°æœŸåé…é¢æ¸…é›¶

**å…³é”®æ–‡ä»¶ï¼š**
- `src/routes/membership.routes.js`
- `src/services/quota.service.js` - é…é¢ç®¡ç†

### 4. åˆ†é”€ç³»ç»Ÿ

**æµç¨‹ï¼š**
```
ç”¨æˆ·Aæ³¨å†Œæ—¶å¡«å†™æ¨èäººB
  â†’ åˆ›å»ºæ¨èå…³ç³»
  â†’ Bè´­ä¹°ä¼šå‘˜æ—¶ï¼ŒAè·å¾—ä½£é‡‘
  â†’ Aç”³è¯·æç°
  â†’ ç®¡ç†å‘˜å®¡æ ¸
  â†’ æ‰“æ¬¾
```

**å…³é”®æ–‡ä»¶ï¼š**
- `src/routes/distribution.routes.js`
- `src/controllers/distribution.controller.js`

### 5. åå°ç®¡ç†

**åŠŸèƒ½ï¼š**
- åŠŸèƒ½é…ç½®ï¼ˆFeature Definitionï¼‰
- Pipelineé…ç½®ï¼ˆæ‹–æ‹½å¼ç¼–è¾‘ï¼‰
- ç”¨æˆ·ç®¡ç†
- è®¢å•ç®¡ç†
- æ•°æ®ç»Ÿè®¡

**å…³é”®æ–‡ä»¶ï¼š**
- `src/routes/admin.routes.js`
- `src/controllers/admin/`

---

## APIæ¥å£å¤§å…¨

### è®¤è¯ç›¸å…³ `/api/auth`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | éœ€è¦ç™»å½• |
|------|------|------|---------|
| `/send-code` | POST | å‘é€éªŒè¯ç  | âŒ |
| `/login` | POST | ç™»å½•/æ³¨å†Œ | âŒ |
| `/me` | GET | è·å–å½“å‰ç”¨æˆ· | âœ… |

**ç¤ºä¾‹ï¼šå‘é€éªŒè¯ç **
```bash
curl -X POST http://localhost:3001/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'
```

**ç¤ºä¾‹ï¼šç™»å½•**
```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"123456"}'
```

### ä»»åŠ¡ç›¸å…³ `/api/tasks`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | éœ€è¦ç™»å½• |
|------|------|------|---------|
| `/` | POST | åˆ›å»ºä»»åŠ¡ | âœ… |
| `/` | GET | è·å–ä»»åŠ¡åˆ—è¡¨ | âœ… |
| `/:id` | GET | è·å–ä»»åŠ¡è¯¦æƒ… | âœ… |

**ç¤ºä¾‹ï¼šåˆ›å»ºä»»åŠ¡**
```bash
curl -X POST http://localhost:3001/api/tasks \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "featureId": "ai_fashion",
    "inputImageUrl": "https://example.com/image.jpg",
    "params": {"style": "casual"}
  }'
```

### ä¼šå‘˜ç›¸å…³ `/api/membership`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | éœ€è¦ç™»å½• |
|------|------|------|---------|
| `/plans` | GET | è·å–ä¼šå‘˜å¥—é¤ | âŒ |
| `/purchase` | POST | è´­ä¹°ä¼šå‘˜ | âœ… |
| `/status` | GET | è·å–ä¼šå‘˜çŠ¶æ€ | âœ… |

### åˆ†é”€ç›¸å…³ `/api/distribution`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | éœ€è¦ç™»å½• |
|------|------|------|---------|
| `/become-distributor` | POST | æˆä¸ºåˆ†é”€å•† | âœ… |
| `/stats` | GET | åˆ†é”€ç»Ÿè®¡ | âœ… |
| `/withdraw` | POST | ç”³è¯·æç° | âœ… |

### ç”¨æˆ·ç›¸å…³ `/api/users`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | éœ€è¦ç™»å½• |
|------|------|------|---------|
| `/me` | GET | è·å–ä¸ªäººä¿¡æ¯ | âœ… |
| `/me` | PUT | æ›´æ–°ä¸ªäººä¿¡æ¯ | âœ… |

### å†…å®¹ç›¸å…³

| è·¯å¾„ | è¯´æ˜ |
|------|------|
| `/api/announcements` | å…¬å‘Šç®¡ç† |
| `/api/banners` | è½®æ’­å›¾ç®¡ç† |
| `/api/membership-benefits` | ä¼šå‘˜æƒç›Š |

---

## æ•°æ®åº“ç»“æ„

### æ ¸å¿ƒè¡¨

#### 1. usersï¼ˆç”¨æˆ·è¡¨ï¼‰
```sql
- id: ç”¨æˆ·ID
- phone: æ‰‹æœºå·
- role: è§’è‰²ï¼ˆuser/admin/distributorï¼‰
- isMember: æ˜¯å¦ä¼šå‘˜
- quota_remaining: å‰©ä½™é…é¢
- quota_expireAt: é…é¢è¿‡æœŸæ—¶é—´
- referrer_id: æ¨èäººID
```

#### 2. tasksï¼ˆä»»åŠ¡è¡¨ï¼‰
```sql
- id: ä»»åŠ¡ID
- userId: ç”¨æˆ·ID
- featureId: åŠŸèƒ½ID
- status: çŠ¶æ€ï¼ˆpending/processing/success/failedï¼‰
- inputImageUrl: è¾“å…¥å›¾ç‰‡
- resultUrls: ç»“æœå›¾ç‰‡/è§†é¢‘
- params: å‚æ•°ï¼ˆJSONï¼‰
- error_message: é”™è¯¯ä¿¡æ¯
```

#### 3. ordersï¼ˆè®¢å•è¡¨ï¼‰
```sql
- id: è®¢å•ID
- userId: ç”¨æˆ·ID
- amount: é‡‘é¢
- status: çŠ¶æ€ï¼ˆpending/paid/cancelledï¼‰
- type: ç±»å‹ï¼ˆmembership/quotaï¼‰
```

#### 4. feature_definitionsï¼ˆåŠŸèƒ½å®šä¹‰è¡¨ï¼‰
```sql
- feature_id: åŠŸèƒ½IDï¼ˆå¦‚ai_fashionï¼‰
- name: åŠŸèƒ½åç§°
- pipeline_schema_ref: Pipelineå¼•ç”¨
- quota_cost: é…é¢æ¶ˆè€—
- is_enabled: æ˜¯å¦å¯ç”¨
```

#### 5. pipeline_schemasï¼ˆPipelineé…ç½®è¡¨ï¼‰
```sql
- pipeline_id: Pipeline ID
- name: åç§°
- steps: æ­¥éª¤é…ç½®ï¼ˆJSONï¼‰
  - æ–°æ ¼å¼ï¼š{nodes: [], edges: []}  // æ”¯æŒFORK/JOIN
  - æ—§æ ¼å¼ï¼š[{type, provider_ref}, ...]
```

#### 6. task_stepsï¼ˆä»»åŠ¡æ­¥éª¤è¡¨ï¼‰
```sql
- task_id: ä»»åŠ¡ID
- step_index: æ­¥éª¤ç´¢å¼•
- type: ç±»å‹ï¼ˆprovider/conditionç­‰ï¼‰
- status: çŠ¶æ€ï¼ˆpending/processing/completed/failedï¼‰
- input: è¾“å…¥æ•°æ®ï¼ˆJSONï¼‰
- output: è¾“å‡ºæ•°æ®ï¼ˆJSONï¼‰
```

### åˆ†é”€ç›¸å…³è¡¨

- `distributors` - åˆ†é”€å•†
- `referral_relationships` - æ¨èå…³ç³»
- `commissions` - ä½£é‡‘è®°å½•
- `withdrawals` - æç°è®°å½•

---

## å¸¸è§é—®é¢˜è§£ç­”

### Q1: æ€ä¹ˆæµ‹è¯•åç«¯åŠŸèƒ½ï¼Ÿ

**A: ä¸‰ç§æ–¹å¼**

**æ–¹å¼1ï¼šä½¿ç”¨Postman/Insomniaï¼ˆæ¨èï¼‰**
1. å¯¼å…¥APIæ¥å£
2. å…ˆè°ƒç”¨`/api/auth/send-code`è·å–éªŒè¯ç 
3. è°ƒç”¨`/api/auth/login`ç™»å½•è·å–Token
4. åç»­è¯·æ±‚HeaderåŠ ä¸Š`Authorization: Bearer TOKEN`

**æ–¹å¼2ï¼šä½¿ç”¨curlå‘½ä»¤**
```bash
# å‘é€éªŒè¯ç 
curl -X POST http://localhost:3001/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'

# ç™»å½•ï¼ˆå¼€å‘ç¯å¢ƒéªŒè¯ç å¯èƒ½æ˜¯å›ºå®šçš„ï¼Œçœ‹æ—¥å¿—ï¼‰
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"123456"}'
```

**æ–¹å¼3ï¼šå¯åŠ¨å‰ç«¯é¡¹ç›®**
```bash
cd ../frontend
npm install
npm run dev
# è®¿é—® http://localhost:3000
```

### Q2: éªŒè¯ç åœ¨å“ªé‡Œçœ‹ï¼Ÿ

**A: å¼€å‘ç¯å¢ƒçœ‹åç«¯æ—¥å¿—**

åç«¯å¯åŠ¨æ—¶ï¼ŒéªŒè¯ç ä¼šæ‰“å°åœ¨æ§åˆ¶å°ï¼š
```
[AUTH] å‘é€éªŒè¯ç : phone=13800138000 code=123456
```

### Q3: æ€ä¹ˆåˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼Ÿ

**A: ç›´æ¥ä¿®æ”¹æ•°æ®åº“**

```bash
# è¿æ¥MySQL
docker exec -it ai-photo-mysql-dev mysql -uroot -pdev_password_123

USE ai_photo;

# å…ˆæ­£å¸¸ç™»å½•åˆ›å»ºç”¨æˆ·ï¼Œç„¶åæ”¹role
UPDATE users SET role='admin' WHERE phone='13800138000';
```

### Q4: Pipelineæ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆé…ç½®ï¼Ÿ

**A: Pipelineæ˜¯ä»»åŠ¡æ‰§è¡Œæµç¨‹**

**ç®€å•ç†è§£ï¼š**
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
  â†“
[Pipelineå¼€å§‹]
  â†’ Step 1: å›¾ç‰‡é¢„å¤„ç†ï¼ˆProvider: image_preprocessï¼‰
  â†’ Step 2: AIå¤„ç†ï¼ˆProvider: runninghubï¼‰
  â†’ Step 3: åå¤„ç†ï¼ˆProvider: image_postprocessï¼‰
[Pipelineç»“æŸ]
  â†“
è¿”å›ç»“æœ
```

**é…ç½®æ–¹å¼ï¼ˆç®¡ç†åå°ï¼‰ï¼š**
1. è®¿é—®ç®¡ç†åå°
2. è¿›å…¥"Pipelineç®¡ç†"
3. æ‹–æ‹½èŠ‚ç‚¹é…ç½®æµç¨‹
4. ä¿å­˜

**FORK/JOINï¼ˆå¹¶è¡Œï¼‰ï¼š**
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
  â†“
[FORK: å¯åŠ¨3ä¸ªå¹¶è¡Œåˆ†æ”¯]
  â†’ åˆ†æ”¯1: AIæ¨¡å‹Aå¤„ç†
  â†’ åˆ†æ”¯2: AIæ¨¡å‹Bå¤„ç†
  â†’ åˆ†æ”¯3: AIæ¨¡å‹Cå¤„ç†
[JOIN: ç­‰å¾…æ‰€æœ‰åˆ†æ”¯å®Œæˆ]
  â†“
è¿”å›3ä¸ªç»“æœ
```

### Q5: æ€ä¹ˆæ·»åŠ æ–°çš„AIåŠŸèƒ½ï¼Ÿ

**A: 4ä¸ªæ­¥éª¤**

**æ­¥éª¤1ï¼šåˆ›å»ºProvider**
```javascript
// src/providers/my-ai.provider.js
class MyAIProvider extends BaseProvider {
  async _execute(context) {
    // è°ƒç”¨ä½ çš„AIæœåŠ¡
    const result = await callMyAI(context.input);
    return { success: true, data: result };
  }
}
```

**æ­¥éª¤2ï¼šæ³¨å†ŒProvider**
```javascript
// src/providers/provider-loader.js
const PROVIDER_WHITELIST = [
  'runninghub_provider',
  'my_ai_provider',  // æ·»åŠ è¿™è¡Œ
];
```

**æ­¥éª¤3ï¼šåˆ›å»ºPipeline Schema**
```sql
INSERT INTO pipeline_schemas (pipeline_id, name, steps) VALUES (
  'my_ai_pipeline',
  'æˆ‘çš„AIåŠŸèƒ½',
  '[{"type":"provider","provider_ref":"my_ai_provider"}]'
);
```

**æ­¥éª¤4ï¼šåˆ›å»ºFeature Definition**
```sql
INSERT INTO feature_definitions (feature_id, name, pipeline_schema_ref, quota_cost) VALUES (
  'my_ai_feature',
  'æˆ‘çš„AIåŠŸèƒ½',
  'my_ai_pipeline',
  1
);
```

### Q6: æ—¥å¿—åœ¨å“ªé‡Œçœ‹ï¼Ÿ

**A: ä¸‰ä¸ªåœ°æ–¹**

1. **æ§åˆ¶å°è¾“å‡º**ï¼š`npm run dev`å¯åŠ¨æ—¶ç›´æ¥çœ‹
2. **æ–‡ä»¶æ—¥å¿—**ï¼š`backend/logs/` ç›®å½•
3. **æ•°æ®åº“æ—¥å¿—**ï¼š`audit_logs` è¡¨

### Q7: æ€ä¹ˆè°ƒè¯•ä»£ç ï¼Ÿ

**A: ä½¿ç”¨VS Codeè°ƒè¯•**

**æ­¥éª¤1ï¼šåˆ›å»º`.vscode/launch.json`**
```json
{
  "configurations": [
    {
      "name": "Debug Backend",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/backend/src/server.js",
      "env": {
        "NODE_ENV": "development"
      }
    }
  ]
}
```

**æ­¥éª¤2ï¼šæ‰“æ–­ç‚¹ï¼ŒæŒ‰F5å¯åŠ¨è°ƒè¯•**

### Q8: ä¸ºä»€ä¹ˆæ²¡æœ‰å¯†ç ç™»å½•ï¼Ÿ

**A: ä½¿ç”¨æ‰‹æœºéªŒè¯ç æ›´å®‰å…¨**

ä¼˜ç‚¹ï¼š
- âœ… æ— éœ€è®°ä½å¯†ç 
- âœ… é˜²æ­¢å¯†ç æ³„éœ²
- âœ… éªŒè¯æ‰‹æœºå·çœŸå®æ€§
- âœ… è‡ªåŠ¨æ³¨å†Œï¼ˆé¦–æ¬¡ç™»å½•ï¼‰

---

## é‡è¦æ–‡æ¡£ç´¢å¼•

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| `README_AUTH_API.md` | è®¤è¯APIè¯¦ç»†æ–‡æ¡£ |
| `README_FORK_JOIN.md` | FORK/JOINå¹¶è¡Œæ‰§è¡Œè¯´æ˜ |
| `tests/README_TESTING.md` | æµ‹è¯•æŒ‡å— |
| `åç«¯å®Œå…¨ä½¿ç”¨è¯´æ˜.md` | æœ¬æ–‡æ¡£ |

---

## å¼€å‘æµç¨‹æ€»ç»“

### æ—¥å¸¸å¼€å‘
```bash
# 1. å¯åŠ¨æ•°æ®åº“
docker-compose -f docker-compose.dev.yml up -d

# 2. å¯åŠ¨åç«¯
cd backend
npm run dev

# 3. å¯åŠ¨å‰ç«¯
cd frontend
npm run dev

# 4. æµè§ˆå™¨è®¿é—®
# http://localhost:3000
```

### æµ‹è¯•
```bash
# å•å…ƒæµ‹è¯•ï¼ˆä¸éœ€è¦æ•°æ®åº“ï¼‰
npm test -- pipelineEngine.simple.test.js

# é›†æˆæµ‹è¯•ï¼ˆéœ€è¦æ•°æ®åº“ï¼‰
npm test
```

### éƒ¨ç½²
```bash
# ç¼–è¯‘TypeScript
npm run build

# è¿è¡Œç”Ÿäº§ç¯å¢ƒ
npm start
```

---

## æ¶æ„å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTPè¯·æ±‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Expressåç«¯æœåŠ¡           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Routesï¼ˆè·¯ç”±ï¼‰     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â†“                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Controllersï¼ˆæ§åˆ¶å™¨ï¼‰â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â†“                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Servicesï¼ˆæœåŠ¡ï¼‰    â”‚   â”‚
â”‚   â”‚ - auth.service      â”‚   â”‚
â”‚   â”‚ - task.service      â”‚   â”‚
â”‚   â”‚ - pipelineEngine    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â†“                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Providersï¼ˆAIæœåŠ¡ï¼‰ â”‚   â”‚
â”‚   â”‚ - RunningHub        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â”‚         â”‚
       â†“         â†“         â†“
   â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚MySQLâ”‚  â”‚Redisâ”‚  â”‚è…¾è®¯äº‘COSâ”‚
   â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‰ æ€»ç»“

è‰¹ï¼è€ç‹æˆ‘æŠŠåç«¯ä»å¤´åˆ°å°¾ç»™ä½ ç†æ¸…æ¥šäº†ï¼

**æ ¸å¿ƒè¦ç‚¹ï¼š**
1. **æ‰‹æœºéªŒè¯ç ç™»å½•**ï¼šä¸éœ€è¦å¯†ç 
2. **Pipelineå¼•æ“**ï¼šAIä»»åŠ¡å¤„ç†æ ¸å¿ƒ
3. **FORK/JOIN**ï¼šæ”¯æŒå¹¶è¡Œå¤„ç†ï¼Œæé«˜é€Ÿåº¦
4. **ä¼šå‘˜é…é¢**ï¼šæ¶ˆè´¹åˆ¶ï¼Œç”¨å¤šå°‘æ‰£å¤šå°‘
5. **åˆ†é”€è¿”ä½£**ï¼šæ¨èæœ‰å¥–

**å¿«é€Ÿä¸Šæ‰‹ï¼š**
```bash
docker-compose -f docker-compose.dev.yml up -d
cd backend && npm install && npm run db:migrate && npm run dev
```

**å¦‚æœ‰é—®é¢˜æ‰¾è€ç‹æˆ‘ï¼ğŸ’ª**
