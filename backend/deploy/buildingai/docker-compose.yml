version: '3.8'

# BuildingAI Sidecar Docker Composeé…ç½®
# è‰¹ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶è´Ÿè´£å¯åŠ¨BuildingAIåç«¯æœåŠ¡ï¼
#
# ä½¿ç”¨è¯´æ˜ï¼š
# 1. ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•æœ‰.env.buildingaiæ–‡ä»¶
# 2. docker-compose --env-file ../../.env.buildingai up -d
# 3. ç­‰å¾…2-3åˆ†é’ŸæœåŠ¡å®Œå…¨å¯åŠ¨
# 4. è®¿é—® http://localhost:4090/health éªŒè¯

services:
  buildingai-server:
    image: buildingai/buildingai-server:latest
    container_name: buildingai-sidecar
    restart: unless-stopped

    # ç«¯å£æ˜ å°„ - ä»…ç»‘å®šlocalhostï¼ˆå†…ç½‘è®¿é—®ï¼‰
    ports:
      - "127.0.0.1:4090:4090"

    # ç¯å¢ƒå˜é‡é…ç½®
    environment:
      # åº”ç”¨é…ç½®
      NODE_ENV: production
      PORT: 4090

      # æ•°æ®åº“é…ç½® - ä½¿ç”¨å®¿ä¸»æœºMySQL
      DB_TYPE: mysql
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE:-ai_photo}
      DB_SYNCHRONIZE: "false"  # ç”Ÿäº§ç¯å¢ƒç¦æ­¢è‡ªåŠ¨åŒæ­¥schema
      DB_LOGGING: "false"

      # Redisé…ç½® - ä½¿ç”¨ç‹¬ç«‹DB
      REDIS_HOST: ${REDIS_HOST:-host.docker.internal}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 1  # ä½¿ç”¨DB1éš”ç¦»ï¼ˆä¸»åº”ç”¨ç”¨DB0ï¼‰
      REDIS_KEY_PREFIX: "ba:"  # Keyå‰ç¼€éš”ç¦»

      # JWTé…ç½®
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}

      # ç®¡ç†å‘˜è´¦å·é…ç½®ï¼ˆé¦–æ¬¡å¯åŠ¨æ—¶åˆ›å»ºï¼‰
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@buildingai.local}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

      # BuildingAIåŠŸèƒ½å¼€å…³
      ENABLE_FRONTEND: "false"  # âš ï¸ å…³é—­å‰ç«¯ï¼ˆæˆ‘ä»¬åªç”¨åç«¯APIï¼‰
      ENABLE_MCP: "true"
      ENABLE_RAG: "true"
      ENABLE_BILLING: "true"

      # AI Provideré…ç½®
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # æ—¥å¿—é…ç½®
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: json

      # å®‰å…¨é…ç½®
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000,https://aizhao.icu}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # æŒ‚è½½é…ç½®ï¼ˆå¯é€‰ï¼‰
    volumes:
      # æŒä¹…åŒ–æ—¥å¿—
      - ./logs:/app/logs
      # æŒä¹…åŒ–ä¸Šä¼ æ–‡ä»¶
      - ./uploads:/app/uploads

    # ç½‘ç»œé…ç½®
    networks:
      - buildingai-network

    # ä¾èµ–é…ç½®ï¼ˆå¦‚æœéœ€è¦æœ¬åœ°Rediså®¹å™¨ï¼‰
    # depends_on:
    #   - redis

    # é¢å¤–é…ç½®
    extra_hosts:
      - "host.docker.internal:host-gateway"  # å…è®¸è®¿é—®å®¿ä¸»æœºæœåŠ¡

# ç½‘ç»œé…ç½®
networks:
  buildingai-network:
    driver: bridge

# å·é…ç½®ï¼ˆå¯é€‰ï¼‰
volumes:
  buildingai-logs:
  buildingai-uploads:

# ---
#
# ğŸ“ ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š
#
# 1. æ•°æ®åº“é…ç½®
#    - ç¡®ä¿MySQL 8.0åœ¨å®¿ä¸»æœºè¿è¡Œï¼ˆæˆ–ä¿®æ”¹DB_HOSTï¼‰
#    - BuildingAIä¼šè‡ªåŠ¨åˆ›å»ºæ‰€éœ€è¡¨ï¼ˆé¦–æ¬¡å¯åŠ¨æ…¢ï¼‰
#    - ä¸ä¼šå½±å“ç°æœ‰ä¸šåŠ¡è¡¨
#
# 2. Rediséš”ç¦»
#    - ä½¿ç”¨DB=1ï¼ˆä¸»åº”ç”¨ç”¨DB=0ï¼‰
#    - Keyå‰ç¼€"ba:"è¿›ä¸€æ­¥éš”ç¦»
#    - å¯ä»¥å…±äº«Rediså®ä¾‹
#
# 3. ç«¯å£å®‰å…¨
#    - 4090ä»…ç»‘å®š127.0.0.1ï¼ˆå¤–ç½‘æ— æ³•è®¿é—®ï¼‰
#    - BFFé€šè¿‡localhost:4090è°ƒç”¨
#    - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Nginxåä»£+ç™½åå•
#
# 4. é¦–æ¬¡å¯åŠ¨
#    - ä¼šè‡ªåŠ¨åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼ˆä½¿ç”¨ADMIN_PASSWORDï¼‰
#    - âš ï¸ é¦–æ¬¡å¯åŠ¨åç«‹å³ä¿®æ”¹å¯†ç ï¼
#    - è®°å½•åˆ°å®‰å…¨æ–‡æ¡£
#
# 5. æ—¥å¿—ä¸ç›‘æ§
#    - æ—¥å¿—æŒ‚è½½åˆ°./logsç›®å½•
#    - å¥åº·æ£€æŸ¥ï¼šhttp://localhost:4090/health
#    - æŸ¥çœ‹æ—¥å¿—ï¼šdocker-compose logs -f
#
# 6. æ•…éšœæ’æŸ¥
#    - å¯åŠ¨å¤±è´¥ï¼šæ£€æŸ¥MySQL/Redisè¿æ¥
#    - ç«¯å£å ç”¨ï¼šä¿®æ”¹portsé…ç½®
#    - å†…å­˜ä¸è¶³ï¼šè°ƒæ•´resources.limits
#
# ---
