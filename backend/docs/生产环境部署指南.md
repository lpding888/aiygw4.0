# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

**æ›´æ–°æ—¶é—´ï¼š** 2025-11-03
**è´Ÿè´£äººï¼š** è€ç‹
**ç‰ˆæœ¬ï¼š** 1.0.0

è‰¹ï¼Œè¿™ä¸ªæ–‡æ¡£è¯¦ç»†è®°å½•äº†å¦‚ä½•å°†ç³»ç»Ÿéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼æŒ‰ç…§è¿™ä¸ªæ¥å‡†æ²¡é”™ï¼

---

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æœåŠ¡å™¨è¦æ±‚](#æœåŠ¡å™¨è¦æ±‚)
- [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
- [æ•°æ®åº“éƒ¨ç½²](#æ•°æ®åº“éƒ¨ç½²)
- [Rediséƒ¨ç½²](#rediséƒ¨ç½²)
- [åç«¯æœåŠ¡éƒ¨ç½²](#åç«¯æœåŠ¡éƒ¨ç½²)
- [Nginxé…ç½®](#nginxé…ç½®)
- [BuildingAIä¾§è½¦éƒ¨ç½²](#buildingaiä¾§è½¦éƒ¨ç½²)
- [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
- [å¤‡ä»½ç­–ç•¥](#å¤‡ä»½ç­–ç•¥)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç³»ç»Ÿæ¶æ„

```
                                                  Internet
                                                     â”‚
                                                     â”‚
                                              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                                              â”‚   Nginx     â”‚
                                              â”‚  (SSL/TLS)  â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                            â”‚                            â”‚
                  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Node.js   â”‚            â”‚  BuildingAI    â”‚          â”‚   Frontend      â”‚
                  â”‚  Backend   â”‚            â”‚    Sidecar     â”‚          â”‚  (Static Files) â”‚
                  â”‚  (PM2)     â”‚            â”‚   (Docker)     â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚              â”‚                â”‚           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚  MySQL  â”‚   â”‚   Redis   â”‚   â”‚  MySQL  â”‚  â”‚ Redis  â”‚
    â”‚   Main  â”‚   â”‚   Cache   â”‚   â”‚  (BA)   â”‚  â”‚  (BA)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æœåŠ¡å™¨è¦æ±‚

### æœ€ä½é…ç½®

**ä¸»æœåŠ¡å™¨ï¼ˆåç«¯ï¼‰ï¼š**
- CPU: 4æ ¸
- å†…å­˜: 8GB
- ç£ç›˜: 100GB SSD
- ç½‘ç»œ: 5Mbps

**æ•°æ®åº“æœåŠ¡å™¨ï¼š**
- CPU: 4æ ¸
- å†…å­˜: 16GB
- ç£ç›˜: 500GB SSDï¼ˆRAID 1ï¼‰
- ç½‘ç»œ: 10Mbps

### æ¨èé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**ä¸»æœåŠ¡å™¨ï¼ˆåç«¯ï¼‰ï¼š**
- CPU: 8æ ¸
- å†…å­˜: 32GB
- ç£ç›˜: 500GB NVMe SSD
- ç½‘ç»œ: 100Mbps

**æ•°æ®åº“æœåŠ¡å™¨ï¼š**
- CPU: 16æ ¸
- å†…å­˜: 64GB
- ç£ç›˜: 1TB NVMe SSDï¼ˆRAID 10ï¼‰
- ç½‘ç»œ: 1Gbps

### æ“ä½œç³»ç»Ÿ

- **æ¨èï¼š** Ubuntu 22.04 LTSæˆ–CentOS Stream 9
- **æœ€ä½ï¼š** Ubuntu 20.04 LTSæˆ–CentOS 8

---

## éƒ¨ç½²å‰å‡†å¤‡

### 1. æ›´æ–°ç³»ç»Ÿ

```bash
# Ubuntu
sudo apt update && sudo apt upgrade -y

# CentOS
sudo dnf update -y
```

### 2. å®‰è£…åŸºç¡€è½¯ä»¶

```bash
# å®‰è£…Node.js 18.xï¼ˆä½¿ç”¨nvmæ¨èï¼‰
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
nvm alias default 18

# å®‰è£…PM2
npm install -g pm2

# å®‰è£…Nginx
sudo apt install nginx -y  # Ubuntu
# æˆ–
sudo dnf install nginx -y  # CentOS

# å®‰è£…Dockerï¼ˆç”¨äºBuildingAIä¾§è½¦ï¼‰
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 3. åˆ›å»ºéƒ¨ç½²ç”¨æˆ·

```bash
# åˆ›å»ºdeployç”¨æˆ·
sudo useradd -m -s /bin/bash deploy
sudo usermod -aG docker deploy
sudo usermod -aG sudo deploy  # å¦‚éœ€sudoæƒé™

# è®¾ç½®å¯†ç 
sudo passwd deploy

# åˆ‡æ¢åˆ°deployç”¨æˆ·
su - deploy
```

---

## æ•°æ®åº“éƒ¨ç½²

### MySQL 8.0å®‰è£…

```bash
# Ubuntu
sudo apt install mysql-server-8.0 -y

# CentOS
sudo dnf install mysql-server -y
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

### å®‰å…¨é…ç½®

```bash
# è¿è¡Œå®‰å…¨é…ç½®è„šæœ¬
sudo mysql_secure_installation

# è®¾ç½®ï¼š
# - Rootå¯†ç ï¼šå¼ºå¯†ç ï¼ˆè‡³å°‘16ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
# - åˆ é™¤åŒ¿åç”¨æˆ·ï¼šæ˜¯
# - ç¦æ­¢è¿œç¨‹rootç™»å½•ï¼šæ˜¯
# - åˆ é™¤testæ•°æ®åº“ï¼šæ˜¯
# - é‡æ–°åŠ è½½æƒé™è¡¨ï¼šæ˜¯
```

### åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

```bash
# ç™»å½•MySQL
sudo mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE aizhao_prod CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER 'aizhao_user'@'localhost' IDENTIFIED BY 'your_strong_password_here';

# æˆæƒ
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, DROP ON aizhao_prod.* TO 'aizhao_user'@'localhost';
FLUSH PRIVILEGES;

EXIT;
```

### æ€§èƒ½ä¼˜åŒ–ï¼ˆ/etc/mysql/mysql.conf.d/mysqld.cnfï¼‰

```ini
[mysqld]
# åŸºæœ¬è®¾ç½®
max_connections = 500
max_connect_errors = 100
wait_timeout = 600
interactive_timeout = 600

# InnoDBè®¾ç½®
innodb_buffer_pool_size = 16G  # ç‰©ç†å†…å­˜çš„50-70%
innodb_log_file_size = 512M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1

# æŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 8.0å·²ç§»é™¤ï¼Œä½¿ç”¨åº”ç”¨å±‚ç¼“å­˜ï¼‰
# query_cache_size = 0
# query_cache_type = 0

# æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2

# äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆç”¨äºå¤‡ä»½å’Œä¸»ä»å¤åˆ¶ï¼‰
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW
expire_logs_days = 7
max_binlog_size = 100M
```

```bash
# é‡å¯MySQLåº”ç”¨é…ç½®
sudo systemctl restart mysql
```

### è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd /opt/backend
npm run migrate:prod
```

---

## Rediséƒ¨ç½²

### Redis 7.xå®‰è£…

```bash
# Ubuntu
sudo apt install redis-server -y

# CentOS
sudo dnf install redis -y
sudo systemctl start redis
sudo systemctl enable redis
```

### å®‰å…¨é…ç½®ï¼ˆ/etc/redis/redis.confï¼‰

```ini
# ç½‘ç»œç»‘å®šï¼ˆä»…æœ¬åœ°è®¿é—®ï¼‰
bind 127.0.0.1 ::1

# å¯†ç è®¤è¯
requirepass your_redis_password_here

# æŒä¹…åŒ–é…ç½®
save 900 1
save 300 10
save 60 10000
dir /var/lib/redis
dbfilename dump.rdb

# AOFæŒä¹…åŒ–ï¼ˆæ›´å®‰å…¨ä½†æ€§èƒ½ç¨ä½ï¼‰
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

# å†…å­˜é™åˆ¶
maxmemory 4gb
maxmemory-policy allkeys-lru

# æ…¢æŸ¥è¯¢æ—¥å¿—
slowlog-log-slower-than 10000
slowlog-max-len 128
```

```bash
# é‡å¯Redis
sudo systemctl restart redis

# éªŒè¯
redis-cli -a your_redis_password_here ping
# åº”è¯¥è¿”å›ï¼šPONG
```

---

## åç«¯æœåŠ¡éƒ¨ç½²

### 1. éƒ¨ç½²ä»£ç 

```bash
# åˆ›å»ºéƒ¨ç½²ç›®å½•
sudo mkdir -p /opt/backend
sudo chown deploy:deploy /opt/backend

# å…‹éš†ä»£ç ï¼ˆæˆ–ä½¿ç”¨CI/CDï¼‰
cd /opt
git clone https://github.com/your-org/backend.git
cd backend

# å®‰è£…ä¾èµ–
npm ci --only=production

# æ„å»ºTypeScriptï¼ˆå¦‚éœ€è¦ï¼‰
npm run build
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env.production

# ç¼–è¾‘ç”Ÿäº§ç¯å¢ƒé…ç½®
nano .env.production
```

**å…³é”®é…ç½®ï¼š**

```bash
# ===== åŸºç¡€é…ç½® =====
NODE_ENV=production
PORT=3000
LOG_LEVEL=info

# ===== æ•°æ®åº“é…ç½® =====
DB_HOST=localhost
DB_PORT=3306
DB_USER=aizhao_user
DB_PASSWORD=your_strong_password_here
DB_NAME=aizhao_prod

# ===== Redisé…ç½® =====
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password_here
REDIS_DB=0

# ===== JWTé…ç½® =====
JWT_SECRET=<ç”Ÿæˆ64ä½éšæœºå­—ç¬¦ä¸²>
JWT_EXPIRES_IN=7d

# ===== COSé…ç½® =====
COS_SECRET_ID=<è…¾è®¯äº‘SecretId>
COS_SECRET_KEY=<è…¾è®¯äº‘SecretKey>
COS_BUCKET=your-bucket-123456
COS_REGION=ap-guangzhou

# ===== AI Provideré…ç½® =====
OPENAI_API_KEY=sk-xxx
ANTHROPIC_API_KEY=sk-ant-xxx
BUILDINGAI_API_URL=http://localhost:4090

# ===== ç›‘æ§é…ç½® =====
SENTRY_DSN=<Sentry DSN>
```

**ç”ŸæˆJWT Secretï¼š**

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. ä½¿ç”¨PM2éƒ¨ç½²

åˆ›å»ºPM2é…ç½®æ–‡ä»¶`ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [
    {
      name: 'aizhao-backend',
      script: './src/server.js',
      instances: 4, // ä½¿ç”¨4ä¸ªè¿›ç¨‹ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ï¼‰
      exec_mode: 'cluster',
      env_production: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      error_file: './logs/pm2-error.log',
      out_file: './logs/pm2-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
      max_memory_restart: '1G',
      autorestart: true,
      watch: false,
      ignore_watch: ['node_modules', 'logs', 'data'],

      // ä¼˜é›…é‡å¯
      kill_timeout: 5000,
      listen_timeout: 10000,

      // å¥åº·æ£€æŸ¥
      max_restarts: 10,
      min_uptime: '10s'
    }
  ]
};
```

**å¯åŠ¨æœåŠ¡ï¼š**

```bash
# å¯åŠ¨PM2
pm2 start ecosystem.config.js --env production

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs aizhao-backend

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤ï¼ˆéœ€è¦sudoï¼‰
```

### 4. PM2ç›‘æ§

```bash
# å¯åŠ¨PM2ç›‘æ§é¢æ¿
pm2 install pm2-logrotate  # æ—¥å¿—è½®è½¬
pm2 set pm2-logrotate:max_size 100M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true

# Webç›‘æ§ï¼ˆå¯é€‰ï¼‰
pm2 web
# è®¿é—® http://localhost:9615
```

---

## Nginxé…ç½®

### å®‰è£…SSLè¯ä¹¦

```bash
# ä½¿ç”¨Let's Encryptï¼ˆå…è´¹ï¼‰
sudo apt install certbot python3-certbot-nginx -y

# ç”³è¯·è¯ä¹¦
sudo certbot --nginx -d api.aizhao.icu
```

### Nginxé…ç½®æ–‡ä»¶ï¼ˆ/etc/nginx/sites-available/aizhaoï¼‰

```nginx
# åç«¯APIæœåŠ¡å™¨
upstream backend {
    least_conn;
    server 127.0.0.1:3000 weight=1 max_fails=3 fail_timeout=30s;
    # å¦‚æœæœ‰å¤šä¸ªåç«¯å®ä¾‹ï¼Œæ·»åŠ æ›´å¤šserverè¡Œ
}

# HTTP -> HTTPSé‡å®šå‘
server {
    listen 80;
    listen [::]:80;
    server_name api.aizhao.icu;

    return 301 https://$server_name$request_uri;
}

# HTTPSé…ç½®
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.aizhao.icu;

    # SSLè¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/api.aizhao.icu/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.aizhao.icu/privkey.pem;

    # SSLä¼˜åŒ–
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # æ—¥å¿—
    access_log /var/log/nginx/aizhao-access.log;
    error_log /var/log/nginx/aizhao-error.log;

    # è¯·æ±‚ä½“å¤§å°é™åˆ¶
    client_max_body_size 50M;

    # APIä»£ç†
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;

        # ä»£ç†å¤´
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;  # SSEæµå¼éœ€è¦æ›´é•¿è¶…æ—¶

        # ç¼“å†²è®¾ç½®ï¼ˆSSEéœ€è¦ç¦ç”¨ç¼“å†²ï¼‰
        proxy_buffering off;
        proxy_cache off;

        # é™æµ
        limit_req zone=api burst=20 nodelay;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://backend;
        access_log off;
    }
}

# é™æµé…ç½®
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
```

**å¯ç”¨é…ç½®ï¼š**

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/aizhao /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

---

## BuildingAIä¾§è½¦éƒ¨ç½²

### 1. å‡†å¤‡é…ç½®æ–‡ä»¶

```bash
cd /opt/backend

# å¤åˆ¶ç¯å¢ƒå˜é‡
cp .env.buildingai .env.buildingai.prod

# ç¼–è¾‘é…ç½®
nano .env.buildingai.prod

# ä¿®æ”¹å…³é”®é…ç½®ï¼š
# - DB_PASSWORD
# - JWT_SECRET
# - ADMIN_PASSWORD
```

### 2. å¯åŠ¨BuildingAI

```bash
cd deploy/buildingai

# å¯åŠ¨
docker-compose --env-file ../../.env.buildingai.prod up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f buildingai-server

# ç­‰å¾…2-3åˆ†é’Ÿç›´åˆ°æœåŠ¡å®Œå…¨å¯åŠ¨
```

### 3. éªŒè¯

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:4090/health

# åº”è¯¥è¿”å›ï¼š{"status":"ok"}
```

---

## ç›‘æ§å’Œæ—¥å¿—

### 1. é…ç½®Sentryï¼ˆé”™è¯¯ç›‘æ§ï¼‰

```bash
# å·²åœ¨.env.productionä¸­é…ç½®SENTRY_DSN
# Sentryä¼šè‡ªåŠ¨æ•è·å’Œä¸ŠæŠ¥é”™è¯¯
```

### 2. é…ç½®æ—¥å¿—è½®è½¬

```bash
# æ—¥å¿—è½®è½¬é…ç½®ï¼ˆ/etc/logrotate.d/aizhaoï¼‰
sudo nano /etc/logrotate.d/aizhao
```

```
/opt/backend/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 deploy deploy
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}

/var/log/nginx/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        systemctl reload nginx > /dev/null 2>&1 || true
    endscript
}
```

### 3. ç³»ç»Ÿç›‘æ§ï¼ˆPrometheus + Grafanaï¼Œå¯é€‰ï¼‰

è‰¹ï¼Œè¿™ä¸ªéœ€è¦å•ç‹¬éƒ¨ç½²ï¼Œè¯¦è§ç›‘æ§æ–‡æ¡£ï¼

---

## å¤‡ä»½ç­–ç•¥

### MySQLå¤‡ä»½

åˆ›å»ºå¤‡ä»½è„šæœ¬`/opt/scripts/backup-mysql.sh`ï¼š

```bash
#!/bin/bash
BACKUP_DIR="/opt/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="aizhao_prod"
DB_USER="aizhao_user"
DB_PASS="your_password"

mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +30 -delete

echo "Backup completed: backup_$DATE.sql.gz"
```

```bash
# è®¾ç½®æƒé™
chmod +x /opt/scripts/backup-mysql.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
crontab -e

# æ·»åŠ ï¼š
0 2 * * * /opt/scripts/backup-mysql.sh >> /var/log/mysql-backup.log 2>&1
```

### Rediså¤‡ä»½

```bash
# Redisè‡ªåŠ¨ä¿å­˜dump.rdb
# æ‰‹åŠ¨å¤‡ä»½ï¼š
cp /var/lib/redis/dump.rdb /opt/backups/redis/dump_$(date +%Y%m%d).rdb
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. æœåŠ¡æ— æ³•å¯åŠ¨**

```bash
# æ£€æŸ¥PM2æ—¥å¿—
pm2 logs aizhao-backend --lines 100

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep :3000

# æ£€æŸ¥ç¯å¢ƒå˜é‡
pm2 env 0  # æŸ¥çœ‹è¿›ç¨‹0çš„ç¯å¢ƒå˜é‡
```

**2. æ•°æ®åº“è¿æ¥å¤±è´¥**

```bash
# æ£€æŸ¥MySQLçŠ¶æ€
sudo systemctl status mysql

# æµ‹è¯•è¿æ¥
mysql -u aizhao_user -p -h localhost aizhao_prod

# æŸ¥çœ‹MySQLæ—¥å¿—
sudo tail -f /var/log/mysql/error.log
```

**3. Redisè¿æ¥å¤±è´¥**

```bash
# æ£€æŸ¥RedisçŠ¶æ€
sudo systemctl status redis

# æµ‹è¯•è¿æ¥
redis-cli -a your_redis_password ping
```

**4. Nginx 502é”™è¯¯**

```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
pm2 status

# æ£€æŸ¥Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/aizhao-error.log

# æµ‹è¯•åç«¯ç›´æ¥è®¿é—®
curl http://localhost:3000/health
```

**5. SSLè¯ä¹¦è¿‡æœŸ**

```bash
# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
sudo certbot certificates

# æ‰‹åŠ¨ç»­æœŸ
sudo certbot renew

# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å¯†ç ä½¿ç”¨å¼ºå¯†ç ï¼ˆ16ä½+ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
- [ ] MySQL rootç”¨æˆ·ç¦æ­¢è¿œç¨‹ç™»å½•
- [ ] Redisè®¾ç½®å¯†ç è®¤è¯
- [ ] SSHç¦ç”¨å¯†ç ç™»å½•ï¼Œä»…ä½¿ç”¨å¯†é’¥è®¤è¯
- [ ] é˜²ç«å¢™ä»…å¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ80, 443, 22ï¼‰
- [ ] å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œè½¯ä»¶åŒ…
- [ ] å¯ç”¨fail2bané˜²æ­¢æš´åŠ›ç ´è§£
- [ ] é…ç½®SSL/TLSè¯ä¹¦
- [ ] å¯ç”¨HSTS
- [ ] å®šæœŸå¤‡ä»½æ•°æ®åº“å’Œé…ç½®æ–‡ä»¶
- [ ] ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

---

è‰¹ï¼Œéƒ¨ç½²æ–‡æ¡£å†™å®Œäº†ï¼æŒ‰ç…§è¿™ä¸ªæ¥éƒ¨ç½²ï¼Œç»å¯¹æ²¡é—®é¢˜ï¼æœ‰é—®é¢˜æ¥æ‰¾è€ç‹ï¼
