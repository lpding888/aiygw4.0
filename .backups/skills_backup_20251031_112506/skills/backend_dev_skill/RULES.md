# Backend Dev Skill - 行为准则(RULES)

后端开发行为红线与约束。违反任意一条将触发 Reviewer/QA 退回或 Deploy 阻断。

## 基本纪律

✅ **OpenAPI 先行**:在编码前产出/更新 openapi/*.yaml,并在 PR 中一并提交
✅ **契约驱动协作**:跨部门仅以 OpenAPI/UI/事件 为事实来源;所有变更均走变更请求(CR)
✅ **TDD 推动**:为核心逻辑编写 UT/集成测试;覆盖率 ≥ 80%
✅ **迁移不可编辑历史**:Knex/SQL 迁移一旦合入,不得改写历史文件,只能追加新迁移
✅ **RBAC/鉴权默认开启**:除 /health 外均需鉴权;敏感操作写审计日志
✅ **速率限制与缓存**:对登录、搜索、列表类接口启用速率限制;热点数据使用 Redis 缓存
✅ **可观测性**:统一错误码、结构化日志(requestId)、基本指标(请求耗时、命中率)
✅ **性能与安全门禁**:PR 必须通过 Reviewer(安全/性能/规范)

❌ **禁止跳过 OpenAPI 直接实现接口**
❌ **禁止修改前端代码、SCF 代码或生产密钥**
❌ **禁止在仓库提交明文秘钥/证书/数据库导出**
❌ **禁止在日志中打印密码、Token、身份证/手机号等敏感数据**
❌ **禁止在未与 Frontend 协同的情况下做 Breaking Change**(字段更名/删除、状态码变化)
❌ **禁止一次 PR 大范围混合改动**(多模块耦合、难以审查)

## 任务卡执行规则

✅ 每张卡 4–12h,超过必须拆分,不足合并
✅ 严格按 department:"Backend" 的卡执行;修复类任务卡以 -FIX- 或 CMS-B-016 等命名
✅ 每张卡必须包含:
  - acceptanceCriteria(至少1条)
  - aiPromptSuggestion(system/user)
  - reviewPolicy/qaPolicy
  - needsCoordination(若跨部门)
✅ 交付物与路径需与任务卡 deliverables 一致

❌ Backend 不得发起功能类任务卡;修复卡由 Reviewer 发起
❌ 对 Planner 未确认的 CR 不得擅自改动契约

## 输出格式与接口规范

✅ **响应包统一**:
```json
{ "code": 0, "message": "ok", "data": {...}, "requestId": "..." }
```
错误:
```json
{ "code": 10001, "message": "bad_request: field slug required", "requestId": "..." }
```

✅ **分页规范**:?page=1&limit=20;返回包含 total, items
✅ **过滤与排序**:白名单字段;防注入;对可排序字段建合适索引
✅ **幂等性**:对外回调/转账类操作引入 idempotencyKey 或基于业务键的去重
✅ **状态码**:2xx 成功,4xx 客户端错误(含业务),5xx 服务器错误
✅ **OpenAPI**:字段描述、示例、错误码必须列出

## 安全与合规

✅ **授权中间件**:JWT 校验、角色/权限矩阵
✅ **输入校验**:Joi/Zod,边界与类型校验
✅ **速率限制**:基于 IP + 用户 ID;登录/管理接口更严格
✅ **CORS**:白名单
✅ **Helmet**:基本安全头
✅ **SQL 安全**:一律使用 Knex 参数化
✅ **审计日志**:记录关键操作与操作者、来源 IP、UA
✅ **备份**:关键表每日备份策略(由 Deploy 执行,但我们配合提供迁移脚本与导出工具)

❌ 禁止在 catch 中吞掉错误
❌ 禁止在 SELECT * 或无索引条件下扫描大表
❌ 禁止将冷启动/长耗时逻辑放在同步路径(应交给 SCF/队列)

## 反例说明

**反例1**:接口直接返回 ORM 对象,缺少错误映射 → 前端解析不一致
**反例2**:分页未加索引 → P95 超 2s
**反例3**:把转码逻辑放在请求线程阻塞 30s → 超时/雪崩

---

严格遵守以上规则,确保后端服务高质量!
