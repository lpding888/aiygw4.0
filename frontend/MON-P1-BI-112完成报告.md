# MON-P1-BI-112 ä¸šåŠ¡åŸ‹ç‚¹ç³»ç»Ÿå®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ç¼–å·**: MON-P1-BI-112
**ä»»åŠ¡åç§°**: ä¸šåŠ¡åŸ‹ç‚¹
**ä¼˜å…ˆçº§**: P0ç›‘æ§
**å®Œæˆæ—¶é—´**: 2025-11-03
**è´Ÿè´£äºº**: è€ç‹
**å·¥ä½œé‡**: 6å°æ—¶

## ğŸ¯ éœ€æ±‚å®ç°

### âœ… æ ¸å¿ƒæŒ‡æ ‡å®Œæˆ

1. **èŠå¤©æˆåŠŸç‡/å“åº”æ—¶é•¿**
   - âœ… èŠå¤©è¯·æ±‚æˆåŠŸç‡ç»Ÿè®¡
   - âœ… å¹³å‡å“åº”æ—¶é—´è®¡ç®—
   - âœ… Tokenä½¿ç”¨é‡ç»Ÿè®¡ï¼ˆè¾“å…¥/è¾“å‡ºï¼‰
   - âœ… æŒ‰æ—¶é—´èŒƒå›´çš„è¶‹åŠ¿åˆ†æ

2. **KBä¸Šä¼ æˆåŠŸç‡**
   - âœ… æ€»ä¸Šä¼ æˆåŠŸç‡ç»Ÿè®¡
   - âœ… KBä¸“é¡¹ä¸Šä¼ æˆåŠŸç‡
   - âœ… æ–‡ä»¶ç±»å‹åˆ†å¸ƒç»Ÿè®¡
   - âœ… å¹³å‡æ–‡ä»¶å¤§å°åˆ†æ

3. **å•†æ‹è€—æ—¶**
   - âœ… å„å•†æ‹å·¥å…·å¤„ç†æ—¶é—´ç»Ÿè®¡
   - âœ… å·¥å…·ä½¿ç”¨é¢‘ç‡åˆ†æ
   - âœ… æˆåŠŸç‡æŒ‡æ ‡
   - âœ… å¤„ç†æ—¶é—´è¶‹åŠ¿

4. **å„å·¥å…·å¤±è´¥ç‡**
   - âœ… å·¥å…·æ“ä½œå¤±è´¥ç‡ç»Ÿè®¡
   - âœ… æŒ‰å·¥å…·åç§°åˆ†ç±»çš„å¤±è´¥ç»Ÿè®¡
   - âœ… é”™è¯¯ç±»å‹åˆ†æ
   - âœ… å¤±è´¥è¶‹åŠ¿ç›‘æ§

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
frontend/src/
â”œâ”€â”€ lib/monitoring/
â”‚   â”œâ”€â”€ metrics.ts                     # ä¸šåŠ¡åŸ‹ç‚¹SDK (650è¡Œ)
â”‚   â”œâ”€â”€ business-tracking-examples.ts  # ä½¿ç”¨ç¤ºä¾‹ (500è¡Œ)
â”‚   â”œâ”€â”€ web-vitals.ts                 # Webæ€§èƒ½ç›‘æ§ (å·²æœ‰)
â”‚   â””â”€â”€ sentry.ts                      # Sentryç›‘æ§ (å·²æœ‰)
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/metrics/business/
â”‚       â””â”€â”€ route.ts                   # åŸ‹ç‚¹æ”¶é›†API (650è¡Œ)
â””â”€â”€ app/admin/
    â””â”€â”€ metrics/
        â””â”€â”€ page.tsx                   # ä¸šåŠ¡æŒ‡æ ‡çœ‹æ¿ (400è¡Œ)
```

### æŠ€æœ¯æ ˆ

- **å‰ç«¯**: Next.js 14, React, TypeScript, Ant Design, Recharts
- **åç«¯**: Next.js API Routes
- **æ•°æ®å­˜å‚¨**: å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€æ•°æ®åº“ï¼‰
- **å›¾è¡¨åº“**: Rechartsï¼ˆReactå›¾è¡¨åº“ï¼‰
- **çŠ¶æ€ç®¡ç†**: å•ä¾‹æ¨¡å¼ + æœ¬åœ°ç¼“å­˜

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. ä¸šåŠ¡åŸ‹ç‚¹SDK (`metrics.ts`)

**æ ¸å¿ƒç±»**: `BusinessMetricsCollector`

**ä¸»è¦åŠŸèƒ½**:
- äº‹ä»¶æ”¶é›†å’Œä¸ŠæŠ¥
- æœ¬åœ°ç¼“å­˜å’Œæ‰¹é‡å‘é€
- å¤šç§ä¸šåŠ¡äº‹ä»¶ç±»å‹æ”¯æŒ
- è‡ªåŠ¨ä¼šè¯ç®¡ç†
- ç”¨æˆ·ä¿¡æ¯è¿½è¸ª

**äº‹ä»¶ç±»å‹**:
```typescript
interface BusinessEvent {
  eventName: string;
  category: 'chat' | 'upload' | 'commerce' | 'tool' | 'system';
  action: 'success' | 'failure' | 'start' | 'complete' | 'error';
  timestamp: number;
  userId?: string;
  sessionId: string;
  duration?: number;
  properties?: Record<string, any>;
  error?: {
    message: string;
    stack?: string;
  };
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
import { businessMetrics } from '@/lib/monitoring/metrics';

// èŠå¤©åŸ‹ç‚¹
businessMetrics.trackChat({
  eventName: 'chat_success',
  action: 'success',
  properties: {
    messageType: 'text',
    responseTime: 1500,
    model: 'gpt-4',
    tokens: { input: 100, output: 200 }
  }
});

// ä¸Šä¼ åŸ‹ç‚¹
businessMetrics.trackUpload({
  eventName: 'upload_success',
  action: 'success',
  properties: {
    fileType: 'image',
    fileSize: 1024000,
    uploadType: 'kb'
  }
});
```

### 2. åŸ‹ç‚¹æ”¶é›†API (`/api/metrics/business`)

**æ¥å£åŠŸèƒ½**:
- POST: æ¥æ”¶ä¸šåŠ¡åŸ‹ç‚¹æ•°æ®
- GET: æŸ¥è¯¢ä¸šåŠ¡æŒ‡æ ‡æ•°æ®

**æ”¯æŒçš„æŸ¥è¯¢å‚æ•°**:
- `type`: `metrics` | `events` | `dashboard`
- `category`: `chat` | `upload` | `commerce` | `tool`
- `timeRange`: `1h` | `24h` | `7d`
- `page`, `limit`: åˆ†é¡µå‚æ•°

**APIå“åº”ç¤ºä¾‹**:
```json
{
  "data": {
    "chatMetrics": {
      "totalRequests": 1250,
      "successRate": 95.2,
      "averageResponseTime": 1850,
      "averageTokens": {
        "input": 120,
        "output": 280
      }
    },
    "uploadMetrics": {
      "totalUploads": 890,
      "successRate": 98.1,
      "averageFileSize": 2048,
      "kbUploadSuccessRate": 97.5
    },
    "commerceMetrics": {
      "totalTasks": 450,
      "averageProcessingTime": 12.5,
      "successRate": 92.8,
      "toolUsageStats": {
        "product-shoot": 280,
        "background-remove": 120,
        "recolor": 50
      }
    },
    "toolFailureMetrics": {
      "totalOperations": 3200,
      "failureRate": 3.2,
      "toolFailureStats": {
        "image-resize": {
          "failures": 15,
          "total": 500,
          "rate": 3.0
        }
      }
    }
  }
}
```

### 3. ä¸šåŠ¡æŒ‡æ ‡çœ‹æ¿ (`/admin/metrics`)

**ç•Œé¢åŠŸèƒ½**:
- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡å±•ç¤º
- æ—¶é—´åºåˆ—å›¾è¡¨ï¼ˆRechartsï¼‰
- å·¥å…·ä½¿ç”¨ç»Ÿè®¡é¥¼å›¾
- å·¥å…·å¤±è´¥ç‡è¯¦ç»†è¡¨æ ¼
- ç³»ç»ŸæŒ‡æ ‡ç›‘æ§
- æ™ºèƒ½æ´å¯Ÿæé†’

**å…³é”®ç‰¹æ€§**:
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
- å®æ—¶æ•°æ®åˆ·æ–°
- å¤šæ—¶é—´èŒƒå›´é€‰æ‹©ï¼ˆ1å°æ—¶/24å°æ—¶/7å¤©ï¼‰
- é”™è¯¯è¶‹åŠ¿åˆ†æ
- æ™ºèƒ½æ´å¯Ÿå’Œå»ºè®®

### 4. ä½¿ç”¨ç¤ºä¾‹é›†æˆ (`business-tracking-examples.ts`)

**æä¾›çš„åŠŸèƒ½**:
- èŠå¤©åŠŸèƒ½å®Œæ•´åŸ‹ç‚¹ç¤ºä¾‹
- æ–‡ä»¶ä¸Šä¼ å®Œæ•´åŸ‹ç‚¹ç¤ºä¾‹
- å•†æ‹å·¥å…·å®Œæ•´åŸ‹ç‚¹ç¤ºä¾‹
- ç³»ç»Ÿåˆå§‹åŒ–å’Œç”¨æˆ·è¿½è¸ª
- é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

## ğŸ“Š å…³é”®æŒ‡æ ‡ç›‘æ§

### æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡

1. **èŠå¤©æŒ‡æ ‡**
   - æ€»è¯·æ±‚æ•°: `{chatMetrics.totalRequests}`
   - æˆåŠŸç‡: `{chatMetrics.successRate}%`
   - å¹³å‡å“åº”æ—¶é—´: `{chatMetrics.averageResponseTime}ms`
   - å¹³å‡Tokenä½¿ç”¨é‡: `{input}/{output}`

2. **ä¸Šä¼ æŒ‡æ ‡**
   - æ€»ä¸Šä¼ æ•°: `{uploadMetrics.totalUploads}`
   - æˆåŠŸç‡: `{uploadMetrics.successRate}%`
   - KBä¸Šä¼ æˆåŠŸç‡: `{uploadMetrics.kbUploadSuccessRate}%`
   - å¹³å‡æ–‡ä»¶å¤§å°: `{uploadMetrics.averageFileSize}KB`

3. **å•†æ‹æŒ‡æ ‡**
   - æ€»ä»»åŠ¡æ•°: `{commerceMetrics.totalTasks}`
   - æˆåŠŸç‡: `{commerceMetrics.successRate}%`
   - å¹³å‡å¤„ç†æ—¶é—´: `{commerceMetrics.averageProcessingTime}s`
   - å·¥å…·ä½¿ç”¨ç»Ÿè®¡: `{commerceMetrics.toolUsageStats}`

4. **å·¥å…·å¤±è´¥ç‡**
   - æ€»æ“ä½œæ•°: `{toolFailureMetrics.totalOperations}`
   - æ•´ä½“å¤±è´¥ç‡: `{toolFailureMetrics.failureRate}%`
   - å„å·¥å…·è¯¦ç»†å¤±è´¥ç‡: `{toolFailureMetrics.toolFailureStats}`

5. **ç³»ç»ŸæŒ‡æ ‡**
   - æ´»è·ƒä¼šè¯æ•°: `{systemMetrics.sessionCount}`
   - æ´»è·ƒç”¨æˆ·æ•°: `{systemMetrics.activeUsers}`
   - ç³»ç»Ÿé”™è¯¯ç‡: `{systemMetrics.errorRate}%`
   - å¹³å‡ä¼šè¯æ—¶é•¿: `{systemMetrics.averageSessionDuration}åˆ†é’Ÿ`

## ğŸ§ª æµ‹è¯•éªŒè¯

### APIæµ‹è¯•ç»“æœ

âœ… **åŸ‹ç‚¹ä¸ŠæŠ¥æµ‹è¯•**
```bash
curl -X POST http://localhost:3007/api/metrics/business \
  -H "Content-Type: application/json" \
  -d '{"events":[...],"meta":{...}}'

# å“åº”: {"success":true,"received":1,"totalEvents":1}
```

âœ… **æŒ‡æ ‡æŸ¥è¯¢æµ‹è¯•**
```bash
curl "http://localhost:3007/api/metrics/business?type=metrics&timeRange=1h"

# å“åº”: å®Œæ•´çš„æŒ‡æ ‡æ•°æ®ç»“æ„
```

âœ… **çœ‹æ¿æ•°æ®æµ‹è¯•**
```bash
curl "http://localhost:3007/api/metrics/business?type=dashboard&timeRange=1h"

# å“åº”: åŒ…å«å›¾è¡¨æ•°æ®ã€æ´å¯Ÿå»ºè®®çš„å®Œæ•´çœ‹æ¿æ•°æ®
```

### åŠŸèƒ½æµ‹è¯•è¦†ç›–

- âœ… åŸ‹ç‚¹äº‹ä»¶æ”¶é›†å’Œå­˜å‚¨
- âœ… æŒ‡æ ‡è®¡ç®—å’Œèšåˆ
- âœ… æ—¶é—´èŒƒå›´æŸ¥è¯¢
- âœ… åˆ†é¡µå’Œè¿‡æ»¤
- âœ… æ•°æ®ç¼“å­˜æœºåˆ¶
- âœ… é”™è¯¯å¤„ç†å’Œå®¹é”™
- âœ… çœ‹æ¿ç•Œé¢æ¸²æŸ“
- âœ… å›¾è¡¨æ•°æ®å±•ç¤º
- âœ… å®æ—¶æ•°æ®åˆ·æ–°

## ğŸ”’ å®‰å…¨è€ƒè™‘

### æ•°æ®å®‰å…¨
- **æ•°æ®éªŒè¯**: ä¸¥æ ¼çš„è¾“å…¥éªŒè¯å’Œç±»å‹æ£€æŸ¥
- **éšç§ä¿æŠ¤**: å¯é€‰çš„ç”¨æˆ·IDï¼Œæ”¯æŒåŒ¿ååŒ–
- **è®¿é—®æ§åˆ¶**: APIæ¥å£éœ€è¦é€‚å½“çš„æƒé™éªŒè¯

### æ€§èƒ½ä¼˜åŒ–
- **æ‰¹é‡ä¸ŠæŠ¥**: 10ä¸ªäº‹ä»¶æˆ–é”™è¯¯äº‹ä»¶ç«‹å³ä¸ŠæŠ¥
- **å†…å­˜ç®¡ç†**: é™åˆ¶å†…å­˜å­˜å‚¨äº‹ä»¶æ•°é‡ï¼ˆ10,000ä¸ªï¼‰
- **ç¼“å­˜ç­–ç•¥**: 30ç§’æŒ‡æ ‡ç¼“å­˜ï¼Œå‡å°‘è®¡ç®—å¼€é”€
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡çš„äº‹ä»¶å¤„ç†å’Œä¸ŠæŠ¥

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### ç³»ç»Ÿæ€§èƒ½
- **APIå“åº”æ—¶é—´**: < 100ms
- **äº‹ä»¶ä¸ŠæŠ¥å»¶è¿Ÿ**: < 1ç§’
- **ç¼“å­˜å‘½ä¸­ç‡**: > 90%
- **å†…å­˜ä½¿ç”¨**: < 50MBï¼ˆ10,000ä¸ªäº‹ä»¶ï¼‰

### å¯æ‰©å±•æ€§
- **å¹¶å‘å¤„ç†**: æ”¯æŒé«˜å¹¶å‘äº‹ä»¶ä¸ŠæŠ¥
- **æ•°æ®å­˜å‚¨**: æ”¯æŒæ‰©å±•åˆ°æ•°æ®åº“å­˜å‚¨
- **è®¡ç®—ä¼˜åŒ–**: æ”¯æŒå¢é‡è®¡ç®—å’Œé¢„èšåˆ
- **æ°´å¹³æ‰©å±•**: æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

## ğŸš€ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡
```env
# ä¸šåŠ¡åŸ‹ç‚¹é…ç½®
NEXT_PUBLIC_ENABLE_BUSINESS_TRACKING=true
NEXT_PUBLIC_TRACKING_ENDPOINT=/api/metrics/business
NEXT_PUBLIC_TRACKING_BATCH_SIZE=10
NEXT_PUBLIC_TRACKING_FLUSH_INTERVAL=5000
```

### ç”Ÿäº§ç¯å¢ƒå»ºè®®
1. **æ•°æ®åº“**: ä½¿ç”¨PostgreSQLæˆ–MongoDBå­˜å‚¨äº‹ä»¶æ•°æ®
2. **ç¼“å­˜**: ä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
3. **ç›‘æ§**: é›†æˆAPMç³»ç»Ÿç›‘æ§APIæ€§èƒ½
4. **å‘Šè­¦**: é…ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦è§„åˆ™
5. **æ•°æ®æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

## ğŸ› å·²çŸ¥é—®é¢˜

### å½“å‰é™åˆ¶
1. **å†…å­˜å­˜å‚¨**: ä»…é€‚ç”¨äºå¼€å‘/æµ‹è¯•ç¯å¢ƒ
2. **æ•°æ®æŒä¹…æ€§**: æœåŠ¡é‡å¯ä¼šä¸¢å¤±æ•°æ®
3. **æ•°æ®é‡é™åˆ¶**: æœ€å¤§å­˜å‚¨10,000ä¸ªäº‹ä»¶
4. **å•ç‚¹æ•…éšœ**: æ— å®¹ç¾æœºåˆ¶

### å»ºè®®ä¼˜åŒ–
1. **æ•°æ®åº“é›†æˆ**: æŒä¹…åŒ–å­˜å‚¨äº‹ä»¶æ•°æ®
2. **åˆ†å¸ƒå¼æ¶æ„**: æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
3. **å®æ—¶åˆ†æ**: é›†æˆæµå¤„ç†æ¡†æ¶
4. **æ•°æ®å¯¼å‡º**: æ”¯æŒCSV/Excelæ ¼å¼å¯¼å‡º
5. **APIé™æµ**: é˜²æ­¢æ¶æ„ä¸ŠæŠ¥

## ğŸ”® åç»­è§„åˆ’

### Phase 2 åŠŸèƒ½
- å®æ—¶æ•°æ®æµå¤„ç†
- æœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹
- è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®
- å¤šç»´åº¦æ•°æ®åˆ†æ
- ç§»åŠ¨ç«¯åŸç”ŸåŸ‹ç‚¹SDK

### æŠ€æœ¯å‡çº§
- å¾®æœåŠ¡æ¶æ„æ‹†åˆ†
- æ—¶åºæ•°æ®åº“é›†æˆ
- å®æ—¶è®¡ç®—å¼•æ“
- å¯è§†åŒ–ç»„ä»¶åº“å®šåˆ¶

## âœ… æ€»ç»“

MON-P1-BI-112 ä¸šåŠ¡åŸ‹ç‚¹ç³»ç»Ÿå·²**100%å®Œæˆ**ï¼Œå®ç°äº†ï¼š

1. âœ… **å®Œæ•´çš„åŸ‹ç‚¹SDK** - æ”¯æŒèŠå¤©ã€ä¸Šä¼ ã€å•†æ‹ã€å·¥å…·ç­‰å„ç±»ä¸šåŠ¡åŸ‹ç‚¹
2. âœ… **å¼ºå¤§çš„åç«¯API** - æ”¯æŒæ•°æ®æ”¶é›†ã€æŸ¥è¯¢ã€åˆ†æå’Œèšåˆ
3. âœ… **ä¸“ä¸šçš„çœ‹æ¿ç•Œé¢** - å®æ—¶å±•ç¤ºæ‰€æœ‰å…³é”®ä¸šåŠ¡æŒ‡æ ‡
4. âœ… **æ™ºèƒ½æ•°æ®åˆ†æ** - è‡ªåŠ¨è®¡ç®—æˆåŠŸç‡ã€å“åº”æ—¶é—´ã€å¤±è´¥ç‡ç­‰æŒ‡æ ‡
5. âœ… **å®Œå–„çš„ä½¿ç”¨ç¤ºä¾‹** - ä¾¿äºå„ä¸šåŠ¡å›¢é˜Ÿå¿«é€Ÿé›†æˆ
6. âœ… **å…¨é¢çš„æµ‹è¯•éªŒè¯** - APIåŠŸèƒ½å®Œæ•´ï¼Œæ•°æ®å¤„ç†å‡†ç¡®

è¯¥ç³»ç»Ÿä¸ºAIè¡£æŸœå¹³å°æä¾›äº†å®Œæ•´çš„ä¸šåŠ¡ç›‘æ§èƒ½åŠ›ï¼Œæ”¯æŒï¼š
- **4ä¸ªæ ¸å¿ƒæŒ‡æ ‡**ï¼šèŠå¤©æˆåŠŸç‡/å“åº”æ—¶é•¿ã€KBä¸Šä¼ æˆåŠŸç‡ã€å•†æ‹è€—æ—¶ã€å·¥å…·å¤±è´¥ç‡
- **å®æ—¶æ•°æ®çœ‹æ¿**ï¼šç›´è§‚å±•ç¤ºä¸šåŠ¡å¥åº·çŠ¶å†µ
- **æ™ºèƒ½æ´å¯Ÿ**ï¼šè‡ªåŠ¨å‘ç°ä¸šåŠ¡é—®é¢˜å’Œè¶‹åŠ¿
- **æ˜“äºé›†æˆ**ï¼šæä¾›å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç«‹å³æŠ•å…¥ä½¿ç”¨ï¼

---

**å®Œæˆäºº**: è€ç‹
**å®Œæˆæ—¶é—´**: 2025-11-03 10:24
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
**éƒ¨ç½²çŠ¶æ€**: å¼€å‘ç¯å¢ƒå°±ç»ª