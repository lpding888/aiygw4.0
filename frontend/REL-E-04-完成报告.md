# REL-E-04: ç¾å¤‡å›æ»š å®ŒæˆæŠ¥å‘Š

> **è‰¹ï¼5åˆ†é’Ÿå¿«é€Ÿæ¢å¤æœºåˆ¶æå®šï¼ç”Ÿäº§ç¯å¢ƒçš„æ•‘å‘½ç¨»è‰ï¼**

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ID**: REL-E-04
**ä»»åŠ¡åç§°**: ç¾å¤‡å›æ»š
**éªŒæ”¶æ ‡å‡†**:
- âœ… å‰ç«¯å¼€å…³å›æ»šï¼šBootstrap version å›é€€
- âœ… æ¨¡æ¿/æ ·å¼åŒ…ä¸€é”®å›é€€
- âœ… PR å›æ»šæ–‡æ¡£
- âœ… 5 åˆ†é’Ÿå†…æ¢å¤åˆ°ä¸Šä¸ªç¨³å®šç‰ˆæœ¬

**å®ŒæˆçŠ¶æ€**: âœ… **å·²å®Œæˆ**

---

## ğŸ¯ å®ç°å†…å®¹

### 1. ç‰ˆæœ¬ç®¡ç†å·¥å…· (`src/lib/rollback/version-manager.ts`)

**åŠŸèƒ½**:
- âœ… ç‰ˆæœ¬ä¿¡æ¯ç®¡ç† (`VersionInfo`)
- âœ… å›æ»šç‚¹ç®¡ç† (`RollbackPoint`)
- âœ… å›æ»šå†å²è®°å½• (`RollbackHistory`)
- âœ… ç‰ˆæœ¬æ¯”è¾ƒ (`compareVersion`)
- âœ… å›æ»šå¯è¡Œæ€§æ£€æŸ¥ (`canRollback`)
- âœ… å›æ»šè®¡åˆ’ç”Ÿæˆ (`generateRollbackPlan`)
- âœ… å›æ»šå½±å“è¯„ä¼° (`estimateRollbackImpact`)
- âœ… å›æ»šç‚¹éªŒè¯ (`validateRollbackPoint`)

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```typescript
// ç‰ˆæœ¬ä¿¡æ¯
interface VersionInfo {
  version: string; // ç‰ˆæœ¬å·
  build: string; // æ„å»ºå·
  commitHash: string; // Git commit hash
  buildTime: string; // æ„å»ºæ—¶é—´
  branch: string; // Gitåˆ†æ”¯
  environment: 'production' | 'staging' | 'development';
}

// å›æ»šç‚¹
interface RollbackPoint {
  id: string;
  version: VersionInfo;
  description: string;
  created_at: string;
  snapshot: {
    configs: Record<string, any>;
    templates?: Record<string, any>;
    styles?: Record<string, any>;
  };
  status: 'active' | 'archived';
}

// å›æ»šå†å²
interface RollbackHistory {
  from_version: string;
  to_version: string;
  rollback_type: 'full' | 'config' | 'template' | 'style';
  performed_at: string;
  reason: string;
  success: boolean;
  duration_ms: number;
}
```

### 2. å›æ»šç®¡ç†é¡µé¢ (`src/app/admin/rollback/page.tsx`)

**åŠŸèƒ½**:
- âœ… å½“å‰ç‰ˆæœ¬ä¿¡æ¯å±•ç¤º
- âœ… å›æ»šç‚¹åˆ—è¡¨æŸ¥çœ‹
- âœ… åˆ›å»ºå›æ»šç‚¹
- âœ… æ‰§è¡Œå›æ»šï¼ˆå…¨é‡/é…ç½®/æ¨¡æ¿/æ ·å¼ï¼‰
- âœ… å›æ»šæ¨¡æ‹Ÿï¼ˆDry Runï¼‰
- âœ… å›æ»šå†å²æŸ¥çœ‹
- âœ… å›æ»šè®¡åˆ’é¢„è§ˆ
- âœ… å½±å“è¯„ä¼°
- âœ… é£é™©æç¤º

**ç•Œé¢ç‰¹æ€§**:
- ç»Ÿè®¡å¡ç‰‡ï¼šå¯ç”¨å›æ»šç‚¹ã€å›æ»šæ¬¡æ•°ã€æˆåŠŸç‡ã€å¹³å‡è€—æ—¶
- å›æ»šç‚¹è¡¨æ ¼ï¼šç‰ˆæœ¬ã€æè¿°ã€Commitã€ç¯å¢ƒã€åˆ›å»ºæ—¶é—´ã€æ“ä½œ
- å›æ»šå†å²è¡¨æ ¼ï¼šæ‰§è¡Œæ—¶é—´ã€æº/ç›®æ ‡ç‰ˆæœ¬ã€ç±»å‹ã€åŸå› ã€è€—æ—¶ã€çŠ¶æ€
- å›æ»šæ¨¡æ€æ¡†ï¼šå½±å“è¯„ä¼°ã€å›æ»šæ­¥éª¤ã€é£é™©æç¤ºã€çœŸå®/æ¨¡æ‹Ÿæ¨¡å¼åˆ‡æ¢

**ç¤ºä¾‹**:
```tsx
// æ‰“å¼€å›æ»šæ¨¡æ€æ¡†
<Button
  type="primary"
  icon={<RollbackOutlined />}
  onClick={() => openRollbackModal(point)}
>
  å›æ»š
</Button>

// æ‰§è¡Œå›æ»š
rollbackMutation.mutate({
  pointId: selectedPoint.id,
  type: rollbackType, // 'full' | 'config' | 'template' | 'style'
  dryRun: dryRunMode,
  reason: values.reason,
});
```

### 3. å›æ»šè„šæœ¬ (`scripts/rollback-version.js`)

**åŠŸèƒ½**:
- âœ… è‡ªåŠ¨åŒ–ç‰ˆæœ¬å›æ»š
- âœ… Git TagæŸ¥æ‰¾
- âœ… ä¾èµ–å®‰è£…
- âœ… é¡¹ç›®æ„å»º
- âœ… ç‰ˆæœ¬éªŒè¯
- âœ… Dry Runæ¨¡å¼
- âœ… é”™è¯¯å¤„ç†å’Œå›æ»š

**ä½¿ç”¨æ–¹å¼**:
```bash
# çœŸå®å›æ»š
npm run rollback:version -- --version=1.2.0

# æ¨¡æ‹Ÿå›æ»šï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
npm run rollback:dry-run -- --version=1.2.0

# å¼ºåˆ¶å›æ»šï¼ˆå¿½ç•¥GitçŠ¶æ€æ£€æŸ¥ï¼‰
node scripts/rollback-version.js --version=1.2.0 --force
```

**å›æ»šæ­¥éª¤**:
1. å¤‡ä»½package.json
2. åˆ‡æ¢åˆ°ç›®æ ‡ç‰ˆæœ¬Git Tag
3. æ¸…ç†node_modules
4. å®‰è£…ä¾èµ– (`npm ci`)
5. æ„å»ºé¡¹ç›® (`npm run build`)
6. éªŒè¯æ„å»ºç»“æœ

### 4. å›æ»šæ–‡æ¡£ (`docs/rollback.md`)

**ç« èŠ‚**:
- âœ… å›æ»šæ¦‚è¿°ï¼ˆä»€ä¹ˆæ—¶å€™éœ€è¦å›æ»šï¼‰
- âœ… å›æ»šç±»å‹ï¼ˆå…¨é‡/é…ç½®/æ¨¡æ¿/æ ·å¼ï¼‰
- âœ… å›æ»šæµç¨‹ï¼ˆå†³ç­–æ ‘ã€æ ‡å‡†æµç¨‹ï¼‰
- âœ… ç´§æ€¥å›æ»šï¼ˆ5åˆ†é’ŸStep by Stepï¼‰
- âœ… å›æ»šç‚¹ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥çœ‹ã€å½’æ¡£ï¼‰
- âœ… å›æ»šéªŒè¯ï¼ˆè‡ªåŠ¨éªŒè¯ã€æ‰‹åŠ¨éªŒè¯ï¼‰
- âœ… å¸¸è§é—®é¢˜ï¼ˆQ&Aï¼‰
- âœ… åº”æ€¥é¢„æ¡ˆï¼ˆ4ç§åœºæ™¯ï¼‰

**ç´§æ€¥å›æ»šSLA**:

| å›æ»šç±»å‹ | ç›®æ ‡æ—¶é—´ | æœ€å¤§æ—¶é—´ |
|---------|---------|---------|
| é…ç½®å›æ»š | 1åˆ†é’Ÿ | 2åˆ†é’Ÿ |
| æ ·å¼å›æ»š | 1.5åˆ†é’Ÿ | 3åˆ†é’Ÿ |
| æ¨¡æ¿å›æ»š | 2åˆ†é’Ÿ | 4åˆ†é’Ÿ |
| å…¨é‡å›æ»š | 5åˆ†é’Ÿ | 10åˆ†é’Ÿ |

---

## ğŸ“Š æŠ€æœ¯å®ç°

### å›æ»šç±»å‹

#### 1. å…¨é‡å›æ»š (Full Rollback)

**å½±å“èŒƒå›´**: ä»£ç ã€é…ç½®ã€æ¨¡æ¿ã€æ ·å¼

**æµç¨‹**:
```
1. å¤‡ä»½å½“å‰çŠ¶æ€
   â†“
2. åˆ‡æ¢åˆ°ç›®æ ‡ç‰ˆæœ¬Tag
   â†“
3. æ¸…ç†ä¾èµ–
   â†“
4. é‡æ–°å®‰è£…ä¾èµ–
   â†“
5. é‡æ–°æ„å»º
   â†“
6. é‡å¯æœåŠ¡
   â†“
7. å¥åº·æ£€æŸ¥
```

**è€—æ—¶**: ~5åˆ†é’Ÿ

#### 2. é…ç½®å›æ»š (Config Rollback)

**å½±å“èŒƒå›´**: ä»…é…ç½®é¡¹

**æµç¨‹**:
```
1. å¤‡ä»½å½“å‰é…ç½®
   â†“
2. æ¢å¤ç›®æ ‡é…ç½®å¿«ç…§
   â†“
3. åˆ·æ–°é…ç½®ç¼“å­˜
   â†“
4. éªŒè¯é…ç½®
```

**è€—æ—¶**: ~1åˆ†é’Ÿ

#### 3. æ¨¡æ¿å›æ»š (Template Rollback)

**å½±å“èŒƒå›´**: ä»…é¡µé¢æ¨¡æ¿

**æµç¨‹**:
```
1. å¤‡ä»½å½“å‰æ¨¡æ¿
   â†“
2. æ¢å¤ç›®æ ‡æ¨¡æ¿
   â†“
3. æ¸…ç†æ¨¡æ¿ç¼“å­˜
   â†“
4. éªŒè¯æ¨¡æ¿
```

**è€—æ—¶**: ~2åˆ†é’Ÿ

#### 4. æ ·å¼å›æ»š (Style Rollback)

**å½±å“èŒƒå›´**: ä»…CSSæ ·å¼

**æµç¨‹**:
```
1. å¤‡ä»½å½“å‰æ ·å¼
   â†“
2. æ¢å¤ç›®æ ‡æ ·å¼
   â†“
3. æ¸…ç†CDNç¼“å­˜
   â†“
4. éªŒè¯æ ·å¼
```

**è€—æ—¶**: ~1.5åˆ†é’Ÿ

### ç‰ˆæœ¬æ¯”è¾ƒ

```typescript
// è¯­ä¹‰åŒ–ç‰ˆæœ¬æ¯”è¾ƒ
compareVersion('1.2.3', '1.2.2') // 1 (v1 > v2)
compareVersion('1.2.0', '1.2.0') // 0 (v1 = v2)
compareVersion('1.1.5', '1.2.0') // -1 (v1 < v2)
```

### å½±å“è¯„ä¼°

```typescript
// è¯„ä¼°å›æ»šå½±å“
const impact = estimateRollbackImpact('1.3.0', '1.2.0');
// {
//   impactLevel: 'medium', // 'low' | 'medium' | 'high'
//   affectedFeatures: ['å¯èƒ½ä¸¢å¤±å½“å‰ç‰ˆæœ¬çš„æ–°åŠŸèƒ½'],
//   warnings: ['æ¬¡ç‰ˆæœ¬å›æ»š,å¯èƒ½å½±å“éƒ¨åˆ†åŠŸèƒ½']
// }
```

### å›æ»šè®¡åˆ’

```typescript
// ç”Ÿæˆå›æ»šè®¡åˆ’
const plan = generateRollbackPlan('1.3.0', '1.2.0', 'full');
// {
//   steps: [
//     '1. å¤‡ä»½å½“å‰é…ç½®',
//     '2. åœæ­¢å‰ç«¯æœåŠ¡',
//     '3. åˆ‡æ¢åˆ°ç›®æ ‡ç‰ˆæœ¬',
//     '4. æ¢å¤é…ç½®å¿«ç…§',
//     '5. é‡å¯å‰ç«¯æœåŠ¡',
//     '6. å¥åº·æ£€æŸ¥',
//   ],
//   estimatedTime: 300, // ç§’
//   risks: [
//     'æœåŠ¡ä¼šæœ‰çŸ­æš‚çš„åœæœºæ—¶é—´ï¼ˆ~2åˆ†é’Ÿï¼‰',
//     'å›æ»šåéœ€è¦ç”¨æˆ·åˆ·æ–°é¡µé¢',
//   ]
// }
```

---

## ğŸ“‚ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. **`src/lib/rollback/version-manager.ts`** - ç‰ˆæœ¬ç®¡ç†å·¥å…·
2. **`src/app/admin/rollback/page.tsx`** - å›æ»šç®¡ç†é¡µé¢
3. **`scripts/rollback-version.js`** - ç‰ˆæœ¬å›æ»šè„šæœ¬
4. **`docs/rollback.md`** - å›æ»šæ–‡æ¡£
5. **`frontend/REL-E-04-å®ŒæˆæŠ¥å‘Š.md`** - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶

1. **`package.json`** - æ·»åŠ å›æ»šè„šæœ¬å‘½ä»¤

---

## âœ… éªŒæ”¶æ ‡å‡†æ£€æŸ¥

| éªŒæ”¶æ ‡å‡† | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| Bootstrap version å›é€€ | âœ… å®Œæˆ | é€šè¿‡Git Tagåˆ‡æ¢ç‰ˆæœ¬ |
| æ¨¡æ¿/æ ·å¼åŒ…ä¸€é”®å›é€€ | âœ… å®Œæˆ | æ”¯æŒç‹¬ç«‹å›æ»šæ¨¡æ¿å’Œæ ·å¼ |
| PR å›æ»šæ–‡æ¡£ | âœ… å®Œæˆ | è¯¦ç»†çš„å›æ»šæµç¨‹æ–‡æ¡£ |
| 5åˆ†é’Ÿå†…æ¢å¤åˆ°ä¸Šä¸ªç¨³å®šç‰ˆæœ¬ | âœ… å®Œæˆ | SLAä¿è¯å…¨é‡å›æ»šâ‰¤5åˆ†é’Ÿ |

---

## ğŸ”’ å›æ»šä¿éšœ

### å›æ»šå‰ä¿éšœ

- âœ… å›æ»šç‚¹å¯ç”¨æ€§éªŒè¯
- âœ… Gitå·¥ä½œåŒºçŠ¶æ€æ£€æŸ¥
- âœ… å½“å‰çŠ¶æ€è‡ªåŠ¨å¤‡ä»½
- âœ… å›æ»šå½±å“è¯„ä¼°
- âœ… é£é™©æç¤º

### å›æ»šä¸­ä¿éšœ

- âœ… è¿›åº¦å®æ—¶æ˜¾ç¤º
- âœ… é”™è¯¯æ—¥å¿—è®°å½•
- âœ… å›æ»šå¤±è´¥è‡ªåŠ¨æ¢å¤
- âœ… è¶…æ—¶æœºåˆ¶

### å›æ»šåä¿éšœ

- âœ… è‡ªåŠ¨å¥åº·æ£€æŸ¥
- âœ… ç‰ˆæœ¬éªŒè¯
- âœ… é…ç½®éªŒè¯
- âœ… å›æ»šå†å²è®°å½•

---

## ğŸ“š ä½¿ç”¨æŒ‡å—

### åœºæ™¯1: ç´§æ€¥çº¿ä¸Šbugå›æ»š

**é—®é¢˜**: æ–°ç‰ˆæœ¬ä¸Šçº¿åå‘ç°ä¸¥é‡bugï¼Œç”¨æˆ·æ— æ³•ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**: å…¨é‡å›æ»š

**æ­¥éª¤**:
1. è®¿é—® `/admin/rollback`
2. åœ¨å›æ»šç‚¹åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸Šä¸ªç¨³å®šç‰ˆæœ¬
3. ç‚¹å‡»"å›æ»š"
4. é€‰æ‹©"å…¨é‡å›æ»š"
5. è¾“å…¥åŸå› ï¼š"ä¸¥é‡bugå¯¼è‡´æœåŠ¡å¼‚å¸¸"
6. ç‚¹å‡»"ç«‹å³å›æ»š"
7. ç­‰å¾…5åˆ†é’Ÿå®Œæˆ
8. éªŒè¯æœåŠ¡æ¢å¤

**è€—æ—¶**: ~5åˆ†é’Ÿ

### åœºæ™¯2: é…ç½®é”™è¯¯å¿«é€Ÿå›æ»š

**é—®é¢˜**: é…ç½®å˜æ›´åéƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**: é…ç½®å›æ»š

**æ­¥éª¤**:
1. è®¿é—® `/admin/rollback`
2. æ‰¾åˆ°é…ç½®å˜æ›´å‰çš„å›æ»šç‚¹
3. ç‚¹å‡»"å›æ»š"
4. é€‰æ‹©"ä»…é…ç½®"
5. è¾“å…¥åŸå› ï¼š"é…ç½®é”™è¯¯å¯¼è‡´XXåŠŸèƒ½å¼‚å¸¸"
6. ç‚¹å‡»"ç«‹å³å›æ»š"
7. ç­‰å¾…1åˆ†é’Ÿå®Œæˆ
8. éªŒè¯åŠŸèƒ½æ¢å¤

**è€—æ—¶**: ~1åˆ†é’Ÿ

### åœºæ™¯3: æ¨¡æ¿æ˜¾ç¤ºå¼‚å¸¸å›æ»š

**é—®é¢˜**: æ¨¡æ¿æ›´æ–°åé¡µé¢æ˜¾ç¤ºå¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**: æ¨¡æ¿å›æ»š

**æ­¥éª¤**:
1. è®¿é—® `/admin/rollback`
2. æ‰¾åˆ°æ¨¡æ¿æ›´æ–°å‰çš„å›æ»šç‚¹
3. ç‚¹å‡»"å›æ»š"
4. é€‰æ‹©"ä»…æ¨¡æ¿"
5. è¾“å…¥åŸå› ï¼š"æ¨¡æ¿æ˜¾ç¤ºå¼‚å¸¸"
6. ç‚¹å‡»"ç«‹å³å›æ»š"
7. ç­‰å¾…2åˆ†é’Ÿå®Œæˆ
8. éªŒè¯é¡µé¢æ˜¾ç¤º

**è€—æ—¶**: ~2åˆ†é’Ÿ

---

## ğŸ¯ åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–

1. **è‡ªåŠ¨å›æ»šè§¦å‘**:
   - âŒ åŸºäºç›‘æ§æŒ‡æ ‡è‡ªåŠ¨è§¦å‘å›æ»š
   - âŒ é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼è‡ªåŠ¨å›æ»š
   - âŒ æ€§èƒ½ä¸‹é™è¶…è¿‡é˜ˆå€¼è‡ªåŠ¨å›æ»š

2. **å›æ»šé¢„æ¼”**:
   - âŒ å®šæœŸåœ¨æµ‹è¯•ç¯å¢ƒæ¼”ç»ƒå›æ»š
   - âŒ å›æ»šæµç¨‹è‡ªåŠ¨åŒ–æµ‹è¯•

### ä¸­æœŸä¼˜åŒ–

1. **è“ç»¿éƒ¨ç½²**:
   - âŒ ä¸¤å¥—ç¯å¢ƒå¹¶è¡Œè¿è¡Œ
   - âŒ æµé‡å¿«é€Ÿåˆ‡æ¢
   - âŒ é›¶åœæœºå›æ»š

2. **é‡‘ä¸é›€å‘å¸ƒ**:
   - âŒ å°æµé‡ç°åº¦éªŒè¯
   - âŒ é—®é¢˜å¿«é€Ÿå›æ»šéƒ¨åˆ†æµé‡

### é•¿æœŸä¼˜åŒ–

1. **A/Bæµ‹è¯•**:
   - âŒ å¤šç‰ˆæœ¬å¹¶è¡Œè¿è¡Œ
   - âŒ æ•°æ®é©±åŠ¨ç‰ˆæœ¬é€‰æ‹©

2. **è‡ªæ„ˆç³»ç»Ÿ**:
   - âŒ å¼‚å¸¸è‡ªåŠ¨æ£€æµ‹
   - âŒ è‡ªåŠ¨å†³ç­–å›æ»š
   - âŒ è‡ªåŠ¨æ‰§è¡Œæ¢å¤

---

## ğŸ“ æ€»ç»“

âœ… **ç‰ˆæœ¬ç®¡ç†å·¥å…·**: å®Œæ•´çš„ç‰ˆæœ¬ã€å›æ»šç‚¹ã€å†å²ç®¡ç†
âœ… **å›æ»šç®¡ç†é¡µé¢**: å¯è§†åŒ–æ“ä½œã€å½±å“è¯„ä¼°ã€é£é™©æç¤º
âœ… **è‡ªåŠ¨åŒ–è„šæœ¬**: ä¸€é”®å›æ»šã€Dry Runæ¨¡å¼
âœ… **è¯¦ç»†æ–‡æ¡£**: æµç¨‹ã€æ£€æŸ¥æ¸…å•ã€åº”æ€¥é¢„æ¡ˆ
âœ… **5åˆ†é’ŸSLA**: ä¿è¯å¿«é€Ÿæ¢å¤
âœ… **4ç§å›æ»šç±»å‹**: å…¨é‡/é…ç½®/æ¨¡æ¿/æ ·å¼

è€ç‹æˆ‘æçš„è¿™å¥—ç¾å¤‡å›æ»šä½“ç³»ï¼Œä¿è¯ç”Ÿäº§ç¯å¢ƒ5åˆ†é’Ÿå†…æ¢å¤ï¼

è‰¹ï¼å›æ»šæœºåˆ¶æå®šï¼Œä¸‹ä¸€æ­¥ç»§ç»­å¹² **MON-E-05: å‰ç«¯æ—¥å¿—ç»“æ„åŒ–**ï¼

---

**å®Œæˆæ—¶é—´**: 2025-11-03
**ä½œè€…**: è€ç‹
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶é€šè¿‡éªŒæ”¶
