# CHECKLIST.md - 后端开发工程师自检清单

## 每次代码提交前必须自检的项目

### ✅ API接口设计完整性
- [ ] API路径是否符合RESTful设计原则？
- [ ] 请求参数是否都进行了适当的验证？
- [ ] 响应格式是否统一使用{success, data, message, code}？
- [ ] HTTP状态码是否使用正确？
- [ ] API接口是否有清晰的文档说明？

### ✅ 数据库设计和操作
- [ ] 数据库表结构设计是否合理？
- [ ] 是否为频繁查询的字段添加了索引？
- [ ] 数据迁移文件是否可以正确执行和回滚？
- [ ] 数据库操作是否使用Knex.js的参数化查询？
- [ ] 是否避免了SQL注入的风险？

### ✅ 业务逻辑和事务处理
- [ ] 核心业务逻辑是否封装在service层？
- [ ] 涉及多个表的操作是否使用了数据库事务？
- [ ] 配额扣减是否使用了行锁防止并发问题？
- [ ] 业务规则验证是否完整？
- [ ] 异常情况的处理是否合理？

### ✅ 认证和授权安全
- [ ] JWT token的生成和验证是否正确？
- [ ] API权限验证是否完整？
- [ ] 敏感信息是否加密存储？
- [ ] 是否实现了访问频率限制？
- [ ] 是否防止了常见的安全漏洞？

### ✅ 第三方服务集成
- [ ] 腾讯云COS的STS临时密钥生成是否安全？
- [ ] 微信支付的签名验证和回调处理是否正确？
- [ ] RunningHub API的调用是否包含适当的错误处理？
- [ ] 第三方服务的异常是否有合适的重试机制？
- [ ] API密钥是否安全存储，没有暴露在代码中？

### ✅ 配额和计费系统
- [ ] 配额扣减是否使用事务保证原子性？
- [ ] 配额不足时的检查和处理是否正确？
- [ ] 任务失败时配额返还逻辑是否完整？
- [ ] 并发场景下的配额管理是否安全？
- [ ] 配额使用记录是否完整准确？

### ✅ 任务处理和队列系统
- [ ] 异步任务是否正确加入队列处理？
- [ ] 任务状态变更是否及时更新数据库？
- [ ] 失败任务的重试机制是否合理？
- [ ] 队列消费者的错误处理是否完整？
- [ ] 任务处理的性能是否满足要求？

### ✅ 错误处理和日志记录
- [ ] 是否有全局错误处理中间件？
- [ ] 关键操作是否都有日志记录？
- [ ] 错误信息是否对用户友好？
- [ ] 敏感信息是否没有记录到日志中？
- [ ] 是否实现了系统监控和告警？

### ✅ 代码质量和规范
- [ ] 代码是否通过ESLint检查？
- [ ] 是否使用Prettier进行了格式化？
- [ ] 函数和变量命名是否清晰合理？
- [ ] 是否有适当的注释说明？
- [ ] 代码复用性是否良好？

### ✅ 测试和部署准备
- [ ] 是否编写了单元测试用例？
- [ ] API接口是否使用Postman进行了测试？
- [ ] 数据库迁移是否可以在开发环境执行？
- [ ] 环境变量配置是否完整？
- [ ] 是否只修改了任务范围内的文件？

## 输出前最后检查

在提交代码之前，请确认：

1. **功能完整性**：所有API接口都按需求实现
2. **安全性**：没有安全漏洞，敏感信息得到保护
3. **性能**：数据库查询优化，响应时间达标
4. **可靠性**：错误处理完整，事务安全
5. **可维护性**：代码结构清晰，注释完整

## 常见错误避免

❌ **避免这些错误**：
- 在API响应中暴露敏感信息（如密码、密钥）
- 配额管理不使用事务，导致超用或数据不一致
- 直接拼接SQL语句，存在SQL注入风险
- 不验证用户输入，导致安全漏洞
- 忽略错误处理，导致系统不稳定
- 在生产环境输出调试日志

✅ **坚持这些原则**：
- 安全第一，所有输入都要验证和过滤
- 事务安全，涉及数据修改的操作要原子化
- 性能优先，数据库查询要优化
- 错误处理，所有异常都要有合适的处理
- 代码质量，遵循最佳实践和编码规范

## 配额管理特别检查

⚠️ **配额管理安全检查**：
- [ ] 是否使用数据库事务进行配额操作？
- [ ] 是否使用`FOR UPDATE`行锁防止并发？
- [ ] 配额检查是否在扣减之前进行？
- [ ] 配额不足时是否抛出明确的错误？
- [ ] 任务失败时配额返还逻辑是否完整？
- [ ] 配额操作日志是否记录完整？

## 第三方集成特别检查

⚠️ **外部服务集成检查**：
- [ ] API密钥是否通过环境变量配置？
- [ ] 网络请求是否包含超时处理？
- [ ] 第三方服务异常是否不影响核心业务？
- [ ] 回调接口的签名验证是否完整？
- [ ] 重试机制是否合理，避免无限重试？