# FLOW.md - 后端开发工程师标准工作流程

## 标准工作流程（必须严格按此格式输出）

每次接收产品需求时，你必须按照以下8个步骤输出，不能缺省任何步骤：

### 1. API接口设计和规范
- **RESTful API设计**：遵循REST设计原则，使用标准HTTP方法
- **路径规划**：设计清晰的API路径结构，符合资源命名规范
- **请求参数规范**：定义请求体、查询参数、路径参数的验证规则
- **响应格式统一**：使用统一的响应格式{success, data, message, code}

### 2. 数据库设计和迁移
- **表结构设计**：设计符合业务需求的数据库表结构
- **索引优化**：为查询频繁的字段添加合适的索引
- **数据迁移文件**：编写Knex.js数据库迁移文件
- **数据验证约束**：添加字段约束和业务规则验证

### 3. 业务逻辑实现
- **服务层封装**：在service层实现核心业务逻辑
- **数据访问层**：使用Knex.js进行数据库操作，避免SQL注入
- **事务处理**：对涉及多个表的操作使用数据库事务
- **业务规则验证**：实现配额检查、权限验证等业务规则

### 4. 认证和授权系统
- **JWT Token管理**：实现用户登录认证和token验证中间件
- **权限控制**：基于用户角色的API访问控制
- **Session管理**：管理用户登录状态和会话信息
- **安全防护**：防止常见安全漏洞（XSS、CSRF、SQL注入）

### 5. 第三方服务集成
- **腾讯云COS集成**：实现STS临时密钥生成和文件上传管理
- **微信支付集成**：实现微信支付API v3的订单创建和回调处理
- **RunningHub AI集成**：实现AI模特生成任务的创建和状态查询
- **短信服务集成**：实现手机验证码发送功能

### 6. 配额和计费系统
- **配额管理**：实现用户配额的扣减、返还和查询
- **事务安全**：使用数据库事务和行锁确保配额操作的原子性
- **防并发控制**：防止配额超用的并发控制机制
- **计费记录**：记录配额使用历史和计费明细

### 7. 任务处理和队列系统
- **任务创建**：创建基础修图和AI模特生成任务
- **异步处理**：使用Bull队列处理长时间运行的异步任务
- **状态管理**：管理任务状态变更和结果回调
- **失败重试**：实现任务失败的重试和补偿机制

### 8. 错误处理和日志记录
- **统一错误处理**：实现全局错误处理中间件
- **日志记录**：记录关键操作和错误信息
- **监控告警**：实现系统健康检查和异常告警
- **性能监控**：监控API响应时间和系统资源使用

## 技术栈和工具

### 核心技术
- **Node.js + Express**：后端服务框架
- **Knex.js + MySQL**：数据库操作ORM和关系型数据库
- **JWT**：用户认证和授权
- **Bull Queue**：任务队列处理
- **PM2**：生产环境进程管理

### 开发工具
- **Nodemon**：开发环境热重载
- **ESLint + Prettier**：代码规范和格式化
- **Jest**：单元测试框架
- **Postman**：API测试工具

## 输出格式要求

- API接口要有清晰的文档说明
- 代码要有适当的注释和类型定义
- 错误处理要完整，避免未捕获异常
- 数据库操作要考虑性能和安全性

## 禁止事项

- 不能在前端暴露后端API密钥和敏感信息
- 不能忽略配额管理的原子性要求
- 不能直接执行未经验证的用户输入
- 不能在生产环境输出调试信息
- 不能使用不安全的数据库操作方式

## 安全要求

- 所有API接口都要进行权限验证
- 敏感信息要加密存储
- 数据库操作要使用参数化查询
- 要实现访问频率限制和防刷机制
- 定期更新依赖包，修复安全漏洞

## 性能要求

- API响应时间要控制在500ms以内
- 数据库查询要有适当的索引优化
- 静态资源要使用CDN加速
- 要实现适当的缓存策略
- 监控系统性能瓶颈并及时优化