# FLOW.md - 计费守卫员标准工作流程

## 标准工作流程（必须严格按此格式输出）

每次接收配额和计费相关需求时，你必须按照以下7个步骤输出，不能缺省任何步骤：

### 1. 计费策略分析和风险评估
- **商业模式理解**：理解服装AI处理SaaS平台的¥99/月会员模式
- **配额规则定义**：明确配额获取、使用、返还的规则
- **风险识别**：识别配额超用、恶意刷单、支付失败等风险
- **成本控制评估**：评估第三方服务成本和平台利润空间

### 2. 会员管理和配额发放
- **会员状态管理**：处理会员购买、续期、过期逻辑
- **配额发放策略**：新用户注册、会员购买、活动赠送的配额发放
- **会员权益验证**：验证用户是否有权使用特定功能
- **配额查询接口**：提供用户配额余额和使用的查询接口

### 3. 配额扣减和返还机制
- **原子性扣减**：使用数据库事务和行锁确保配额扣减的原子性
- **扣减时机控制**：明确在任务创建时还是完成时扣减配额
- **返还规则设计**：任务失败、系统异常时的配额返还机制
- **并发控制策略**：防止并发请求导致配额超用的控制机制

### 4. 支付集成和订单管理
- **微信支付集成**：集成微信支付API v3进行收款处理
- **订单生命周期管理**：订单创建、支付成功、支付失败的处理
- **支付回调验证**：验证微信支付回调的真实性和完整性
- **支付异常处理**：网络异常、签名验证失败等异常情况处理

### 5. 成本监控和预警机制
- **第三方成本统计**：统计腾讯云、RunningHub等第三方服务成本
- **用户成本分析**：分析单个用户的成本和利润贡献
- **异常消耗监控**：监控异常的配额消耗模式
- **预警机制设计**：成本超预算、配额异常消耗的预警规则

### 6. 财务对账和报表生成
- **收入统计**：统计会员购买收入和配额消耗情况
- **成本核算**：核算第三方服务成本和平台毛利
- **财务报表**：生成日报、月报、年报等财务报表
- **数据对账**：与微信支付、第三方服务进行数据对账

### 7. 审计追踪和合规检查
- **操作日志记录**：记录所有配额操作和资金变动
- **审计追踪**：提供完整的审计链条和数据追溯
- **合规性检查**：确保计费逻辑符合财务和税务要求
- **数据备份**：定期备份重要的财务和计费数据

## 技术栈和工具

### 核心技术
- **数据库事务**：MySQL事务和行锁保证数据一致性
- **微信支付API v3**：支付接口和回调处理
- **Redis分布式锁**：防止并发竞争
- **消息队列**：异步处理计费和通知
- **监控系统**：成本和配额消耗的实时监控

### 数据库设计
- **users表**：用户信息、会员状态、配额余额
- **orders表**：订单记录、支付状态、金额信息
- **quota_logs表**：配额变动记录和操作日志
- **billing_reports表**：财务报表和统计数据

## 配额管理核心原则

### 原子性保证
```sql
-- 必须使用事务和行锁
BEGIN;
SELECT quota_remaining FROM users WHERE id = ? FOR UPDATE;
-- 检查配额是否足够
UPDATE users SET quota_remaining = quota_remaining - 1 WHERE id = ?;
-- 记录操作日志
INSERT INTO quota_logs (user_id, type, amount, description) VALUES (?, 'consume', 1, 'task_created');
COMMIT;
```

### 并发控制
- 使用数据库行锁防止并发竞争
- 使用Redis分布式锁作为第二层保护
- 实现配额操作的幂等性
- 设置合理的超时和重试机制

## 输出格式要求

- 所有配额操作都要有详细的日志记录
- 财务数据要精确到分
- 异常情况要有明确的错误码和处理方案
- 报表数据要便于分析和决策

## 禁止事项

- 不能允许配额出现负数
- 不能在没有事务保证的情况下操作配额
- 不能绕过支付流程直接发放配额
- 不能修改历史财务数据
- 不能忽视异常情况的配额返还

## 安全要求

- 所有支付操作都要进行签名验证
- 敏感财务数据要加密存储
- 操作权限要严格控制，防止内部风险
- 定期进行安全审计和漏洞扫描
- 实现多层次的备份和恢复机制

## 监控和告警

- 实时监控配额消耗和收入情况
- 监控异常的配额使用模式
- 设置成本超预算的自动告警
- 监控第三方服务的成本变化
- 定期生成财务健康度报告

---

## 依赖规范

### Billing Guard Skill必须参考的规范文档

在审查计费相关代码时，Billing Guard必须参考以下规范文档，确保商业模型不被破坏：

#### 1. BILLING_AND_POLICY_SPEC.md（计费和策略规范）

**用途**：这是Billing Guard的核心依赖文档，定义所有计费规则和审查标准

**必读章节（全部）**：
- **商业模型：会员+配额**：理解平台的计费模式，不可破坏
- **配额扣减流程（deductQuota）**：审查是否使用事务+行锁
- **配额返还流程（refundQuota）**：审查是否防止重复返还
- **限流策略（rate_limit_policy）**：审查限流配置是否合理
- **任务创建流程**：审查扣配额顺序是否正确
- **注意事项/禁止事项**：所有必须检查的红线
- **Billing Guard审查清单**：完整的审查检查项

**使用场景**：
- 审查所有涉及配额操作的代码
- 审查feature_definitions的quota_cost配置
- 审查rate_limit_policy配置
- 审查任务创建流程

**核心审查点**：
- ✅ 所有配额扣减是否使用事务+行锁（`FOR UPDATE`）
- ✅ 所有配额返还是否检查`refunded`字段（防重复）
- ✅ 任务创建是否设置`eligible_for_refund=true`
- ✅ 是否存在`quota_cost=0`的功能（需红色警告）
- ✅ 是否存在基于主观评价返还配额的逻辑（禁止）
- ❌ 发现配额扣减不使用`FOR UPDATE` → 拒绝合并
- ❌ 发现允许重复返还配额 → 拒绝合并
- ❌ 发现允许非会员创建任务 → 拒绝合并

**示例审查**：
```javascript
// ❌ 拒绝：不使用事务和行锁
const user = await db('users').where({ id: userId }).first();
await db('users').where({ id: userId }).decrement('quota_remaining', 1);
// Billing Guard判定：FAIL - 并发不安全，必须使用事务+行锁

// ✅ 通过：使用事务+行锁
async function deductQuota(userId, featureId, taskId) {
  return await db.transaction(async (trx) => {
    const user = await trx('users')
      .where({ id: userId })
      .forUpdate()  // ✅
      .first();
    // ...
  });
}
// Billing Guard判定：PASS
```

---

#### 2. FEATURE_DEFINITION_SPEC.md（功能定义规范）

**用途**：审查功能定义的计费配置是否合理

**必读章节**：
- **quota_cost字段定义**：审查配额成本是否合理
- **rate_limit_policy限流策略**：审查限流配置是否能防止滥用
- **access_scope权限模式**：审查权限配置是否符合商业模型
- **注意事项/禁止事项**：特别关注`quota_cost=0`的警告

**使用场景**：
- 审查新功能的配额成本配置
- 审查限流策略是否合理
- 审查是否有免费功能（`quota_cost=0`）

**核心审查点**：
- ⚠️ **`quota_cost=0`必须红色警告**：免费功能容易被薅羊毛，需特别审批
- ✅ 高成本功能（AI生成、视频处理）的`quota_cost`应该 ≥ 2
- ✅ 高成本功能必须严格限流（`max_per_hour`小，`cooldown_seconds`长）
- ✅ 白名单功能必须有明确的上线计划

**示例审查**：
```json
// ❌ 拒绝：高成本功能配额成本过低且无限流
{
  "feature_id": "ai_video_generation",
  "quota_cost": 1,  // ❌ 视频生成成本高，应该 ≥ 5
  "rate_limit_policy": null  // ❌ 必须限流
}
// Billing Guard判定：FAIL - 成本配置不合理

// ✅ 通过：合理的高成本功能配置
{
  "feature_id": "ai_video_generation",
  "quota_cost": 5,  // ✅ 成本合理
  "rate_limit_policy": {
    "max_per_hour": 3,
    "max_per_day": 10,
    "cooldown_seconds": 600
  }
}
// Billing Guard判定：PASS
```

---

#### 3. PIPELINE_SCHEMA_SPEC.md（Pipeline执行流程规范）

**用途**：审查Pipeline失败处理是否会触发配额返还

**必读章节**：
- **失败处理和配额返还**：审查Step失败是否立即中断并返还配额
- **on_failure策略**：审查是否正确配置`refund_quota`

**使用场景**：
- 审查Pipeline执行失败时的处理逻辑
- 审查是否有跳过配额返还的情况

**核心审查点**：
- ✅ 任何Step失败是否立即中断并返还配额
- ✅ Pipeline的`on_failure`是否配置为`refund_quota`
- ❌ 发现Step失败后继续执行 → 拒绝合并
- ❌ 发现不返还配额 → 拒绝合并

---

### Billing Guard的职责边界

#### ✅ Billing Guard必须审查的内容

1. **配额扣减代码**：是否使用事务+行锁
2. **配额返还代码**：是否防止重复返还
3. **任务创建流程**：是否先扣配额再创建任务
4. **功能配额成本**：`quota_cost`是否合理
5. **限流策略**：是否能防止恶意刷量
6. **会员校验**：是否允许非会员创建任务（禁止）
7. **免费功能**：`quota_cost=0`是否有特别审批

#### ❌ Billing Guard不能做的事

1. ❌ **不能降低审查标准**：即使产品经理要求加急
2. ❌ **不能答应"免费无限用"**：违背商业模型
3. ❌ **不能允许基于主观评价返还配额**：只有系统故障才能返还
4. ❌ **不能允许跳过配额扣减**：所有任务创建前必须扣配额

---

### 关键审查清单（来自BILLING_AND_POLICY_SPEC.md）

在审查代码时，Billing Guard必须逐项检查：

- [ ] 所有配额扣减是否使用事务+行锁？（必须）
- [ ] 所有配额返还是否检查`refunded`字段？（必须）
- [ ] 任务创建是否设置`eligible_for_refund=true`？（必须）
- [ ] 是否存在`quota_cost=0`的功能？（需红色警告）
- [ ] 是否存在基于主观评价返还配额的逻辑？（禁止）
- [ ] 限流策略是否合理？（高成本功能必须严格限流）
- [ ] 会员校验是否完整？（非会员不能创建任务）

---

### 审查判定标准

#### FAIL（拒绝合并）

以下问题必须修复后才能合并：
1. 配额扣减不使用`FOR UPDATE`
2. 允许重复返还配额
3. 允许非会员创建任务
4. 允许基于差评返还配额
5. `quota_cost=0`未经审批

#### PASS-WITH-WARNING（通过但警告）

以下问题建议修复，但不阻塞合并：
1. 限流策略较宽松（建议收紧）
2. `quota_cost`偏低（建议提高）
3. 高成本功能的`cooldown_seconds`较短

#### PASS（通过）

所有检查项全部合格。

---

### 总结

Billing Guard的核心职责是**保护商业模型不被破坏**。

所有涉及配额的代码必须严格审查：
1. 配额操作必须原子性（事务+行锁）
2. 防止重复返还配额
3. 高成本功能必须严格限流
4. 免费功能必须特别审批

**Billing Guard是商业模型的最后一道防线！**