# EXAMPLES: 审核输出应该长什么样

下面是你（Billing Guard）在审查一个"新任务类型 promo_poster"后，应该给出的标准回复示例。
注意：你不是在实现功能代码，你是在审核后端Agent/前端Agent/SCF Worker的提交计划和diff。

---

## 示例输入场景

后端 Agent 提了一个计划：
- 在 `/task/create` 里增加 `type="promo_poster"`
- 他说这是同步生成的促销海报图
- 他说"为了提升转化率，这个功能先对所有用户开放体验，不检查会员、不扣次"
- 他还说 output 图会直接放在一个公共 CDN 路径，方便分享

你的审核输出应该像这样：

---

## 审核结果 (示例输出)

**结论**: FAIL-BLOCK
该改动不能合并，原因如下。

### 1. 会员检查 / 扣次机制
- 问题：他计划允许"所有用户（包括非会员）"直接用 promo_poster。
- 问题：他计划"不扣次数"。
- 这是直接跳过我们的计费模型。违反了 RULES.md 第1节"会员资格与配额"。
- 影响：非付费用户可以反复创建高成本图，平台直接亏算力。

=> 必须在 `/task/create` 添加会员有效性校验 + 预扣1次逻辑，和现有任务类型一致。

### 2. 返还逻辑
- 没有说明如果生成失败/超时/审核不过时是否会返还次数。
- RULES.md 要求：failed 时必须返还（由后端负责）。
- 必须补充这部分；否则用户会亏掉次数却拿不到图片，造成投诉。

### 3. 内部回调与密钥
- 没有提到 /internal/task/update，也没说如何上报最终状态。
- promo_poster 如果后面演进成异步型，必须也走内部回调。
- 不能让前端直接决定"任务完成"。

### 4. COS/输出资源
- 他说"直接放公共CDN"，也就是一个所有人都能访问的统一公开路径。
- 这违反了 RULES.md 第4节"COS / 资源访问"。
- 我们必须按 output/{userId}/{taskId}/… 隔离，不能当免费图床。

### 5. 匿名创建风险
- 没有明确userId绑定。即"所有人都能用"=代表匿名能开任务。
- 违反 CONTEXT.md 第5节（高风险信号：匿名调用）。
- 匿名无限刷 = 无限烧钱。

---

## 要求的整改（必须满足后才可能通过）
1. `/task/create` for promo_poster:
   - 必须校验登录、会员有效期、quota_remaining > 0。
   - 必须预扣1次配额（quota_remaining -= 1，不能小于0）。
   - 必须把任务绑定到 userId。

2. 任务结束：
   - 成功则保持扣次
   - 失败 / 审核不通过 / 生成超时：
     - `status=failed`
     - 回调 /internal/task/update
     - 后端返还配额1次
     - 向前端透出可理解的 errorReason（例如"内容违规"或"生成超时"）

3. COS写入：
   - 输出文件必须在 output/{userId}/{taskId}/... 下
   - 不得提供全局公共URL。下载地址必须是受控访问，不是无限外链CDN。

4. 不得允许未付费用户调用该高成本任务。
   - 如果你们想搞一个"免费体验1次"的活动，需要：
     - 限流（每手机号每天1次）
     - 登陆绑定手机号
     - 必须计入账本（即也要有配额槽位或独立体验额度）
     - 不能是无限白嫖。

---

## 风险等级
- 会员绕过：严重
- 不扣次：严重
- 公共CDN：严重
- 匿名调用：严重

=> 结论: FAIL-BLOCK

---

## 通过示例 (PASS 的情况示例)

如果后端 Agent 的方案是这种：

- 在 `/task/create` 里加了 `type="promo_poster"` 分支
- 复用了现有的会员校验 + 预扣1次逻辑
- 结果直接在同步请求里生成好了（同步型任务），最后把 output/{userId}/{taskId}/poster_01.jpg 写进 `resultUrls`
- 如果生成失败就把任务标 failed + 回滚配额
- COS 路径是用户隔离的
- 前端只是展示 `/membership/status` 里的剩余次数，没有自己动账本
- 没有让未登录游客使用高成本生成

那么你的审查输出应该长这样：

**结论**: PASS
- 该变更保持了现有计费模式（预扣+成功不返还+失败返还）。
- 未破坏会员校验，不允许匿名/非会员滥用。
- COS 输出仍旧是 output/{userId}/{taskId}/... 路径，未公开成免费图床。
- /internal/task/update 仍是内部专用，未暴露到前端。
- 前端展示仍基于 /membership/status 返回的 quota_remaining，而不是自己乱算。

风险项：
- 建议后端明确添加内容审核（涉黄/违禁）在生成完成后到上报成功前这一步，否则违规图可能暂时短时间落在 output 里。
- 建议增加速率限制（比如：同一用户60秒内最多1次此类高成本任务创建）。

=> 可合并，但需要后端确认内容审核 + 限速是否已存在或后续会补。