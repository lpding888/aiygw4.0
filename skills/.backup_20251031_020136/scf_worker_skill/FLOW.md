# FLOW.md - 云函数处理工程师标准工作流程

## 标准工作流程（必须严格按此格式输出）

每次接收任务处理需求时，你必须按照以下6个步骤输出，不能缺省任何步骤：

### 1. 云函数需求分析和方案设计
- **任务类型识别**：明确是基础修图（basic_clean）还是AI模特生成（model_pose12）
- **输入输出分析**：分析输入文件格式、输出文件格式和处理要求
- **技术方案选择**：选择合适的云服务商和处理方案
- **性能需求评估**：评估处理时间、并发量、内存使用等性能要求

### 2. 腾讯云SCF函数开发
- **函数触发器设计**：配置COS事件触发或API网关触发
- **函数代码编写**：使用Python或Node.js编写处理逻辑
- **环境配置**：配置运行时环境、内存大小、超时时间
- **依赖包管理**：处理第三方库依赖和包大小优化

### 3. 腾讯云数据万象集成（基础修图）
- **万象API调用**：使用数据万象的图片处理接口
- **处理参数配置**：配置图片压缩、格式转换、背景处理等参数
- **输出文件管理**：将处理后的文件上传到指定COS路径
- **状态回调机制**：处理完成后回调后端API更新任务状态

### 4. RunningHub AI集成（AI模特生成）
- **AI接口调用**：调用RunningHub AI的人像生成API
- **分镜任务管理**：处理12张不同角度的分镜图片生成
- **异步状态轮询**：定期查询AI处理状态和进度
- **结果文件处理**：下载并整理生成的图片文件

### 5. COS文件管理和存储优化
- **输入文件路径规范**：按照统一规范管理输入文件路径
- **输出文件路径规划**：设计清晰的输出文件存储结构
- **文件生命周期管理**：配置文件自动清理和归档策略
- **存储成本优化**：选择合适的存储类型和压缩方案

### 6. 错误处理和监控告警
- **异常捕获和处理**：处理各种可能的异常情况
- **重试机制设计**：实现失败任务的重试逻辑
- **日志记录规范**：记录处理过程和关键指标
- **监控告警配置**：配置函数执行的监控和异常告警

## 技术栈和工具

### 核心技术
- **腾讯云SCF**：无服务器云函数计算平台
- **腾讯云COS**：对象存储服务
- **数据万象**：腾讯云图片处理服务
- **RunningHub AI**：第三方AI人像生成服务
- **Python/Node.js**：云函数开发语言

### 开发工具
- **Serverless Framework**：无服务器应用开发框架
- **Tencent Cloud CLI**：腾讯云命令行工具
- **Docker**：本地开发环境模拟
- **Postman**：云函数接口测试

## 云函数配置标准

### 基础配置
- **运行时**：Python 3.9 或 Node.js 16.x
- **内存大小**：512MB - 2GB（根据任务类型调整）
- **超时时间**：30秒 - 900秒（根据处理复杂度设置）
- **并发限制**：根据业务需求和成本预算设置

### 触发器配置
- **COS触发器**：监听特定前缀的文件上传事件
- **API网关触发器**：提供HTTP接口调用能力
- **定时触发器**：用于清理临时文件和统计数据

## 输出格式要求

- 函数代码要有清晰的注释和错误处理
- 输入输出参数要有明确的类型定义
- 处理过程要有详细的日志记录
- 异常情况要有合适的错误码和错误信息

## 禁止事项

- 不能在云函数中存储敏感信息
- 不能忽略输入参数的验证和安全检查
- 不能使用无限循环或阻塞操作
- 不能超出云函数的资源限制
- 不能直接访问数据库或内部网络

## 性能优化要求

- 函数冷启动时间要控制在合理范围
- 内存使用要优化，避免内存泄漏
- 处理时间要尽可能短，减少用户等待
- 并发处理要合理配置，避免资源浪费
- 网络请求要使用连接池和缓存

## 成本控制策略

- 合理配置函数内存和超时时间
- 优化代码执行效率，减少计算资源消耗
- 使用预置并发减少冷启动延迟
- 定期清理无用函数和存储资源
- 监控函数执行成本，及时优化

---

## 依赖规范

### SCF Worker Skill必须参考的规范文档

在开发SCF云函数时，SCF Worker必须参考以下规范文档，确保实现符合平台标准：

#### 1. PIPELINE_SCHEMA_SPEC.md（Pipeline执行流程规范）

**用途**：理解SCF在Pipeline中的角色和回调机制

**必读章节**：
- **Step类型详解 - type: scf**：理解SCF类型Step的执行逻辑
- **SCF回调机制**：理解如何回调后端接口更新任务状态
- **输入输出映射**：理解`input_mapping`和`output_mapping`规则
- **失败处理和配额返还**：理解Step失败时的处理逻辑

**使用场景**：
- 实现SCF云函数的主处理逻辑时
- 发送回调请求给后端时
- 处理输入参数和生成输出结果时

**核心原则**：
- ✅ SCF只能通过回调接口更新状态（不直接操作数据库）
- ✅ 回调请求必须包含签名验证
- ✅ 处理失败时必须通过回调通知后端（触发配额返还）
- ❌ 禁止SCF直接操作数据库
- ❌ 禁止跳过签名发送

**示例**：
```javascript
// ✅ 正确：发送回调并验证签名
const crypto = require('crypto');
const axios = require('axios');

async function sendCallback(taskId, stepIndex, status, output) {
  const timestamp = Math.floor(Date.now() / 1000);
  const payload = `${taskId}${stepIndex}${timestamp}`;
  const signature = crypto
    .createHmac('sha256', process.env.INTERNAL_CALLBACK_SECRET)
    .update(payload)
    .digest('hex');

  await axios.post(
    `${process.env.BACKEND_URL}/api/internal/tasks/${taskId}/steps/${stepIndex}/callback`,
    {
      status: status,  // "success" | "failed"
      output: output
    },
    {
      headers: {
        'X-Internal-Signature': signature,
        'X-Timestamp': timestamp
      }
    }
  );
}

// ❌ 错误：直接操作数据库
await db('task_steps').where({ id: stepId }).update({ output: ... });  // 禁止
```

---

#### 2. BILLING_AND_POLICY_SPEC.md（计费和策略规范）

**用途**：理解配额返还机制，确保失败时正确触发

**必读章节**：
- **任务创建流程**：理解`eligible_for_refund`字段的作用
- **配额返还流程**：理解后端如何返还配额
- **失败处理规则**：理解什么情况下会触发返还

**使用场景**：
- SCF处理失败时
- 调用回调接口时（`status: "failed"`）

**核心原则**：
- ✅ SCF处理失败时必须发送`status: "failed"`回调
- ✅ 后端收到失败回调后会自动返还配额
- ❌ SCF不能直接操作配额

**示例**：
```javascript
// ✅ 正确：处理失败时发送失败回调
try {
  const result = await processVideo(inputUrl);
  await sendCallback(taskId, stepIndex, 'success', { video_url: result.url });
} catch (error) {
  // 发送失败回调，后端会自动返还配额
  await sendCallback(taskId, stepIndex, 'failed', { error_message: error.message });
}
```

---

### SCF Worker的职责边界

#### ✅ SCF Worker可以做的事

1. **处理大文件**：下载COS输入文件，处理后上传到COS输出路径
2. **调用供应商API**：调用外部AI服务（如RunningHub、Stable Diffusion）
3. **复杂编排**：多个供应商API的编排和容错
4. **异步处理**：长耗时任务（视频合成、批量处理等）
5. **回调后端**：完成或失败后调用回调接口通知后端

#### ❌ SCF Worker不能做的事

1. ❌ **不能直接操作数据库**：必须通过回调接口
2. ❌ **不能跳过签名验证**：回调请求必须包含签名
3. ❌ **不能操作配额**：配额的扣减和返还只能由后端完成
4. ❌ **不能暴露敏感信息**：不能在日志或回调中暴露API密钥

---

### 关键检查清单

在提交SCF代码前，必须自检：

- [ ] 是否通过回调接口更新任务状态？（必须）
- [ ] 回调请求是否包含签名？（必须）
- [ ] 签名算法是否与后端一致？（必须）
- [ ] 处理失败时是否发送`status: "failed"`回调？（必须）
- [ ] 是否直接操作了数据库？（禁止）
- [ ] 是否暴露了敏感信息？（禁止）

---

### 总结

SCF Worker的核心职责是**大文件处理、异步任务、供应商编排**。

所有状态更新必须通过回调接口完成：
1. 下载输入文件 → 处理 → 上传输出文件
2. 完成时发送`status: "success"`回调
3. 失败时发送`status: "failed"`回调（触发配额返还）

**遵循这些规范，才能确保SCF实现符合平台架构标准！**