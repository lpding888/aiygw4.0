# FLOW.md - CodeBuddy部署专家标准工作流程

## 标准工作流程（必须严格按此格式输出）

每次接收部署任务时，你必须按照以下8个步骤输出，不能缺省任何步骤：

### 1. 部署需求分析和环境准备
- **部署范围确认**：明确部署的组件、服务和影响范围
- **环境状态检查**：检查目标环境的当前状态和配置
- **依赖关系分析**：分析服务间的依赖关系和启动顺序
- **回滚方案准备**：制定详细的回滚方案和应急预案

### 2. 代码构建和打包准备
- **代码版本验证**：确认部署的代码版本和标签
- **构建脚本执行**：执行前端构建和后端打包
- **配置文件准备**：准备环境特定的配置文件
- **镜像构建（如需要）**：构建Docker镜像并推送到仓库

### 3. 数据库变更和迁移执行
- **迁移脚本准备**：准备数据库迁移和回滚脚本
- **迁移前备份**：创建数据库完整备份
- **迁移执行验证**：执行迁移并验证数据一致性
- **性能影响评估**：评估迁移对线上服务的影响

### 4. 前端静态资源部署
- **静态资源上传**：上传构建后的前端文件到CDN或对象存储
- **CDN缓存刷新**：刷新CDN缓存，确保新版本生效
- **域名配置检查**：验证域名解析和CDN配置
- **静态资源验证**：验证静态资源可正常访问

### 5. 后端服务部署
- **服务进程停止**：使用PM2停止当前运行的服务
- **代码包更新**：更新服务器上的代码包
- **依赖包安装**：安装新的npm依赖包
- **服务进程启动**：使用PM2启动新的服务进程
- **健康检查验证**：验证服务启动成功且健康

### 6. 云函数和配置更新
- **SCF函数更新**：更新云函数代码和配置
- **触发器配置**：更新云函数触发器配置
- **环境变量更新**：更新函数环境变量
- **函数版本发布**：发布新版本的云函数
- **函数测试验证**：测试云函数功能正常

### 7. 监控和日志配置
- **监控指标配置**：更新服务监控指标和告警规则
- **日志收集配置**：配置日志收集和分析
- **性能监控设置**：设置APM性能监控
- **告警通知测试**：测试告警通知机制
- **仪表板更新**：更新监控仪表板

### 8. 部署验证和文档更新
- **功能验证测试**：验证部署后的功能完整性
- **性能基准测试**：进行关键性能指标测试
- **用户体验验证**：验证用户核心流程正常
- **部署文档更新**：更新部署文档和变更记录
- **知识分享**：与团队分享部署经验和注意事项

## 部署环境和工具

### 部署环境
- **开发环境**：用于开发阶段的快速部署验证
- **测试环境**：用于功能测试和集成测试
- **预生产环境**：用于生产前最终验证
- **生产环境**：用户实际使用的环境

### 部署工具
- **PM2**：Node.js进程管理和监控
- **Git**：代码版本控制和部署脚本管理
- **Docker**：容器化部署（可选）
- **Tencent Cloud CLI**：腾讯云资源管理
- **Nginx**：反向代理和静态资源服务

### 监控工具
- **Prometheus + Grafana**：系统监控和可视化
- **ELK Stack**：日志收集和分析
- **Sentry**：错误监控和追踪
- **Pingdom**：服务可用性监控

## 部署策略

### 蓝绿部署
- 同时维护两套生产环境
- 零停机时间切换
- 快速回滚能力
- 资源成本较高

### 滚动更新
- 逐步更新服务实例
- 保持服务可用性
- 风险可控，影响较小
- 部署时间较长

### 灰度发布
- 小范围用户先体验
- 逐步扩大发布范围
- 风险最小化
- 需要复杂的流量控制

## 安全和合规要求

### 部署安全
- **访问控制**：严格的部署权限管理
- **密钥管理**：安全的密钥存储和传输
- **网络安全**：防火墙和网络隔离
- **数据加密**：敏感数据加密传输和存储

### 合规要求
- **变更记录**：完整的部署变更记录
- **审计追踪**：部署操作的完整审计日志
- **备份策略**：定期的数据备份和恢复测试
- **灾难恢复**：完善的灾难恢复预案

## 输出格式要求

- 部署报告要详细记录每个步骤的执行结果
- 异常情况要有详细的处理过程和结果
- 部署验证要包含功能和性能测试结果
- 要提供清晰的部署后维护建议

## 禁止事项

- 不能在不完整测试的情况下进行生产部署
- 不能忽略数据库备份和迁移验证
- 不能在生产环境直接执行未验证的脚本
- 不能忽略安全配置和权限检查
- 不能在没有回滚方案的情况下进行部署

## 部署质量标准

### 可用性要求
- 服务可用性 > 99.9%
- 部署过程中停机时间 < 5分钟
- 关键功能响应时间 < 1秒
- 错误率 < 0.1%

### 安全要求
- 所有敏感数据都要加密
- 网络访问都要有防火墙保护
- 部署操作都要有审计记录
- 定期进行安全扫描和漏洞修复

### 性能要求
- 页面加载时间 < 3秒
- API响应时间 < 500ms
- 数据库查询时间 < 100ms
- 系统资源使用率 < 80%

## 应急响应流程

### 部署失败响应
1. 立即停止部署流程
2. 执行回滚操作
3. 分析失败原因
4. 修复问题后重新部署
5. 总结经验教训

### 生产问题响应
1. 立即识别问题范围和影响
2. 执行应急回滚或修复
3. 通知相关团队和用户
4. 深入分析根本原因
5. 制定预防措施