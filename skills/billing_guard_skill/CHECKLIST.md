# CHECKLIST.md - 计费守卫员自检清单

## 每次计费逻辑变更前必须自检的项目

### ✅ 计费策略和商业模式
- [ ] 我是否理解了¥99/月会员制的商业模式？
- [ ] 配额规则（100次/月）是否明确定义？
- [ ] 是否识别了所有可能的财务风险？
- [ ] 第三方服务成本是否已经核算清楚？
- [ ] 平台利润空间是否合理？

### ✅ 会员管理逻辑
- [ ] 会员购买流程是否完整？
- [ ] 会员续期和过期逻辑是否正确？
- [ ] 新用户注册的配额发放是否合理？
- [ ] 会员权益验证是否严格？
- [ ] 配额查询接口是否准确？

### ✅ 配额操作原子性（最高优先级）
- [ ] 配额扣减是否使用数据库事务？
- [ ] 是否使用`FOR UPDATE`行锁防止并发？
- [ ] 配额检查是否在扣减之前进行？
- [ ] 配额不足时是否抛出明确错误？
- [ ] 配额操作是否保证原子性？
- [ ] 配额返还逻辑是否完整且可靠？

### ✅ 并发控制和防刷机制
- [ ] 是否实现了Redis分布式锁作为第二层保护？
- [ ] 并发场景下的配额管理是否安全？
- [ ] 是否有防止恶意刷单的机制？
- [ ] API访问频率限制是否合理？
- [ ] 异常配额消耗是否能够及时发现？

### ✅ 支付集成和安全性
- [ ] 微信支付签名验证是否完整？
- [ ] 支付回发的幂等性处理是否正确？
- [ ] 支付失败时的处理流程是否完善？
- [ ] 支付金额和订单金额是否一致？
- [ ] 支付异常是否不会影响用户配额？

### ✅ 财务数据准确性
- [ ] 所有收入是否正确记录？
- [ ] 第三方成本是否准确核算？
- [ ] 财务报表数据是否与实际一致？
- [ ] 数据对账是否定期进行？
- [ ] 异常账务是否能够及时发现？

### ✅ 审计和合规性
- [ ] 所有配额操作是否都有日志记录？
- [ ] 审计追踪链条是否完整？
- [ ] 敏感财务数据是否加密存储？
- [ ] 操作权限是否严格控制？
- [ ] 是否符合财务和税务合规要求？

### ✅ 成本监控和预警
- [ ] 第三方服务成本是否实时监控？
- [ ] 用户成本分析是否准确？
- [ ] 成本超预算是否有预警机制？
- [ ] 异常消耗模式是否能及时发现？
- [ ] 成本优化建议是否定期提出？

### ✅ 数据备份和恢复
- [ ] 财务数据是否定期备份？
- [ ] 配额操作日志是否完整保存？
- [ ] 灾难恢复方案是否完备？
- [ ] 数据恢复流程是否经过测试？
- [ ] 备份数据的完整性是否验证？

### ✅ 错误处理和异常恢复
- [ ] 配额操作失败时的回滚机制是否完整？
- [ ] 网络异常时的处理是否合理？
- [ ] 第三方服务异常时的影响是否可控？
- [ ] 异常恢复后数据一致性是否保证？
- [ ] 用户是否不会因为系统异常损失配额？

## 输出前最后检查

在部署计费逻辑变更之前，请确认：

1. **数据安全**：配额操作绝对不会出现负数
2. **原子性**：所有配额操作都是原子性的
3. **并发安全**：并发场景下配额管理是安全的
4. **财务准确**：所有收入和成本数据都准确无误
5. **审计完整**：所有操作都有完整的审计记录

## 常见错误避免

❌ **避免这些致命错误**：
- 不使用事务就操作配额，导致超用
- 不使用行锁，导致并发竞争问题
- 配额不足时还允许扣减
- 忽略支付失败后的配额返还
- 修改历史财务数据
- 在前端暴露计费逻辑

✅ **坚持这些铁律**：
- 配额操作必须原子化，绝不能出现负数
- 并发控制必须多重保护，防止竞争条件
- 支付和配额必须严格对应，不能出现不一致
- 财务数据必须准确无误，经得起审计
- 异常处理必须完整，用户不能因此受损

## 配额管理特别检查

⚠️ **配额原子性安全检查（最高优先级）**：
- [ ] 是否使用 `BEGIN; ... COMMIT;` 事务？
- [ ] 是否使用 `SELECT ... FOR UPDATE` 行锁？
- [ ] 配额检查逻辑是否在事务内执行？
- [ ] 配额扣减是否在检查成功后立即执行？
- [ ] 异常时是否能够正确回滚事务？
- [ ] 配额操作日志是否在同一个事务中记录？

⚠️ **并发控制安全检查**：
- [ ] Redis分布式锁的key是否合理设计？
- [ ] 锁的过期时间是否设置合理？
- [ ] 获取锁失败时的处理是否正确？
- [ ] 锁的释放是否在finally块中执行？
- [ ] 是否测试过高并发场景下的安全性？

## 支付安全特别检查

⚠️ **微信支付安全检查**：
- [ ] 支付回调的签名验证是否完整？
- [ ] 订单金额和支付金额是否二次验证？
- [ ] 支付通知的幂等性处理是否正确？
- [ ] 支付超时时的处理机制是否完善？
- [ ] 重复支付是否能正确识别和处理？

## 数据一致性检查

⚠️ **数据一致性保证检查**：
- [ ] users表的quota_remaining字段是否准确？
- [ ] quota_logs表的操作记录是否完整？
- [ ] orders表的支付状态是否实时更新？
- [ ] 定期对账的机制是否建立？
- [ ] 数据不一致时的修复方案是否完备？

## 风险评估检查

⚠️ **财务风险评估检查**：
- [ ] 是否评估了第三方服务价格上涨的风险？
- [ ] 是否评估了恶意用户刷单的风险？
- [ ] 是否评估了系统故障导致损失的风险？
- [ ] 是否评估了汇率波动的影响？
- [ ] 风险应对措施是否充分？