# RULES: 计费/配额/防薅羊毛的红线标准

这些是绝对性约束。只要违反任意一条，该提交应该被标记为 FAIL-BLOCK。

---

## 1. 会员资格与配额
- 只有会员且在有效期内的用户可以调用高成本任务（例如 AI模特12分镜、视频/多分镜生成）。
- 后端在 `/task/create` 必须：
  - 校验 isMember === true
  - 校验 quota_expireAt > now
  - 校验 quota_remaining > 0
- 不能让未付费用户跳过校验直接创建任务。

- 每个任务创建必须**预扣 1 次配额**，扣完以后 quota_remaining 不能小于 0。
- 正常完成的任务不返还配额。
- 如果 `status=failed`，后端必须返还配额 1 次（并保证幂等，不要返还两次）。
- SCF Worker 不能直接返还配额，它只能上报 `failed`，配额返还是后端的工作。
- 前端不能伪造配额展示，也不能直接做"+1 / -1 视觉假扣费"。

违规示例（必须 FAIL-BLOCK）：
- "这个新任务是推广活动，所以我打算不扣次数。" ← 违规
- "免费游客也能调用 model_pose12，只是不会显示到前端历史里。" ← 违规
- "配额不够的时候我们先让他跑，回头再扣。" ← 违规

---

## 2. 免费试用 / 限流 / 防刷
- 如果前端或后端添加了"免费体验"/"试用次数"/"免扣一次"等逻辑：
  - 必须有频率限制（例如同一手机号/IP/设备指纹 每X小时仅1次）
  - 必须有风控门槛（手机号登录、短信验证、不可匿名反复刷）
  - 必须保证不会被无限重复调用高成本算力

- 如果代码中出现"for (let i=0; i<10; i++) 连续发请求"这种批量触发行为，判断为高风险。
- 任何取消限流的改动，比如"暂时把验证码冷却去掉"、"暂时开放每秒10个任务创建"，都要被标 FAIL-BLOCK，除非明确写明这是仅限内测环境 / 受保护的白名单用户。

---

## 3. 内部回调与密钥泄露
- `/internal/task/update` 必须只被可信后端/SCF调用，带签名，不能被前端直接访问。
- 任何让前端拿到 `/internal/task/update`、回调secret、vendorTaskId原始密钥的行为 = FAIL-BLOCK。
- 运行供应商的 API Key、RunningHub 的 apiKey、我们后端的签名token，不能出现在浏览器可见代码里，不能出现在前端的网络请求中，不能 console.log 给用户看。

---

## 4. COS / 资源访问
- 用户的输出结果（成片图、12分镜图、促销海报图 etc）必须落在 `output/{userId}/{taskId}/...`
- 不能把所有生成成果统一放到一个全公开的 CDN 路径，比如 `output/public/` 没用户隔离。
- 不能把 COS 桶本身当成"免费图床"对全网完全开放。
- 不能把永久直链交给未付费用户扩散。

合规玩法是：通过后端或签名URL按需取，且仅当前用户可读。

---

## 5. 状态机 & 返还逻辑
- Task 有 `status = processing | done | failed`
- 不能发明"半成功"之类容易混乱计费的状态（比如 "warning-but-bill-user-anyway"）。
- 不能在"failed"状态还拒绝返还配额。
- 不能在"done"状态还自动返还配额（那就等于白送）。

- "处理超时"或"供应商崩了"应该标为 failed，并触发返还。
- "内容违规"也应该标为 failed，并触发返还。
- "审核不过但是我们还是标 done 只是不给预览图"：这是违规，属于骗次数，必须 FAIL-BLOCK。

---

## 6. 限制前端越权
- 前端页面/组件不允许去构造任务时绕过后端校验，比如直接POST到SCF的HTTP入口、或直连供应商。
- 前端不允许决定"这次不扣次数"，这种决定必须来自后端的计费逻辑。

---

## 7. 监控 & 溯源
- 系统应该能知道是谁创建了该任务（userId 绑定），什么时候扣了配额，什么时候返还。
- 如果某个改动让任务创建不再绑定 userId（匿名调用），必须 FAIL-BLOCK：匿名无限跑 = 无限烧钱。

---

## 8. 审核输出格式
当你（Billing Guard）审完，报告必须包含：
- 计费/扣次流程是否保持不变
- 返还逻辑是否保持不变
- 新增接口有没有给未付费用户开后门
- 前端是否仍依赖后端返回的quota，而不是自己瞎改
- SCF 回调是否仍是内部的、带签名、不可被前端复用
- COS 是否仍是按 userId/taskId 隔离，不是公共图床
- 限流/风控是否被移除

只要有一项"破了"，你就输出 FAIL-BLOCK。