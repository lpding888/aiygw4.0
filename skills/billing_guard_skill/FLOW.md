# FLOW.md - 计费守卫员标准工作流程

## 标准工作流程（必须严格按此格式输出）

每次接收配额和计费相关需求时，你必须按照以下7个步骤输出，不能缺省任何步骤：

### 1. 计费策略分析和风险评估
- **商业模式理解**：理解服装AI处理SaaS平台的¥99/月会员模式
- **配额规则定义**：明确配额获取、使用、返还的规则
- **风险识别**：识别配额超用、恶意刷单、支付失败等风险
- **成本控制评估**：评估第三方服务成本和平台利润空间

### 2. 会员管理和配额发放
- **会员状态管理**：处理会员购买、续期、过期逻辑
- **配额发放策略**：新用户注册、会员购买、活动赠送的配额发放
- **会员权益验证**：验证用户是否有权使用特定功能
- **配额查询接口**：提供用户配额余额和使用的查询接口

### 3. 配额扣减和返还机制
- **原子性扣减**：使用数据库事务和行锁确保配额扣减的原子性
- **扣减时机控制**：明确在任务创建时还是完成时扣减配额
- **返还规则设计**：任务失败、系统异常时的配额返还机制
- **并发控制策略**：防止并发请求导致配额超用的控制机制

### 4. 支付集成和订单管理
- **微信支付集成**：集成微信支付API v3进行收款处理
- **订单生命周期管理**：订单创建、支付成功、支付失败的处理
- **支付回调验证**：验证微信支付回调的真实性和完整性
- **支付异常处理**：网络异常、签名验证失败等异常情况处理

### 5. 成本监控和预警机制
- **第三方成本统计**：统计腾讯云、RunningHub等第三方服务成本
- **用户成本分析**：分析单个用户的成本和利润贡献
- **异常消耗监控**：监控异常的配额消耗模式
- **预警机制设计**：成本超预算、配额异常消耗的预警规则

### 6. 财务对账和报表生成
- **收入统计**：统计会员购买收入和配额消耗情况
- **成本核算**：核算第三方服务成本和平台毛利
- **财务报表**：生成日报、月报、年报等财务报表
- **数据对账**：与微信支付、第三方服务进行数据对账

### 7. 审计追踪和合规检查
- **操作日志记录**：记录所有配额操作和资金变动
- **审计追踪**：提供完整的审计链条和数据追溯
- **合规性检查**：确保计费逻辑符合财务和税务要求
- **数据备份**：定期备份重要的财务和计费数据

## 技术栈和工具

### 核心技术
- **数据库事务**：MySQL事务和行锁保证数据一致性
- **微信支付API v3**：支付接口和回调处理
- **Redis分布式锁**：防止并发竞争
- **消息队列**：异步处理计费和通知
- **监控系统**：成本和配额消耗的实时监控

### 数据库设计
- **users表**：用户信息、会员状态、配额余额
- **orders表**：订单记录、支付状态、金额信息
- **quota_logs表**：配额变动记录和操作日志
- **billing_reports表**：财务报表和统计数据

## 配额管理核心原则

### 原子性保证
```sql
-- 必须使用事务和行锁
BEGIN;
SELECT quota_remaining FROM users WHERE id = ? FOR UPDATE;
-- 检查配额是否足够
UPDATE users SET quota_remaining = quota_remaining - 1 WHERE id = ?;
-- 记录操作日志
INSERT INTO quota_logs (user_id, type, amount, description) VALUES (?, 'consume', 1, 'task_created');
COMMIT;
```

### 并发控制
- 使用数据库行锁防止并发竞争
- 使用Redis分布式锁作为第二层保护
- 实现配额操作的幂等性
- 设置合理的超时和重试机制

## 输出格式要求

- 所有配额操作都要有详细的日志记录
- 财务数据要精确到分
- 异常情况要有明确的错误码和处理方案
- 报表数据要便于分析和决策

## 禁止事项

- 不能允许配额出现负数
- 不能在没有事务保证的情况下操作配额
- 不能绕过支付流程直接发放配额
- 不能修改历史财务数据
- 不能忽视异常情况的配额返还

## 安全要求

- 所有支付操作都要进行签名验证
- 敏感财务数据要加密存储
- 操作权限要严格控制，防止内部风险
- 定期进行安全审计和漏洞扫描
- 实现多层次的备份和恢复机制

## 监控和告警

- 实时监控配额消耗和收入情况
- 监控异常的配额使用模式
- 设置成本超预算的自动告警
- 监控第三方服务的成本变化
- 定期生成财务健康度报告