# FLOW.md - 云函数处理工程师标准工作流程

## 标准工作流程（必须严格按此格式输出）

每次接收任务处理需求时，你必须按照以下6个步骤输出，不能缺省任何步骤：

### 1. 云函数需求分析和方案设计
- **任务类型识别**：明确是基础修图（basic_clean）还是AI模特生成（model_pose12）
- **输入输出分析**：分析输入文件格式、输出文件格式和处理要求
- **技术方案选择**：选择合适的云服务商和处理方案
- **性能需求评估**：评估处理时间、并发量、内存使用等性能要求

### 2. 腾讯云SCF函数开发
- **函数触发器设计**：配置COS事件触发或API网关触发
- **函数代码编写**：使用Python或Node.js编写处理逻辑
- **环境配置**：配置运行时环境、内存大小、超时时间
- **依赖包管理**：处理第三方库依赖和包大小优化

### 3. 腾讯云数据万象集成（基础修图）
- **万象API调用**：使用数据万象的图片处理接口
- **处理参数配置**：配置图片压缩、格式转换、背景处理等参数
- **输出文件管理**：将处理后的文件上传到指定COS路径
- **状态回调机制**：处理完成后回调后端API更新任务状态

### 4. RunningHub AI集成（AI模特生成）
- **AI接口调用**：调用RunningHub AI的人像生成API
- **分镜任务管理**：处理12张不同角度的分镜图片生成
- **异步状态轮询**：定期查询AI处理状态和进度
- **结果文件处理**：下载并整理生成的图片文件

### 5. COS文件管理和存储优化
- **输入文件路径规范**：按照统一规范管理输入文件路径
- **输出文件路径规划**：设计清晰的输出文件存储结构
- **文件生命周期管理**：配置文件自动清理和归档策略
- **存储成本优化**：选择合适的存储类型和压缩方案

### 6. 错误处理和监控告警
- **异常捕获和处理**：处理各种可能的异常情况
- **重试机制设计**：实现失败任务的重试逻辑
- **日志记录规范**：记录处理过程和关键指标
- **监控告警配置**：配置函数执行的监控和异常告警

## 技术栈和工具

### 核心技术
- **腾讯云SCF**：无服务器云函数计算平台
- **腾讯云COS**：对象存储服务
- **数据万象**：腾讯云图片处理服务
- **RunningHub AI**：第三方AI人像生成服务
- **Python/Node.js**：云函数开发语言

### 开发工具
- **Serverless Framework**：无服务器应用开发框架
- **Tencent Cloud CLI**：腾讯云命令行工具
- **Docker**：本地开发环境模拟
- **Postman**：云函数接口测试

## 云函数配置标准

### 基础配置
- **运行时**：Python 3.9 或 Node.js 16.x
- **内存大小**：512MB - 2GB（根据任务类型调整）
- **超时时间**：30秒 - 900秒（根据处理复杂度设置）
- **并发限制**：根据业务需求和成本预算设置

### 触发器配置
- **COS触发器**：监听特定前缀的文件上传事件
- **API网关触发器**：提供HTTP接口调用能力
- **定时触发器**：用于清理临时文件和统计数据

## 输出格式要求

- 函数代码要有清晰的注释和错误处理
- 输入输出参数要有明确的类型定义
- 处理过程要有详细的日志记录
- 异常情况要有合适的错误码和错误信息

## 禁止事项

- 不能在云函数中存储敏感信息
- 不能忽略输入参数的验证和安全检查
- 不能使用无限循环或阻塞操作
- 不能超出云函数的资源限制
- 不能直接访问数据库或内部网络

## 性能优化要求

- 函数冷启动时间要控制在合理范围
- 内存使用要优化，避免内存泄漏
- 处理时间要尽可能短，减少用户等待
- 并发处理要合理配置，避免资源浪费
- 网络请求要使用连接池和缓存

## 成本控制策略

- 合理配置函数内存和超时时间
- 优化代码执行效率，减少计算资源消耗
- 使用预置并发减少冷启动延迟
- 定期清理无用函数和存储资源
- 监控函数执行成本，及时优化